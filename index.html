<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANACIM - Système de Gestion des Aérodromes</title>
    <style>
        /* ============ VARIABLES DE COULEUR PROFESSIONNELLES ============ */
        :root {
            --primary-color: #1a237e;
            --primary-light: #534bae;
            --primary-dark: #000051;
            --secondary-color: #006064;
            --secondary-light: #428e92;
            --secondary-dark: #00363a;
            --accent-color: #ff6f00;
            --accent-light: #ff9e40;
            --accent-dark: #c43e00;
            --success-color: #2e7d32;
            --warning-color: #f57c00;
            --danger-color: #c62828;
            --info-color: #0277bd;
            --light-bg: #f5f7fa;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #546e7a;
            --border-color: #e0e6ed;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --gradient-success: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%);
            --gradient-warning: linear-gradient(135deg, var(--warning-color) 0%, #ffb74d 100%);
            --gradient-danger: linear-gradient(135deg, var(--danger-color) 0%, #ef5350 100%);
            --gradient-info: linear-gradient(135deg, var(--info-color) 0%, #29b6f6 100%);
        }

        /* ============ RÉINITIALISATION ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--light-bg) 0%, #e3f2fd 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ============ ANIMATIONS FLUIDES ============ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* ============ TRANSITIONS GÉNÉRALES ============ */
        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ============ PAGE DE CONNEXION ============ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite linear;
        }

        .login-box {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-hover);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.8s ease-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo .logo-animation {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
        }

        .login-logo h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .login-error {
            background: rgba(198, 40, 40, 0.1);
            color: var(--danger-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--danger-color);
            display: none;
        }

        .login-success {
            background: rgba(46, 125, 50, 0.1);
            color: var(--success-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--success-color);
            display: none;
        }

        /* ============ APPLICATION PRINCIPALE ============ */
        .container {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .container.active {
            display: block;
        }

        /* ============ EN-TÊTE ============ */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-center h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(to right, #fff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.3);
        }

        /* ============ NAVIGATION SUR 3 LIGNES ============ */
        .nav-container {
            position: sticky;
            top: 80px;
            z-index: 999;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 10px 20px;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .nav-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            border-radius: 10px;
            flex: 1;
            min-width: 180px;
            max-width: 220px;
            justify-content: center;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            transition: all 0.3s;
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }

        .nav-tab:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
            background: rgba(26, 35, 126, 0.05);
        }

        .nav-tab:hover::after {
            width: 80%;
        }

        .nav-tab.active {
            color: var(--primary-color);
            background: rgba(26, 35, 126, 0.1);
        }

        .nav-tab.active::after {
            width: 100%;
        }

        /* ============ CONTENU PRINCIPAL ============ */
        .content {
            padding: 40px;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============ CARTES DE STATISTIQUES ============ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
        }

        .stat-card h3 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ============ FORMULAIRES ============ */
        .form-group {
            margin-bottom: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--light-bg);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        /* ============ BOUTONS ============ */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ffb74d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #ef5350 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #29b6f6 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #78909c 0%, #b0bec5 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* ============ TABLEAUX ============ */
        .table-container {
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 24px;
            animation: fadeIn 0.4s ease-out;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: rgba(26, 35, 126, 0.05);
        }

        /* ============ BADGES ============ */
        .badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .badge-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ffb74d 100%);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #ef5350 100%);
            color: white;
        }

        .badge-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #29b6f6 100%);
            color: white;
        }

        .badge-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
        }

        /* ============ MODALES ============ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideInRight 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: var(--shadow-hover);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }

        /* ============ GESTION DES FICHIERS ============ */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--light-bg);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(26, 35, 126, 0.05);
        }

        .file-upload i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--light-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            animation: slideInRight 0.3s ease-out;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 16px;
        }

        /* ============ COMMENTAIRES ============ */
        .comments-section {
            margin-top: 30px;
        }

        .comment-form {
            margin-bottom: 30px;
        }

        .comment-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .comment-item {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-out;
            border-left: 4px solid var(--primary-color);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: 600;
            color: var(--primary-color);
        }

        .comment-date {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* ============ BARRE DE PROGRESSION ============ */
        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
        }

        /* ============ CARTES DE PHASE ============ */
        .phase-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .phase-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .phase-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .phase-status {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ============ CARTE AÉRODROME ============ */
        .aerodrome-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s;
        }

        .aerodrome-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .aerodrome-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .aerodrome-code {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .aerodrome-name {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        /* ============ BADGE DE STATUT ============ */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active { background: #e8f5e9; color: #2e7d32; }
        .status-pending { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e3f2fd; color: #1976d2; }
        .status-closed { background: #f5f5f5; color: #616161; }
        .status-onleave { background: #fff8e1; color: #ff8f00; }
        .status-intraining { background: #e8eaf6; color: #3949ab; }
        .status-high-risk { background: #ffebee; color: #c62828; }
        .status-medium-risk { background: #fff3e0; color: #ef6c00; }
        .status-low-risk { background: #f1f8e9; color: #689f38; }

	/* ============ ANIMATIONS DASHBOARD ============ */
@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes progressFill {
    from { width: 0; }
}

.stat-card h3 {
    animation: countUp 0.6s ease-out;
}

.progress-fill {
    animation: progressFill 1.5s ease-out;
}

.stat-card:nth-child(1) { animation-delay: 0s; }
.stat-card:nth-child(2) { animation-delay: 0.1s; }
.stat-card:nth-child(3) { animation-delay: 0.2s; }
.stat-card:nth-child(4) { animation-delay: 0.3s; }

.performance-item {
    animation: fadeIn 0.6s ease-out;
}

.performance-item:nth-child(1) { animation-delay: 0.2s; opacity: 0; animation-fill-mode: forwards; }
.performance-item:nth-child(2) { animation-delay: 0.4s; opacity: 0; animation-fill-mode: forwards; }
.performance-item:nth-child(3) { animation-delay: 0.6s; opacity: 0; animation-fill-mode: forwards; }
.performance-item:nth-child(4) { animation-delay: 0.8s; opacity: 0; animation-fill-mode: forwards; }

/* Effet de brillance sur les cartes au survol */
.stat-card::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        transparent 40%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 60%,
        transparent
    );
    transform: translateX(-100%);
    transition: transform 0.6s;
}

.stat-card:hover::after {
    transform: translateX(100%);
}

        /* ============ RESPONSIVE ============ */
        @media (max-width: 1200px) {
            .nav-tab {
                min-width: 160px;
                max-width: 180px;
            }
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .header {
                padding: 20px;
                flex-direction: column;
                gap: 20px;
            }
            
            .nav-container {
                top: 140px;
            }
            
            .nav-tab {
                min-width: 140px;
                max-width: 160px;
                font-size: 13px;
                padding: 10px 15px;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                gap: 8px;
            }
            
            .nav-tab {
                min-width: 120px;
                max-width: 140px;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .stat-card {
                padding: 24px;
            }
            
            .stat-card h3 {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 30px 20px;
            }
            
            .header-center h1 {
                font-size: 20px;
                text-align: center;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .nav-tab {
                min-width: 100px;
                max-width: 120px;
                font-size: 11px;
                padding: 6px 10px;
            }
        }

	

	/* ============ TOOLTIPS PERSONNALISÉES AMÉLIORÉES ============ */
[data-tooltip] {
    position: relative;
    cursor: help;
}

[data-tooltip]::before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 15px); /* Plus d'espace entre la carte et le tooltip */
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.95);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    /* CORRECTION PRINCIPALE: Permettre le retour à la ligne */
    white-space: normal;
    max-width: 280px; /* Largeur maximale */
    min-width: 200px; /* Largeur minimale */
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 10000; /* Très élevé pour passer au-dessus de tout */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    text-align: center;
    word-wrap: break-word; /* Couper les mots longs si nécessaire */
}

[data-tooltip]::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.95);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
    opacity: 1;
}

[data-tooltip]:hover::before {
    transform: translateX(-50%) translateY(0);
}

/* Ajuster le tooltip pour les bords de l'écran */
[data-tooltip]:first-child::before {
    left: 0;
    transform: translateX(0);
}

[data-tooltip]:first-child:hover::before {
    transform: translateX(0) translateY(0);
}

[data-tooltip]:last-child::before {
    left: auto;
    right: 0;
    transform: translateX(0);
}

[data-tooltip]:last-child:hover::before {
    transform: translateX(0) translateY(0);
}

        /* ============ SCROLLBAR PERSONNALISÉE ============ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
        }

        /* ============ ÉLÉMENTS SPÉCIFIQUES ============ */
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 30px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 5px;
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 4px var(--primary-color);
        }

        .search-box {
            position: relative;
            margin-bottom: 30px;
        }

        .search-box input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            border-radius: 50px;
            border: 2px solid var(--border-color);
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .search-box i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* ============ ALERTES ET NOTIFICATIONS ============ */
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid;
        }

        .alert-success {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: var(--success-color);
            border-left-color: var(--success-color);
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: var(--warning-color);
            border-left-color: var(--warning-color);
        }

        .alert-danger {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: var(--danger-color);
            border-left-color: var(--danger-color);
        }

        .alert-info {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            color: var(--info-color);
            border-left-color: var(--info-color);
        }

        /* ============ OVERLAY DE CHARGEMENT ============ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(10px);
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============ CARTE INSPECTEUR ============ */
        .inspector-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--info-color);
            transition: all 0.3s;
        }

        .inspector-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .inspector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .inspector-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .inspector-specialty {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* ============ PREUVE VISUELLE ============ */
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .evidence-item {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .evidence-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .evidence-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* ============ CARTE FORMATION ============ */
        .training-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--accent-color);
            transition: all 0.3s;
        }

        .training-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .training-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .training-period {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* ============ FICHIER UPLOAD STYLE ============ */
        .file-upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--light-bg);
            margin: 20px 0;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(26, 35, 126, 0.05);
        }

        .file-upload-area i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .file-upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(46, 125, 50, 0.1);
        }

        /* ============ INDICATEUR DE CONFORMITÉ ============ */
        .conformity-indicator {
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .conformity-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .conformity-label {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* ============ GRILLE DES ÉCARTS ============ */
        .ecart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ecart-item {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid var(--danger-color);
            transition: all 0.3s;
        }

        .ecart-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .ecart-title {
            font-weight: 600;
            color: var(--danger-color);
            margin-bottom: 5px;
        }

        .ecart-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ============ CARTE DÉTAILS AÉRODROME ============ */
        .aerodrome-detail-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border-top: 8px solid var(--primary-color);
            transition: all 0.3s;
        }

        .aerodrome-detail-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .detail-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .detail-value {
            color: var(--text-primary);
            font-size: 16px;
        }

        .risk-level-indicator {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin: 0 auto;
            position: relative;
        }

        .risk-level-indicator.high {
            background: radial-gradient(circle, #ff5252 0%, #c62828 100%);
            box-shadow: 0 4px 20px rgba(198, 40, 40, 0.3);
        }

        .risk-level-indicator.medium {
            background: radial-gradient(circle, #ffb74d 0%, #f57c00 100%);
            box-shadow: 0 4px 20px rgba(245, 124, 0, 0.3);
        }

        .risk-level-indicator.low {
            background: radial-gradient(circle, #81c784 0%, #388e3c 100%);
            box-shadow: 0 4px 20px rgba(56, 142, 60, 0.3);
        }

	/* ============ CALENDRIER AMÉLIORɉ ============ */
.calendar-view {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
}

.calendar-legend {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.calendar-event-item {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    margin-bottom: 3px;
    cursor: pointer;
    transition: all 0.2s;
}

.calendar-event-item:hover {
    transform: translateX(3px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.event-planning { background: #e3f2fd; color: #1976d2; border-left: 3px solid #1976d2; }
.event-formation { background: #f3e5f5; color: #7b1fa2; border-left: 3px solid #7b1fa2; }
.event-action { background: #fff3e0; color: #f57c00; border-left: 3px solid #f57c00; }
.event-depasse { background: #ffebee; color: #c62828; border-left: 3px solid #c62828; font-weight: bold; }

        /* ============ PERFORMANCE INDICATORS ============ */
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .performance-item {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .performance-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }

        .performance-content {
            flex: 1;
        }

        .performance-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .performance-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

	.performance-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.performance-item:hover > div:last-child {
    opacity: 1 !important;
}

.stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-hover);
}

.stat-card:hover h3 {
    animation: pulse 0.5s ease-in-out;
}

        /* ============ ALERTE CARD ============ */
        .alert-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 6px solid;
            animation: slideInRight 0.3s ease-out;
        }

        .alert-card.critical {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .alert-card.warning {
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .alert-card.info {
            border-left-color: var(--info-color);
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alert-title {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ============ FILTERS AND SORTING ============ */
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            flex: 1;
            min-width: 200px;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
        }

        /* ============ PERMISSION INDICATOR ============ */
        .permission-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .permission-admin {
            background: var(--danger-color);
            color: white;
        }

        .permission-inspecteur {
            background: var(--info-color);
            color: white;
        }
        
        /* ============ PROGRESSION DOSSIER ============ */
        .dossier-progress-container {
            margin: 20px 0;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 12px;
        }
        
        .dossier-progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .dossier-progress-title {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .dossier-progress-value {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* ============ FICHIER PREVIEW ============ */
        .file-preview-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            align-items: center;
            justify-content: center;
        }

        .file-preview-container.active {
            display: flex;
        }

        .file-preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .file-preview-content img,
        .file-preview-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .file-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ============ MODALE PERSONNALISÉE ============ */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .custom-modal.active {
            display: flex;
        }

        .custom-modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-hover);
        }

        .custom-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .custom-modal-close:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }

        /* ============ STYLES POUR LE KIT INSPECTEUR ============ */
        .kit-category {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .kit-category:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .kit-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .kit-category-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .kit-file-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .kit-files-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .kit-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--info-color);
            transition: all 0.3s;
        }

        .kit-file-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .kit-file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 15px;
        }

        .kit-file-info {
            flex: 1;
        }

        .kit-file-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .kit-file-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .kit-file-actions {
            display: flex;
            gap: 8px;
        }

        /* ============ FILTRES AVANCÉS ============ */
        .advanced-filters {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .filter-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

	  /* ============ DROPDOWN MULTIPLE STYLE ============ */
        select[multiple] {
            height: 150px;
            padding: 10px;
        }
        
        select[multiple] option {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        select[multiple] option:hover {
            background: rgba(26, 35, 126, 0.1);
        }
        
        select[multiple] option:checked {
            background: var(--gradient-primary);
            color: white;
        }
        
        /* ============ PLANNING CALENDAR ============ */
        .calendar-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav button {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calendar-nav button:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .calendar-day {
            background: white;
            padding: 15px;
            min-height: 100px;
            border: 1px solid var(--border-color);
        }
        
        .calendar-day-header {
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            padding: 10px;
            background: var(--light-bg);
        }
        
        .calendar-event {
            background: var(--gradient-info);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calendar-event:hover {
            transform: translateX(5px);
        }
        
        /* ============ PERMISSION BADGE ============ */
        .permission-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        .permission-admin {
            background: var(--danger-color);
            color: white;
        }
        
        .permission-inspecteur {
            background: var(--info-color);
            color: white;
        }
        
        .permission-service {
            background: var(--success-color);
            color: white;
        }
        
        /* ============ EMPTY STATE ============ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
            display: block;
        }
        /* ============ BADGE DE TYPE DE FICHIER ============ */
        .file-type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .file-type-pdf { background: #f44336; color: white; }
        .file-type-doc { background: #2196f3; color: white; }
        .file-type-xls { background: #4caf50; color: white; }
        .file-type-ppt { background: #ff9800; color: white; }
        .file-type-img { background: #9c27b0; color: white; }
        .file-type-zip { background: #795548; color: white; }

	  /* ============ ACTION BUTTONS ============ */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            padding: 10px 20px;
            font-size: 14px;
        }
	
	        /* ============ STYLES ALERTES TEMPS RÉEL ============ */
        .alertes-temps-reel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            animation: fadeIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .alertes-temps-reel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--warning-color), var(--accent-color));
        }
        
        .alertes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 100px;
        }
        
        .alerte-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            border-left: 5px solid;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: slideInLeft 0.3s ease-out;
        }
        
        .alerte-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .alerte-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .alerte-item:hover::after {
            transform: translateX(100%);
        }
        
        .alerte-urgence-haute { 
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.05) 0%, rgba(255, 255, 255, 1) 100%);
        }
        
        .alerte-urgence-moyenne { 
            border-left-color: var(--warning-color);
            background: linear-gradient(135deg, rgba(245, 124, 0, 0.05) 0%, rgba(255, 255, 255, 1) 100%);
        }
        
        .alerte-urgence-basse { 
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05) 0%, rgba(255, 255, 255, 1) 100%);
        }
        
        .alerte-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .alerte-icon-urgence-haute { background: linear-gradient(135deg, var(--danger-color) 0%, #ef5350 100%); color: white; }
        .alerte-icon-urgence-moyenne { background: linear-gradient(135deg, var(--warning-color) 0%, #ffb74d 100%); color: white; }
        .alerte-icon-urgence-basse { background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%); color: white; }
        
        .alerte-content {
            flex: 1;
        }
        
        .alerte-message {
            font-weight: 600;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .alerte-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
        }
        
        .alerte-type {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .alerte-type-inspection { background: var(--info-color); color: white; }
        .alerte-type-certificat { background: var(--success-color); color: white; }
        .alerte-type-plan_action { background: var(--accent-color); color: white; }
        .alerte-type-formation { background: #7b1fa2; color: white; }
        
        .alerte-date {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .alerte-statut {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
            white-space: nowrap;
        }
        
        .alerte-statut-urgence { background: var(--danger-color); color: white; }
        .alerte-statut-avertissement { background: var(--warning-color); color: white; }
        .alerte-statut-info { background: var(--info-color); color: white; }
        .alerte-statut-ok { background: var(--success-color); color: white; }
        
        .btn-alerte-filtre {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-alerte-filtre:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .btn-alerte-filtre.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .chargement-alertes {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .chargement-alertes i {
            font-size: 32px;
            margin-bottom: 15px;
            display: block;
            opacity: 0.5;
        }
        
        .aucune-alerte {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .aucune-alerte i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            opacity: 0.3;
            color: var(--success-color);
        }
        
        /* Animation pour les nouvelles alertes */
        @keyframes pulseAlert {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .nouvelle-alerte {
            animation: pulseAlert 1s ease-in-out;
        }

.form-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #e0e0e0;
}

.file-upload-zone {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
    margin-top: 10px;
}

.file-upload-zone:hover {
    border-color: var(--primary-color);
    background: #f5f5f5;
}

.file-upload-zone i {
    font-size: 36px;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.file-list-container {
    margin-top: 15px;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    margin-bottom: 8px;
}

.file-item-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-item-actions button {
    background: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
}

.taux-indicator {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
}

.taux-0 { background: #f44336; color: white; }
.taux-25 { background: #ff9800; color: white; }
.taux-75 { background: #2196f3; color: white; }
.taux-100 { background: #4caf50; color: white; }

/* ============================================
   GRILLE UNIVERSELLE OPTIMISÉE (PLEINE LARGEUR)
   ============================================ */
#aerodromesList,
#surveillanceList,
#trainingsList,
#plansActionsList,
#inspectorsList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(calc(50% - 20px), 1fr));
    gap: 25px;
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
    align-items: start;
}

/* INSPECTIONS/PLANNING : Grille adaptée avec groupes dépliables */
#inspectionsList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(calc(50% - 20px), 1fr));
    gap: 25px;
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
    align-items: start;
}

/* HOMOLOGATIONS : Conteneur flexible pour gérer sa propre grille */
#homologationsList {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
}

/* MODIFICATION IMPORTANTE : Certifications utilise flexbox pour le wrapper */
#certificationsList {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
}

/* Grille interne pour les cartes d'homologation (gérée dans le JS) */
.homolog-grid-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    width: 100%;
}

/* Forcer les en-têtes de section et de statistiques à prendre TOUTE la largeur */
#homologationsList > div[style*="background"],
#inspectionsList > div[style*="background"],
#inspectorsList > div[style*="background"],
#certificationsList > div:first-child,
.service-group-header,
.aero-group-card-full,
.pagination-container,
.aerodrome-group-container {
    width: 100%;
    grid-column: 1 / -1 !important;
}

/* ============================================
   ANIMATIONS POUR LES GROUPES DÉPLIABLES
   ============================================ */

/* Animation pour les groupes d'homologation */
.homolog-group-content {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.homolog-group-content.collapsed {
    max-height: 0;
    opacity: 0;
}

.homolog-group-content.expanded {
    max-height: 10000px;
    opacity: 1;
}

/* Animation pour les groupes de planning */
.planning-group-content {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.planning-group-content.collapsed {
    max-height: 0;
    opacity: 0;
}

.planning-group-content.expanded {
    max-height: 10000px;
    opacity: 1;
}

/* Animation de rotation pour les icônes chevron */
.aero-group-header i {
    transition: transform 0.3s ease-in-out;
}

/* Hover effect pour les en-têtes de groupe */
.aero-group-header:hover {
    background: #0284c7 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
}

/* ============================================
   ADAPTATION DES POLICES (TYPOGRAPHIE)
   ============================================ */
body {
    font-size: 14px;
}

h3 { font-size: 1.4rem; font-weight: 700; }
h4 { font-size: 1.1rem; font-weight: 600; }
h5 { font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

.inspector-name, .aero-name {
    font-size: 16px;
    font-weight: 700;
}

.inspector-specialty, .aero-code {
    font-size: 13px;
    opacity: 0.8;
}

.card-detail-text {
    font-size: 12px;
    color: #666;
}

/* ============================================
   RESPONSIVE TABLETTES & MOBILES
   ============================================ */
@media (max-width: 1200px) {
    #aerodromesList,
    #surveillanceList,
    #trainingsList,
    #inspectionsList,
    #plansActionsList,
    #inspectorsList {
        grid-template-columns: 1fr;
    }
    
    .homolog-grid-container {
        grid-template-columns: 1fr !important;
    }
    
    #certificationsList .cert-grid-container {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 768px) {
    /* Adapter la grille interne des missions en planning */
    .planning-group-content > div {
        grid-template-columns: 1fr !important;
    }
}

/* ============================================
   COMPOSANTS RÉUTILISABLES AMÉLIORÉS
   ============================================ */
.aerodrome-group-container,
.inspector-card,
.aero-group-card,
.inspector-planning-card,
.aerodrome-planaction-card {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    background: white;
    border-radius: 12px;
    border: 1px solid #e0e6ed;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.aerodrome-group-container:hover,
.inspector-card:hover,
.aero-group-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

/* Cartes de détail de planning */
.planning-detail-card {
    transition: all 0.3s ease-in-out;
}

.planning-detail-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.15) !important;
    border-left-width: 6px !important;
}

.card-internal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

/* ============================================
   STATUTS ET BADGES (Taille adaptée)
   ============================================ */
.status-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
}

.status-active {
    background: #dbeafe;
    color: #0369a1;
    border: 1px solid #7dd3fc;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.action-buttons .btn {
    padding: 8px 12px;
    font-size: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all 0.3s;
}

.action-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* ============================================
   EMPTY STATES
   ============================================ */
.empty-state {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    background: #f8f9fa;
    border-radius: 15px;
    border: 2px dashed #dee2e6;
}

.empty-state i {
    font-size: 64px;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #64748b;
    margin-bottom: 10px;
}

.empty-state p {
    color: #94a3b8;
}

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes progressFill {
    from { width: 0%; }
}

.phase-progress-fill {
    animation: progressFill 1s ease-in-out;
}

@keyframes fadeIn {
    from { 
        opacity: 0;
        transform: translateY(10px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.planning-detail-card,
.homolog-group-content,
.planning-group-content {
    animation: fadeIn 0.3s ease-in-out;
}

/* ============================================
   BADGES ET LABELS
   ============================================ */
.badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
}

/* ============================================
   BOUTONS
   ============================================ */
.btn {
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
}

.btn-secondary {
    background: #64748b;
    color: white;
}

.btn-info {
    background: #0284c7;
    color: white;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-success {
    background: #10b981;
    color: white;
}

/* ============================================
   TRANSITIONS GLOBALES
   ============================================ */
* {
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
}

/* ============================================
   ANIMATIONS POUR LES GROUPES DE PLANS D'ACTION
   ============================================ */

/* Animation pour les groupes de plans d'action */
.planaction-group-content {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.planaction-group-content.collapsed {
    max-height: 0;
    opacity: 0;
}

.planaction-group-content.expanded {
    max-height: 15000px;
    opacity: 1;
}

/* Hover effect pour les cartes de plan d'action */
#plansActionsList .planning-detail-card,
#plansActionsList > div > div > div > div > div[style*="border-left: 5px solid"] {
    transition: all 0.3s ease-in-out;
}

#plansActionsList > div > div > div > div > div[style*="border-left: 5px solid"]:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15) !important;
    border-left-width: 8px !important;
}

/* Scrollbar personnalisée pour la liste des actions */
.planaction-group-content > div > div div[style*="overflow-y: auto"]::-webkit-scrollbar {
    width: 6px;
}

.planaction-group-content > div > div div[style*="overflow-y: auto"]::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.planaction-group-content > div > div div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.planaction-group-content > div > div div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Animation de pulsation pour les badges "RETARD" */
@keyframes pulse-red {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

span[style*="RETARD"] {
    animation: pulse-red 2s ease-in-out infinite;
}

/* Animation pour les barres de progression */
@keyframes fillProgress {
    from {
        width: 0%;
    }
}

.planaction-group-content div[style*="transition: width 0.8s ease"] {
    animation: fillProgress 1.2s ease-out;
}

/* Responsive pour les cartes de plans d'action */
@media (max-width: 1400px) {
    .planaction-group-content > div {
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)) !important;
    }
}

@media (max-width: 768px) {
    .planaction-group-content > div {
        grid-template-columns: 1fr !important;
    }
}

/* Style pour les boutons dans les cartes */
#plansActionsList button {
    transition: all 0.3s ease;
}

#plansActionsList button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

#plansActionsList button:active {
    transform: translateY(0);
}

/* Badge de risque avec effet de brillance */
span[style*="CRITIQUE"],
span[style*="ÉLEVÉ"],
span[style*="MOYEN"] {
    position: relative;
    overflow: hidden;
}

span[style*="CRITIQUE"]::after,
span[style*="ÉLEVÉ"]::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shine 3s ease-in-out infinite;
}

@keyframes shine {
    0%, 100% {
        left: -100%;
    }
    50% {
        left: 100%;
    }
}

/* Amélioration visuelle des actions correctives */
.planaction-group-content div[style*="background: #f0fdf4"],
.planaction-group-content div[style*="background: #fef3c7"] {
    transition: all 0.2s ease;
}

.planaction-group-content div[style*="background: #f0fdf4"]:hover,
.planaction-group-content div[style*="background: #fef3c7"]:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Animation d'entrée pour les cartes */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.planaction-group-content > div > div > div {
    animation: slideInUp 0.4s ease-out;
}

.planaction-group-content > div > div > div:nth-child(1) { animation-delay: 0.05s; }
.planaction-group-content > div > div > div:nth-child(2) { animation-delay: 0.1s; }
.planaction-group-content > div > div > div:nth-child(3) { animation-delay: 0.15s; }
.planaction-group-content > div > div > div:nth-child(4) { animation-delay: 0.2s; }

/* ============ NOUVEAUX STYLES POUR PLANNING ============ */

/* Badge étoilé chef de mission */
.badge-star {
    background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.7em;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.3);
}

/* Bordure bleu aviation */
.border-bleu-aviation {
    border-left: 5px solid #0284c7 !important;
    position: relative;
}

.border-bleu-aviation::before {
    content: '';
    position: absolute;
    left: -5px;
    top: 0;
    height: 100%;
    width: 2px;
    background: linear-gradient(to bottom, #0284c7, #0369a1, #0284c7);
}

/* Statuts spécifiques pour planning */
.status-planifiee {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #60a5fa;
}

.status-en-retard {
    background: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fca5a5;
    animation: pulse-retard 2s infinite;
}

@keyframes pulse-retard {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Indicateur d'équipe */
.team-indicator {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.85em;
}

.team-chef {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
    border: 1px solid #fbbf24;
    color: #b45309;
}

.team-inspecteur {
    background: rgba(14, 165, 233, 0.1);
    border: 1px solid #7dd3fc;
    color: #0369a1;
}

/* Carte de planning améliorée */
.planning-card-enhanced {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
}

.planning-card-enhanced:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
}

.planning-card-enhanced::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #0284c7;
}

/* Dashboard stats planning */
.dashboard-planning-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card-planning {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
    border-left: 4px solid;
    transition: all 0.3s;
}

.stat-card-planning:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(14, 165, 233, 0.2);
}

.stat-card-planning.total { border-left-color: #0ea5e9; }
.stat-card-planning.retard { border-left-color: #ef4444; }
.stat-card-planning.execution { border-left-color: #10b981; }
.stat-card-planning.aerodromes { border-left-color: #8b5cf6; }

/* Filtres planning */
.filters-planning-container {
    background: white;
    border-left: 4px solid #0284c7;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.filters-planning-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
}

.filter-label-planning {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    font-weight: 700;
    color: #475569;
    text-transform: uppercase;
    margin-bottom: 8px;
    letter-spacing: 0.5px;
}

/* Responsive pour les cartes de planning */
@media (max-width: 1400px) {
    .planning-group-content > div {
        grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)) !important;
    }
}

@media (max-width: 768px) {
    .planning-group-content > div {
        grid-template-columns: 1fr !important;
    }
    
    .dashboard-planning-stats {
        grid-template-columns: 1fr;
    }
    
    .filters-planning-grid {
        grid-template-columns: 1fr;
    }
}

/* Animation pour les nouvelles cartes */
@keyframes slideInPlanning {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.planning-detail-card {
    animation: slideInPlanning 0.3s ease-out;
}

/* ============ CORRECTIONS MINIMALES POUR PLANS D'ACTION ============ */

#plansActionsList {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
}

/* Animation pour les groupes */
.planaction-group-content {
    transition: all 0.3s ease-in-out;
    overflow: hidden;
}

.planaction-group-content.collapsed {
    max-height: 0;
    opacity: 0;
}

.planaction-group-content.expanded {
    max-height: 10000px;
    opacity: 1;
}

/* Badges de risque (pour renderPlanCard) */
.risk-badge-critique {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
    0%, 100% {
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    50% {
        opacity: 0.9;
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
}

/* Responsive */
@media (max-width: 1200px) {
    #plansActionsList .planaction-group-content > div {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)) !important;
    }
}

@media (max-width: 768px) {
    #plansActionsList .planaction-group-content > div {
        grid-template-columns: 1fr !important;
    }
}

/* Styles spécifiques aux registres */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-en-cours {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
}

.status-expire {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

.status-suspendu {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.status-annule {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #cbd5e1;
}

.delai-ok {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.delai-retard {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

.delai-normal {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #cbd5e1;
}

.detail-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.detail-label {
    font-size: 12px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.detail-value {
    font-size: 14px;
    color: #1e293b;
    font-weight: 600;
}

.file-upload-area {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8fafc;
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background: #f0f9ff;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-top: 10px;
}

.file-icon {
    width: 40px;
    height: 40px;
    background: #e0e7ff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4f46e5;
}

/* Styles des groupes */
.registre-group {
    transition: all 0.3s ease;
}

.group-header {
    transition: all 0.3s ease;
}

.group-header:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.group-content table {
    width: 100%;
    border-collapse: collapse;
}

.group-content th {
    font-weight: 600;
    color: #475569;
    background: #f8fafc;
    padding: 12px 15px;
    border-bottom: 2px solid #e2e8f0;
    text-align: left;
}

.group-content td {
    padding: 12px 15px;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.group-content tr:hover {
    background: #f8fafc;
}

/* Styles de pagination */
.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.page-btn {
    padding: 8px 16px;
    border: 1px solid #cbd5e1;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #475569;
}

.page-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.page-btn:hover:not(.active) {
    background: #f1f5f9;
}

/* Animation pour le dépliage */
.group-content {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Styles spécifiques aux dossiers */
.dossier-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.dossier-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-nouveau {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
}

.status-en-cours {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.status-en-attente {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #cbd5e1;
}

.status-termine {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.status-archive {
    background: #f5f3ff;
    color: #5b21b6;
    border: 1px solid #c4b5fd;
}

.priority-badge {
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-normal {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
}

.priority-high {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.priority-urgent {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* Styles pour les barres de progression */
.progress-fill {
    transition: width 0.5s ease-in-out;
}

/* Animation pour les cartes */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.dossier-card {
    animation: fadeIn 0.3s ease-out;
}

/* Styles pour le tableau de bord */
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e0e6ed;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.stat-content h3 {
    margin: 0;
    font-weight: 700;
}

.stat-content p {
    margin: 5px 0 0 0;
}

/* Styles pour les cartes d'inspecteurs */
.inspector-card {
    transition: all 0.3s ease;
}

.inspector-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

/* Styles pour le calendrier */
.calendar-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

/* Styles pour les événements du calendrier */
.calendar-event-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

.calendar-event-item:hover {
    opacity: 0.9;
    transform: translateX(2px);
}

.event-planning {
    border-left-color: #7b1fa2 !important;
}

.event-action {
    border-left-color: #f57c00 !important;
}

.event-formation {
    border-left-color: #2196f3 !important;
}

.event-depasse {
    border-left-color: #d32f2f !important;
}

/* Styles responsives */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .stat-card {
        padding: 15px;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
    
    .stat-content h3 {
        font-size: 22px;
    }
}

/* Styles pour le tableau de bord de kit inspecteur */
/* Styles pour le tableau de bord */
.dashboard-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    margin-bottom: 30px;
    width: 100%;
    box-sizing: border-box;
}

.dashboard-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    width: 100%;
}

.dashboard-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
    min-width: 0;
}

.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
}

.dashboard-icon {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.dashboard-content {
    flex: 1;
    min-width: 0;
}

.dashboard-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.dashboard-label {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Styles pour les catégories */
.kit-category {
    margin-bottom: 25px;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    width: 100%;
    box-sizing: border-box;
}

.kit-category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 25px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.kit-category-header:hover {
    opacity: 0.95;
}

.kit-category-title {
    font-size: 17px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    flex-wrap: wrap;
}

.kit-file-count {
    background: rgba(255, 255, 255, 0.25);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 13px;
    margin-left: 10px;
    color: white;
    font-weight: 500;
}

.kit-category-actions {
    font-size: 14px;
    color: white;
    opacity: 0.9;
}

/* Styles pour la grille de documents - 3 cartes par ligne */
.kit-files-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    padding: 25px;
    width: 100%;
    box-sizing: border-box;
}

.kit-file-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    border-left: 4px solid #1e40af;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    height: 340px;
    min-height: 340px;
}

.kit-file-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color);
}

.kit-file-card-header {
    padding: 15px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.kit-file-icon-large {
    width: 50px;
    height: 50px;
    background: #f8fafc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
}

.kit-file-card-body {
    padding: 15px;
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.kit-file-name {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 10px;
    line-height: 1.4;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    min-height: 42px;
}

.kit-file-description {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.5;
    margin-bottom: 15px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    flex-shrink: 0;
}

.kit-file-meta {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    flex-shrink: 0;
}

.file-type-badge {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.file-type-pdf {
    background: #fee;
    color: #dc2626;
}

.file-type-doc {
    background: #e8f4ff;
    color: #2563eb;
}

.file-type-xls {
    background: #f0f9f0;
    color: #059669;
}

.file-type-ppt {
    background: #fef7e6;
    color: #d97706;
}

.file-type-img {
    background: #f5f0ff;
    color: #8b5cf6;
}

.file-type-zip {
    background: #f3f4f6;
    color: #4b5563;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
}

.status-active {
    background: #d1fae5;
    color: #065f46;
}

.status-closed {
    background: #fee2e2;
    color: #991b1b;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.kit-file-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
    flex-shrink: 0;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
}

.detail-item i {
    width: 14px;
    text-align: center;
    color: #9ca3af;
}

.kit-file-specialties {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid #f3f4f6;
    flex-shrink: 0;
}

.specialty-tag {
    background: #e0f2fe;
    color: #0369a1;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    white-space: nowrap;
}

.kit-file-card-footer {
    padding: 15px;
    border-top: 1px solid #f3f4f6;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.btn-sm {
    padding: 7px 12px;
    font-size: 13px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    flex: 1;
}

/* Styles pour le dropdown */
.dropdown {
    position: relative;
}

.dropdown-toggle {
    padding: 6px;
    border-radius: 6px;
    color: #6b7280;
}

.dropdown-toggle:hover {
    background: #f3f4f6;
    color: #374151;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 160px;
    z-index: 1000;
    display: none;
    border: 1px solid #e5e7eb;
}

.dropdown:hover .dropdown-menu {
    display: block;
}

.dropdown-menu a {
    display: block;
    padding: 10px 14px;
    color: #374151;
    text-decoration: none;
    transition: all 0.2s;
    font-size: 13px;
    border-bottom: 1px solid #f3f4f6;
}

.dropdown-menu a:last-child {
    border-bottom: none;
}

.dropdown-menu a:hover {
    background: #f9fafb;
    color: var(--primary-color);
}

.dropdown-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 4px 0;
}

/* Styles pour les modales */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 25px;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-sizing: border-box;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: #6b7280;
    padding: 5px;
    line-height: 1;
}

.close-modal:hover {
    color: #374151;
}

/* Styles pour les formulaires */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.file-upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 10px;
    padding: 30px 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f9fafb;
    box-sizing: border-box;
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background: #eff6ff;
}

.file-upload-area i {
    font-size: 40px;
    color: #9ca3af;
    margin-bottom: 12px;
}

.file-upload-area h4 {
    margin: 0 0 8px 0;
    color: #374151;
    font-size: 16px;
}

.file-upload-area p {
    margin: 0 0 8px 0;
    color: #6b7280;
    font-size: 14px;
}

.file-upload-area small {
    color: #9ca3af;
    font-size: 12px;
}

.file-list {
    margin-top: 12px;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    margin-top: 8px;
    box-sizing: border-box;
}

.file-icon {
    width: 36px;
    height: 36px;
    background: #e5e7eb;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    flex-shrink: 0;
}

/* Styles pour les boutons */
.btn {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.btn-primary {
    background: var(--primary-color, #1e40af);
    color: white;
}

.btn-primary:hover {
    background: #1e3a8a;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-info {
    background: #0ea5e9;
    color: white;
}

.btn-info:hover {
    background: #0284c7;
}

/* États vides */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin: 20px 0;
}

.empty-state i {
    font-size: 60px;
    color: #d1d5db;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #374151;
    margin-bottom: 10px;
    font-size: 18px;
}

.empty-state p {
    color: #6b7280;
    font-size: 14px;
}

/* Responsive */
@media (max-width: 1200px) {
    .kit-files-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 20px;
    }
    
    .dashboard-row {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
}

@media (max-width: 768px) {
    .kit-files-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 15px;
    }
    
    .dashboard-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .kit-file-card {
        height: auto;
        min-height: auto;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        padding: 20px;
        margin: 10px;
    }
    
    .kit-file-name {
        min-height: auto;
        -webkit-line-clamp: 2;
    }
}

@media (max-width: 480px) {
    .dashboard-row {
        grid-template-columns: 1fr;
    }
    
    .kit-file-card-footer {
        flex-direction: row;
    }
    
    .btn-sm {
        padding: 6px 10px;
        font-size: 12px;
    }
    
    .kit-category-header {
        padding: 15px;
    }
    
    .kit-category-title {
        font-size: 15px;
    }
}

/* Styles pour le tableau de bord Evènement */
.dashboard-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
    margin-bottom: 30px;
    width: 100%;
    box-sizing: border-box;
}

.dashboard-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    width: 100%;
}

.dashboard-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
    min-width: 0;
}

.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
}

.dashboard-icon {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.dashboard-content {
    flex: 1;
    min-width: 0;
}

.dashboard-value {
    font-size: 24px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.dashboard-label {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Styles pour les cartes d'événements */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    width: 100%;
    box-sizing: border-box;
}

.event-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    border-left: 4px solid #1e40af;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    height: 320px;
    min-height: 320px;
}

.event-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.event-header {
    padding: 15px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0;
}

.event-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 8px;
}

.event-aerodrome {
    background: #e0f2fe;
    color: #0369a1;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
}

.event-date {
    font-size: 12px;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 5px;
}

.event-body {
    padding: 15px;
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.event-meta {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.badge-critical, .badge-major, .badge-minor, .status-pending, .status-active, .status-completed, .status-investigation, .badge-files {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge-critical {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.badge-major {
    background: #fef3c7;
    color: #d97706;
    border: 1px solid #fde68a;
}

.badge-minor {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.status-pending {
    background: #f0f9ff;
    color: #0369a1;
    border: 1px solid #bae6fd;
}

.status-active {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #bbf7d0;
}

.status-completed {
    background: #f5f5f5;
    color: #525252;
    border: 1px solid #e5e5e5;
}

.status-investigation {
    background: #faf5ff;
    color: #7c3aed;
    border: 1px solid #e9d5ff;
}

.badge-files {
    background: #f8fafc;
    color: #475569;
    border: 1px solid #e2e8f0;
}

.event-description {
    font-size: 13px;
    color: #6b7280;
    line-height: 1.5;
    margin-bottom: 15px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    flex-shrink: 0;
}

.event-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
    flex-shrink: 0;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #6b7280;
}

.detail-item i {
    width: 14px;
    text-align: center;
    color: #9ca3af;
}

.event-actions {
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid #f3f4f6;
    flex-shrink: 0;
}

.event-actions-label {
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.event-actions-content {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.4;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.event-footer {
    padding: 15px;
    border-top: 1px solid #f3f4f6;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

/* Styles pour le dropdown des fichiers */
.dropdown {
    position: relative;
}

.dropdown-toggle {
    position: relative;
    padding-right: 25px;
}

.dropdown-toggle::after {
    content: '▾';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 200px;
    z-index: 1000;
    display: none;
    border: 1px solid #e5e7eb;
    margin-top: 5px;
}

.dropdown:hover .dropdown-menu {
    display: block;
}

.dropdown-menu a {
    display: block;
    padding: 10px 14px;
    color: #374151;
    text-decoration: none;
    transition: all 0.2s;
    font-size: 13px;
    border-bottom: 1px solid #f3f4f6;
}

.dropdown-menu a:last-child {
    border-bottom: none;
}

.dropdown-menu a:hover {
    background: #f9fafb;
    color: var(--primary-color);
}

/* Styles pour les graphiques */
.chart-container {
    width: 100%;
    box-sizing: border-box;
}

/* Styles pour les modales */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 25px;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-sizing: border-box;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    color: #6b7280;
    padding: 5px;
    line-height: 1;
}

.close-modal:hover {
    color: #374151;
}

/* Styles pour les formulaires */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.file-upload-area {
    border: 2px dashed #d1d5db;
    border-radius: 10px;
    padding: 30px 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f9fafb;
    box-sizing: border-box;
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background: #eff6ff;
}

.file-upload-area i {
    font-size: 40px;
    color: #9ca3af;
    margin-bottom: 12px;
}

.file-upload-area h4 {
    margin: 0 0 8px 0;
    color: #374151;
    font-size: 16px;
}

.file-upload-area p {
    margin: 0 0 8px 0;
    color: #6b7280;
    font-size: 14px;
}

.file-upload-area small {
    color: #9ca3af;
    font-size: 12px;
}

.file-list {
    margin-top: 12px;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    margin-top: 8px;
    box-sizing: border-box;
}

.file-icon {
    width: 36px;
    height: 36px;
    background: #e5e7eb;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    flex-shrink: 0;
}

/* Styles pour les boutons */
.btn {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.btn-primary {
    background: var(--primary-color, #1e40af);
    color: white;
}

.btn-primary:hover {
    background: #1e3a8a;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-info {
    background: #0ea5e9;
    color: white;
}

.btn-info:hover {
    background: #0284c7;
}

/* États vides */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin: 20px 0;
}

.empty-state i {
    font-size: 60px;
    color: #d1d5db;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #374151;
    margin-bottom: 10px;
    font-size: 18px;
}

.empty-state p {
    color: #6b7280;
    font-size: 14px;
}

/* Responsive */
@media (max-width: 1200px) {
    .dashboard-row {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    
    .dashboard-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
}

@media (max-width: 768px) {
    .dashboard-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .event-card {
        height: auto;
        min-height: auto;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        padding: 20px;
        margin: 10px;
    }
    
    .event-footer {
        flex-wrap: wrap;
    }
    
    .btn-sm {
        flex: 1;
        min-width: 80px;
    }
}

@media (max-width: 480px) {
    .dashboard-row {
        grid-template-columns: 1fr;
    }
    
    .event-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .event-date {
        align-self: flex-start;
    }
}

   </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Page de connexion -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">
                <div class="logo-animation">
                    <i class="fas fa-plane-departure"></i>
                </div>
                <h2>ANACIM</h2>
                <p style="color: var(--text-secondary); font-weight: 600; margin-bottom: 4px;">
                    Système de Gestion des Aérodromes
                </p>
                <p style="font-size: 14px; color: var(--text-secondary);">
                    Département Normes et Sécurité des Aérodromes
                </p>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Identifiant ou mot de passe incorrect
            </div>

            <div class="login-success" id="loginSuccess">
                <i class="fas fa-check-circle"></i> Connexion réussie
            </div>

            <form class="login-form" id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="form-group">
                    <label>Identifiant</label>
                    <input type="text" id="loginUsername" required placeholder="Votre identifiant" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" required placeholder="Votre mot de passe" autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-sign-in-alt"></i> Se Connecter
                </button>
            </form>
        </div>
    </div>

    <!-- Application principale -->
    <div class="container" id="mainApp">
        <!-- En-tête -->
        <div class="header">
            <div class="header-left">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i> <span id="currentUser"></span> - <span id="currentRole"></span>
                    <span id="currentPermission" class="permission-badge permission-admin" style="margin-left: 10px;"></span>
                </div>
            </div>
            
            <div class="header-center">
                <h1><i class="fas fa-plane-departure"></i> Système de Gestion des Aérodromes</h1>
                <p style="font-size: 14px; opacity: 0.9;">Département Normes et Sécurité des Aérodromes - ANACIM</p>
            </div>
            
            <div class="header-right">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
        </div>

        <!-- Navigation sur 3 lignes (ajout du Kit Inspecteur) -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">
                    <i class="fas fa-chart-line"></i> Tableau de Bord
                </button>
                <button class="nav-tab" onclick="showTab('aerodromes')">
                    <i class="fas fa-plane"></i> Aérodromes
                </button>
                <button class="nav-tab" onclick="showTab('certification')">
                    <i class="fas fa-certificate"></i> Certification
                </button>
                <button class="nav-tab" onclick="showTab('homologation')">
                    <i class="fas fa-check-circle"></i> Homologation
                </button>
                <button class="nav-tab" onclick="showTab('planning')">
                    <i class="fas fa-calendar-alt"></i> Planning
                </button>
                <button class="nav-tab" onclick="showTab('surveillance')">
                    <i class="fas fa-eye"></i> Surveillance
                </button>
                <button class="nav-tab" onclick="showTab('plans-actions')">
                    <i class="fas fa-clipboard-list"></i> Plans d'Actions
                </button>
                <button class="nav-tab" onclick="showTab('registres')">
                    <i class="fas fa-book"></i> Registres
                </button>
                <button class="nav-tab" onclick="showTab('dossiers')">
                    <i class="fas fa-folder"></i> Gestion des Dossiers
                </button>
                <button class="nav-tab" onclick="showTab('formation')">
                    <i class="fas fa-graduation-cap"></i> Formation
                </button>
                <!-- NOUVEAU: Kit Inspecteur -->
                <button class="nav-tab" onclick="showTab('kit-inspecteur')">
                    <i class="fas fa-toolbox"></i> Kit Inspecteur
                </button>
                <button class="nav-tab" onclick="showTab('evenements')">
                    <i class="fas fa-exclamation-triangle"></i> Événements
                </button>
                <button class="nav-tab" onclick="showTab('utilisateurs')">
                    <i class="fas fa-users"></i> Utilisateurs
                </button>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="content">
                        <!-- Tableau de bord -->
            <div id="dashboard" class="tab-content active">
    <!-- 🆕 NOUVEAU : En-tête avec boutons -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <h2 style="color: var(--primary-color); margin: 0;">
            <i class="fas fa-chart-line"></i> Tableau de Bord
        </h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="refreshDashboard()" style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
            <button class="btn btn-info" onclick="exportDashboardData()" style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-download"></i> Exporter
            </button>
        </div>
    </div>
              
		 <!-- ============ ALERTES EN TEMPS RÉEL ============ -->
                <div class="alertes-temps-reel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary-color); margin: 0;">
                            <i class="fas fa-bell"></i> Alertes en Temps Réel
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="afficherAlertes()" style="padding: 8px 16px; font-size: 13px;">
                                <i class="fas fa-sync-alt"></i> Actualiser
                            </button>
                            <button class="btn btn-info" onclick="marquerToutesAlertesLues()" style="padding: 8px 16px; font-size: 13px;">
                                <i class="fas fa-check-double"></i> Tout marquer lu
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtres des alertes -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">Filtrer :</span>
                            <button class="btn-alerte-filtre active" onclick="filtrerAlertes('toutes')">
                                Toutes
                            </button>
                            <button class="btn-alerte-filtre" onclick="filtrerAlertes('inspection')">
                                <i class="fas fa-clipboard-check"></i> Inspections
                            </button>
                            <button class="btn-alerte-filtre" onclick="filtrerAlertes('certificat')">
                                <i class="fas fa-certificate"></i> Certificats
                            </button>
                            <button class="btn-alerte-filtre" onclick="filtrerAlertes('plan_action')">
                                <i class="fas fa-clipboard-list"></i> Plans d'action
                            </button>
                            <button class="btn-alerte-filtre" onclick="filtrerAlertes('formation')">
                                <i class="fas fa-graduation-cap"></i> Formations
                            </button>
                        </div>
                    </div>
                    
                    <div class="alertes-container" id="alertesContainer">
                        <!-- Les alertes seront ajoutées dynamiquement ici -->
                        <div class="chargement-alertes">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Chargement des alertes...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                        <i class="fas fa-info-circle"></i> Cliquez sur une alerte pour accéder aux détails
                    </div>
                </div>
                 
                <!-- Section risque et priorités -->
                <div class="dashboard-grid">
                        <div class="stat-card" 
                             onclick="viewRiskAerodromes()" 
                             style="cursor: pointer;"
                             data-tooltip="⚠️ Aérodromes nécessitant une attention immédiate">
                            <h3 id="stat-aerodromes-risque">0</h3>
                            <p>Aérodromes à Risque</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-aerodromes-risque" style="width: 0%; background: var(--danger-color);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--danger-color); font-weight: 600;">
            <i class="fas fa-exclamation-triangle"></i> Voir les détails
        </div>
    </div>
                            <div class="stat-card" 
                             onclick="viewUpcomingInspections()" 
                             style="cursor: pointer;"
                             data-tooltip="📅 Voir le calendrier des inspections planifiées">
                            <h3 id="stat-inspections-a-venir">0</h3>
                            <p>Inspections à Venir</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-inspections-a-venir" style="width: 0%; background: var(--warning-color);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--warning-color); font-weight: 600;">
            <i class="fas fa-calendar-check"></i> Voir le planning
        </div>
    </div>
                         <div class="stat-card" 
                             onclick="viewUpcomingFormations()" 
                             style="cursor: pointer;"
                             data-tooltip="🎓 Formations programmées pour les inspecteurs">
                            <h3 id="stat-formations-a-venir">0</h3>
                            <p>Formations à Venir</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-formations-a-venir" style="width: 0%; background: var(--info-color);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--info-color); font-weight: 600;">
            <i class="fas fa-graduation-cap"></i> Voir les formations
        </div>
    </div>
                            <div class="stat-card" 
                             onclick="viewDelayedDossiers()" 
                             style="cursor: pointer;"
                             data-tooltip="⏰ Dossiers ayant dépassé leur échéance">
                            <h3 id="stat-dossiers-retard">0</h3>
                            <p>Dossiers en Retard</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-dossiers-retard" style="width: 0%; background: var(--danger-color);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--danger-color); font-weight: 600;">
            <i class="fas fa-folder-open"></i> Voir les dossiers
        </div>
    </div>
</div>
	       
                <!-- Section Performances -->
                <div class="performance-grid">
    <div class="performance-item" style="cursor: pointer; transition: all 0.3s;" onclick="showTab('surveillance')">
        <div class="performance-icon" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);">
            <i class="fas fa-plane"></i>
        </div>
        <div class="performance-content">
            <div class="performance-title">Taux de Conformité Global</div>
            <div class="performance-description" id="performance-conformite-global">Calcul en cours...</div>
            <div class="progress-bar" style="margin-top: 10px;">
                <div class="progress-fill" id="progress-conformite-global" style="width: 0%"></div>
            </div>
        </div>
        <div style="color: var(--primary-color); font-size: 20px; opacity: 0; transition: opacity 0.3s;">
            <i class="fas fa-arrow-right"></i>
        </div>
    </div>
    
    <div class="performance-item" style="cursor: pointer; transition: all 0.3s;" onclick="showTab('certification')">
        <div class="performance-icon" style="background: linear-gradient(135deg, var(--success-color) 0%, #4caf50 100%);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="performance-content">
            <div class="performance-title">Certifications en Cours</div>
            <div class="performance-description" id="performance-certifications-cours">Calcul en cours...</div>
            <div class="progress-bar" style="margin-top: 10px;">
                <div class="progress-fill" id="progress-certifications-cours" style="width: 0%; background: linear-gradient(90deg, var(--success-color) 0%, #4caf50 100%);"></div>
            </div>
        </div>
        <div style="color: var(--success-color); font-size: 20px; opacity: 0; transition: opacity 0.3s;">
            <i class="fas fa-arrow-right"></i>
        </div>
    </div>
    
    <div class="performance-item" style="cursor: pointer; transition: all 0.3s;" onclick="showTab('aerodromes')">
        <div class="performance-icon" style="background: linear-gradient(135deg, var(--danger-color) 0%, #ef5350 100%);">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="performance-content">
            <div class="performance-title">Niveau de Risque Moyen</div>
            <div class="performance-description" id="performance-risque-moyen">Calcul en cours...</div>
            <div class="progress-bar" style="margin-top: 10px;">
                <div class="progress-fill" id="progress-risque-moyen" style="width: 0%; background: linear-gradient(90deg, var(--danger-color) 0%, #ef5350 100%);"></div>
            </div>
        </div>
        <div style="color: var(--danger-color); font-size: 20px; opacity: 0; transition: opacity 0.3s;">
            <i class="fas fa-arrow-right"></i>
        </div>
    </div>
    
    <div class="performance-item" style="cursor: pointer; transition: all 0.3s;" onclick="showTab('planning')">
        <div class="performance-icon" style="background: linear-gradient(135deg, var(--warning-color) 0%, #ffb74d 100%);">
            <i class="fas fa-calendar-times"></i>
        </div>
        <div class="performance-content">
            <div class="performance-title">Inspections en Retard</div>
            <div class="performance-description" id="performance-inspections-retard">Calcul en cours...</div>
            <div class="progress-bar" style="margin-top: 10px;">
                <div class="progress-fill" id="progress-inspections-retard" style="width: 0%; background: linear-gradient(90deg, var(--warning-color) 0%, #ffb74d 100%);"></div>
            </div>
        </div>
        <div style="color: var(--warning-color); font-size: 20px; opacity: 0; transition: opacity 0.3s;">
            <i class="fas fa-arrow-right"></i>
        </div>
    </div>
</div>

                <!-- Statistiques principales -->
<div class="dashboard-grid">
    <div class="stat-card" 
         onclick="showTab('aerodromes')" 
         style="cursor: pointer; transition: transform 0.3s;"
         data-tooltip="Cliquez pour voir la liste complète des aérodromes">
        <h3 id="stat-aerodromes">0</h3>
        <p>Aérodromes Enregistrés</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-aerodromes" style="width: 0%"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--primary-color); font-weight: 600;">
            <i class="fas fa-arrow-right"></i> Voir tous les aérodromes
        </div>
    </div>
    <div class="stat-card" 
         onclick="showTab('certification')" 
         style="cursor: pointer; transition: transform 0.3s;"
         data-tooltip="Voir toutes les certifications en cours et terminées">
        <h3 id="stat-certifies">0</h3>
        <p>Certifiés</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-certifies" style="width: 0%; background: linear-gradient(90deg, var(--success-color) 0%, #4caf50 100%);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--success-color); font-weight: 600;">
            <i class="fas fa-arrow-right"></i> Voir les certifications
        </div>
    </div>
     <div class="stat-card" 
         onclick="showTab('homologation')" 
         style="cursor: pointer; transition: transform 0.3s;"
         data-tooltip="Accéder aux procédures d'homologation">
        <h3 id="stat-homologues">0</h3>
        <p>Homologués</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-homologues" style="width: 0%; background: linear-gradient(90deg, var(--info-color) 0%, #29b6f6 100%);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--info-color); font-weight: 600;">
            <i class="fas fa-arrow-right"></i> Voir les homologations
        </div>
    </div>
    <div class="stat-card" 
         onclick="showTab('formation')" 
         style="cursor: pointer; transition: transform 0.3s;"
         data-tooltip="Gérer les inspecteurs et leurs formations">
        <h3 id="stat-inspecteurs">0</h3>
        <p>Inspecteurs</p>
        <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill" id="progress-inspecteurs" style="width: 0%; background: linear-gradient(90deg, var(--accent-color) 0%, var(--accent-light) 100%);"></div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: var(--accent-color); font-weight: 600;">
            <i class="fas fa-arrow-right"></i> Voir les inspecteurs
        </div>
    </div>
</div>

                <!-- Section Niveaux de Risque -->
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                        <i class="fas fa-radiation"></i> Niveaux de Risque des Aérodromes
                    </h3>
                    
                    <div class="dashboard-grid" id="risk-levels-container"></div>
                </div>

                <!-- Section Performances des Inspecteurs -->
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                        <i class="fas fa-users-cog"></i> Performances des Inspecteurs
                    </h3>
                    
                    <div class="dashboard-grid" id="inspectors-performance-container"></div>
                </div>

                <!-- Section Performances des Services -->
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                        <i class="fas fa-building"></i> Performances des Services
                    </h3>
                    
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">
                        <!-- Service Normes -->
                        <div class="stat-card" style="cursor: pointer;" onclick="viewServiceDetails('normes')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">Service Normes d'Aérodromes</div>
                                    <h3 id="stat-normes-dossiers" style="color: var(--info-color); margin: 0;">0</h3>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Dossiers ce mois</div>
                                </div>
                                <div style="font-size: 48px; color: var(--info-color); opacity: 0.3;">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                                <div>
                                    <strong>Certifications:</strong> <span id="stat-normes-certifs">0</span>
                                </div>
                                <div>
                                    <strong>Homologations:</strong> <span id="stat-normes-homologs">0</span>
                                </div>
                                <div>
                                    <strong>Inspections:</strong> <span id="stat-normes-inspections">0</span>
                                </div>
                                <div>
                                    <strong>Taux conformité:</strong> <span id="stat-normes-conformite">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Service Sécurité -->
                        <div class="stat-card" style="cursor: pointer;" onclick="viewServiceDetails('securite')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">Service Sécurité des Aérodromes</div>
                                    <h3 id="stat-securite-dossiers" style="color: var(--danger-color); margin: 0;">0</h3>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Dossiers ce mois</div>
                                </div>
                                <div style="font-size: 48px; color: var(--danger-color); opacity: 0.3;">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                                <div>
                                    <strong>Événements:</strong> <span id="stat-securite-events">0</span>
                                </div>
                                <div>
                                    <strong>Audits:</strong> <span id="stat-securite-audits">0</span>
                                </div>
                                <div>
                                    <strong>Plans d'action:</strong> <span id="stat-securite-plans">0</span>
                                </div>
                                <div>
                                    <strong>Taux résolution:</strong> <span id="stat-securite-resolution">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Tendances des 30 derniers jours -->
                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                        <i class="fas fa-chart-line"></i> Tendances des 30 derniers jours
                    </h3>
                    
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <div class="stat-card" style="cursor: pointer;" onclick="showTab('certification')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">Nouvelles Certifications</div>
                                    <h3 id="trend-certifications" style="color: var(--success-color); margin: 0;">0</h3>
                                </div>
                                <div style="font-size: 32px; color: var(--success-color); opacity: 0.3;">
                                    <i class="fas fa-certificate"></i>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--success-color); font-weight: 600;">
                                <i class="fas fa-arrow-up"></i> <span id="trend-cert-percent">0%</span> vs mois dernier
                            </div>
                        </div>
                        
                        <div class="stat-card" style="cursor: pointer;" onclick="showTab('planning')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">Inspections Réalisées</div>
                                    <h3 id="trend-inspections" style="color: var(--info-color); margin: 0;">0</h3>
                                </div>
                                <div style="font-size: 32px; color: var(--info-color); opacity: 0.3;">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--info-color); font-weight: 600;">
                                <i class="fas fa-arrow-up"></i> <span id="trend-insp-percent">0%</span> vs mois dernier
                            </div>
                        </div>
                        
                        <div class="stat-card" style="cursor: pointer;" onclick="showTab('evenements')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">Événements Signalés</div>
                                    <h3 id="trend-evenements" style="color: var(--warning-color); margin: 0;">0</h3>
                                </div>
                                <div style="font-size: 32px; color: var(--warning-color); opacity: 0.3;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--warning-color); font-weight: 600;">
                                <i class="fas fa-arrow-down"></i> <span id="trend-event-percent">0%</span> vs mois dernier
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- ← FIN du Tableau de Bord -->


            <!-- Onglet Aérodromes -->
<div id="aerodromes" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-plane"></i> Gestion des Aérodromes
        </h2>
        <div>
            <button class="btn btn-primary" onclick="openNewAerodromeModal()" id="btnNewAerodrome" style="margin-right: 10px;">
                <i class="fas fa-plus"></i> Nouvel Aérodrome
            </button>
            <button class="btn btn-info" onclick="showAllAerodromeDetails()">
                <i class="fas fa-search"></i> Voir Tous les Détails
            </button>
        </div>
    </div>

    <div class="search-box">
        <input type="text" id="searchAerodrome" placeholder="Rechercher un aérodrome..." oninput="searchAerodromes()">
        <i class="fas fa-search"></i>
    </div>

    <!-- Sélecteur pour afficher les détails -->
    <div class="form-group" style="margin-bottom: 30px;">
        <label>Sélectionner un aérodrome pour voir les détails complets</label>
        <div style="display: flex; gap: 10px;">
            <select id="selectAerodromeDetails" class="form-group" style="flex: 1; padding: 12px;" onchange="showAerodromeDetails(this.value)">
                <option value="">Sélectionner un aérodrome...</option>
            </select>
        </div>
    </div>

    <!-- Section détails (cachée par défaut) -->
    <div id="aerodromeDetailsSection" style="display: none;">
        <!-- Les détails seront insérés ici dynamiquement -->
    </div>

    <!-- Liste des aérodromes -->
    <div id="aerodromesList" class="dashboard-grid"></div>
</div>

<!-- Onglet Certification -->
<div id="certification" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-certificate"></i> Processus de Certification
        </h2>
        <button class="btn btn-primary" onclick="openModal('modalCertification')" id="btnNewCertification">
            <i class="fas fa-plus"></i> Nouvelle Certification
        </button>
    </div>

    <div class="search-box">
        <input type="text" id="searchCertification" placeholder="Rechercher une certification..." oninput="searchCertifications()">
        <i class="fas fa-search"></i>
    </div>
    
    <div id="certificationsList" class="dashboard-grid"></div>
</div>

<!-- Onglet Homologation -->
<div id="homologation" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-check-circle"></i> Processus d'Homologation
        </h2>
        <button class="btn btn-primary" onclick="openModal('modalHomologation')" id="btnNewHomologation">
            <i class="fas fa-plus"></i> Nouvelle Homologation
        </button>
    </div>
    
    <div id="homologationsList" class="dashboard-grid"></div>
</div>

<!-- Onglet Planning -->
<div id="planning" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-calendar-alt"></i> Planning des Inspections
        </h2>
        <button class="btn btn-primary" onclick="initPlanningModal(); openModal('modalPlanning')" id="btnNewPlanning">
            <i class="fas fa-plus"></i> Nouveau Planning
        </button>
    </div>
        
    <!-- Calendrier des plannings -->
    <div class="calendar-view">
        <h3 style="color: var(--primary-color); margin-bottom: 20px;">
            <i class="fas fa-calendar"></i> Calendrier des Inspections
        </h3>
        
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #1976d2;"></div>
                <span>Planifié</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f57c00;"></div>
                <span>En cours</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c62828;"></div>
                <span>En retard</span>
            </div>
        </div>
        
        <div id="planningCalendar"></div>
    </div>

    <!-- Liste des inspections -->
    <div id="inspectionsList" class="dashboard-grid"></div>
</div>

<!-- Onglet Surveillance -->
<div id="surveillance" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-eye"></i> Surveillance et Inspections
        </h2>
        <button class="btn btn-primary" onclick="openModal('modalSurveillance')" id="btnNewSurveillance">
            <i class="fas fa-plus"></i> Nouvelle Inspection/Audit
        </button>
    </div>
    <div id="surveillanceList" class="dashboard-grid"></div>
</div>

<!-- Onglet Registres -->
<div id="registres" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-book"></i> Registres Officiels
        </h2>
        <div>
            <button class="btn btn-primary" onclick="openModal('modalRegistre')" id="btnNewRegistre" style="margin-right: 10px;">
                <i class="fas fa-plus"></i> Nouveau Registre
            </button>
            <button class="btn btn-success" onclick="generateReport()">
                <i class="fas fa-file-export"></i> Générer Rapport
            </button>
        </div>
    </div>
    
    <!-- Mini Tableau de Bord -->
    <div id="registresDashboard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
        <!-- Les cartes seront générées dynamiquement -->
    </div>
    
    <!-- Section Filtres -->
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1); border: 1px solid #e2e8f0;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <!-- Filtre Type -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-filter" style="color: #1e3a8a; margin-right: 5px;"></i>
                    Type de Registre
                </label>
                <select id="filterRegistreType" onchange="applyRegistreFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Tous les types</option>
                    <option value="Certification">Certification</option>
                    <option value="Homologation">Homologation</option>
                </select>
            </div>
            
            <!-- Filtre Statut -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-tasks" style="color: #0284c7; margin-right: 5px;"></i>
                    Statut
                </label>
                <select id="filterRegistreStatus" onchange="applyRegistreFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Tous les statuts</option>
                    <option value="En cours">En cours</option>
                    <option value="Expiré">Expiré</option>
                    <option value="Suspendu">Suspendu</option>
                    <option value="Annulé">Annulé</option>
                </select>
            </div>
            
            <!-- Filtre Aérodrome -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-plane-departure" style="color: #8b5cf6; margin-right: 5px;"></i>
                    Aérodrome
                </label>
                <select id="filterRegistreAerodrome" onchange="applyRegistreFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Tous les aérodromes</option>
                </select>
            </div>
            
            <!-- Filtre Période -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-calendar-alt" style="color: #059669; margin-right: 5px;"></i>
                    Période
                </label>
                <select id="filterRegistrePeriod" onchange="applyRegistreFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Toute période</option>
                    <option value="current">En cours</option>
                    <option value="past">Passés</option>
                    <option value="future">Futurs</option>
                </select>
            </div>
            
            <!-- Boutons d'action -->
            <div style="display: flex; align-items: flex-end; gap: 10px;">
                <button onclick="resetRegistreFilters()" 
                        style="background: #f1f5f9; border: 2px solid #cbd5e1; color: #475569; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-redo-alt"></i>
                    Réinitialiser
                </button>
                <button onclick="exportRegistres()" 
                        style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-download"></i>
                    Exporter
                </button>
            </div>
        </div>
    </div>
    
    <!-- Section Groupements -->
    <div id="registresGroupContainer" style="margin-bottom: 30px;">
        <!-- Les groupements seront générés ici -->
    </div>
    
    <!-- Tableau des Registres (backup) -->
    <div class="table-container" style="display: none;" id="registresTableContainer">
        <table>
            <thead>
                <tr>
                    <th onclick="sortRegistres('type')">Type de Registre <i class="fas fa-sort"></i></th>
                    <th onclick="sortRegistres('reference')">Référence <i class="fas fa-sort"></i></th>
                    <th onclick="sortRegistres('dateDebut')">Période <i class="fas fa-sort"></i></th>
                    <th onclick="sortRegistres('responsable')">Responsable <i class="fas fa-sort"></i></th>
                    <th onclick="sortRegistres('status')">Statut <i class="fas fa-sort"></i></th>
                    <th onclick="sortRegistres('delai')">Délai <i class="fas fa-sort"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="registresTable"></tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div style="color: #64748b; font-size: 14px;">
            Total: <span id="registresCount">0</span> registre(s)
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="changeRegistrePage('prev')" 
                    style="background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-chevron-left"></i> Précédent
            </button>
            <span style="padding: 8px 16px; background: #e2e8f0; border-radius: 6px; font-weight: 600;">
                Page <span id="registresCurrentPage">1</span>
            </span>
            <button onclick="changeRegistrePage('next')" 
                    style="background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                Suivant <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>


<!-- Onglet Plans d'Actions -->
<div id="plans-actions" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-clipboard-list"></i> Plans d'Actions
        </h2>
        <button class="btn btn-primary" onclick="openModal('modalPlanAction')" id="btnNewPlanAction">
            <i class="fas fa-plus"></i> Nouveau Plan
        </button>
    </div>

    <!-- Calendrier des plans d'actions -->
    <div class="calendar-view">
        <h3 style="color: var(--primary-color); margin-bottom: 20px;">
            <i class="fas fa-calendar-check"></i> Calendrier des Actions
        </h3>
        
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #4caf50;"></div>
                <span>Nouveau</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f57c00;"></div>
                <span>En cours</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #c62828;"></div>
                <span>En retard</span>
            </div>
        </div>
        
        <div id="actionsCalendar"></div>
    </div>		

    <!-- Liste des plans d'actions -->
    <div id="plansActionsList" class="dashboard-grid"></div>
</div>

<!-- Onglet Gestion des Dossiers -->
<div id="dossiers" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-folder"></i> Gestion des Dossiers
        </h2>
        <button class="btn btn-primary" onclick="openModal('modalDossier')" id="btnNewDossier">
            <i class="fas fa-plus"></i> Nouveau Dossier
        </button>
    </div>

    <!-- Mini Tableau de Bord -->
    <div id="dossiersDashboard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
        <!-- Les cartes seront générées dynamiquement -->
    </div>

    <!-- Section Filtres -->
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1); border: 1px solid #e2e8f0;">
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <!-- Filtre Type -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-filter" style="color: #1e3a8a; margin-right: 5px;"></i>
                    Type de Dossier
                </label>
                <select id="filterDossierType" onchange="applyDossierFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Tous les types</option>
                    <option value="Certification">Certification</option>
                    <option value="Homologation">Homologation</option>
                    <option value="Surveillance continue">Surveillance continue</option>
                    <option value="Evènement de sécurité">Evènement de sécurité</option>
                    <option value="Enquête">Enquête</option>
                    <option value="Administratif">Administratif</option>
                    <option value="Création aérodrome">Création aérodrome</option>
                    <option value="Plan d'actions correctives (PAC)">Plan d'actions correctives (PAC)</option>
                </select>
            </div>
            
            <!-- Filtre Statut -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-tasks" style="color: #0284c7; margin-right: 5px;"></i>
                    Statut
                </label>
                <select id="filterDossierStatus" onchange="applyDossierFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Tous les statuts</option>
                    <option value="Nouveau">Nouveau</option>
                    <option value="En cours">En cours</option>
                    <option value="En attente">En attente</option>
                    <option value="Terminé">Terminé</option>
                    <option value="Archivé">Archivé</option>
                </select>
            </div>
            
            <!-- Filtre Priorité -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-exclamation-triangle" style="color: #dc2626; margin-right: 5px;"></i>
                    Priorité
                </label>
                <select id="filterDossierPriority" onchange="applyDossierFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Toutes priorités</option>
                    <option value="Normale">Normale</option>
                    <option value="Haute">Haute</option>
                    <option value="Urgente">Urgente</option>
                </select>
            </div>
            
            <!-- Filtre Service -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 8px;">
                    <i class="fas fa-building" style="color: #059669; margin-right: 5px;"></i>
                    Service
                </label>
                <select id="filterDossierService" onchange="applyDossierFilters()" 
                        style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #1e293b; background: white; cursor: pointer;">
                    <option value="">Tous services</option>
                    <option value="Service Normes d'Aérodromes">Service Normes d'Aérodromes</option>
                    <option value="Service Sécurité des Aérodromes">Service Sécurité des Aérodromes</option>
                </select>
            </div>
            
            <!-- Boutons d'action -->
            <div style="display: flex; align-items: flex-end; gap: 10px;">
                <button onclick="resetDossierFilters()" 
                        style="background: #f1f5f9; border: 2px solid #cbd5e1; color: #475569; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-redo-alt"></i>
                    Réinitialiser
                </button>
                <button onclick="exportDossiers()" 
                        style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-download"></i>
                    Exporter
                </button>
            </div>
        </div>
        
        <!-- Filtre avancé : Recherche -->
        <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
            <div style="flex: 1; position: relative;">
                <input type="text" id="searchDossier" onkeyup="applyDossierFilters()" 
                       placeholder="Rechercher un dossier par référence ou description..." 
                       style="width: 100%; padding: 10px 12px 10px 40px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
            </div>
            <div style="display: flex; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" id="filterDelayed" onchange="applyDossierFilters()" style="cursor: pointer;">
                    <span style="font-size: 13px; color: #475569;">Afficher seulement les dossiers en retard</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Barre de progression globale -->
    <div class="dossier-progress-container" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1); border: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">
                <i class="fas fa-chart-line" style="color: #1e3a8a; margin-right: 8px;"></i>
                Progression Globale des Dossiers
            </div>
            <div style="font-size: 24px; font-weight: 800; color: #1e3a8a;" id="dossier-global-progress">0%</div>
        </div>
        <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
            <div class="progress-fill" id="dossier-global-progress-bar" style="width: 0%; background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%); height: 100%;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 13px; color: #475569;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 12px; height: 12px; background: #059669; border-radius: 50%;"></div>
                <span>Terminés: <strong id="dossier-completed">0</strong></span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 12px; height: 12px; background: #0284c7; border-radius: 50%;"></div>
                <span>En cours: <strong id="dossier-in-progress">0</strong></span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 12px; height: 12px; background: #dc2626; border-radius: 50%;"></div>
                <span>En retard: <strong id="dossier-delayed">0</strong></span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                <span>Nouveaux: <strong id="dossier-new">0</strong></span>
            </div>
        </div>
    </div>

    <!-- Liste des dossiers -->
    <div id="dossiersList" class="dashboard-grid" style="grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;"></div>

    <!-- Pagination -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
        <div style="color: #64748b; font-size: 14px;">
            Total: <span id="dossiersCount">0</span> dossier(s)
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="changeDossierPage('prev')" 
                    style="background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                <i class="fas fa-chevron-left"></i> Précédent
            </button>
            <span style="padding: 8px 16px; background: #e2e8f0; border-radius: 6px; font-weight: 600; font-size: 13px;">
                Page <span id="dossiersCurrentPage">1</span>
            </span>
            <button onclick="changeDossierPage('next')" 
                    style="background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                Suivant <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>


<!-- Onglet Formation -->
<div id="formation" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-graduation-cap"></i> Gestion des Formations
        </h2>
        <div>
            <button class="btn btn-primary" onclick="openModal('modalFormation')" id="btnNewFormation" style="margin-right: 10px;">
                <i class="fas fa-plus"></i> Nouvelle Formation
            </button>
            <button class="btn btn-success" onclick="openModal('modalInspector')" id="btnNewInspector">
                <i class="fas fa-user-plus"></i> Ajouter Inspecteur
            </button>
        </div>
    </div>

    <!-- Filtres et tri -->
    <div class="filter-container">
        <div class="form-group filter-select">
            <label>Filtrer par spécialité</label>
            <select id="filterSpecialty" onchange="filterInspectors()">
                <option value="">Toutes les spécialités</option>
                <option value="AGA/Exploitation">AGA/Exploitation</option>
                <option value="AGA/SLI-RA">AGA/SLI-RA</option>
                <option value="AGA/Génie civil">AGA/Génie civil</option>
                <option value="AGA/Génie électrique">AGA/Génie électrique</option>
                <option value="AGA/Sécurité">AGA/Sécurité</option>
                <option value="AGA/Environnement">AGA/Environnement</option>
            </select>
        </div>
        <div class="form-group filter-select">
            <label>Filtrer par statut</label>
            <select id="filterStatus" onchange="filterInspectors()">
                <option value="">Tous les statuts</option>
                <option value="Actif">Actif</option>
                <option value="En congé">En congé</option>
                <option value="En formation">En formation</option>
                <option value="Inactif">Inactif</option>
            </select>
        </div>
        <div class="sort-buttons">
            <button class="btn btn-secondary" onclick="sortInspectors('name')">
                <i class="fas fa-sort-alpha-down"></i> Trier par nom
            </button>
            <button class="btn btn-secondary" onclick="sortInspectors('date')">
                <i class="fas fa-sort-numeric-down"></i> Trier par date
            </button>
        </div>
    </div>

    <!-- Mini Tableau de Bord - Nouvelle mise en page -->
    <div class="dashboard-grid" style="margin-bottom: 30px; background: white; border-radius: 12px; padding: 20px; border: 1px solid #e0e6ed; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 4px solid #1a237e; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
        <div class="stat-card" style="flex: 1; min-width: 180px; background: transparent; box-shadow: none; border: none; padding: 15px;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <h3 id="stat-inspecteurs-actifs" style="font-size: 28px; color: #2c3e50;">0</h3>
                <p style="font-size: 16px; color: #666;">Inspecteurs Actifs</p>
            </div>
        </div>
        <div class="stat-card" style="flex: 1; min-width: 180px; background: transparent; box-shadow: none; border: none; padding: 15px;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="fas fa-umbrella-beach"></i>
            </div>
            <div class="stat-content">
                <h3 id="stat-inspecteurs-conge" style="font-size: 28px; color: #2c3e50;">0</h3>
                <p style="font-size: 16px; color: #666;">En Congé</p>
            </div>
        </div>
        <div class="stat-card" style="flex: 1; min-width: 180px; background: transparent; box-shadow: none; border: none; padding: 15px;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-content">
                <h3 id="stat-inspecteurs-formation" style="font-size: 28px; color: #2c3e50;">0</h3>
                <p style="font-size: 16px; color: #666;">En Formation</p>
            </div>
        </div>
        <div class="stat-card" style="flex: 1; min-width: 180px; background: transparent; box-shadow: none; border: none; padding: 15px;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
                <h3 id="stat-formations-par-inspecteur" style="font-size: 28px; color: #2c3e50;">0</h3>
                <p style="font-size: 16px; color: #666;">Moyenne Formations/Inspecteur</p>
            </div>
        </div>
        <div class="stat-card" style="flex: 1; min-width: 180px; background: transparent; box-shadow: none; border: none; padding: 15px;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3 id="stat-execution" style="font-size: 28px; color: #2c3e50;">0%</h3>
                <p style="font-size: 16px; color: #666;">Niveau d'Exécution</p>
            </div>
        </div>
    </div>

    <!-- Calendrier des formations - Vue Annuelle sur 2 lignes -->
    <div class="calendar-view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--primary-color); margin: 0;">
                <i class="fas fa-calendar-alt"></i> Calendrier Annuel des Formations
            </h3>
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #7b1fa2;"></div>
                    <span>Planifiée</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f57c00;"></div>
                    <span>En cours</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>Terminée</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d32f2f;"></div>
                    <span>Annulée</span>
                </div>
            </div>
        </div>
        
        <div id="formationsCalendar" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border-color);">
            <!-- Le calendrier annuel sera généré ici -->
        </div>
    </div>

    <!-- Section Inspecteurs -->
    <div style="margin-bottom: 40px;">
        <h3 style="margin-bottom: 20px; color: var(--primary-color);">
            <i class="fas fa-users"></i> Liste des Inspecteurs
        </h3>
        <div id="inspectorsList" class="dashboard-grid"></div>
    </div>

    <!-- Section Formations -->
    <div>
        <h3 style="margin-bottom: 20px; color: var(--primary-color);">
            <i class="fas fa-calendar-alt"></i> Formations Planifiées
        </h3>
        <div id="trainingsList" class="dashboard-grid"></div>
    </div>
</div>

<!-- Onglet Kit Inspecteur -->
<div id="kit-inspecteur" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-toolbox"></i> Kit Inspecteur
        </h2>
        <div>
            <button class="btn btn-primary" onclick="openModal('modalKitFile')" id="btnNewKitFile" style="margin-right: 10px;">
                <i class="fas fa-plus"></i> Ajouter un Document
            </button>
            <button class="btn btn-success" onclick="exportAllKitFiles()">
                <i class="fas fa-file-export"></i> Exporter Tout
            </button>
        </div>
    </div>

    <!-- Mini Tableau de Bord -->
    <div class="dashboard-container" style="margin-bottom: 30px;">
        <div class="dashboard-row">
            <!-- Statistiques des documents -->
            <div class="dashboard-card" style="border-left: 4px solid #1e3a8a;">
                <div class="dashboard-icon" style="background-color: #eff6ff;">
                    <i class="fas fa-file-alt" style="color: #1e3a8a;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-kit-total">0</div>
                    <div class="dashboard-label">Total Documents</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #0ea5e9;">
                <div class="dashboard-icon" style="background-color: #f0f9ff;">
                    <i class="fas fa-gavel" style="color: #0ea5e9;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-kit-reglementation">0</div>
                    <div class="dashboard-label">Règlementations</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #8b5cf6;">
                <div class="dashboard-icon" style="background-color: #f5f3ff;">
                    <i class="fas fa-list-check" style="color: #8b5cf6;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-kit-procedures">0</div>
                    <div class="dashboard-label">Procédures</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #10b981;">
                <div class="dashboard-icon" style="background-color: #ecfdf5;">
                    <i class="fas fa-book" style="color: #10b981;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-kit-guides">0</div>
                    <div class="dashboard-label">Guides</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #f59e0b;">
                <div class="dashboard-icon" style="background-color: #fffbeb;">
                    <i class="fas fa-clipboard-check" style="color: #f59e0b;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-kit-checklists">0</div>
                    <div class="dashboard-label">Check-lists</div>
                </div>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filters-row" style="border-left: 4px solid #1e40af; padding-left: 15px; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom: 15px; color: #1e40af;">
                <i class="fas fa-filter"></i> Filtres
            </h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Spécialité</label>
                    <select id="filterSpecialty" onchange="filterKitFiles()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px;">
                        <option value="">Toutes les spécialités</option>
                        <option value="AGA/Exploitation">AGA/Exploitation</option>
                        <option value="AGA/SLI-RA">AGA/SLI-RA</option>
                        <option value="AGA/Génie civil">AGA/Génie civil</option>
                        <option value="AGA/Génie électrique">AGA/Génie électrique</option>
                        <option value="AGA/Sécurité">AGA/Sécurité</option>
                        <option value="AGA/Environnement">AGA/Environnement</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Type de document</label>
                    <select id="filterCategory" onchange="filterKitFiles()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px;">
                        <option value="">Tous les types</option>
                        <option value="Reglementation">Règlementation</option>
                        <option value="Procedures">Procédures</option>
                        <option value="Guides">Guides</option>
                        <option value="Checklists">Check-lists</option>
                        <option value="Formulaires">Formulaires</option>
                        <option value="Rapports">Modèles de rapports</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Statut</label>
                    <select id="filterStatus" onchange="filterKitFiles()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px;">
                        <option value="">Tous les statuts</option>
                        <option value="Actif">Actif</option>
                        <option value="Archivé">Archivé</option>
                        <option value="En révision">En révision</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Recherche</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="searchKitFile" placeholder="Nom, mots-clés..." onkeyup="filterKitFiles()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; flex: 1; min-width: 250px;">
                        <button class="btn btn-secondary" onclick="resetKitFilters()" style="padding: 8px 12px;">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Catégories du kit inspecteur avec groupement par type -->
    <div id="kitCategoriesContainer">
        <!-- Les catégories seront chargées dynamiquement -->
    </div>
</div>

<!-- Onglet Événements -->
<div id="evenements" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-exclamation-triangle"></i> Gestion des Événements
        </h2>
        <div>
            <button class="btn btn-primary" onclick="openModal('modalEvenement')" id="btnNewEvenement" style="margin-right: 10px;">
                <i class="fas fa-plus"></i> Nouvel Événement
            </button>
            <button class="btn btn-danger" onclick="openModal('modalAlerte')" id="btnNewAlerte">
                <i class="fas fa-bell"></i> Nouvelle Alerte
            </button>
        </div>
    </div>

    <!-- Mini Tableau de Bord Événements -->
    <div class="dashboard-container" style="margin-bottom: 30px;">
        <div class="dashboard-row">
            <!-- Statistiques des événements -->
            <div class="dashboard-card" style="border-left: 4px solid #1e3a8a;">
                <div class="dashboard-icon" style="background-color: #eff6ff;">
                    <i class="fas fa-exclamation-triangle" style="color: #1e3a8a;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-evenements-total">0</div>
                    <div class="dashboard-label">Total Événements</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #dc2626;">
                <div class="dashboard-icon" style="background-color: #fef2f2;">
                    <i class="fas fa-skull-crossbones" style="color: #dc2626;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-evenements-critiques">0</div>
                    <div class="dashboard-label">Critiques</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #f59e0b;">
                <div class="dashboard-icon" style="background-color: #fffbeb;">
                    <i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-evenements-majeurs">0</div>
                    <div class="dashboard-label">Majeurs</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #10b981;">
                <div class="dashboard-icon" style="background-color: #ecfdf5;">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-evenements-ouverts">0</div>
                    <div class="dashboard-label">En cours</div>
                </div>
            </div>

            <div class="dashboard-card" style="border-left: 4px solid #8b5cf6;">
                <div class="dashboard-icon" style="background-color: #f5f3ff;">
                    <i class="fas fa-chart-line" style="color: #8b5cf6;"></i>
                </div>
                <div class="dashboard-content">
                    <div class="dashboard-value" id="stat-evenements-mois">0</div>
                    <div class="dashboard-label">Ce mois</div>
                </div>
            </div>
        </div>

        <!-- Graphique comparatif mensuel -->
        <div class="chart-container" style="border-left: 4px solid #1e40af; padding-left: 15px; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom: 15px; color: #1e40af;">
                <i class="fas fa-chart-bar"></i> Événements par mois
            </h4>
            <div id="chartEvenements" style="height: 200px; width: 100%;">
                <!-- Le graphique sera généré dynamiquement -->
                <canvas id="evenementsChart"></canvas>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filters-row" style="border-left: 4px solid #1e40af; padding-left: 15px; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom: 15px; color: #1e40af;">
                <i class="fas fa-filter"></i> Filtres
            </h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Type d'événement</label>
                    <select id="filterEventType" onchange="filterEvenements()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px;">
                        <option value="">Tous les types</option>
                        <option value="Incident">Incident</option>
                        <option value="Accident">Accident</option>
                        <option value="Non-conformité">Non-conformité</option>
                        <option value="Défaut">Défaut technique</option>
                        <option value="Météo">Événement météorologique</option>
                        <option value="Sécurité">Événement de sécurité</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Niveau de gravité</label>
                    <select id="filterEventGravite" onchange="filterEvenements()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px;">
                        <option value="">Tous les niveaux</option>
                        <option value="Mineur">Mineur</option>
                        <option value="Majeur">Majeur</option>
                        <option value="Critique">Critique</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Statut</label>
                    <select id="filterEventStatus" onchange="filterEvenements()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px;">
                        <option value="">Tous les statuts</option>
                        <option value="Signalé">Signalé</option>
                        <option value="En investigation">En investigation</option>
                        <option value="Traité">Traité</option>
                        <option value="Clôturé">Clôturé</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Recherche</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="searchEventKeyword" placeholder="Description, rapporteur..." onkeyup="filterEvenements()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; flex: 1; min-width: 250px;">
                        <button class="btn btn-secondary" onclick="resetEventFilters()" style="padding: 8px 12px;">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des événements -->
    <div id="evenementsList" class="dashboard-grid"></div>
</div>

<!-- Onglet Alertes -->
<div id="alertes" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-exclamation-triangle"></i> Alertes de Sécurité Aviation Civile
        </h2>
        <div>
            <button class="btn btn-danger" onclick="openAlerteModal()">
                <i class="fas fa-plus"></i> Nouvelle Alerte Urgente
            </button>
        </div>
    </div>

    <!-- Description de l'onglet -->
    <div class="info-card" style="background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 30px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-info-circle" style="color: #856404; font-size: 24px;"></i>
            <div>
                <h4 style="color: #856404; margin: 0 0 5px 0;">Utilisation des Alertes</h4>
                <p style="margin: 0; color: #856404;">
                    Cet onglet permet d'envoyer des alertes urgentes aux inspecteurs concernant des préoccupations graves de sécurité de l'aviation civile. 
                    Les alertes sont envoyées immédiatement par email à tous les inspecteurs concernés.
                </p>
            </div>
        </div>
    </div>

    <!-- Liste des alertes -->
    <div id="alertesList" class="alertes-grid"></div>
</div>

<!-- Onglet Utilisateurs -->
<div id="utilisateurs" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 style="color: var(--primary-color);">
            <i class="fas fa-users"></i> Gestion des Utilisateurs
        </h2>
        <button class="btn btn-primary" onclick="openModal('modalUtilisateur')" id="btnNewUtilisateur">
            <i class="fas fa-user-plus"></i> Nouvel Utilisateur
        </button>
    </div>

    <!-- Filtres et tri pour Utilisateurs -->
    <div class="advanced-filters" style="margin-bottom: 20px;">
        <h3 style="color: var(--primary-color); margin-bottom: 20px;">
            <i class="fas fa-filter"></i> Filtres de Recherche
        </h3>
        <div class="form-row">
            <div class="form-group">
                <label>Rôle</label>
                <select id="filterUserRole" onchange="filterUtilisateurs()">
                    <option value="">Tous les rôles</option>
                    <option value="admin">Administrateur</option>
                    <option value="inspecteur">Inspecteur</option>
                    <option value="service_normes">Service Normes</option>
                    <option value="service_securite">Service Sécurité</option>
                    <option value="consultant">Consultant</option>
                </select>
            </div>
            <div class="form-group">
                <label>Statut</label>
                <select id="filterUserStatus" onchange="filterUtilisateurs()">
                    <option value="">Tous les statuts</option>
                    <option value="Actif">Actif</option>
                    <option value="Inactif">Inactif</option>
                    <option value="Suspendu">Suspendu</option>
                </select>
            </div>
            <div class="form-group">
                <label>Service</label>
                <select id="filterUserService" onchange="filterUtilisateurs()">
                    <option value="">Tous les services</option>
                    <option value="Service Normes d'Aérodromes">Service Normes</option>
                    <option value="Service Sécurité des Aérodromes">Service Sécurité</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Recherche</label>
                <input type="text" id="searchUserKeyword" placeholder="Nom, prénom, identifiant..." oninput="filterUtilisateurs()">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-secondary" onclick="resetUserFilters()">
                <i class="fas fa-redo"></i> Réinitialiser
            </button>
            <button class="btn btn-info" onclick="sortUtilisateurs('nom', 'asc')">
                <i class="fas fa-sort-alpha-down"></i> Par nom
            </button>
            <button class="btn btn-info" onclick="sortUtilisateurs('date', 'desc')">
                <i class="fas fa-sort-amount-down"></i> Plus récent
            </button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th onclick="sortUtilisateurs('login')">Identifiant <i class="fas fa-sort"></i></th>
                    <th onclick="sortUtilisateurs('nom')">Nom Complet <i class="fas fa-sort"></i></th>
                    <th onclick="sortUtilisateurs('role')">Rôle <i class="fas fa-sort"></i></th>
                    <th onclick="sortUtilisateurs('service')">Service <i class="fas fa-sort"></i></th>
                    <th onclick="sortUtilisateurs('dateCreation')">Date Création <i class="fas fa-sort"></i></th>
                    <th onclick="sortUtilisateurs('status')">Statut <i class="fas fa-sort"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="utilisateursTable"></tbody>
        </table>
    </div>
</div>

    <!-- ============ MODALES ============ -->

    <!-- Modale Aérodrome -->
    <div id="modalAerodrome" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('modalAerodrome')">&times;</button>
            <h3 style="margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-plane"></i> Nouvel Aérodrome
            </h3>
            
            <form id="formAerodrome">
                <input type="hidden" id="aerodromeId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Code OACI *</label>
                        <input type="text" id="aerodromeCode" required placeholder="Ex: GOOY">
                    </div>
                    <div class="form-group">
                        <label>Nom de l'Aérodrome *</label>
                        <input type="text" id="aerodromeName" required placeholder="Ex: Aéroport International Blaise Diagne">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ville *</label>
                        <input type="text" id="aerodromeCity" required placeholder="Ex: Diass/Dakar">
                    </div>
                    <div class="form-group">
                        <label>Région</label>
                        <select id="aerodromeRegion">
                            <option value="">Sélectionner...</option>
                            <option value="Dakar">Dakar</option>
                            <option value="Thiès">Thiès</option>
                            <option value="Saint-Louis">Saint-Louis</option>
                            <option value="Ziguinchor">Ziguinchor</option>
                            <option value="Kaolack">Kaolack</option>
                            <option value="Tambacounda">Tambacounda</option>
                            <option value="Kolda">Kolda</option>
                            <option value="Matam">Matam</option>
                            <option value="Kédougou">Kédougou</option>
                            <option value="Sédhiou">Sédhiou</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Type d'Aérodrome *</label>
                        <select id="aerodromeType" required onchange="updateCertHomologState()">
                            <option value="">Sélectionner...</option>
                            <option value="International">International</option>
                            <option value="National">National</option>
                            <option value="Régional">Régional</option>
                            <option value="Piste d'atterrissage">Piste d'atterrissage</option>
                            <option value="Héliport">Héliport</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Statut *</label>
                        <select id="aerodromeStatus" required>
                            <option value="En service">En service</option>
                            <option value="Fermé">Fermé</option>
                            <option value="En construction">En construction</option>
                            <option value="En rénovation">En rénovation</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="aerodromeDescription" rows="3" placeholder="Description de l'aérodrome..."></textarea>
                </div>

                <div class="form-group">
                    <label>Coordonnées GPS</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="aerodromeLatitude" placeholder="Latitude">
                        </div>
                        <div class="form-group">
                            <input type="text" id="aerodromeLongitude" placeholder="Longitude">
                        </div>
                    </div>
                </div>

		<!-- Section Caractéristiques de la piste -->
<div class="form-group">
    <h4 style="color: var(--primary-color); margin: 20px 0 15px 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
        <i class="fas fa-road"></i> Caractéristiques de la Piste
    </h4>
    
    <div class="form-row">
        <div class="form-group">
            <label>Dimensions (mètres)</label>
            <input type="text" id="aerodromeDimensions" placeholder="Ex: 3500x45">
        </div>
        <div class="form-group">
            <label>Revêtement</label>
            <select id="aerodromeRevetement">
                <option value="">Sélectionner...</option>
                <option value="Asphalte">Asphalte</option>
                <option value="Béton">Béton</option>
                <option value="Gravier">Gravier</option>
                <option value="Terre">Terre</option>
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label>Orientation</label>
            <input type="text" id="aerodromeOrientation" placeholder="Ex: 06/24">
        </div>
        <div class="form-group">
            <label>Type d'Approche</label>
            <select id="aerodromeApproche">
                <option value="">Sélectionner...</option>
                <option value="Classique">Classique</option>
                <option value="Précision CAT I">Précision CAT I</option>
                <option value="Précision CAT II">Précision CAT II</option>
                <option value="À vue">À vue</option>
            </select>
        </div>
    </div>
</div>

<!-- Section Certification et Homologation -->
<div class="form-group">
    <h4 style="color: var(--primary-color); margin: 20px 0 15px 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
        <i class="fas fa-certificate"></i> Statut de Certification et Homologation
    </h4>
    
    <div class="form-row">
        <div class="form-group">
            <label id="certificationLabel">Statut Certification</label>
            <select id="aerodromeCertification" onchange="updateCertificationState()">
                <option value="">Sélectionner...</option>
                <option value="Certifié">Certifié</option>
                <option value="À certifier">À certifier</option>
                <option value="Non certifié">Non certifié</option>
            </select>
        </div>
        <div class="form-group">
            <label id="homologationLabel">Statut Homologation</label>
            <select id="aerodromeHomologation" onchange="updateHomologationState()">
                <option value="">Sélectionner...</option>
                <option value="Homologué">Homologué</option>
                <option value="À homologuer">À homologuer</option>
                <option value="Non homologué">Non homologué</option>
            </select>
        </div>
    </div>
</div>

<!-- Section Exploitant et Contacts -->
<div class="form-group">
    <h4 style="color: var(--primary-color); margin: 20px 0 15px 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
        <i class="fas fa-building"></i> Exploitant et Contacts
    </h4>
    
    <div class="form-group">
        <label>Nom de l'Exploitant</label>
        <input type="text" id="aerodromeExploitant" placeholder="Ex: Aéroports du Sénégal">
    </div>

    <div class="form-row">
        <div class="form-group">
            <label>Email Contact</label>
            <input type="email" id="aerodromeContactEmail" placeholder="contact@aeroport.sn">
        </div>
        <div class="form-group">
            <label>Téléphone Contact</label>
            <input type="tel" id="aerodromeContactPhone" placeholder="+221 XX XXX XX XX">
        </div>
    </div>
    
    <div class="form-group">
        <label>Adresse</label>
        <textarea id="aerodromeAdresse" rows="2" placeholder="Adresse complète de l'exploitant"></textarea>
    </div>
</div>

                <div class="form-group">
                    <label>Niveau de Risque Initial</label>
                    <select id="aerodromeRiskLevel">
                        <option value="Faible">Faible</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Élevé">Élevé</option>
                    </select>
                </div>

                <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveAerodrome()">
                    <i class="fas fa-save"></i> Enregistrer l'Aérodrome
                </button>
            </form>
        </div>
    </div>

    <!-- Modale Certification -->
    <div id="modalCertification" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('modalCertification')">&times;</button>
            <h3 style="margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-certificate"></i> <span id="certModalTitle">Nouvelle Certification</span>
            </h3>
            
            <form id="formCertification">
                <input type="hidden" id="certificationId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Aérodrome *</label>
                        <select id="certAerodrome" required onchange="loadAerodromeDetails()">
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Début *</label>
                        <input type="date" id="certDateDebut" required>
                    </div>
                </div>

                <!-- Informations de l'aérodrome -->
                <div id="aerodromeDetails" style="display: none; background: var(--light-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Code OACI:</strong>
                            <div id="detailCodeOaci"></div>
                        </div>
                        <div>
                            <strong>Ville:</strong>
                            <div id="detailVille"></div>
                        </div>
                        <div>
                            <strong>Type:</strong>
                            <div id="detailType"></div>
                        </div>
                        <div>
                            <strong>Statut Actuel:</strong>
                            <div id="detailStatut"></div>
                        </div>
                    </div>
                </div>

                <!-- Phases du processus de certification -->
                <h4 style="margin: 30px 0 20px 0; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                    <i class="fas fa-project-diagram"></i> Phases du Processus de Certification
                </h4>

                <div class="timeline">
                    <!-- Phase 1: Expression d'intérêt -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">1. Expression d'intérêt</div>
                                <select class="phase-status" id="certPhase1Status" onchange="updateCertPhaseColor(1)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date Prévisionnelle</label>
                                    <input type="date" id="certPhase1Date">
                                </div>
                                <div class="form-group">
                                    <label>Responsable</label>
                                    <input type="text" id="certPhase1Responsable" placeholder="Nom du responsable">
                                </div>
                            </div>

                            <div class="comments-section" id="certPhase1CommentsSection">
                                <div class="comment-form">
                                    <textarea id="certPhase1Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addCertComment(1)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="certPhase1CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerCertFileUpload(1)" id="certPhase1FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer les documents d'expression d'intérêt</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Formulaire d'expression d'intérêt, lettres</small>
                                <input type="file" id="certPhase1FileInput" multiple style="display: none;" onchange="handleCertFiles(this, 1)">
                            </div>
                            <div class="file-list" id="certPhase1FileList"></div>
                        </div>
                    </div>

                    <!-- Phase 2: Évaluation de la demande formelle -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">2. Évaluation de la demande formelle</div>
                                <select class="phase-status" id="certPhase2Status" onchange="updateCertPhaseColor(2)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date Prévisionnelle</label>
                                    <input type="date" id="certPhase2Date">
                                </div>
                                <div class="form-group">
                                    <label>Évaluateur</label>
                                    <input type="text" id="certPhase2Responsable" placeholder="Nom de l'évaluateur">
                                </div>
                            </div>

                            <div class="comments-section" id="certPhase2CommentsSection">
                                <div class="comment-form">
                                    <textarea id="certPhase2Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addCertComment(2)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="certPhase2CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerCertFileUpload(2)" id="certPhase2FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer le rapport d'évaluation</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Rapport d'évaluation, analyse de conformité</small>
                                <input type="file" id="certPhase2FileInput" multiple style="display: none;" onchange="handleCertFiles(this, 2)">
                            </div>
                            <div class="file-list" id="certPhase2FileList"></div>
                        </div>
                    </div>

                    <!-- Phase 3: Vérification sur site -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">3. Vérification sur site</div>
                                <select class="phase-status" id="certPhase3Status" onchange="updateCertPhaseColor(3)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de Vérification</label>
                                    <input type="date" id="certPhase3Date">
                                </div>
                                <div class="form-group">
                                    <label>Équipe de Vérification</label>
                                    <input type="text" id="certPhase3Responsable" placeholder="Noms des vérificateurs">
                                </div>
                            </div>

                            <div class="comments-section" id="certPhase3CommentsSection">
                                <div class="comment-form">
                                    <textarea id="certPhase3Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addCertComment(3)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="certPhase3CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerCertFileUpload(3)" id="certPhase3FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer les rapports de vérification</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Rapports, photos, constats de vérification</small>
                                <input type="file" id="certPhase3FileInput" multiple style="display: none;" onchange="handleCertFiles(this, 3)">
                            </div>
                            <div class="file-list" id="certPhase3FileList"></div>
                        </div>
                    </div>

                    <!-- Phase 4: Délivrance du certificat -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">4. Délivrance du certificat</div>
                                <select class="phase-status" id="certPhase4Status" onchange="updateCertPhaseColor(4)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de Délivrance</label>
                                    <input type="date" id="certPhase4Date">
                                </div>
                                <div class="form-group">
                                    <label>Signataire</label>
                                    <input type="text" id="certPhase4Responsable" placeholder="Nom du signataire">
                                </div>
                            </div>

                            <div class="comments-section" id="certPhase4CommentsSection">
                                <div class="comment-form">
                                    <textarea id="certPhase4Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addCertComment(4)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="certPhase4CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerCertFileUpload(4)" id="certPhase4FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer le certificat et documents</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Certificat, PV de délivrance</small>
                                <input type="file" id="certPhase4FileInput" multiple style="display: none;" onchange="handleCertFiles(this, 4)">
                            </div>
                            <div class="file-list" id="certPhase4FileList"></div>
                        </div>
                    </div>

                    <!-- Phase 5: Publication du statut -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">5. Publication du statut</div>
                                <select class="phase-status" id="certPhase5Status" onchange="updateCertPhaseColor(5)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de Publication</label>
                                    <input type="date" id="certPhase5Date">
                                </div>
                                <div class="form-group">
                                    <label>Responsable Publication</label>
                                    <input type="text" id="certPhase5Responsable" placeholder="Nom du responsable">
                                </div>
                            </div>

                            <div class="comments-section" id="certPhase5CommentsSection">
                                <div class="comment-form">
                                    <textarea id="certPhase5Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addCertComment(5)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="certPhase5CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerCertFileUpload(5)" id="certPhase5FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer les documents de publication</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Bulletin officiel, communication</small>
                                <input type="file" id="certPhase5FileInput" multiple style="display: none;" onchange="handleCertFiles(this, 5)">
                            </div>
                            <div class="file-list" id="certPhase5FileList"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Remarques Générales</label>
                    <textarea id="certRemarques" rows="3" placeholder="Remarques supplémentaires..."></textarea>
                </div>

                <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveCertification()">
                    <i class="fas fa-save"></i> Enregistrer la Certification
                </button>
            </form>
        </div>
    </div>

    <!-- Modale Homologation -->
    <div id="modalHomologation" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('modalHomologation')">&times;</button>
            <h3 style="margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-check-circle"></i> <span id="homologationModalTitle">Nouvelle Homologation</span>
            </h3>
            
            <form id="formHomologation">
                <input type="hidden" id="homologationId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Aérodrome *</label>
                        <select id="homologAerodrome" required>
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type d'Homologation *</label>
                        <select id="homologType" required>
                            <option value="">Sélectionner...</option>
                            <option value="Temporaire">Temporaire</option>
                            <option value="Permanente">Permanente</option>
                            <option value="Renouvellement">Renouvellement</option>
                            <option value="Modification">Modification</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date Début *</label>
                        <input type="date" id="homologDateDebut" required>
                    </div>
                    <div class="form-group">
                        <label>Date Fin</label>
                        <input type="date" id="homologDateFin">
                    </div>
                </div>

                <div class="form-group">
                    <label>Numéro d'Homologation</label>
                    <input type="text" id="homologNumero" placeholder="Ex: HOM/2024/001">
                </div>

                <div class="form-group">
                    <label>Organisme Certificateur</label>
                    <input type="text" id="homologOrganisme" placeholder="Ex: ANACIM">
                </div>

                <!-- Phases de l'homologation -->
                <h4 style="margin: 30px 0 20px 0; color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                    <i class="fas fa-list-ol"></i> Phases du Processus d'Homologation
                </h4>

                <div class="timeline">
                    <!-- Phase 1: Évaluation de la demande formelle -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">1. Évaluation de la demande formelle</div>
                                <select class="phase-status" id="homologPhase1Status" onchange="updateHomologPhaseColor(1)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date d'Évaluation</label>
                                    <input type="date" id="homologPhase1Date">
                                </div>
                                <div class="form-group">
                                    <label>Évaluateur</label>
                                    <input type="text" id="homologPhase1Responsable" placeholder="Nom de l'évaluateur">
                                </div>
                            </div>

                            <div class="comments-section" id="homologPhase1CommentsSection">
                                <div class="comment-form">
                                    <textarea id="homologPhase1Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addHomologComment(1)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="homologPhase1CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerHomologFileUpload(1)" id="homologPhase1FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer les documents d'évaluation</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Rapport d'évaluation, analyse technique</small>
                                <input type="file" id="homologPhase1FileInput" multiple style="display: none;" onchange="handleHomologFiles(this, 1)">
                            </div>
                            <div class="file-list" id="homologPhase1FileList"></div>
                        </div>
                    </div>

                    <!-- Phase 2: Vérification sur site -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">2. Vérification sur site</div>
                                <select class="phase-status" id="homologPhase2Status" onchange="updateHomologPhaseColor(2)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de Vérification</label>
                                    <input type="date" id="homologPhase2Date">
                                </div>
                                <div class="form-group">
                                    <label>Vérificateur</label>
                                    <input type="text" id="homologPhase2Responsable" placeholder="Nom du vérificateur">
                                </div>
                            </div>

                            <div class="comments-section" id="homologPhase2CommentsSection">
                                <div class="comment-form">
                                    <textarea id="homologPhase2Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addHomologComment(2)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="homologPhase2CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerHomologFileUpload(2)" id="homologPhase2FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer les rapports de vérification</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Rapports, photos, constats</small>
                                <input type="file" id="homologPhase2FileInput" multiple style="display: none;" onchange="handleHomologFiles(this, 2)">
                            </div>
                            <div class="file-list" id="homologPhase2FileList"></div>
                        </div>
                    </div>

                    <!-- Phase 3: Délivrance de la décision d'homologation -->
                    <div class="timeline-item">
                        <div class="phase-card">
                            <div class="phase-header">
                                <div class="phase-title">3. Délivrance de la décision d'homologation</div>
                                <select class="phase-status" id="homologPhase3Status" onchange="updateHomologPhaseColor(3)">
                                    <option value="pending">En attente</option>
                                    <option value="in-progress">En cours</option>
                                    <option value="completed">Terminé</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date de Décision</label>
                                    <input type="date" id="homologPhase3Date">
                                </div>
                                <div class="form-group">
                                    <label>Comité de Décision</label>
                                    <input type="text" id="homologPhase3Responsable" placeholder="Membres du comité">
                                </div>
                            </div>

                            <div class="comments-section" id="homologPhase3CommentsSection">
                                <div class="comment-form">
                                    <textarea id="homologPhase3Comment" placeholder="Ajouter un commentaire..." rows="2"></textarea>
                                    <button type="button" class="btn btn-secondary" onclick="addHomologComment(3)" style="margin-top: 10px;">
                                        <i class="fas fa-comment"></i> Ajouter Commentaire
                                    </button>
                                </div>
                                <div class="comment-list" id="homologPhase3CommentList"></div>
                            </div>

                            <div class="file-upload-area" onclick="triggerHomologFileUpload(3)" id="homologPhase3FileUpload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Déposer la décision d'homologation</h4>
                                <p>ou cliquez pour parcourir</p>
                                <small>Décision signée, PV du comité</small>
                                <input type="file" id="homologPhase3FileInput" multiple style="display: none;" onchange="handleHomologFiles(this, 3)">
                            </div>
                            <div class="file-list" id="homologPhase3FileList"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Statut *</label>
                    <select id="homologStatus" required>
                        <option value="En attente">En attente</option>
                        <option value="En cours">En cours</option>
                        <option value="Approuvée">Approuvée</option>
                        <option value="Refusée">Refusée</option>
                        <option value="Expirée">Expirée</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Remarques</label>
                    <textarea id="homologRemarques" rows="3" placeholder="Remarques supplémentaires..."></textarea>
                </div>

                <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveHomologation()">
                    <i class="fas fa-save"></i> Enregistrer l'Homologation
                </button>
            </form>
        </div>
    </div>

    <!-- Modale Planning -->
    <div id="modalPlanning" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('modalPlanning')">&times;</button>
            <h3 style="margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-calendar-alt"></i> <span id="planningModalTitle">Nouveau Planning</span>
            </h3>
            <form id="formPlanning" onsubmit="event.preventDefault(); savePlanning();">
                <input type="hidden" id="planningId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Aérodrome *</label>
                        <select id="planningAerodrome" required>
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type d'Inspection *</label>
                        <select id="planningType" required>
                            <option value="">Sélectionner...</option>
                            <option value="Programmée">Programmée</option>
                            <option value="Inopinée">Inopinée</option>
                            <option value="Spéciale">Spéciale</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date Début *</label>
                        <input type="datetime-local" id="planningDateDebut" required>
                    </div>
                    <div class="form-group">
                        <label>Date Fin *</label>
                        <input type="datetime-local" id="planningDateFin" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Équipe d'Inspection *</label>
                        <select id="planningEquipe" multiple style="height: 150px;" required>
                            <!-- Les inspecteurs seront chargés dynamiquement -->
                        </select>
                        <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                            Maintenez Ctrl (Cmd sur Mac) pour sélectionner plusieurs inspecteurs
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Chef d'Équipe *</label>
                        <select id="planningChef" required>
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Objectifs de l'Inspection</label>
                    <textarea id="planningObjectifs" rows="3" placeholder="Objectifs spécifiques de l'inspection..."></textarea>
                </div>
                <div class="form-group">
                    <label>Statut *</label>
                    <select id="planningStatus" required>
                        <option value="Planifié">Planifié</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminé">Terminé</option>
                        <option value="Reporté">Reporté</option>
                        <option value="Annulé">Annulé</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;">
                    <i class="fas fa-save"></i> Enregistrer le Planning
                </button>
            </form>
        </div>
    </div>

    <!-- Modale Surveillance -->
    <div id="modalSurveillance" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('modalSurveillance')">&times;</button>
            <h3 style="margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-eye"></i> <span id="surveillanceModalTitle">Nouvelle Inspection/Audit</span>
            </h3>
            
            <form id="formSurveillance">
                <input type="hidden" id="surveillanceId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Aérodrome *</label>
                        <select id="surveillanceAerodrome" required onchange="updateAerodromeInfo()">
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type d'Inspection/Audit *</label>
                        <select id="surveillanceType" required>
                            <option value="">Sélectionner...</option>
                            <option value="Suivi mise en œuvre PAC">Suivi mise en œuvre PAC</option>
                            <option value="Suivi du maintien de la sécurité">Suivi du maintien de la sécurité</option>
                            <option value="Surveillance continue">Surveillance continue</option>
                            <option value="Homologation">Homologation</option>
                            <option value="Certification">Certification</option>
                            <option value="Programmée">Programmée</option>
                            <option value="Inopinée">Inopinée</option>
                            <option value="Suivi des événements de sécurité">Suivi des événements de sécurité</option>
                        </select>
                    </div>
                </div>

                <!-- Informations aérodrome -->
                <div id="surveillanceAerodromeInfo" style="display: none; background: var(--light-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                        <div><strong>Code OACI:</strong> <span id="infoCode"></span></div>
                        <div><strong>Ville:</strong> <span id="infoVille"></span></div>
                        <div><strong>Type:</strong> <span id="infoType"></span></div>
                        <div><strong>Statut:</strong> <span id="infoStatut"></span></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date de l'Inspection/Audit *</label>
                        <input type="date" id="surveillanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Taux de Conformité *</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="surveillanceConformite" min="0" max="100" step="5" value="0" style="flex: 1;" oninput="updateConformiteValue()">
                            <span id="conformiteValue" style="font-weight: bold; font-size: 18px; min-width: 60px;">0%</span>
                        </div>
                        <div class="conformity-indicator" style="margin-top: 10px;">
                            <div class="conformity-fill" id="conformiteFill" style="width: 0%; background: var(--danger-color);"></div>
                            <div class="conformity-label" id="conformiteLabel">0%</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Inspecteurs Concernés *</label>
                    <select id="surveillanceInspecteurs" multiple style="height: 150px;" required>
                        <!-- Chargé dynamiquement -->
                    </select>
                    <div style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs inspecteurs
                    </div>
                </div>

                <!-- Section écarts à risque élevé -->
                <div class="form-group">
                    <label>Écarts à Risque Élevé</label>
                    <div id="ecartsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addEcart()" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> Ajouter un écart
                    </button>
                </div>

                <div class="form-group">
                    <label>Observations et Remarques</label>
                    <textarea id="surveillanceObservations" rows="3" placeholder="Observations générales, points positifs, recommandations..."></textarea>
                </div>

                <!-- Section fichiers -->
                <div class="form-group">
                    <label>Documents et Preuves</label>
                    <div class="file-upload-area" onclick="triggerSurveillanceFileUpload()" id="surveillanceFileUploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>Déposer les documents ici</h4>
                        <p>ou cliquez pour parcourir</p>
                        <small>Rapports, listes de vérification, photos, preuves (PDF, DOC, XLS, JPG, PNG - max 10MB)</small>
                        <input type="file" id="surveillanceFileInput" multiple style="display: none;" onchange="handleSurveillanceFiles(this)">
                    </div>
                    <div class="file-list" id="surveillanceFileList"></div>
                </div>

                <div class="form-group">
                    <label>Statut *</label>
                    <select id="surveillanceStatus" required>
                        <option value="Planifié">Planifié</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminé">Terminé</option>
                        <option value="En attente de validation">En attente de validation</option>
                        <option value="Validé">Validé</option>
                        <option value="Archivé">Archivé</option>
                    </select>
                </div>

                <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveSurveillance()">
                    <i class="fas fa-save"></i> Enregistrer l'Inspection/Audit
                </button>
            </form>
        </div>
    </div>

  <!-- Modale Registre -->
<div id="modalRegistre" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalRegistre')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--primary-color);">
            <i class="fas fa-book"></i> <span id="registreModalTitle">Nouveau Registre</span>
        </h3>
        
        <form id="formRegistre">
            <input type="hidden" id="registreId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Type de Registre *</label>
                    <select id="registreType" required onchange="updateRegistreFields()">
                        <option value="">Sélectionner...</option>
                        <option value="Certification">Registre des Certifications</option>
                        <option value="Homologation">Registre des Homologations</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Référence *</label>
                    <input type="text" id="registreReference" required placeholder="Ex: REG-CERT-2024-001">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Aérodrome Associé *</label>
                    <select id="registreAerodrome" required onchange="updateRegistreAerodromeInfo(this.value)">
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type de Processus *</label>
                    <select id="registreProcessType" required onchange="updateRegistreRequirements()">
                        <option value="">Sélectionner...</option>
                        <option value="certification">Certification</option>
                        <option value="homologation">Homologation</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date Début *</label>
                    <input type="date" id="registreDateDebut" required>
                </div>
                <div class="form-group">
                    <label>Date Fin *</label>
                    <input type="date" id="registreDateFin" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Responsable *</label>
                    <input type="text" id="registreResponsable" required placeholder="Nom du responsable">
                </div>
                <div class="form-group">
                    <label>Service *</label>
                    <select id="registreService" required>
                        <option value="">Sélectionner...</option>
                        <option value="Service Normes d'Aérodromes">Service Normes d'Aérodromes</option>
                        <option value="Service Sécurité des Aérodromes">Service Sécurité des Aérodromes</option>
                        <option value="Service Technique">Service Technique</option>
                        <option value="Service Juridique">Service Juridique</option>
                    </select>
                </div>
            </div>

            <!-- Section vérification -->
            <div id="registreVerificationInfo" style="display: none; background: var(--light-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                    <i class="fas fa-clipboard-check"></i> Vérification des Prérequis
                </h4>
                <div id="registreRequirementsList"></div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="registreDescription" rows="3" placeholder="Description du registre..."></textarea>
            </div>

            <div class="form-group">
                <label>Fichier du Registre</label>
                <div class="file-upload-area" onclick="triggerRegistreFileUpload()" id="registreFileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Déposer le fichier du registre</h4>
                    <p>ou cliquez pour parcourir</p>
                    <small>Format: PDF, Excel, Word</small>
                    <input type="file" id="registreFileInput" style="display: none;" onchange="handleRegistreFile(this)">
                </div>
                <div class="file-list" id="registreFileList"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Statut *</label>
                    <select id="registreStatus" required>
                        <option value="En cours">En cours</option>
                        <option value="Expiré">Expiré</option>
                        <option value="Suspendu">Suspendu</option>
                        <option value="Annulé">Annulé</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priorité</label>
                    <select id="registrePriority">
                        <option value="Normal">Normal</option>
                        <option value="Haute">Haute</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>
            </div>

            <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveRegistre()">
                <i class="fas fa-save"></i> Enregistrer le Registre
            </button>
        </form>
    </div>
</div>

   <!-- Modale Inspecteur -->
<div id="modalInspector" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalInspector')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--primary-color);">
            <i class="fas fa-user-plus"></i> <span id="inspectorModalTitle">Nouvel Inspecteur</span>
        </h3>
        
        <form id="formInspector">
            <input type="hidden" id="inspectorId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Nom *</label>
                    <input type="text" id="inspectorLastName" required placeholder="Nom de famille">
                </div>
                <div class="form-group">
                    <label>Prénom *</label>
                    <input type="text" id="inspectorFirstName" required placeholder="Prénom">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Matricule *</label>
                    <input type="text" id="inspectorMatricule" required placeholder="Numéro de matricule">
                </div>
                <div class="form-group">
                    <label>Type d'Inspecteur *</label>
                    <select id="inspectorType" required>
                        <option value="">Sélectionner...</option>
                        <option value="Stagiaire">Stagiaire</option>
                        <option value="Titulaire">Titulaire</option>
                        <option value="Principal">Principal</option>
                        <option value="Cadre Technique">Cadre Technique</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Service *</label>
                    <select id="inspectorService" required>
                        <option value="">Sélectionner...</option>
                        <option value="Service Normes d'Aérodromes">Service Normes d'Aérodromes</option>
                        <option value="Service Sécurité des Aérodromes">Service Sécurité des Aérodromes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Spécialité *</label>
                    <select id="inspectorSpecialty" required>
                        <option value="">Sélectionner...</option>
                        <option value="AGA/Exploitation">AGA/Exploitation</option>
                        <option value="AGA/SLI-RA">AGA/SLI-RA</option>
                        <option value="AGA/Génie civil">AGA/Génie civil</option>
                        <option value="AGA/Génie électrique">AGA/Génie électrique</option>
                        <option value="AGA/Sécurité">AGA/Sécurité</option>
                        <option value="AGA/Environnement">AGA/Environnement</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Statut *</label>
                    <select id="inspectorStatus" required>
                        <option value="Actif">Actif</option>
                        <option value="En congé">En congé</option>
                        <option value="En formation">En formation</option>
                        <option value="Inactif">Inactif</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="inspectorEmail" placeholder="email@anacim.sn">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Téléphone</label>
                    <input type="tel" id="inspectorPhone" placeholder="+221 XX XXX XX XX">
                </div>
                <div class="form-group">
                    <label>Date de prise de fonction</label>
                    <input type="date" id="inspectorStartDate">
                </div>
            </div>

            <div class="form-group">
                <label>Formations suivies</label>
                <textarea id="inspectorTrainings" rows="3" placeholder="Liste des formations..."></textarea>
            </div>

            <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveInspector()">
                <i class="fas fa-save"></i> Enregistrer l'Inspecteur
            </button>
        </form>
    </div>
</div>

<!-- Modale Formation -->
<div id="modalFormation" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalFormation')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--primary-color);">
            <i class="fas fa-graduation-cap"></i> <span id="formationModalTitle">Nouvelle Formation</span>
        </h3>
        
        <form id="formFormation">
            <input type="hidden" id="formationId">
            
            <div class="form-group">
                <label>Titre de la Formation *</label>
                <input type="text" id="formationTitle" required placeholder="Ex: Certification AGA Niveau 1" style="font-size: 16px; padding: 12px;">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date Début *</label>
                    <input type="date" id="formationStartDate" required style="font-size: 16px; padding: 12px;">
                </div>
                <div class="form-group">
                    <label>Date Fin *</label>
                    <input type="date" id="formationEndDate" required style="font-size: 16px; padding: 12px;">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Type de Formation</label>
                    <select id="formationType" style="font-size: 16px; padding: 12px;">
                        <option value="">Sélectionner...</option>
                        <option value="Initiale">Initiale</option>
                        <option value="Continue">Continue</option>
                        <option value="Spécialisée">Spécialisée</option>
                        <option value="Recyclage">Recyclage</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Organisateur</label>
                    <input type="text" id="formationOrganizer" placeholder="Ex: ANACIM, OACI, EAMAC" style="font-size: 16px; padding: 12px;">
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="formationDescription" rows="3" placeholder="Description de la formation..." style="font-size: 16px; padding: 12px;"></textarea>
            </div>

            <div class="form-group">
                <label>Participants</label>
                <select id="formationParticipants" multiple style="height: 150px; font-size: 16px; padding: 8px;">
                    <!-- Les inspecteurs seront chargés dynamiquement -->
                </select>
            </div>

            <div class="form-group">
                <label>Statut *</label>
                <select id="formationStatus" required style="font-size: 16px; padding: 12px;">
                    <option value="Planifiée">Planifiée</option>
                    <option value="En cours">En cours</option>
                    <option value="Terminée">Terminée</option>
                    <option value="Annulée">Annulée</option>
                </select>
            </div>

            <!-- Section fichiers pour attestations -->
            <div class="form-group">
                <label>Attestations/Certificats</label>
                <div class="file-upload-area" onclick="triggerFormationFileUpload()" id="formationFileUploadArea" style="border: 2px dashed #1a237e; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #1a237e; margin-bottom: 15px;"></i>
                    <h4 style="color: #1a237e; margin-bottom: 10px;">Déposer les certificats de formation</h4>
                    <p style="color: #666;">Attestations, certificats, documents d'évaluation</p>
                    <small style="color: #999;">Formats: PDF, DOC, JPG, PNG (max 20MB)</small>
                    <input type="file" id="formationFileInput" multiple style="display: none;" onchange="handleFormationFiles(this)">
                </div>
                <div class="file-list" id="formationFileList" style="margin-top: 15px;"></div>
            </div>

            <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveFormation()">
                <i class="fas fa-save"></i> Enregistrer la Formation
            </button>
        </form>
    </div>
</div>


    <!-- Modale Dossier -->
<div id="modalDossier" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalDossier')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--primary-color);">
            <i class="fas fa-folder"></i> <span id="dossierModalTitle">Nouveau Dossier</span>
        </h3>
        
        <form id="formDossier">
            <input type="hidden" id="dossierId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Référence *</label>
                    <input type="text" id="dossierReference" required placeholder="Ex: DOS-AGA-2024-001">
                </div>
                <div class="form-group">
                    <label>Type de Dossier *</label>
                    <select id="dossierType" required>
                        <option value="">Sélectionner...</option>
                        <option value="Certification">Certification</option>
                        <option value="Homologation">Homologation</option>
                        <option value="Surveillance continue">Surveillance continue</option>
                        <option value="Evènement de sécurité">Evènement de sécurité</option>
                        <option value="Enquête">Enquête</option>
                        <option value="Administratif">Administratif</option>
                        <option value="Création aérodrome">Création aérodrome</option>
                        <option value="Plan d'actions correctives (PAC)">Plan d'actions correctives (PAC)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description *</label>
                <textarea id="dossierDescription" required rows="3" placeholder="Description du dossier..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Service Responsable *</label>
                    <select id="dossierService" required>
                        <option value="">Sélectionner...</option>
                        <option value="Service Normes d'Aérodromes">Service Normes d'Aérodromes</option>
                        <option value="Service Sécurité des Aérodromes">Service Sécurité des Aérodromes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Inspecteur Assigné</label>
                    <select id="dossierInspector">
                        <option value="">Sélectionner un inspecteur...</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date d'Ouverture *</label>
                    <input type="date" id="dossierStartDate" required>
                </div>
                <div class="form-group">
                    <label>Date Limite</label>
                    <input type="date" id="dossierDeadline">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Priorité</label>
                    <select id="dossierPriority">
                        <option value="Normale">Normale</option>
                        <option value="Haute">Haute</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Statut *</label>
                    <select id="dossierStatus" required>
                        <option value="Nouveau">Nouveau</option>
                        <option value="En cours">En cours</option>
                        <option value="En attente">En attente</option>
                        <option value="Terminé">Terminé</option>
                        <option value="Archivé">Archivé</option>
                    </select>
                </div>
            </div>

            <!-- Section tâches -->
            <div class="form-group">
                <label>Tâches</label>
                <div id="dossierTasks"></div>
                <button type="button" class="btn btn-secondary" onclick="addTask()" style="margin-top: 10px;">
                    <i class="fas fa-plus"></i> Ajouter une tâche
                </button>
            </div>

            <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveDossier()">
                <i class="fas fa-save"></i> Enregistrer le Dossier
            </button>
        </form>
    </div>
</div>

   <!-- Modal Plan d'Action -->
<div id="modalPlanAction" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeModal('modalPlanAction')">&times;</span>
        <h2><i class="fas fa-clipboard-list"></i> <span id="modalPlanActionTitle">Nouveau Plan d'Action</span></h2>
        
        <form id="formPlanAction" onsubmit="event.preventDefault(); savePlanAction();">
            <!-- SECTION 1: Informations sur la Constatation -->
            <div class="form-section">
                <h3 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Informations sur la Constatation
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Référence du Plan <span style="color: red;">*</span></label>
                        <input type="text" id="planActionReference" required placeholder="Ex: PA-2024-001">
                    </div>
                    
                    <div class="form-group">
                        <label>Aérodrome(s) Concerné(s) <span style="color: red;">*</span></label>
                        <select id="planActionAerodrome" required>
                            <option value="">Sélectionner...</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Description de la Constatation <span style="color: red;">*</span></label>
                        <textarea id="planActionDescription" required rows="4" placeholder="Décrivez la constatation en détail..."></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Niveau de Risque de Sécurité <span style="color: red;">*</span></label>
                        <select id="planActionRiskLevel" required>
                            <option value="">Sélectionner...</option>
                            <option value="Faible">Faible</option>
                            <option value="Moyen">Moyen</option>
                            <option value="Élevé">Élevé</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Date d'Émission de la Constatation <span style="color: red;">*</span></label>
                        <input type="date" id="planActionEmissionDate" required>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 2: Actions Correctives -->
            <div class="form-section">
                <h3 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px;">
                    <i class="fas fa-tools"></i> Actions Correctives
                </h3>
                
                <div id="planActionItems"></div>
                
                <button type="button" class="btn btn-secondary" onclick="addActionItem()" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-plus"></i> Ajouter une Action Corrective
                </button>
            </div>
            
            <input type="hidden" id="planActionId">
            <input type="hidden" id="planActionTitle">
            <input type="hidden" id="planActionStartDate">
            <input type="hidden" id="planActionDeadline">
            <input type="hidden" id="planActionResponsible">
            <input type="hidden" id="planActionStatus">
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('modalPlanAction')">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modale Kit Inspecteur -->
<div id="modalKitFile" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalKitFile')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--primary-color);">
            <i class="fas fa-toolbox"></i> <span id="kitFileModalTitle">Nouveau Document du Kit Inspecteur</span>
        </h3>
        
        <form id="formKitFile">
            <input type="hidden" id="kitFileId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Nom du Document *</label>
                    <input type="text" id="kitFileName" required placeholder="Ex: Règlementation AGA 2024">
                </div>
                <div class="form-group">
                    <label>Catégorie *</label>
                    <select id="kitFileCategory" required>
                        <option value="">Sélectionner...</option>
                        <option value="Reglementation">Règlementation</option>
                        <option value="Procedures">Procédures</option>
                        <option value="Guides">Guides</option>
                        <option value="Checklists">Check-lists</option>
                        <option value="Formulaires">Formulaires</option>
                        <option value="Rapports">Modèles de rapports</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="kitFileDescription" rows="3" placeholder="Description du document..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Version</label>
                    <input type="text" id="kitFileVersion" placeholder="Ex: 1.0">
                </div>
                <div class="form-group">
                    <label>Date de publication</label>
                    <input type="date" id="kitFileDate">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Spécialité concernée</label>
                    <select id="kitFileSpecialty" multiple style="height: 120px;">
                        <option value="AGA/Exploitation">AGA/Exploitation</option>
                        <option value="AGA/SLI-RA">AGA/SLI-RA</option>
                        <option value="AGA/Génie civil">AGA/Génie civil</option>
                        <option value="AGA/Génie électrique">AGA/Génie électrique</option>
                        <option value="AGA/Sécurité">AGA/Sécurité</option>
                        <option value="AGA/Environnement">AGA/Environnement</option>
                        <option value="Toutes">Toutes les spécialités</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mots-clés</label>
                    <textarea id="kitFileKeywords" rows="3" placeholder="Séparer par des virgules"></textarea>
                </div>
            </div>

            <div class="form-group">
                <label>Fichier *</label>
                <div class="file-upload-area" onclick="triggerKitFileUpload()" id="kitFileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Déposer le document ici</h4>
                    <p>ou cliquez pour parcourir</p>
                    <small>Formats acceptés: PDF, DOC, XLS, PPT, JPG, PNG, ZIP (max 50MB)</small>
                    <input type="file" id="kitFileInput" style="display: none;" onchange="handleKitFile(this)">
                </div>
                <div class="file-list" id="kitFileList"></div>
            </div>

            <div class="form-group">
                <label>Statut *</label>
                <select id="kitFileStatus" required>
                    <option value="Actif">Actif</option>
                    <option value="Archivé">Archivé</option>
                    <option value="En révision">En révision</option>
                </select>
            </div>

            <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveKitFile()">
                <i class="fas fa-save"></i> Enregistrer le Document
            </button>
        </form>
    </div>
</div>

<!-- Modale de visualisation de document -->
<div id="modalDocumentViewer" class="modal">
    <div class="modal-content" style="max-width: 90%; width: 90%; height: 90vh;">
        <button class="close-modal" onclick="closeModal('modalDocumentViewer')">&times;</button>
        <div id="documentViewerContent" style="height: calc(100% - 60px); margin-top: 20px;">
            <!-- Contenu du document sera chargé ici -->
        </div>
    </div>
</div>

    <!-- Modale Utilisateur -->
    <div id="modalUtilisateur" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('modalUtilisateur')">&times;</button>
            <h3 style="margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-user-plus"></i> <span id="utilisateurModalTitle">Nouvel Utilisateur</span>
            </h3>
            
            <form id="formUtilisateur">
                <input type="hidden" id="utilisateurId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" id="utilisateurNom" required placeholder="Nom de famille">
                    </div>
                    <div class="form-group">
                        <label>Prénom *</label>
                        <input type="text" id="utilisateurPrenom" required placeholder="Prénom">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Identifiant *</label>
                        <input type="text" id="utilisateurLogin" required placeholder="Identifiant de connexion">
                    </div>
                    <div class="form-group">
                        <label>Mot de passe *</label>
                        <input type="password" id="utilisateurPassword" required placeholder="Mot de passe">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="utilisateurEmail" required placeholder="email@anacim.sn">
                    </div>
                    <div class="form-group">
                        <label>Téléphone</label>
                        <input type="tel" id="utilisateurPhone" placeholder="+221 XX XXX XX XX">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Rôle *</label>
                        <select id="utilisateurRole" required onchange="updatePermissionVisibility()">
                            <option value="">Sélectionner...</option>
                            <option value="admin">Administrateur</option>
                            <option value="inspecteur">Inspecteur</option>
                            <option value="service_normes">Service Normes</option>
                            <option value="service_securite">Service Sécurité</option>
                            <option value="consultant">Consultant</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Service</label>
                        <select id="utilisateurService">
                            <option value="">Sélectionner...</option>
                            <option value="Service Normes d'Aérodromes">Service Normes d'Aérodromes</option>
                            <option value="Service Sécurité des Aérodromes">Service Sécurité des Aérodromes</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Date de début</label>
                    <input type="date" id="utilisateurDateDebut">
                </div>

                <div class="form-group">
                    <label>Statut *</label>
                    <select id="utilisateurStatus" required>
                        <option value="Actif">Actif</option>
                        <option value="Inactif">Inactif</option>
                        <option value="Suspendu">Suspendu</option>
                    </select>
                </div>

                <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveUtilisateur()">
                    <i class="fas fa-save"></i> Enregistrer l'Utilisateur
                </button>
            </form>
        </div>
    </div>

    <!-- Modale Événement -->
<div id="modalEvenement" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalEvenement')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--primary-color);">
            <i class="fas fa-exclamation-triangle"></i> <span id="evenementModalTitle">Nouvel Événement</span>
        </h3>
        
        <form id="formEvenement">
            <input type="hidden" id="evenementId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Aérodrome *</label>
                    <select id="evenementAerodrome" required>
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type d'Événement *</label>
                    <select id="evenementType" required>
                        <option value="">Sélectionner...</option>
                        <option value="Incident">Incident</option>
                        <option value="Accident">Accident</option>
                        <option value="Non-conformité">Non-conformité</option>
                        <option value="Défaut">Défaut technique</option>
                        <option value="Météo">Événement météorologique</option>
                        <option value="Sécurité">Événement de sécurité</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date et Heure *</label>
                    <input type="datetime-local" id="evenementDate" required>
                </div>
                <div class="form-group">
                    <label>Gravité *</label>
                    <select id="evenementGravite" required>
                        <option value="Mineur">Mineur</option>
                        <option value="Majeur">Majeur</option>
                        <option value="Critique">Critique</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description *</label>
                <textarea id="evenementDescription" required rows="3" placeholder="Description détaillée de l'événement..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rapporteur *</label>
                    <input type="text" id="evenementRapporteur" required placeholder="Nom du rapporteur">
                </div>
                <div class="form-group">
                    <label>Statut *</label>
                    <select id="evenementStatus" required>
                        <option value="Signalé">Signalé</option>
                        <option value="En investigation">En investigation</option>
                        <option value="Traité">Traité</option>
                        <option value="Clôturé">Clôturé</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Actions immédiates</label>
                <textarea id="evenementActions" rows="2" placeholder="Actions prises immédiatement..."></textarea>
            </div>

            <div class="form-group">
                <label>Documents associés</label>
                <div class="file-upload-area" onclick="triggerEvenementFileUpload()" id="evenementFileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Déposer les documents relatifs à l'événement</h4>
                    <p>ou cliquez pour parcourir</p>
                    <small>Photos, rapports, témoignages (max 50MB par fichier)</small>
                    <input type="file" id="evenementFileInput" multiple style="display: none;" onchange="handleEvenementFiles(this)">
                </div>
                <div class="file-list" id="evenementFileList"></div>
            </div>

            <button type="button" class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 18px;" onclick="saveEvenement()">
                <i class="fas fa-save"></i> Enregistrer l'Événement
            </button>
        </form>
    </div>
</div>

<!-- Modale Alerte -->
<div id="modalAlerte" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('modalAlerte')">&times;</button>
        <h3 style="margin-bottom: 30px; color: var(--danger-color);">
            <i class="fas fa-exclamation-triangle"></i> <span id="alerteModalTitle">Nouvelle Alerte Urgente</span>
        </h3>
        
        <form id="formAlerte">
            <input type="hidden" id="alerteId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>Titre de l'Alerte *</label>
                    <input type="text" id="alerteTitre" required placeholder="Ex: Risque sécurité critique - Aérodrome X">
                </div>
                <div class="form-group">
                    <label>Type d'Alerte *</label>
                    <select id="alerteType" required>
                        <option value="">Sélectionner...</option>
                        <option value="Sécurité Critique">Sécurité Critique</option>
                        <option value="Risque Immédiat">Risque Immédiat</option>
                        <option value="Incident Grave">Incident Grave</option>
                        <option value="Non-conformité Majeure">Non-conformité Majeure</option>
                        <option value="Alerte Météo">Alerte Météo</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Date d'Échéance *</label>
                    <input type="datetime-local" id="alerteDateEcheance" required>
                </div>
                <div class="form-group">
                    <label>Niveau d'Urgence *</label>
                    <select id="alerteUrgence" required>
                        <option value="Critique">Critique</option>
                        <option value="Haute">Haute</option>
                        <option value="Moyenne">Moyenne</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description Détaillée *</label>
                <textarea id="alerteDescription" required rows="5" placeholder="Décrivez en détail la préoccupation de sécurité..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Inspecteurs Concernés *</label>
                    <select id="alerteDestinataires" multiple style="height: 150px;" required>
                        <!-- Les inspecteurs seront chargés dynamiquement -->
                    </select>
                    <small style="color: var(--text-secondary);">Maintenez Ctrl pour sélectionner plusieurs inspecteurs</small>
                </div>
                <div class="form-group">
                    <label>Actions Requises</label>
                    <select id="alerteActions" multiple style="height: 150px;">
                        <option value="Inspection immédiate">Inspection immédiate</option>
                        <option value="Rapport dans 24h">Rapport dans 24h</option>
                        <option value="Suspension temporaire">Suspension temporaire</option>
                        <option value="Réunion d'urgence">Réunion d'urgence</option>
                        <option value="Contrôle renforcé">Contrôle renforcé</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Localisation / Aérodrome concerné</label>
                <input type="text" id="alerteLocalisation" placeholder="Ex: Aérodrome XYZ, Ville ABC">
            </div>

            <button type="button" class="btn btn-danger" style="width: 100%; padding: 18px; font-size: 18px; background: var(--danger-color); border: none;" onclick="saveAlerte()">
                <i class="fas fa-paper-plane"></i> Envoyer l'Alerte aux Inspecteurs
            </button>
        </form>
    </div>
</div>

<!-- Modal de confirmation d'envoi -->
<div id="modalConfirmationAlerte" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 60px; color: var(--danger-color); margin-bottom: 20px;">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h3 style="color: var(--danger-color); margin-bottom: 15px;">Alerte Envoyée !</h3>
            <p style="margin-bottom: 25px; font-size: 16px; color: var(--text-color);">
                L'alerte de sécurité a été envoyée avec succès à <span id="nombreDestinataires">0</span> inspecteur(s).
                <br>
                Les emails de notification ont été distribués.
            </p>
            <button class="btn btn-secondary" onclick="closeModal('modalConfirmationAlerte')" style="padding: 12px 30px;">
                <i class="fas fa-check"></i> Compris
            </button>
        </div>
    </div>
</div>

<!-- Modale de visualisation de fichiers -->
<div id="modalFileViewer" class="modal">
    <div class="modal-content" style="max-width: 90%; width: 90%; height: 90vh;">
        <button class="close-modal" onclick="closeModal('modalFileViewer')">&times;</button>
        <div id="fileViewerContent" style="height: calc(100% - 60px); margin-top: 20px;">
            <!-- Contenu des fichiers sera chargé ici -->
        </div>
    </div>
</div>


    <!-- Modale personnalisée pour les détails -->
    <div id="modalCustom" class="custom-modal">
        <div class="custom-modal-content">
            <button class="custom-modal-close" onclick="closeCustomModal()">&times;</button>
            <div id="modalCustomContent"></div>
        </div>
    </div>

    <!-- Overlay de chargement -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // ============ VARIABLES GLOBALES ============
	let currentEditingAerodromeId = null;
	let currentViewMode = 'grid';
        let currentUser = null;
        let currentRole = null;
        let currentPermission = null;
        let aerodromes = [];
        let certifications = [];
        let homologations = [];
        let plannings = [];
        let surveillances = [];
        let registres = [];
        let inspectors = [];
        let formations = [];
        let dossiers = [];
        let plansActions = [];
        let utilisateurs = [];
        let evenements = [];
        let alertes = [];
        let selectedCertificationId = null;
        let selectedHomologationId = null;
        let filteredInspectors = [];
        let dragDropFiles = {};
        
        // NOUVEAU: Variables pour le Kit Inspecteur
        let kitFiles = [];
        let filteredKitFiles = [];

        // Variables pour le tri et le filtrage
        let currentSurveillanceSort = { field: 'date', direction: 'desc' };
        let currentRegistreSort = { field: 'dateDebut', direction: 'desc' };
        let currentUtilisateurSort = { field: 'dateCreation', direction: 'desc' };
        let currentEvenementSort = { field: 'date', direction: 'desc' };
        let chartEvenements = null;

        // ============ FONCTIONS DE BASE ============
// ============ VÉRIFICATION CERTIFICATION/HOMOLOGATION COMPLÈTE ============
function isCertificationComplete(certificationId) {
    const certification = certifications.find(c => c.id === certificationId);
    if (!certification) return false;
    
    // Vérifier que toutes les phases sont terminées avec preuves
    const phases = certification.phases || [];
    if (phases.length < 5) return false;
    
    // Vérifier chaque phase
    for (let i = 1; i <= 5; i++) {
        const phase = phases.find(p => p.phaseNumber === i);
        if (!phase || phase.status !== 'completed') return false;
        
        // Vérifier qu'il y a des fichiers preuves
        const phaseFiles = certification.files?.filter(f => f.phase === i) || [];
        if (phaseFiles.length === 0) return false;
        
        // Vérifier qu'au moins un fichier est une preuve valide
        const validProofs = phaseFiles.filter(f => 
            f.type === 'proof' || 
            f.name.toLowerCase().includes('preuve') ||
            f.name.toLowerCase().includes('rapport') ||
            f.name.toLowerCase().includes('certificat')
        );
        if (validProofs.length === 0) return false;
    }
    
    return true;
}

function isHomologationComplete(homologationId) {
    const homologation = homologations.find(h => h.id === homologationId);
    if (!homologation) return false;
    
    // Vérifier que toutes les phases sont terminées avec preuves
    const phases = homologation.phases || [];
    if (phases.length < 3) return false;
    
    for (let i = 1; i <= 3; i++) {
        const phase = phases.find(p => p.phaseNumber === i);
        if (!phase || phase.status !== 'completed') return false;
        
        const phaseFiles = homologation.files?.filter(f => f.phase === i) || [];
        if (phaseFiles.length === 0) return false;
        
        const validProofs = phaseFiles.filter(f => 
            f.type === 'proof' || 
            f.name.toLowerCase().includes('decision') ||
            f.name.toLowerCase().includes('rapport') ||
            f.name.toLowerCase().includes('verification')
        );
        if (validProofs.length === 0) return false;
    }
    
    return true;
}
        // ============ FONCTION DE CONNEXION ============
function login() {
    showLoading();
    
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    // Vérifier les identifiants
    setTimeout(() => {
        if (username === 'admin' && password === 'dnsa2025') {
            currentUser = username;
            currentRole = 'Administrateur';
            currentPermission = 'admin';
            
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('currentRole').textContent = currentRole;
            document.getElementById('currentPermission').textContent = currentPermission.toUpperCase();
            document.getElementById('currentPermission').className = `permission-badge permission-${currentPermission}`;
            
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginSuccess').style.display = 'flex';
            
            initData();
            loadSavedData();
            updateDashboard();
            updateAlertes();
            updatePermissionVisibility();
            enableAllButtons();
            
            showNotification(`Bienvenue, ${currentUser}!`, 'success');
        } else {
            document.getElementById('loginError').style.display = 'flex';
            document.getElementById('loginSuccess').style.display = 'none';
            document.getElementById('loginError').style.animation = 'shake 0.5s';
            setTimeout(() => {
                document.getElementById('loginError').style.animation = '';
            }, 500);
        }
        
        hideLoading();
    }, 800);
}

        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                currentUser = null;
                currentRole = null;
                currentPermission = null;
                
                document.getElementById('mainApp').classList.remove('active');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                showNotification('Déconnexion réussie', 'success');
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; margin-left: auto;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 9999;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInLeft 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function checkPermission(requiredPermission) {
            if (currentPermission === 'admin') return true;
            
            const permissions = {
                'admin': ['read', 'write', 'delete', 'manage_users'],
                'inspecteur': ['read', 'write'],
                'service_normes': ['read', 'write'],
                'service_securite': ['read', 'write'],
                'consultant': ['read']
            };
            
            return permissions[currentPermission]?.includes(requiredPermission) || false;
        }

        function updatePermissionVisibility() {
            const isAdmin = checkPermission('manage_users');
            const canWrite = checkPermission('write');
            
            // Activer/désactiver les boutons de création
            document.getElementById('btnNewAerodrome').disabled = !canWrite;
            document.getElementById('btnNewCertification').disabled = !canWrite;
            document.getElementById('btnNewHomologation').disabled = !canWrite;
            document.getElementById('btnNewPlanning').disabled = !canWrite;
            document.getElementById('btnNewSurveillance').disabled = !canWrite;
            document.getElementById('btnNewRegistre').disabled = !canWrite;
            document.getElementById('btnNewFormation').disabled = !canWrite;
            document.getElementById('btnNewInspector').disabled = !canWrite;
            document.getElementById('btnNewDossier').disabled = !canWrite;
            document.getElementById('btnNewPlanAction').disabled = !canWrite;
            document.getElementById('btnNewKitFile').disabled = !canWrite;
            document.getElementById('btnNewUtilisateur').disabled = !isAdmin;
            document.getElementById('btnNewEvenement').disabled = !canWrite;
            document.getElementById('btnNewAlerte').disabled = !isAdmin;
            
            // Gestion des rôles dans le formulaire utilisateur
            const roleSelect = document.getElementById('utilisateurRole');
            if (roleSelect) {
                if (!isAdmin) {
                    roleSelect.querySelectorAll('option[value="admin"]').forEach(opt => opt.disabled = true);
                    roleSelect.value = roleSelect.value === 'admin' ? '' : roleSelect.value;
                }
            }
        }

        function showTab(tabId) {
            // Masquer tous les contenus d'onglet
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Désactiver tous les onglets de navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.getElementById(tabId).classList.add('active');
            
            // Activer le bouton de navigation correspondant
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(tabId)) {
                    tab.classList.add('active');
                }
            });
            
            // Charger les données spécifiques à l'onglet
            switch(tabId) {
                case 'dashboard':
                    updateDashboard();
                    updateAlertes();
                    break;
                case 'aerodromes':
                    loadAerodromes();
                    break;
                case 'certification':
                    loadCertifications();
                    break;
                case 'homologation':
                    loadHomologations();
                    break;
                case 'planning':
                    loadPlannings();
		    updateAllCalendars(); 
                    break;
                case 'surveillance':
                    loadSurveillances();
                    break;
                case 'registres':
                    loadRegistres();
                    break;
                case 'formation':
                    loadInspectors();
                    loadFormations();
		    updateAllCalendars(); 
                    break;
                case 'dossiers':
                    loadDossiers();
                    updateDossierProgress();
                    break;
                case 'plans-actions':
                    loadPlansActionsGrouped();
		    updateAllCalendars(); 
                    break;
                case 'kit-inspecteur':
                    loadKitFiles();
                    break;
                case 'utilisateurs':
                    loadUtilisateurs();
                    break;
                case 'evenements':
                    loadEvenements();
                    break;
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                
                // Initialiser les formulaires selon la modale
                switch(modalId) {
                    case 'modalAerodrome':
                        initAerodromeModal();
                        break;
                    case 'modalCertification':
                        initCertificationModal();
                        break;
                    case 'modalHomologation':
                        initHomologationModal();
                        break;
                    case 'modalPlanning':
                        initPlanningModal();
                        break;
                    case 'modalSurveillance':
                        initSurveillanceModal();
                        break;
                    case 'modalRegistre':
                        initRegistreModal();
                        break;
                    case 'modalInspector':
                        initInspectorModal();
                        break;
                    case 'modalFormation':
                        initFormationModal();
                        break;
                    case 'modalDossier':
                        initDossierModal();
                        break;
                    case 'modalPlanAction':
                        initPlanActionModal();
                        break;
                    case 'modalKitFile':
                        initKitFileModal();
                        break;
                    case 'modalUtilisateur':
                        initUtilisateurModal();
                        break;
                    case 'modalEvenement':
                        initEvenementModal();
                        break;
                    case 'modalAlerte':
                        initAlerteModal();
                        break;
                }
            }
        }

        function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        // NE PAS réinitialiser automatiquement - on le fera manuellement quand nécessaire
        // const form = modal.querySelector('form');
        // if (form) form.reset();
    }
}

        function closeCustomModal() {
            document.getElementById('modalCustom').classList.remove('active');
        }

        function closeFilePreview() {
            document.getElementById('modalFilePreview').classList.remove('active');
        }

	// ============ FONCTIONS DE VISUALISATION DE FICHIERS ============

// ============ FONCTIONS DE VISUALISATION DE FICHIERS ============

function viewFile(fileName, fileType) {
    const previewContainer = document.getElementById('modalFilePreview');
    const previewContent = document.getElementById('filePreviewContent');
    
    const extension = fileName.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
        previewContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: white; margin-bottom: 20px;">${fileName}</h3>
                <div style="color: white; margin-bottom: 20px;">
                    <i class="fas fa-image" style="font-size: 100px; opacity: 0.5;"></i>
                    <p style="margin-top: 20px; opacity: 0.8;">Aperçu d'image (simulation)</p>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="downloadFile('${fileName}')">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                </div>
            </div>
        `;
    } else if (extension === 'pdf') {
        previewContent.innerHTML = `
            <div style="text-align: center; padding: 20px; color: white;">
                <h3 style="margin-bottom: 20px;">${fileName}</h3>
                <div style="background: white; padding: 40px; border-radius: 8px; margin: 20px 0;">
                    <i class="fas fa-file-pdf" style="font-size: 100px; color: #dc3545;"></i>
                    <p style="margin-top: 20px; color: #666;">Aperçu PDF (simulation)</p>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="downloadFile('${fileName}')">
                        <i class="fas fa-download"></i> Télécharger
                    </button>
                </div>
            </div>
        `;
    } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(extension)) {
        let iconType = 'file-word';
        let iconColor = '#2b579a';
        if (['xls', 'xlsx'].includes(extension)) {
            iconType = 'file-excel';
            iconColor = '#217346';
        } else if (['ppt', 'pptx'].includes(extension)) {
            iconType = 'file-powerpoint';
            iconColor = '#d24726';
        }
        
        previewContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: white;">
                <i class="fas fa-${iconType}" style="font-size: 100px; color: ${iconColor}; margin-bottom: 20px;"></i>
                <h3 style="margin-bottom: 20px;">${fileName}</h3>
                <p style="margin-bottom: 30px; opacity: 0.8;">
                    Aperçu non disponible pour les fichiers ${extension.toUpperCase()}.<br>
                    Téléchargez le fichier pour le consulter.
                </p>
                <button class="btn btn-success btn-lg" onclick="downloadFile('${fileName}')">
                    <i class="fas fa-download"></i> Télécharger
                </button>
            </div>
        `;
    } else {
        previewContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: white;">
                <i class="fas fa-file" style="font-size: 100px; margin-bottom: 20px; opacity: 0.8;"></i>
                <h3 style="margin-bottom: 20px;">${fileName}</h3>
                <p style="margin-bottom: 30px; opacity: 0.8;">
                    Aperçu non disponible pour ce type de fichier.<br>
                    Téléchargez le fichier pour le consulter.
                </p>
                <button class="btn btn-success btn-lg" onclick="downloadFile('${fileName}')">
                    <i class="fas fa-download"></i> Télécharger
                </button>
            </div>
        `;
    }
    
    previewContainer.classList.add('active');
}

function downloadFile(fileName) {
    showNotification(`Téléchargement de ${fileName} en cours...`, 'info');
    setTimeout(() => {
        showNotification(`${fileName} téléchargé avec succès!`, 'success');
    }, 1000);
}

function removeFileFromPhase(certId, phaseId, fileName) {
    if (!confirm(`Voulez-vous vraiment supprimer le fichier "${fileName}" ?`)) {
        return;
    }
    
    const cert = certifications.find(c => c.id === certId);
    if (cert && cert.phases) {
        const phase = cert.phases.find(p => p.id === phaseId);
        if (phase && phase.files) {
            phase.files = phase.files.filter(f => f.name !== fileName);
            saveAllData();
            showNotification('Fichier supprimé avec succès', 'success');
            // Recharger la modale
            editCertification(certId);
        }
    }
}

        function initData() {
            // Données de démonstration
            aerodromes = [
                {
                    id: 'aerodrome-1',
                    code: 'GOBD',
                    name: 'Aéroport International Blaise Diagne',
                    city: 'Diass/Dakar',
                    region: 'Dakar',
                    type: 'International',
                    status: 'En service',
                    riskLevel: 'Faible'
                },
                {
                    id: 'aerodrome-2',
                    code: 'GOOY',
                    name: 'Aéroport International Léopold Sédar Senghor',
                    city: 'Dakar',
                    region: 'Dakar',
                    type: 'International',
                    status: 'En service',
                    riskLevel: 'Moyen'
                }
            ];

            inspectors = [
                {
                    id: 'inspector-1',
                    lastName: 'Thiam',
                    firstName: 'Alioune',
                    matricule: 'INS001',
                    type: 'Titulaire',
                    specialty: 'AGA/SL-RA',
                    status: 'Actif',
                    email: 'alioune.thim@anacim.sn',
                    phone: '+221 77 123 45 67'
                },
                {
                    id: 'inspector-2',
                    lastName: 'TOB',
                    firstName: 'Serigne',
                    matricule: 'INS002',
                    type: 'Principal',
                    specialty: 'AGA/Génie Electrique',
                    status: 'Actif',
                    email: 'serigne.tob@anacim.sn',
                    phone: '+221 76 234 56 78'
                }
            ];

            plannings = [
                {
                    id: 'planning-1',
                    aerodromeId: 'aerodrome-1',
                    type: 'Programmée',
                    dateDebut: '2024-03-15T09:00',
                    dateFin: '2024-03-15T17:00',
                    equipe: ['inspector-1', 'inspector-2'],
                    chef: 'inspector-1',
                    objectifs: 'Inspection de mise en oeuvre des PACs',
                    status: 'Planifié'
                },
                {
                    id: 'planning-2',
                    aerodromeId: 'aerodrome-2',
                    type: 'Inopinée',
                    dateDebut: '2024-03-20T10:00',
                    dateFin: '2024-03-20T15:00',
                    equipe: ['inspector-1'],
                    chef: 'inspector-1',
                    objectifs: 'Contrôle du balisage et des équipements SLI',
                    status: 'Terminé'
                }
            ];

            formations = [
                {
                    id: 'formation-1',
                    title: 'Certification AGA Niveau 1',
                    startDate: '2024-04-01',
                    endDate: '2024-04-05',
                    type: 'Initiale',
                    organizer: 'ERNAM',
                    description: 'Formation initiale pour nouveaux inspecteurs',
                    participants: ['inspector-1', 'inspector-2'],
                    status: 'Planifiée'
                }
            ];

            dossiers = [
                {
                    id: 'dossier-1',
                    reference: 'DOS-AGA-2024-001',
                    type: 'Certification',
                    description: 'Certification de l\'aéroport international',
                    service: 'Service Normes d\'Aérodromes',
                    inspectorId: 'inspector-1',
                    startDate: '2024-01-15',
                    deadline: '2024-06-30',
                    priority: 'Haute',
                    status: 'En cours',
                    tasks: [
                        {
                            id: 'task-1',
                            name: 'Évaluation documentaire',
                            status: 'Terminée',
                            progress: 100,
                            deadline: '2024-02-15',
                            responsible: 'Aminata Diop'
                        },
                        {
                            id: 'task-2',
                            name: 'Inspection sur site',
                            status: 'En cours',
                            progress: 60,
                            deadline: '2024-05-15',
                            responsible: 'Moussa Ndiaye'
                        }
                    ],
                    progress: 80,
                    dateCreation: '2024-01-15T09:00:00'
                }
            ];

            plansActions = [
                {
                    id: 'plan-1',
                    reference: 'PA-2024-001',
                    aerodromeId: 'aerodrome-1',
                    title: 'Correction des non-conformités de la bande de piste',
                    description: 'Plan d\'actions pour corriger les écarts de sécurité identifiés',
                    startDate: '2024-02-01',
                    deadline: '2024-05-31',
                    responsible: 'Assane BOUSSO',
                    status: 'En cours',
                    priority: 'Haute',
                    actions: [
                        {
                            id: 'action-1',
                            description: 'Installation de panneaux de signalisation',
                            status: 'Terminée',
                            deadline: '2024-02-28',
                            responsible: 'Équipe maintenance'
                        }
                    ]
                }
            ];

            kitFiles = [
                {
                    id: 'kit-1',
                    name: 'Guide d\'inspection AGA',
                    category: 'Guides',
                    description: 'Guide complet pour l\'inspection des aérodromes',
                    version: '1.0',
                    date: '2024-01-15',
                    specialty: ['AGA/Exploitation', 'AGA/Sécurité'],
                    keywords: 'inspection, guide, procédures',
                    status: 'Actif'
                }
            ];

            // Initialiser tous les formulaires
            initAllForms();
            
            // Charger toutes les données
            updateAllTabs();
            
            // Sauvegarder les données initiales
            saveAllData();
	    setTimeout(() => {
    updateAlertes();
    console.log('Alertes initialisées');
}, 500);
        }

	// ============ SAUVEGARDE AUTOMATIQUE ============

function saveToStorage(key, data) {
    try {
        localStorage.setItem(`sgda_${key}`, JSON.stringify(data));
        return true;
    } catch (e) {
        console.error(`Erreur sauvegarde ${key}:`, e);
        return false;
    }
}

function loadFromStorage(key) {
    try {
        const data = localStorage.getItem(`sgda_${key}`);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error(`Erreur chargement ${key}:`, e);
        return null;
    }
}

function autoSaveAll() {
    saveToStorage('aerodromes', aerodromes);
    saveToStorage('certifications', certifications);
    saveToStorage('homologations', homologations);
    saveToStorage('plannings', plannings);
    saveToStorage('surveillances', surveillances);
    saveToStorage('registres', registres);
    saveToStorage('inspectors', inspectors);
    saveToStorage('formations', formations);
    saveToStorage('dossiers', dossiers);
    saveToStorage('plansActions', plansActions);
    saveToStorage('utilisateurs', utilisateurs);
    saveToStorage('evenements', evenements);
    saveToStorage('alertes', alertes);
    saveToStorage('kitFiles', kitFiles);
    
    console.log('Sauvegarde automatique effectuée:', new Date().toLocaleTimeString());
}

// ============ SUPPRESSION EN CASCADE ============

function deleteAerodromeWithCascade(aerodromeId) {
    const aerodrome = aerodromes.find(a => a.id === aerodromeId);
    if (!aerodrome) return;
    
    const aerodromeName = aerodrome.name;
    let itemsDeleted = {
        certifications: 0,
        homologations: 0,
        plannings: 0,
        surveillances: 0,
        plansActions: 0,
        evenements: 0
    };
    
    // Supprimer les certifications
    const certsToDelete = certifications.filter(c => c.aerodromeId === aerodromeId);
    itemsDeleted.certifications = certsToDelete.length;
    certifications = certifications.filter(c => c.aerodromeId !== aerodromeId);
    
    // Supprimer les homologations
    const homologsToDelete = homologations.filter(h => h.aerodromeId === aerodromeId);
    itemsDeleted.homologations = homologsToDelete.length;
    homologations = homologations.filter(h => h.aerodromeId !== aerodromeId);
    
    // Supprimer les plannings
    const planningsToDelete = plannings.filter(p => p.aerodromeId === aerodromeId);
    itemsDeleted.plannings = planningsToDelete.length;
    plannings = plannings.filter(p => p.aerodromeId !== aerodromeId);
    
    // Supprimer les surveillances
    const surveillancesToDelete = surveillances.filter(s => s.aerodromeId === aerodromeId);
    itemsDeleted.surveillances = surveillancesToDelete.length;
    surveillances = surveillances.filter(s => s.aerodromeId !== aerodromeId);
    
    // Supprimer les plans d'actions
    const plansToDelete = plansActions.filter(p => p.aerodromeId === aerodromeId);
    itemsDeleted.plansActions = plansToDelete.length;
    plansActions = plansActions.filter(p => p.aerodromeId !== aerodromeId);
    
    // Supprimer les événements
    const eventsToDelete = evenements.filter(e => e.aerodromeId === aerodromeId);
    itemsDeleted.evenements = eventsToDelete.length;
    evenements = evenements.filter(e => e.aerodromeId !== aerodromeId);
    
    // Supprimer l'aérodrome
    aerodromes = aerodromes.filter(a => a.id !== aerodromeId);
    
    // Construire le message de confirmation
    const totalDeleted = Object.values(itemsDeleted).reduce((a, b) => a + b, 0);
    let message = `Aérodrome "${aerodromeName}" supprimé avec succès.`;
    
    if (totalDeleted > 0) {
        message += `\n\nDonnées supprimées en cascade :`;
        if (itemsDeleted.certifications > 0) message += `\n- ${itemsDeleted.certifications} certification(s)`;
        if (itemsDeleted.homologations > 0) message += `\n- ${itemsDeleted.homologations} homologation(s)`;
        if (itemsDeleted.plannings > 0) message += `\n- ${itemsDeleted.plannings} planning(s)`;
        if (itemsDeleted.surveillances > 0) message += `\n- ${itemsDeleted.surveillances} surveillance(s)`;
        if (itemsDeleted.plansActions > 0) message += `\n- ${itemsDeleted.plansActions} plan(s) d'actions`;
        if (itemsDeleted.evenements > 0) message += `\n- ${itemsDeleted.evenements} événement(s)`;
    }
    
    return { success: true, message, itemsDeleted, totalDeleted };
}

function deleteInspectorWithCascade(inspectorId) {
    const inspector = inspectors.find(i => i.id === inspectorId);
    if (!inspector) return;
    
    const inspectorName = `${inspector.lastName} ${inspector.firstName}`;
    let itemsUpdated = {
        plannings: 0,
        surveillances: 0,
        dossiers: 0,
        formations: 0
    };
    
    // Retirer des plannings (équipe et chef)
    plannings.forEach(p => {
        if (p.equipe && p.equipe.includes(inspectorId)) {
            p.equipe = p.equipe.filter(id => id !== inspectorId);
            itemsUpdated.plannings++;
        }
        if (p.chef === inspectorId) {
            p.chef = '';
            itemsUpdated.plannings++;
        }
    });
    
    // Retirer des surveillances
    surveillances.forEach(s => {
        if (s.inspecteurs && s.inspecteurs.includes(inspectorId)) {
            s.inspecteurs = s.inspecteurs.filter(id => id !== inspectorId);
            itemsUpdated.surveillances++;
        }
    });
    
    // Retirer des dossiers
    dossiers.forEach(d => {
        if (d.inspectorId === inspectorId) {
            d.inspectorId = '';
            itemsUpdated.dossiers++;
        }
    });
    
    // Retirer des formations
    formations.forEach(f => {
        if (f.participants && f.participants.includes(inspectorId)) {
            f.participants = f.participants.filter(id => id !== inspectorId);
            itemsUpdated.formations++;
        }
    });
    
    // Supprimer l'inspecteur
    inspectors = inspectors.filter(i => i.id !== inspectorId);
    
    // Construire le message
    const totalUpdated = Object.values(itemsUpdated).reduce((a, b) => a + b, 0);
    let message = `Inspecteur "${inspectorName}" supprimé avec succès.`;
    
    if (totalUpdated > 0) {
        message += `\n\nDonnées mises à jour :`;
        if (itemsUpdated.plannings > 0) message += `\n- ${itemsUpdated.plannings} planning(s)`;
        if (itemsUpdated.surveillances > 0) message += `\n- ${itemsUpdated.surveillances} surveillance(s)`;
        if (itemsUpdated.dossiers > 0) message += `\n- ${itemsUpdated.dossiers} dossier(s)`;
        if (itemsUpdated.formations > 0) message += `\n- ${itemsUpdated.formations} formation(s)`;
    }
    
    return { success: true, message, itemsUpdated, totalUpdated };
}

function deleteFormationWithCascade(formationId) {
    const formation = formations.find(f => f.id === formationId);
    if (!formation) return;
    
    const formationTitle = formation.title;
    
    // Supprimer la formation
    formations = formations.filter(f => f.id !== formationId);
    
    return { 
        success: true, 
        message: `Formation "${formationTitle}" supprimée avec succès.`
    };
}

function deletePlanActionWithCascade(planActionId) {
    const plan = plansActions.find(p => p.id === planActionId);
    if (!plan) return;
    
    const planRef = plan.reference;
    const actionsCount = plan.actions?.length || 0;
    
    // Supprimer le plan d'action
    plansActions = plansActions.filter(p => p.id !== planActionId);
    
    let message = `Plan d'action "${planRef}" supprimé avec succès.`;
    if (actionsCount > 0) {
        message += `\n\n${actionsCount} action(s) corrective(s) supprimée(s).`;
    }
    
    return { success: true, message };
}

function deleteDossierWithCascade(dossierId) {
    const dossier = dossiers.find(d => d.id === dossierId);
    if (!dossier) return;
    
    const dossierRef = dossier.reference;
    const tasksCount = dossier.tasks?.length || 0;
    
    // Supprimer le dossier
    dossiers = dossiers.filter(d => d.id !== dossierId);
    
    let message = `Dossier "${dossierRef}" supprimé avec succès.`;
    if (tasksCount > 0) {
        message += `\n\n${tasksCount} tâche(s) supprimée(s).`;
    }
    
    return { success: true, message };
}

// Sauvegarder toutes les 30 secondes
setInterval(autoSaveAll, 30000);

// Sauvegarder avant fermeture
window.addEventListener('beforeunload', autoSaveAll);

        function enableAllButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.id !== 'btnNewUtilisateur' && button.id !== 'btnNewAlerte') {
                    button.disabled = false;
                }
            });
            
            // Activer spécifiquement les boutons de modification
            const editButtons = document.querySelectorAll('[onclick^="edit"]');
            editButtons.forEach(btn => btn.disabled = false);
            
            const deleteButtons = document.querySelectorAll('[onclick^="delete"]');
            deleteButtons.forEach(btn => btn.disabled = false);
        }

        function initAllForms() {
            // Initialiser les sélecteurs d'aérodromes
            updateAerodromeSelects();
            
            // Initialiser les sélecteurs d'inspecteurs
            updateInspectorSelects();
            
            // Initialiser les sélecteurs d'utilisateurs
            updateUserSelects();
        }

        // ============ FONCTIONS POUR AÉRODROMES ============
 
function createNewAerodrome() {
    // Réinitialiser la variable globale
    currentEditingAerodromeId = null;
    
    // Vider tous les champs
    document.getElementById('aerodromeId').value = '';
    document.getElementById('aerodromeCode').value = '';
    document.getElementById('aerodromeName').value = '';
    document.getElementById('aerodromeCity').value = '';
    document.getElementById('aerodromeRegion').value = '';
    document.getElementById('aerodromeType').value = 'International';
    document.getElementById('aerodromeStatus').value = 'En service';
    document.getElementById('aerodromeDescription').value = '';
    document.getElementById('aerodromeLatitude').value = '';
    document.getElementById('aerodromeLongitude').value = '';
    document.getElementById('aerodromeRiskLevel').value = 'Faible';
    
    openModal('modalAerodrome');
}

       function saveAerodrome() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée. Seul l\'administrateur peut créer/modifier des aérodromes.', 'error');
        return;
    }
    
    const code = document.getElementById('aerodromeCode').value;
    const name = document.getElementById('aerodromeName').value;
    const city = document.getElementById('aerodromeCity').value;
    const type = document.getElementById('aerodromeType').value;
    
    if (!code || !name || !city || !type) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        const existingId = currentEditingAerodromeId;
        
        // CORRECTION CRITIQUE : Utiliser les BONS noms de propriétés
        const aerodrome = {
            id: existingId || 'aerodrome-' + Date.now(),
            code: code,
            name: name,
            city: city,
            region: document.getElementById('aerodromeRegion').value,
            type: type,
            status: document.getElementById('aerodromeStatus').value,
            description: document.getElementById('aerodromeDescription').value,
            latitude: document.getElementById('aerodromeLatitude').value,
            longitude: document.getElementById('aerodromeLongitude').value,
            riskLevel: document.getElementById('aerodromeRiskLevel').value,
            
            // CORRECTION : Utiliser les BONS noms qui correspondent aux fonctions d'affichage
            dimensions: document.getElementById('aerodromeDimensions').value, // pas 'dimensionsPiste'
            revetement: document.getElementById('aerodromeRevetement').value,
            orientation: document.getElementById('aerodromeOrientation').value,
            approche: document.getElementById('aerodromeApproche').value,
            certification: document.getElementById('aerodromeCertification').value,
            homologation: document.getElementById('aerodromeHomologation').value,
            exploitant: document.getElementById('aerodromeExploitant').value,
            contactEmail: document.getElementById('aerodromeContactEmail').value,
            contactPhone: document.getElementById('aerodromeContactPhone').value,
            adresse: document.getElementById('aerodromeAdresse').value
        };
        
        if (existingId) {
            // MODE MODIFICATION
            const existingIndex = aerodromes.findIndex(a => a.id === existingId);
            if (existingIndex >= 0) {
                aerodromes[existingIndex] = aerodrome;
                showNotification('Aérodrome modifié avec succès!', 'success');
            } else {
                showNotification('Erreur : Aérodrome non trouvé', 'error');
                hideLoading();
                return;
            }
        } else {
            // MODE CRÉATION
            aerodromes.push(aerodrome);
            showNotification('Aérodrome créé avec succès!', 'success');
        }
        
        // RÉINITIALISER la variable globale
        currentEditingAerodromeId = null;
        
        closeModal('modalAerodrome');
        loadAerodromes();
        updateAerodromeSelects();
        updateDashboard();
        hideLoading();
        saveAllData();
    }, 800);
}

// Fonction pour gérer l'état certification/homologation basé sur le type d'aérodrome
function updateCertHomologState() {
    const typeAerodrome = document.getElementById('aerodromeType').value;
    const certificationField = document.getElementById('aerodromeCertification');
    const homologationField = document.getElementById('aerodromeHomologation');
    const certLabel = document.getElementById('certificationLabel');
    const homologLabel = document.getElementById('homologationLabel');
    
    // Réinitialiser tous les champs
    certificationField.disabled = false;
    homologationField.disabled = false;
    certificationField.style.display = 'block';
    homologationField.style.display = 'block';
    certLabel.style.display = 'block';
    homologLabel.style.display = 'block';
    
    if (typeAerodrome === 'International') {
        // International : AFFICHER UNIQUEMENT certification
        homologationField.disabled = true;
        homologationField.style.display = 'none';
        homologLabel.style.display = 'none';
        homologationField.value = '';
        
        certificationField.disabled = false;
        certificationField.style.display = 'block';
        certLabel.style.display = 'block';
        certLabel.innerHTML = 'Statut Certification <span style="color: var(--primary-color);">*</span>';
        
    } else if (['National', 'Régional', 'Piste d\'atterrissage', 'Héliport'].includes(typeAerodrome)) {
        // Non-international : AFFICHER UNIQUEMENT homologation
        certificationField.disabled = true;
        certificationField.style.display = 'none';
        certLabel.style.display = 'none';
        certificationField.value = '';
        
        homologationField.disabled = false;
        homologationField.style.display = 'block';
        homologLabel.style.display = 'block';
        homologLabel.innerHTML = 'Statut Homologation <span style="color: var(--primary-color);">*</span>';
        
    } else {
        // Type non sélectionné : cacher les deux
        certificationField.style.display = 'none';
        homologationField.style.display = 'none';
        certLabel.style.display = 'none';
        homologLabel.style.display = 'none';
    }
}

// Mettre à jour quand le type change
function updateCertificationState() {
    const typeAerodrome = document.getElementById('aerodromeType').value;
    if (typeAerodrome === 'International') {
        document.getElementById('aerodromeHomologation').value = '';
    }
}

function updateHomologationState() {
    const typeAerodrome = document.getElementById('aerodromeType').value;
    if (typeAerodrome !== 'International') {
        document.getElementById('aerodromeCertification').value = '';
    }
}

// Appeler cette fonction au chargement du modal
function initAerodromeModal() {
    updateCertHomologState();
}

function openNewAerodromeModal() {
    // Réinitialiser la variable globale
    currentEditingAerodromeId = null;
    
    // Vider TOUS les champs
    document.getElementById('aerodromeId').value = '';
    document.getElementById('aerodromeCode').value = '';
    document.getElementById('aerodromeName').value = '';
    document.getElementById('aerodromeCity').value = '';
    document.getElementById('aerodromeRegion').value = '';
    document.getElementById('aerodromeType').value = 'International';
    document.getElementById('aerodromeStatus').value = 'En service';
    document.getElementById('aerodromeDescription').value = '';
    document.getElementById('aerodromeLatitude').value = '';
    document.getElementById('aerodromeLongitude').value = '';
    document.getElementById('aerodromeRiskLevel').value = 'Faible';
    
    // Vider les nouveaux champs
    document.getElementById('aerodromeDimensions').value = '';
    document.getElementById('aerodromeRevetement').value = '';
    document.getElementById('aerodromeOrientation').value = '';
    document.getElementById('aerodromeApproche').value = '';
    document.getElementById('aerodromeCertification').value = '';
    document.getElementById('aerodromeHomologation').value = '';
    document.getElementById('aerodromeExploitant').value = '';
    document.getElementById('aerodromeContactEmail').value = '';
    document.getElementById('aerodromeContactPhone').value = '';
    document.getElementById('aerodromeAdresse').value = '';
    
    // Initialiser l'état des champs certification/homologation
    updateCertHomologState();
    
    openModal('modalAerodrome');
}

        function loadAerodromes() {
    const container = document.getElementById('aerodromesList');
    const select = document.getElementById('selectAerodromeDetails');
    
    if (aerodromes.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-plane" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5; display: block;"></i>
                <h3>Aucun aérodrome enregistré</h3>
                <p>Cliquez sur "Nouvel Aérodrome" pour commencer</p>
            </div>
        `;
        select.innerHTML = '<option value="">Sélectionner un aérodrome...</option>';
        return;
    }
    
    // NOUVEAU : Pagination
    const itemsPerPage = 10;
    const currentPage = window.currentAerodromePage || 1;
    const totalPages = Math.ceil(aerodromes.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageAerodromes = aerodromes.slice(startIndex, endIndex);
    
    // En-tête avec statistiques et contrôles
    let html = `
        <div style="grid-column: 1 / -1; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0 0 10px 0; font-size: 22px;"><i class="fas fa-plane"></i> Gestion des Aérodromes</h3>
                    <p style="margin: 0; opacity: 0.9;">Total : ${aerodromes.length} aérodrome(s) • Page ${currentPage} sur ${totalPages}</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="toggleAerodromeView()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-th-list"></i> <span id="viewModeLabel">Vue Compacte</span>
                    </button>
                    <button onclick="sortAerodromesByName()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-sort-alpha-down"></i> Trier
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // AFFICHAGE EN GRILLE 2 COLONNES
    html += pageAerodromes.map(aerodrome => {
        // Classes CSS pour les statuts
        let riskClass = 'status-low-risk';
        if (aerodrome.riskLevel === 'Moyen') riskClass = 'status-medium-risk';
        else if (aerodrome.riskLevel === 'Élevé') riskClass = 'status-high-risk';
        
        let statusClass = 'status-active';
        if (aerodrome.status === 'Fermé') statusClass = 'status-closed';
        else if (aerodrome.status === 'En construction') statusClass = 'status-pending';
        else if (aerodrome.status === 'En rénovation') statusClass = 'status-intraining';
        
        const showCertification = aerodrome.type === 'International';
        const statusToShow = showCertification ? aerodrome.certification : aerodrome.homologation;
        const statusType = showCertification ? 'Certification' : 'Homologation';
        const statusIcon = showCertification ? 'fa-certificate' : 'fa-check-circle';
        
        const caracteristiques = [];
        if (aerodrome.dimensions) caracteristiques.push({label: 'Dimensions', value: aerodrome.dimensions});
        if (aerodrome.revetement) caracteristiques.push({label: 'Revêtement', value: aerodrome.revetement});
        if (aerodrome.orientation) caracteristiques.push({label: 'Orientation', value: aerodrome.orientation});
        if (aerodrome.approche) caracteristiques.push({label: 'Approche', value: aerodrome.approche});
        
        return `
            <div class="aerodrome-card" onclick="showAerodromeDetails('${aerodrome.id}')" 
                 style="cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;">
                
                <!-- Badge de statut positionné en haut à droite -->
                <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                    <div class="status-badge ${riskClass}" style="margin-bottom: 5px;">${aerodrome.riskLevel}</div>
                    <div class="status-badge ${statusClass}">${aerodrome.status}</div>
                </div>
                
                <div class="aerodrome-header" style="padding-right: 120px;">
                    <div>
                        <div class="aerodrome-code">${aerodrome.code}</div>
                        <div class="aerodrome-name">${aerodrome.name}</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 5px;">
                            <i class="fas fa-map-marker-alt"></i> ${aerodrome.city}${aerodrome.region ? ', ' + aerodrome.region : ''}
                        </div>
                    </div>
                </div>
                
                <!-- CARACTÉRISTIQUES COMPACTES -->
                <div style="margin: 15px 0; padding: 12px; background: var(--light-bg); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                        <div><strong>Type:</strong> ${aerodrome.type}</div>
                        ${aerodrome.dimensions ? `<div><strong>Piste:</strong> ${aerodrome.dimensions}</div>` : '<div style="color: var(--text-secondary); font-style: italic;">Piste non définie</div>'}
                        ${aerodrome.revetement ? `<div><strong>Revêtement:</strong> ${aerodrome.revetement}</div>` : ''}
                        ${statusToShow ? `
                        <div>
                            <strong>${statusType}:</strong> 
                            <span class="status-badge ${statusToShow === 'Certifié' || statusToShow === 'Homologué' ? 'status-completed' : 'status-pending'}" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas ${statusIcon}"></i> ${statusToShow}
                            </span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${caracteristiques.length < 2 ? `
                    <div style="margin-top: 8px; padding: 6px; background: rgba(255, 152, 0, 0.1); border-radius: 4px; font-size: 11px; color: var(--warning-color); border-left: 3px solid var(--warning-color);">
                        <i class="fas fa-exclamation-circle"></i> Informations incomplètes
                    </div>
                    ` : ''}
                    
                    ${aerodrome.exploitant ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 11px; color: var(--text-secondary);">
                        <i class="fas fa-building"></i> ${aerodrome.exploitant}
                    </div>
                    ` : ''}
                </div>
                
                <!-- ACTIONS COMPACTES -->
                <div style="margin-top: 12px; display: flex; gap: 6px;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); editAerodrome('${aerodrome.id}')" 
                            style="flex: 1; padding: 6px 10px; font-size: 12px;">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button class="btn btn-info" onclick="event.stopPropagation(); showAerodromeDetails('${aerodrome.id}')" 
                            style="flex: 1; padding: 6px 10px; font-size: 12px;">
                        <i class="fas fa-eye"></i> Détails
                    </button>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); deleteAerodrome('${aerodrome.id}')" 
                            style="padding: 6px 12px; font-size: 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // PAGINATION
    if (totalPages > 1) {
        html += `
            <div style="grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px; background: var(--light-bg); border-radius: 12px;">
                <button onclick="changeAerodromePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''} 
                        class="btn btn-secondary" style="padding: 8px 15px;">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                
                <div style="display: flex; gap: 5px;">
                    ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
                        <button onclick="changeAerodromePage(${page})" 
                                class="btn ${page === currentPage ? 'btn-primary' : 'btn-secondary'}" 
                                style="padding: 8px 12px; min-width: 40px;">
                            ${page}
                        </button>
                    `).join('')}
                </div>
                
                <button onclick="changeAerodromePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''} 
                        class="btn btn-secondary" style="padding: 8px 15px;">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }
    
    container.innerHTML = html;
    
    // Mettre à jour le sélecteur
    select.innerHTML = '<option value="">Sélectionner un aérodrome...</option>' + 
        aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name} (${a.city})</option>`).join('');
}

// Fonction pour changer de page
function changeAerodromePage(page) {
    const totalPages = Math.ceil(aerodromes.length / 10);
    if (page < 1 || page > totalPages) return;
    
    window.currentAerodromePage = page;
    loadAerodromes();
    
    // Scroll vers le haut de la liste
    document.getElementById('aerodromesList').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Fonction pour basculer entre vue compacte et vue détaillée
// Fonction pour basculer entre vue compacte et vue détaillée
function toggleAerodromeView() {
    // Initialiser si n'existe pas
    if (!window.aerodromeViewMode) {
        window.aerodromeViewMode = 'compact';
    }
    
    // Basculer
    window.aerodromeViewMode = window.aerodromeViewMode === 'detailed' ? 'compact' : 'detailed';
    
    const label = document.getElementById('viewModeLabel');
    if (label) {
        if (window.aerodromeViewMode === 'detailed') {
            label.innerHTML = '<i class="fas fa-th"></i> Vue Détaillée';
        } else {
            label.innerHTML = '<i class="fas fa-th-list"></i> Vue Compacte';
        }
    }
    
    showNotification(`Passage en ${window.aerodromeViewMode === 'detailed' ? 'vue détaillée' : 'vue compacte'}`, 'info');
    loadAerodromes();
}

// Fonction pour trier les aérodromes par nom
function sortAerodromesByName() {
    window.aerodromeSortOrder = window.aerodromeSortOrder === 'asc' ? 'desc' : 'asc';
    
    aerodromes.sort((a, b) => {
        if (window.aerodromeSortOrder === 'asc') {
            return a.name.localeCompare(b.name);
        } else {
            return b.name.localeCompare(a.name);
        }
    });
    
    showNotification(`Tri ${window.aerodromeSortOrder === 'asc' ? 'A→Z' : 'Z→A'}`, 'info');
    loadAerodromes();
}

	// Fonction pour gérer le basculement entre certification et homologation
// Fonction principale pour gérer l'état des champs
function manageCertificationHomologation() {
    const typeAerodrome = document.getElementById('aerodromeType').value;
    const homologationField = document.getElementById('aerodromeHomologation');
    const certificationField = document.getElementById('aerodromeCertification');
    
    // Réinitialiser les états
    homologationField.disabled = false;
    certificationField.disabled = false;
    
    if (typeAerodrome === 'International') {
        // International : priorité à la certification
        homologationField.disabled = true;
        homologationField.value = '';
        
        // Si certification sélectionnée, garder l'homologation désactivée
        const certValue = certificationField.value;
        if (certValue === 'Certifié' || certValue === 'À certifier') {
            homologationField.disabled = true;
            homologationField.value = '';
        }
    } else {
        // Non-international : priorité à l'homologation
        certificationField.disabled = true;
        certificationField.value = '';
        
        // Si homologation sélectionnée, garder la certification désactivée
        const homologValue = homologationField.value;
        if (homologValue === 'Homologué' || homologValue === 'À homologuer') {
            certificationField.disabled = true;
            certificationField.value = '';
        }
    }
}

// Appeler cette fonction lors des changements
function updateHomologationState() {
    manageCertificationHomologation();
}

        function loadFilteredAerodromes(filteredList) {
    const container = document.getElementById('aerodromesList');
    
    // Si la liste filtrée est vide, afficher un message
    if (filteredList.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5; display: block;"></i>
                <h3>Aucun résultat trouvé</h3>
                <p>Aucun aérodrome ne correspond à votre recherche</p>
            </div>
        `;
        return;
    }
    
    // Si vous avez une pagination via loadAerodromes, l'utiliser
    if (typeof loadAerodromes === 'function' && typeof aerodromes !== 'undefined') {
        // Sauvegarder temporairement les aérodromes complets
        const originalAerodromes = [...aerodromes];
        
        // Remplacer temporairement pour utiliser loadAerodromes
        aerodromes = filteredList;
        window.currentAerodromePage = 1; // Réinitialiser à la page 1
        
        loadAerodromes();
        
        // Restaurer les aérodromes originaux
        aerodromes = originalAerodromes;
    } else {
        // Sinon, utiliser le rendu direct (version originale)
        container.innerHTML = filteredList.map(aerodrome => {
            let riskClass = 'status-low-risk';
            if (aerodrome.riskLevel === 'Moyen') riskClass = 'status-medium-risk';
            else if (aerodrome.riskLevel === 'Élevé') riskClass = 'status-high-risk';
            
            let statusClass = 'status-active';
            if (aerodrome.status === 'Fermé') statusClass = 'status-closed';
            else if (aerodrome.status === 'En construction') statusClass = 'status-pending';
            else if (aerodrome.status === 'En rénovation') statusClass = 'status-intraining';
            
            return `
                <div class="aerodrome-card">
                    <div class="aerodrome-header">
                        <div>
                            <div class="aerodrome-code">${aerodrome.code}</div>
                            <div class="aerodrome-name">${aerodrome.name}</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                ${aerodrome.city} • ${aerodrome.region}
                            </div>
                        </div>
                        <div>
                            <span class="status-badge ${riskClass}" style="margin-right: 10px;">
                                ${aerodrome.riskLevel}
                            </span>
                            <span class="status-badge ${statusClass}">
                                ${aerodrome.status}
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <div style="font-size: 14px; margin-bottom: 15px;">
                            ${aerodrome.description || 'Pas de description'}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div>
                                <strong>Type:</strong> ${aerodrome.type}
                            </div>
                            <div>
                                <strong>Coordonnées:</strong> 
                                ${aerodrome.latitude ? aerodrome.latitude + ', ' + aerodrome.longitude : 'Non spécifiées'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="editAerodrome('${aerodrome.id}')" style="flex: 1;">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn btn-info" onclick="viewAerodromeDetails('${aerodrome.id}')" style="flex: 1;">
                            <i class="fas fa-eye"></i> Détails
                        </button>
                        <button class="btn btn-danger" onclick="deleteAerodrome('${aerodrome.id}')" style="flex: 1;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

       function editAerodrome(id) {
    if (!checkPermission('write')) {
        showNotification('Permission refusée. Seul l\'administrateur peut modifier des aérodromes.', 'error');
        return;
    }
    
    const aerodrome = aerodromes.find(a => a.id === id);
    if (!aerodrome) {
        showNotification('Aérodrome non trouvé', 'error');
        return;
    }
    
    // STOCKER l'ID dans la variable globale
    currentEditingAerodromeId = aerodrome.id;
    
    // Remplir TOUS les champs
    document.getElementById('aerodromeId').value = aerodrome.id;
    document.getElementById('aerodromeCode').value = aerodrome.code;
    document.getElementById('aerodromeName').value = aerodrome.name;
    document.getElementById('aerodromeCity').value = aerodrome.city;
    document.getElementById('aerodromeRegion').value = aerodrome.region || '';
    document.getElementById('aerodromeType').value = aerodrome.type || 'International';
    document.getElementById('aerodromeStatus').value = aerodrome.status;
    document.getElementById('aerodromeDescription').value = aerodrome.description || '';
    document.getElementById('aerodromeLatitude').value = aerodrome.latitude || '';
    document.getElementById('aerodromeLongitude').value = aerodrome.longitude || '';
    document.getElementById('aerodromeRiskLevel').value = aerodrome.riskLevel || 'Faible';
    
    // AJOUT : Remplir les nouveaux champs
    document.getElementById('aerodromeDimensions').value = aerodrome.dimensions || '';
    document.getElementById('aerodromeRevetement').value = aerodrome.revetement || '';
    document.getElementById('aerodromeOrientation').value = aerodrome.orientation || '';
    document.getElementById('aerodromeApproche').value = aerodrome.approche || '';
    document.getElementById('aerodromeCertification').value = aerodrome.certification || '';
    document.getElementById('aerodromeHomologation').value = aerodrome.homologation || '';
    document.getElementById('aerodromeExploitant').value = aerodrome.exploitant || '';
    document.getElementById('aerodromeContactEmail').value = aerodrome.contactEmail || '';
    document.getElementById('aerodromeContactPhone').value = aerodrome.contactPhone || '';
    document.getElementById('aerodromeAdresse').value = aerodrome.adresse || '';
    
    // Mettre à jour l'état des champs certification/homologation
    updateCertHomologState();
    
    // Ouvrir le modal
    openModal('modalAerodrome');
}

        function deleteAerodrome(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée. Seul l\'administrateur peut supprimer des aérodromes.', 'error');
        return;
    }
    
    const aerodrome = aerodromes.find(a => a.id === id);
    if (!aerodrome) return;
    
    // Compter les données liées
    const certsCount = certifications.filter(c => c.aerodromeId === id).length;
    const homologsCount = homologations.filter(h => h.aerodromeId === id).length;
    const planningsCount = plannings.filter(p => p.aerodromeId === id).length;
    const surveillancesCount = surveillances.filter(s => s.aerodromeId === id).length;
    const plansActionsCount = plansActions.filter(p => p.aerodromeId === id).length;
    const evenementsCount = evenements.filter(e => e.aerodromeId === id).length;
    
    const totalLinked = certsCount + homologsCount + planningsCount + surveillancesCount + plansActionsCount + evenementsCount;
    
    let confirmMessage = `Êtes-vous sûr de vouloir supprimer l'aérodrome "${aerodrome.name}" ?`;
    
    if (totalLinked > 0) {
        confirmMessage += `\n\⚠️ ATTENTION : Cela supprimera également :`;
        if (certsCount > 0) confirmMessage += `\n- ${certsCount} certification(s)`;
        if (homologsCount > 0) confirmMessage += `\n- ${homologsCount} homologation(s)`;
        if (planningsCount > 0) confirmMessage += `\n- ${planningsCount} planning(s)`;
        if (surveillancesCount > 0) confirmMessage += `\n- ${surveillancesCount} surveillance(s)`;
        if (plansActionsCount > 0) confirmMessage += `\n- ${plansActionsCount} plan(s) d'actions`;
        if (evenementsCount > 0) confirmMessage += `\n- ${evenementsCount} événement(s)`;
        confirmMessage += `\n\nCette action est irréversible !`;
    }
    
    if (confirm(confirmMessage)) {
        showLoading();
        
        setTimeout(() => {
            const result = deleteAerodromeWithCascade(id);
            
            if (result.success) {
                loadAerodromes();
                updateAerodromeSelects();
                updateDashboard();
                updateAlertes();
                updateAllCalendars();
                autoSaveAll();
                
                hideLoading();
                
                // Afficher un message détaillé
                alert(result.message);
                showNotification('Suppression effectuée avec succès', 'success');
            }
        }, 300);
    }
}

function viewAerodromeDetails(id) {
            const aerodrome = aerodromes.find(a => a.id === id);
            if (aerodrome) {
                const details = `
                    <div class="aerodrome-detail-card">
                        <div class="aerodrome-detail-section">
                            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                                <i class="fas fa-info-circle"></i> Informations Générales
                            </h3>
                            <div class="detail-row">
                                <div>
                                    <div class="detail-label">Code OACI</div>
                                    <div class="detail-value">${aerodrome.code}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Nom</div>
                                    <div class="detail-value">${aerodrome.name}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Ville</div>
                                    <div class="detail-value">${aerodrome.city}</div>
                                </div>
                            </div>
                            <div class="detail-row">
                                <div>
                                    <div class="detail-label">Région</div>
                                    <div class="detail-value">${aerodrome.region || 'Non spécifiée'}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Type</div>
                                    <div class="detail-value">${aerodrome.type}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Statut</div>
                                    <div class="detail-value">${aerodrome.status}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="aerodrome-detail-section">
                            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                                <i class="fas fa-map-marker-alt"></i> Localisation
                            </h3>
                            <div class="detail-row">
                                <div>
                                    <div class="detail-label">Latitude</div>
                                    <div class="detail-value">${aerodrome.latitude || 'Non spécifiée'}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Longitude</div>
                                    <div class="detail-value">${aerodrome.longitude || 'Non spécifiée'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="aerodrome-detail-section">
                            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                                <i class="fas fa-radiation"></i> Niveau de Risque
                            </h3>
                            <div style="text-align: center;">
                                <div class="risk-level-indicator ${aerodrome.riskLevel?.toLowerCase() || 'low'}">
                                    ${aerodrome.riskLevel || 'Faible'}
                                </div>
                                <p style="margin-top: 15px; color: var(--text-secondary);">
                                    Niveau de risque actuel de l'aérodrome
                                </p>
                            </div>
                        </div>
                        
                        <div class="aerodrome-detail-section">
                            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                                <i class="fas fa-align-left"></i> Description
                            </h3>
                            <div class="detail-value" style="line-height: 1.8;">
                                ${aerodrome.description || 'Aucune description disponible'}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('aerodromeDetailsSection').innerHTML = details;
                document.getElementById('aerodromeDetailsSection').style.display = 'block';
            }
        }

function showAllAerodromeDetails() {
            if (aerodromes.length === 0) {
                showNotification('Aucun aérodrome à afficher', 'warning');
                return;
            }
            
            const allDetails = aerodromes.map(aerodrome => {
                return `
                    <div class="aerodrome-detail-card" style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">
                            ${aerodrome.code} - ${aerodrome.name}
                        </h3>
                        <div class="detail-row">
                            <div>
                                <div class="detail-label">Ville</div>
                                <div class="detail-value">${aerodrome.city}</div>
                            </div>
                            <div>
                                <div class="detail-label">Type</div>
                                <div class="detail-value">${aerodrome.type}</div>
                            </div>
                            <div>
                                <div class="detail-label">Statut</div>
                                <div class="detail-value">${aerodrome.status}</div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div>
                                <div class="detail-label">Région</div>
                                <div class="detail-value">${aerodrome.region || 'Non spécifiée'}</div>
                            </div>
                            <div>
                                <div class="detail-label">Niveau de Risque</div>
                                <div class="detail-value">
                                    <span class="status-badge ${aerodrome.riskLevel === 'Moyen' ? 'status-medium-risk' : aerodrome.riskLevel === 'Élevé' ? 'status-high-risk' : 'status-low-risk'}">
                                        ${aerodrome.riskLevel}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('aerodromeDetailsSection').innerHTML = allDetails;
            document.getElementById('aerodromeDetailsSection').style.display = 'block';
        }

function showAerodromeDetails(id) {
    if (!id) {
        hideAerodromeDetails();
        return;
    }
    
    const aerodrome = aerodromes.find(a => a.id === id);
    if (!aerodrome) return;
    
    // Collecter les données liées
    const certifs = certifications.filter(c => c.aerodromeId === id);
    const homologs = homologations.filter(h => h.aerodromeId === id);
    const surveillancesAero = surveillances.filter(s => s.aerodromeId === id);
    const plansActionsAero = plansActions.filter(pa => pa.aerodromeId === id);
    const eventsAero = evenements.filter(e => e.aerodromeId === id);
    const dossiersAero = dossiers.filter(d => d.aerodromeId === id);
    
    // Calculs
    const certifEnCours = certifs.filter(c => c.status === 'En cours').length;
    const inspectionsTerminees = surveillancesAero.filter(s => s.status === 'Terminé' || s.status === 'Validé').length;
    const conformites = surveillancesAero.map(s => s.conformite || 0).filter(c => c > 0);
    const conformiteMoyenne = conformites.length > 0 
        ? Math.round(conformites.reduce((sum, s) => sum + s, 0) / conformites.length)
        : 0;
    const plansEnCours = plansActionsAero.filter(p => p.status === 'En cours').length;
    
    // Déterminer certification ou homologation
    const showCertification = aerodrome.type === 'International';
    const statusToShow = showCertification ? aerodrome.certification : aerodrome.homologation;
    const statusType = showCertification ? 'Certification' : 'Homologation';
    const statusIcon = showCertification ? 'fa-certificate' : 'fa-check-circle';
    const statusClass = (statusToShow === 'Certifié' || statusToShow === 'Homologué') ? 'status-completed' : 'status-pending';
    
    // Construire le HTML
    let details = '<div class="aerodrome-detail-card" style="position: relative; padding: 30px;">';
    
    // Bouton de fermeture (AMÉLIORÉ)
    details += '<button onclick="hideAerodromeDetails();" ';
    details += 'style="position: absolute; top: 20px; right: 20px; background: white; color: var(--danger-color); border: 2px solid var(--danger-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s;" ';
    details += 'onmouseover="this.style.backgroundColor=\'var(--danger-color)\'; this.style.color=\'white\'" ';
    details += 'onmouseout="this.style.backgroundColor=\'white\'; this.style.color=\'var(--danger-color)\'" ';
    details += 'title="Fermer les détails">';
    details += '<i class="fas fa-times"></i>';
    details += '</button>';
    
    // En-tête
    details += '<div style="margin-bottom: 30px;">';
    details += '<h2 style="color: var(--primary-color); margin: 0 0 10px 0; font-size: 28px;">';
    details += '<i class="fas fa-plane"></i> ' + aerodrome.code + ' - ' + aerodrome.name;
    details += '</h2>';
    details += '<div style="display: flex; gap: 15px; color: var(--text-secondary); font-size: 16px;">';
    details += '<span><i class="fas fa-map-marker-alt"></i> ' + aerodrome.city + ', ' + aerodrome.region + '</span>';
    details += '<span><i class="fas fa-' + (showCertification ? 'certificate' : 'check-circle') + '"></i> ' + aerodrome.type + '</span>';
    details += '</div>';
    details += '</div>';
    
    // ==================== INFORMATIONS GÉNÉRALES ====================
    details += '<div style="margin-bottom: 40px;">';
    details += '<h3 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">';
    details += '<i class="fas fa-info-circle"></i> Informations Générales';
    details += '</h3>';
    
    details += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">';
    
    // Colonne gauche - Identification
    details += '<div>';
    details += '<div style="background: var(--light-bg); padding: 20px; border-radius: 12px; height: 100%;">';
    details += '<h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">Identification</h4>';
    
    details += '<div style="display: grid; gap: 12px;">';
    details += '<div><strong>Code OACI:</strong><br><span style="color: var(--text-primary);">' + aerodrome.code + '</span></div>';
    details += '<div><strong>Ville:</strong><br><span style="color: var(--text-primary);">' + aerodrome.city + '</span></div>';
    details += '<div><strong>Région:</strong><br><span style="color: var(--text-primary);">' + (aerodrome.region || 'Non spécifiée') + '</span></div>';
    details += '<div><strong>Statut Opérationnel:</strong><br>';
    details += '<span class="status-badge ' + (aerodrome.status === 'En service' ? 'status-active' : 'status-closed') + '">';
    details += aerodrome.status;
    details += '</span></div>';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    
        // Colonne centre - Caractéristiques
    details += '<div>';
    details += '<div style="background: var(--light-bg); padding: 20px; border-radius: 12px; height: 100%;">';
    details += '<h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">Caractéristiques de la Piste</h4>';
    
    // Vérifier si des caractéristiques existent
    const hasCharacteristics = aerodrome.dimensions || aerodrome.revetement || aerodrome.orientation || aerodrome.approche;
    
    if (hasCharacteristics) {
        details += '<div style="display: grid; gap: 12px;">';
        
        // Type d'Aérodrome (toujours présent)
        details += '<div><strong>Type d\'Aérodrome:</strong><br><span style="color: var(--text-primary);">' + aerodrome.type + '</span></div>';
        
        // Dimensions de la piste
        if (aerodrome.dimensions) {
            details += '<div><strong>Dimensions de la piste:</strong><br><span style="color: var(--text-primary);">' + aerodrome.dimensions + '</span></div>';
        } else {
            details += '<div><strong>Dimensions de la piste:</strong><br><span style="color: var(--text-secondary); font-style: italic;">Non spécifiées</span></div>';
        }
        
        // Revêtement
        if (aerodrome.revetement) {
            details += '<div><strong>Revêtement:</strong><br><span style="color: var(--text-primary);">' + aerodrome.revetement + '</span></div>';
        } else {
            details += '<div><strong>Revêtement:</strong><br><span style="color: var(--text-secondary); font-style: italic;">Non spécifié</span></div>';
        }
        
        // Orientation
        if (aerodrome.orientation) {
            details += '<div><strong>Orientation:</strong><br><span style="color: var(--text-primary);">' + aerodrome.orientation + '</span></div>';
        } else {
            details += '<div><strong>Orientation:</strong><br><span style="color: var(--text-secondary); font-style: italic;">Non spécifiée</span></div>';
        }
        
        // Type d'Approche
        if (aerodrome.approche) {
            details += '<div><strong>Type d\'Approche:</strong><br><span style="color: var(--text-primary);">' + aerodrome.approche + '</span></div>';
        } else {
            details += '<div><strong>Type d\'Approche:</strong><br><span style="color: var(--text-secondary); font-style: italic;">Non spécifié</span></div>';
        }
        
        details += '</div>';
    } else {
        // Aucune caractéristique disponible
        details += '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">';
        details += '<i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>';
        details += '<p>Aucune caractéristique de piste renseignée</p>';
        details += '<button class="btn btn-primary" onclick="editAerodrome(\'' + aerodrome.id + '\'); closeModal(\'modalAllEcarts\')" style="margin-top: 10px;">';
        details += '<i class="fas fa-edit"></i> Ajouter les caractéristiques';
        details += '</button>';
        details += '</div>';
    }
    
    details += '</div>';
    details += '</div>';
    
    // Colonne droite - Statut et Contact
    details += '<div>';
    details += '<div style="background: var(--light-bg); padding: 20px; border-radius: 12px; height: 100%;">';
    details += '<h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 16px;">Statut et Contact</h4>';
    
    details += '<div style="display: grid; gap: 12px;">';
    
    // Certification/Homologation
    details += '<div><strong>' + statusType + ':</strong><br>';
    if (statusToShow) {
        details += '<span class="status-badge ' + statusClass + '" style="margin-top: 5px; display: inline-block;">';
        details += '<i class="fas ' + statusIcon + '"></i> ' + statusToShow;
        details += '</span>';
    } else {
        details += '<span style="color: var(--text-secondary);">Non spécifié</span>';
    }
    details += '</div>';
    
    // Niveau de risque
    let riskClass = 'status-low-risk';
    if (aerodrome.riskLevel === 'Élevé') riskClass = 'status-high-risk';
    else if (aerodrome.riskLevel === 'Moyen') riskClass = 'status-medium-risk';
    
    details += '<div><strong>Niveau de Risque:</strong><br>';
    details += '<span class="status-badge ' + riskClass + '" style="margin-top: 5px; display: inline-block;">';
    details += aerodrome.riskLevel;
    details += '</span></div>';
    
    // Exploitant
    if (aerodrome.exploitant) {
        details += '<div><strong>Exploitant:</strong><br><span style="color: var(--text-primary);">' + aerodrome.exploitant + '</span></div>';
    }
    
    // Contact
    if (aerodrome.contactPhone) {
        details += '<div><strong>Téléphone:</strong><br><span style="color: var(--text-primary);">' + aerodrome.contactPhone + '</span></div>';
    }
    
    details += '</div>';
    details += '</div>';
    details += '</div>';
    
    details += '</div>'; // Fin de la grid
    
    // Description
    if (aerodrome.description) {
        details += '<div style="margin-top: 20px; padding: 20px; background: var(--light-bg); border-radius: 12px;">';
        details += '<h4 style="color: var(--primary-color); margin-bottom: 10px; font-size: 16px;">Description</h4>';
        details += '<p style="color: var(--text-primary); line-height: 1.6;">' + aerodrome.description + '</p>';
        details += '</div>';
    }
    
    details += '</div>'; // Fin de la section informations générales
    
    // ==================== ACTIVITÉS ET DOCUMENTS ====================
    details += '<div style="margin-bottom: 40px;">';
    details += '<h3 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">';
    details += '<i class="fas fa-chart-bar"></i> Activités et Documents';
    details += '</h3>';
    
    details += '<div class="dashboard-grid" style="margin-top: 20px;">';
    
    // Certifications/Homologations
    details += '<div class="stat-card" style="cursor: pointer;" onclick="showTab(\'' + (showCertification ? 'certification' : 'homologation') + '\'); filterByAerodrome(\'' + aerodrome.id + '\')">';
    details += '<div style="display: flex; align-items: center; gap: 15px;">';
    details += '<div style="width: 60px; height: 60px; background: ' + (showCertification ? 'var(--primary-color)' : 'var(--success-color)') + '; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">';
    details += '<i class="fas ' + statusIcon + '"></i>';
    details += '</div>';
    details += '<div>';
    details += '<div style="font-size: 14px; color: var(--text-secondary);">' + statusType + 's</div>';
    details += '<h3 style="margin: 5px 0; color: ' + (showCertification ? 'var(--primary-color)' : 'var(--success-color)') + ';">' + (showCertification ? certifs.length : homologs.length) + '</h3>';
    details += '<div style="font-size: 12px; color: var(--text-secondary);">';
    details += certifEnCours + ' en cours';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    
    // Inspections
    details += '<div class="stat-card" style="cursor: pointer;" onclick="showTab(\'surveillance\'); filterByAerodrome(\'' + aerodrome.id + '\')">';
    details += '<div style="display: flex; align-items: center; gap: 15px;">';
    details += '<div style="width: 60px; height: 60px; background: var(--info-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">';
    details += '<i class="fas fa-eye"></i>';
    details += '</div>';
    details += '<div>';
    details += '<div style="font-size: 14px; color: var(--text-secondary);">Inspections</div>';
    details += '<h3 style="margin: 5px 0; color: var(--info-color);">' + surveillancesAero.length + '</h3>';
    details += '<div style="font-size: 12px; color: var(--text-secondary);">';
    details += inspectionsTerminees + ' terminées';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    
    // Conformité
    details += '<div class="stat-card">';
    details += '<div style="display: flex; align-items: center; gap: 15px;">';
    details += '<div style="width: 60px; height: 60px; background: ' + (conformiteMoyenne >= 80 ? 'var(--success-color)' : conformiteMoyenne >= 60 ? 'var(--warning-color)' : 'var(--danger-color)') + '; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">';
    details += '<i class="fas fa-chart-line"></i>';
    details += '</div>';
    details += '<div>';
    details += '<div style="font-size: 14px; color: var(--text-secondary);">Conformité Moyenne</div>';
    details += '<h3 style="margin: 5px 0; color: ' + (conformiteMoyenne >= 80 ? 'var(--success-color)' : conformiteMoyenne >= 60 ? 'var(--warning-color)' : 'var(--danger-color)') + ';">' + conformiteMoyenne + '%</h3>';
    details += '<div class="progress-bar" style="margin-top: 8px;">';
    details += '<div class="progress-fill" style="width: ' + conformiteMoyenne + '%; background: ' + (conformiteMoyenne >= 80 ? 'var(--success-color)' : conformiteMoyenne >= 60 ? 'var(--warning-color)' : 'var(--danger-color)') + ';"></div>';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    
    // Plans d'Actions
    details += '<div class="stat-card" style="cursor: pointer;" onclick="showTab(\'plans-actions\'); filterByAerodrome(\'' + aerodrome.id + '\')">';
    details += '<div style="display: flex; align-items: center; gap: 15px;">';
    details += '<div style="width: 60px; height: 60px; background: var(--warning-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">';
    details += '<i class="fas fa-clipboard-list"></i>';
    details += '</div>';
    details += '<div>';
    details += '<div style="font-size: 14px; color: var(--text-secondary);">Plans d\'Actions</div>';
    details += '<h3 style="margin: 5px 0; color: var(--warning-color);">' + plansActionsAero.length + '</h3>';
    details += '<div style="font-size: 12px; color: var(--text-secondary);">';
    details += plansEnCours + ' en cours';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    details += '</div>';
    
    details += '</div>'; // Fin du dashboard-grid
    details += '</div>'; // Fin de la section activités
    
    // ==================== ACCÈS RAPIDE ====================
    details += '<div>';
    details += '<h3 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px;">';
    details += '<i class="fas fa-external-link-alt"></i> Accès Rapide';
    details += '</h3>';
    
    details += '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
    
    // Boutons d'accès rapide
    const quickAccessButtons = [
        { tab: 'certification', label: 'Certifications', icon: 'fa-certificate', color: 'primary', count: certifs.length, show: showCertification },
        { tab: 'homologation', label: 'Homologations', icon: 'fa-check-circle', color: 'success', count: homologs.length, show: !showCertification },
        { tab: 'surveillance', label: 'Inspections', icon: 'fa-eye', color: 'info', count: surveillancesAero.length, show: true },
        { tab: 'plans-actions', label: 'Plans d\'Actions', icon: 'fa-clipboard-list', color: 'warning', count: plansActionsAero.length, show: true },
        { tab: 'evenements', label: 'Événements', icon: 'fa-exclamation-triangle', color: 'danger', count: eventsAero.length, show: true },
        { tab: 'dossiers', label: 'Dossiers', icon: 'fa-folder', color: 'secondary', count: dossiersAero.length, show: true }
    ];
    
    quickAccessButtons.forEach(button => {
        if (button.show && button.count > 0) {
            details += '<button class="btn btn-' + button.color + '" onclick="showTab(\'' + button.tab + '\'); filterByAerodrome(\'' + aerodrome.id + '\')" style="display: flex; align-items: center; gap: 8px;">';
            details += '<i class="fas ' + button.icon + '"></i>';
            details += '<span>' + button.label + '</span>';
            details += '<span class="badge badge-light" style="margin-left: 5px; background: white; color: var(--' + button.color + '-color);">' + button.count + '</span>';
            details += '</button>';
        }
    });
    
    details += '</div>';
    details += '</div>';
    
    // ==================== FIN ====================
    details += '</div>'; // Fin du aerodrome-detail-card
    
    // Afficher les détails
    const detailsSection = document.getElementById('aerodromeDetailsSection');
    detailsSection.innerHTML = details;
    detailsSection.style.display = 'block';
    
    // Scroll vers le haut
    detailsSection.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Fonction pour cacher les détails
function hideAerodromeDetails() {
    const detailsSection = document.getElementById('aerodromeDetailsSection');
    detailsSection.style.display = 'none';
    detailsSection.innerHTML = '';
    document.getElementById('selectAerodromeDetails').value = '';
}

// Fonction helper pour scroller vers une section
function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Animation de highlight
        section.style.transition = 'all 0.3s';
        section.style.transform = 'scale(1.02)';
        section.style.boxShadow = '0 0 20px rgba(26, 35, 126, 0.3)';
        
        setTimeout(() => {
            section.style.transform = 'scale(1)';
            section.style.boxShadow = '';
        }, 600);
    }
}

// Fonction pour filtrer par aérodrome dans d'autres onglets
function filterByAerodrome(aerodromeId) {
    const aerodrome = aerodromes.find(a => a.id === aerodromeId);
    if (!aerodrome) return;
    
    // Stocker l'aérodrome sélectionné dans le localStorage
    localStorage.setItem('selectedAerodromeFilter', aerodromeId);
    
    // Afficher une notification
    showNotification(`Filtrage par aérodrome: ${aerodrome.code} - ${aerodrome.name}`, 'info');
}

// Fonction pour ouvrir les détails d'une surveillance
function openSurveillanceDetails(surveillanceId) {
    const surveillance = surveillances.find(s => s.id === surveillanceId);
    if (surveillance) {
        showTab('surveillance');
        // Vous devrez implémenter une fonction pour afficher les détails d'une surveillance spécifique
        showNotification(`Ouverture des détails de l'inspection`, 'info');
    }
}

// Fonction pour afficher tous les écarts
function showAllEcarts(aerodromeId) {
    const aerodrome = aerodromes.find(a => a.id === aerodromeId);
    if (!aerodrome) return;
    
    const surveillancesAero = surveillances.filter(s => s.aerodromeId === aerodromeId);
    const ecartsRisqueEleve = surveillancesAero.flatMap(s => 
        (s.ecarts || []).filter(e => e.risque === 'Élevé' || e.risque === 'Critique')
    );
    
    if (ecartsRisqueEleve.length === 0) {
        alert(`Aucun écart à risque élevé pour ${aerodrome.code}`);
        return;
    }
    
    let ecartsDetails = `<h3>Écarts à Risque Élevé - ${aerodrome.code} (${ecartsRisqueEleve.length})</h3>`;
    ecartsDetails += '<div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">';
    
    ecartsRisqueEleve.forEach((ecart, index) => {
        ecartsDetails += `
            <div style="padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--danger-color); background: rgba(198, 40, 40, 0.05); border-radius: 0 8px 8px 0;">
                <div style="font-weight: 600; color: var(--danger-color);">Écart #${index + 1}</div>
                <div style="margin: 5px 0;">${ecart.description || 'Non décrit'}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    <strong>Risque:</strong> ${ecart.risque} • 
                    <strong>Date identification:</strong> ${ecart.date || 'Non spécifiée'}
                </div>
            </div>
        `;
    });
    
    ecartsDetails += '</div>';
    
    // Créer un modal pour afficher tous les écarts
    const modalId = 'modalAllEcarts';
    if (!document.getElementById(modalId)) {
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <button class="close-modal" onclick="closeModal('${modalId}')">&times;</button>
                ${ecartsDetails}
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    document.getElementById(modalId).innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-modal" onclick="closeModal('${modalId}')">&times;</button>
            ${ecartsDetails}
        </div>
    `;
    
    openModal(modalId);
}

	function generateAerodromeReport(id) {
    const aerodrome = aerodromes.find(a => a.id === id);
    if (!aerodrome) return;
    
    showLoading();
    showNotification('Génération du rapport en cours...', 'info');
    
    setTimeout(() => {
        // Collecter toutes les données
        const certifs = certifications.filter(c => c.aerodromeId === id);
        const homologs = homologations.filter(h => h.aerodromeId === id);
        const inspections = plannings.filter(p => p.aerodromeId === id);
        const surveillancesAero = surveillances.filter(s => s.aerodromeId === id);
        const eventsAero = evenements.filter(e => e.aerodromeId === id);
        const plansActionsAero = plansActions.filter(pa => pa.aerodromeId === id);
        
        const reportData = {
            dateGeneration: new Date().toISOString(),
            aerodrome: {
                code: aerodrome.code,
                name: aerodrome.name,
                city: aerodrome.city,
                region: aerodrome.region,
                type: aerodrome.type,
                status: aerodrome.status,
                riskLevel: aerodrome.riskLevel
            },
            statistiques: {
                certifications: {
                    total: certifs.length,
                    enCours: certifs.filter(c => c.status === 'En cours').length,
                    terminees: certifs.filter(c => c.status === 'Terminée').length
                },
                homologations: {
                    total: homologs.length,
                    actives: homologs.filter(h => h.status === 'Approuvée').length
                },
                inspections: {
                    total: inspections.length + surveillancesAero.length,
                    terminees: inspections.filter(p => p.status === 'Terminé').length + 
                               surveillancesAero.filter(s => s.status === 'Validé').length,
                    conformiteMoyenne: surveillancesAero.length > 0 
                        ? Math.round(surveillancesAero.reduce((sum, s) => sum + (s.conformite || 0), 0) / surveillancesAero.length)
                        : 0
                },
                evenements: {
                    total: eventsAero.length,
                    critiques: eventsAero.filter(e => e.gravite === 'Critique').length,
                    ouverts: eventsAero.filter(e => e.status !== 'Clôturé').length
                },
                plansActions: {
                    total: plansActionsAero.length,
                    enCours: plansActionsAero.filter(p => p.status === 'En cours').length
                }
            }
        };
        
        // Créer un fichier JSON
        const dataStr = JSON.stringify(reportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Rapport_${aerodrome.code}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideLoading();
        showNotification('Rapport généré avec succès!', 'success');
    }, 1500);
}	

        function updateAerodromeSelects() {
            const aerodromeSelects = document.querySelectorAll('select[id$="Aerodrome"]');
            aerodromeSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Sélectionner...</option>' + 
                    aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function getAerodromeName(id) {
            const aerodrome = aerodromes.find(a => a.id === id);
            return aerodrome ? `${aerodrome.code} - ${aerodrome.name}` : 'Aérodrome inconnu';
        }

        // ============ FONCTIONS POUR PLANNING ============

 function initPlanningModal() {
    document.getElementById('planningId').value = '';
    document.getElementById('planningModalTitle').textContent = 'Nouveau Planning';
    
    // Reset et remplissage Aérodromes
    const aerodromeSelect = document.getElementById('planningAerodrome');
    aerodromeSelect.innerHTML = '<option value="">Sélectionner...</option>' + 
        aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
    
    // Reset et remplissage Inspecteurs
    const equipeSelect = document.getElementById('planningEquipe');
    const chefSelect = document.getElementById('planningChef');
    equipeSelect.innerHTML = '';
    chefSelect.innerHTML = '<option value="">Sélectionner...</option>';
    
    inspectors.forEach(i => {
        const option = new Option(`${i.lastName} ${i.firstName} (${i.matricule})`, i.id);
        equipeSelect.add(option.cloneNode(true));
        chefSelect.add(option);
    });
    
    // Dates par défaut
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.getElementById('planningDateDebut').value = formatDateTimeLocal(now);
    document.getElementById('planningDateFin').value = formatDateTimeLocal(tomorrow);
    document.getElementById('planningStatus').value = 'Planifié';
    document.getElementById('planningObjectifs').value = '';
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    // Le format YYYY-MM-DDTHH:mm est requis pour les inputs de type datetime-local
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function loadPlannings(filteredList = null) {
    const container = document.getElementById('inspectionsList');
    if (!container) return;
    
    const list = filteredList || plannings || [];
    
    // Récupération sécurisée des données
    const inspecteursList = Array.isArray(window.inspecteurs) ? window.inspecteurs : 
                          Array.isArray(window.inspectors) ? window.inspectors : [];
    
    const aerodromesList = Array.isArray(window.aerodromes) ? window.aerodromes : [];

    // CALCUL DES STATISTIQUES
    const stats = {
        total: list.length,
        parAerodrome: {},
        enRetard: 0,
        executees: 0,
        enCours: 0,
        planifiees: 0
    };

    // Calculs avec gestion d'erreurs
    try {
        stats.enRetard = list.filter(p => {
            if (!p || !p.dateDebut || !p.status) return false;
            const dateDebut = new Date(p.dateDebut);
            const aujourdhui = new Date();
            return p.status === 'Planifiée' && dateDebut < aujourdhui;
        }).length;

        stats.executees = list.filter(p => p && p.status === 'Terminée').length;
        stats.enCours = list.filter(p => p && p.status === 'En cours').length;
        stats.planifiees = list.filter(p => p && p.status === 'Planifiée').length;
    } catch (e) {
        console.error("Erreur dans le calcul des statistiques:", e);
    }

    // Calcul par aérodrome (avec vérification que c'est bien un tableau)
    if (Array.isArray(aerodromesList)) {
        aerodromesList.forEach(aero => {
            if (!aero || !aero.id) return;
            const count = list.filter(p => p && String(p.aerodromeId) === String(aero.id)).length;
            if (count > 0 && aero.code) {
                stats.parAerodrome[aero.code] = count;
            }
        });
    }

    // Taux d'exécution
    const tauxExecution = stats.total > 0 ? Math.round((stats.executees / stats.total) * 100) : 0;

    let html = '';

    // 1. TABLEAU DE BORD
    html += `
        <div style="background: white; border-radius: 10px; padding: 20px 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; flex-wrap: nowrap; gap: 15px; width: 100%;">
                <!-- Carte Total Planifié -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #0ea5e9; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(14, 165, 233, 0.25);">
                            <i class="fas fa-calendar-alt" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Total Planifié</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.total}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte Inspections en Retard -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #ef4444; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(239, 68, 68, 0.25);">
                            <i class="fas fa-exclamation-triangle" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Retard</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enRetard}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte Taux d'Exécution -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #10b981; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(16, 185, 129, 0.25);">
                            <i class="fas fa-chart-line" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Taux d'Exécution</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${tauxExecution}%</div>
                        </div>
                    </div>
                </div>

                <!-- Carte Par Aérodrome -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #8b5cf6; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(139, 92, 246, 0.25);">
                            <i class="fas fa-plane-departure" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Par Aérodrome</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${Object.keys(stats.parAerodrome).length}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 2. FILTRES
    html += `
        <div class="filters-planning-container" style="background: white; border-radius: 10px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
            <div class="filters-planning-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div>
                    <div class="filter-label-planning" style="font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plane-departure" style="color: #0284c7; font-size: 14px;"></i>
                        Aérodrome
                    </div>
                    <select id="filterPlanningAerodrome" onchange="applyPlanningFilters()" 
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les aérodromes</option>
                        ${Array.isArray(aerodromesList) ? aerodromesList.map(aero => `<option value="${aero.id}">${aero.code} - ${aero.name}</option>`).join('') : ''}
                    </select>
                </div>

                <div>
                    <div class="filter-label-planning" style="font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-tasks" style="color: #06b6d4; font-size: 14px;"></i>
                        Statut
                    </div>
                    <select id="filterPlanningStatus" onchange="applyPlanningFilters()" 
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les statuts</option>
                        <option value="Planifiée">Planifiée</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminée">Terminée</option>
                        <option value="Annulée">Annulée</option>
                    </select>
                </div>

                <div>
                    <div class="filter-label-planning" style="font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-calendar-day" style="color: #8b5cf6; font-size: 14px;"></i>
                        Période
                    </div>
                    <select id="filterPlanningDate" onchange="applyPlanningFilters()" 
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Toutes les dates</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="past">Passées</option>
                        <option value="future">Futures</option>
                    </select>
                </div>

                <div style="display: flex; align-items: flex-end;">
                    <button onclick="resetPlanningFilters()" class="btn" 
                            style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border: none; color: white; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); transition: all 0.3s; text-transform: uppercase; width: 100%; justify-content: center;">
                        <i class="fas fa-redo-alt" style="font-size: 14px;"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    `;

    // Gestion état vide
    if (list.length === 0) {
        html += `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                <i class="fas fa-calendar-plus" style="font-size: 48px; color: #94a3b8; margin-bottom: 20px;"></i>
                <h3 style="margin: 0 0 10px 0; color: #334155; font-size: 20px;">Aucune planification</h3>
                <p style="color: #64748b; margin: 0; font-size: 14px;">Cliquez sur "Planifier une inspection/audit" pour commencer</p>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    // PAGINATION
    const itemsPerPage = 10;
    const currentPage = window.currentPlanningPage || 1;
    const totalPages = Math.ceil(list.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const pagePlannings = list.slice(startIndex, startIndex + itemsPerPage);

    // Groupement par aérodrome
    const grouped = pagePlannings.reduce((acc, p) => {
        if (!p || !p.aerodromeId) return acc;
        if (!acc[p.aerodromeId]) acc[p.aerodromeId] = [];
        acc[p.aerodromeId].push(p);
        return acc;
    }, {});

    // En-tête avec compteur
    html += `
        <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #0284c7, #0369a1); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700;"><i class="fas fa-calendar-alt"></i> Planning des Missions</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 14px;">Total : ${list.length} planification(s) • Page ${currentPage} sur ${totalPages}</p>
                </div>
                <button onclick="initPlanningModal(); openModal('modalPlanning');" class="btn" 
                        style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s;">
                    <i class="fas fa-plus-circle" style="font-size: 16px;"></i>
                    Nouvelle Planification
                </button>
            </div>
        </div>
    `;

    // Groupes par aérodrome
    const groupKeys = Object.keys(grouped);
    
    if (groupKeys.length === 0) {
        html += `
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; color: #64748b;">
                <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px; color: #94a3b8;"></i>
                <p>Aucune mission à afficher</p>
            </div>
        `;
    } else {
        html += groupKeys.map((aeroId, index) => {
            const aero = Array.isArray(aerodromesList) ? aerodromesList.find(a => a && String(a.id) === String(aeroId)) : null;
            const aeroMissions = grouped[aeroId] || [];
            const isFirstGroup = index === 0;
            const contentId = `planning-aero-content-${aeroId}`;
            const iconId = `planning-aero-icon-${aeroId}`;
            
            return `
                <div class="aerodrome-group-container" style="background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <div class="aero-group-header" onclick="togglePlanningAeroGroup('${aeroId}')" 
                         style="background: linear-gradient(135deg, #0369a1, #0284c7); color: white; padding: 18px 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-map-marker-alt"></i> 
                            ${aero ? `${aero.code || '???'} - ${aero.name || 'Aérodrome inconnu'}` : 'Aérodrome inconnu'}
                        </span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="background: rgba(255,255,255,0.25); font-size: 13px; padding: 6px 12px; font-weight: 600; border-radius: 20px;">${aeroMissions.length} Mission(s)</span>
                            <i class="fas fa-chevron-down" id="${iconId}" style="transition: transform 0.3s; ${isFirstGroup ? 'transform: rotate(180deg);' : ''}"></i>
                        </div>
                    </div>

                    <div id="${contentId}" class="planning-group-content" 
                         style="${isFirstGroup ? 'display: block;' : 'display: none;'} padding: 24px; background: #f8fafc;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                            ${aeroMissions.map(p => {
                                if (!p) return '';
                                
                                const dateFormatee = p.dateDebut ? new Date(p.dateDebut).toLocaleDateString('fr-FR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                }) : 'Date non définie';
                                
                                // Déterminer le statut
                                const isEnCours = p.status === 'En cours';
                                const isTerminee = p.status === 'Terminée';
                                const isPlanifiee = p.status === 'Planifiée';
                                
                                // Détecter si la mission est en retard
                                let estEnRetard = false;
                                if (p.dateDebut && isPlanifiee) {
                                    try {
                                        const dateDebut = new Date(p.dateDebut);
                                        const aujourdhui = new Date();
                                        estEnRetard = dateDebut < aujourdhui;
                                    } catch (e) {
                                        console.error("Erreur de date:", e);
                                    }
                                }
                                
                                // Récupérer les informations des inspecteurs de manière sécurisée
                                const getInspecteurInfo = (membreId) => {
                                    const membre = inspecteursList.find(i => i && String(i.id) === String(membreId));
                                    return membre ? {
                                        nomComplet: `${membre.nom || ''} ${membre.prenom || ''}`.trim(),
                                        nom: membre.nom || '',
                                        prenom: membre.prenom || ''
                                    } : null;
                                };

                                const equipeInfo = (Array.isArray(p.equipe) ? p.equipe : []).map(getInspecteurInfo).filter(Boolean);
                                const chefInfo = equipeInfo.length > 0 ? equipeInfo[0] : null;
                                const autresInspecteurs = equipeInfo.slice(1);
                                
                                // Couleur de la bordure
                                let borderColor = '#0284c7'; // Bleu aviation par défaut
                                let statusClass = 'status-pending';
                                
                                if (estEnRetard) {
                                    borderColor = '#ef4444';
                                    statusClass = 'status-en-retard';
                                } else if (isEnCours) {
                                    borderColor = '#0284c7';
                                    statusClass = 'status-active';
                                } else if (isTerminee) {
                                    borderColor = '#10b981';
                                    statusClass = 'status-completed';
                                } else if (isPlanifiee) {
                                    statusClass = 'status-planifiee';
                                }
                                
                                return `
                                <div class="planning-card-enhanced" style="background: white; border-radius: 10px; overflow: hidden; border-left: 5px solid ${borderColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                                    <div style="padding: 20px;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                            <div>
                                                <h4 style="margin: 0; color: #1e293b; font-size: 16px; font-weight: 700; margin-bottom: 8px;">${p.type || 'Type non défini'}</h4>
                                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                                    <small style="color: #64748b; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                                                        <i class="far fa-calendar-alt"></i> ${dateFormatee}
                                                    </small>
                                                    ${estEnRetard ? `
                                                        <span style="background: #fee2e2; color: #dc2626; font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600;">
                                                            <i class="fas fa-exclamation-circle"></i> En retard
                                                        </span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                                                <span style="background: ${estEnRetard ? '#fee2e2' : (isEnCours ? '#dbeafe' : (isTerminee ? '#d1fae5' : '#f3f4f6'))}; 
                                                       color: ${estEnRetard ? '#dc2626' : (isEnCours ? '#1d4ed8' : (isTerminee ? '#047857' : '#6b7280'))}; 
                                                       font-size: 11px; padding: 6px 12px; border-radius: 20px; font-weight: 600;">
                                                    ${p.status || 'Statut inconnu'}
                                                </span>
                                                ${chefInfo ? `
                                                    <div style="background: #fef3c7; color: #d97706; font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                                                        <i class="fas fa-crown"></i> Chef de mission
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>

                                        <div style="background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                                            <strong style="color: #475569; font-size: 13px; display: block; margin-bottom: 8px;">
                                                <i class="fas fa-bullseye"></i> Objectifs
                                            </strong>
                                            <span style="color: #4b5563; font-size: 14px; line-height: 1.5;">${p.objectifs || 'Non spécifiés'}</span>
                                        </div>

                                        <div style="margin-bottom: 20px;">
                                            <strong style="color: #475569; font-size: 13px; display: block; margin-bottom: 10px;">
                                                <i class="fas fa-users"></i> Équipe (${equipeInfo.length})
                                            </strong>
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                ${chefInfo ? `
                                                    <div class="team-indicator team-chef" style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #fffbeb; border-radius: 8px; border-left: 3px solid #f59e0b;">
                                                        <span style="font-weight: 600; color: #b45309; display: flex; align-items: center; gap: 8px;">
                                                            <i class="fas fa-crown"></i>
                                                            ${chefInfo.nomComplet}
                                                        </span>
                                                        <span style="font-size: 11px; font-weight: 700; color: #f59e0b; text-transform: uppercase;">
                                                            CHEF
                                                        </span>
                                                    </div>
                                                ` : ''}
                                                
                                                ${autresInspecteurs.length > 0 ? `
                                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                        ${autresInspecteurs.map(inspecteur => `
                                                            <div style="padding: 6px 12px; background: #eff6ff; border-radius: 20px; border: 1px solid #dbeafe; display: flex; align-items: center; gap: 6px;">
                                                                <i class="fas fa-user-check" style="color: #0369a1;"></i>
                                                                ${inspecteur.nomComplet}
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : (chefInfo ? '' : '<div style="color: #9ca3af; font-style: italic; font-size: 13px;">Aucun inspecteur assigné</div>')}
                                            </div>
                                        </div>

                                        <div style="border-top: 1px solid #f1f5f9; padding-top: 15px;">
                                            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                                <button class="btn btn-info" onclick="viewPlanning('${p.id}')" 
                                                        style="padding: 8px 16px; font-size: 12px; border-radius: 8px; background: #0284c7; color: white; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                                    <i class="fas fa-eye"></i> Voir
                                                </button>
                                                <button class="btn btn-primary" onclick="editPlanning('${p.id}')" 
                                                        style="padding: 8px 16px; font-size: 12px; border-radius: 8px; background: #10b981; color: white; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                                    <i class="fas fa-edit"></i> Éditer
                                                </button>
                                                <button class="btn btn-danger" onclick="confirmDeletePlanning('${p.id}')" 
                                                        style="padding: 8px 16px; font-size: 12px; border-radius: 8px; background: #ef4444; color: white; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // PAGINATION
    if (totalPages > 1) {
        html += `
            <div style="grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <button onclick="changePlanningPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                        style="padding: 10px 16px; border-radius: 8px; background: ${currentPage === 1 ? '#e2e8f0' : '#0284c7'}; color: ${currentPage === 1 ? '#94a3b8' : 'white'}; border: none; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span style="font-weight: 700; color: #475569; font-size: 14px;">${currentPage} / ${totalPages}</span>
                <button onclick="changePlanningPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                        style="padding: 10px 16px; border-radius: 8px; background: ${currentPage === totalPages ? '#e2e8f0' : '#0284c7'}; color: ${currentPage === totalPages ? '#94a3b8' : 'white'}; border: none; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }

    container.innerHTML = html;
}


function applyPlanningFilters() {
    const aerodromeFilter = document.getElementById('filterPlanningAerodrome')?.value;
    const statusFilter = document.getElementById('filterPlanningStatus')?.value;
    const dateFilter = document.getElementById('filterPlanningDate')?.value;
    
    let filtered = [...plannings];
    
    // Filtre par aérodrome
    if (aerodromeFilter) {
        filtered = filtered.filter(p => String(p.aerodromeId) === String(aerodromeFilter));
    }
    
    // Filtre par statut
    if (statusFilter) {
        filtered = filtered.filter(p => p.status === statusFilter);
    }
    
    // Filtre par date
    if (dateFilter) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        
        filtered = filtered.filter(p => {
            const missionDate = new Date(p.dateDebut);
            missionDate.setHours(0, 0, 0, 0);
            
            switch(dateFilter) {
                case 'today':
                    return missionDate.getTime() === today.getTime();
                case 'week':
                    return missionDate >= startOfWeek && missionDate <= today;
                case 'month':
                    return missionDate >= startOfMonth && missionDate <= today;
                case 'past':
                    return missionDate < today;
                case 'future':
                    return missionDate > today;
                default:
                    return true;
            }
        });
    }
    
    loadPlannings(filtered);
}

function resetPlanningFilters() {
    document.getElementById('filterPlanningAerodrome').value = '';
    document.getElementById('filterPlanningStatus').value = '';
    document.getElementById('filterPlanningDate').value = '';
    loadPlannings();
}

function togglePlanningAeroGroup(aeroId) {
    const contentId = `planning-aero-content-${aeroId}`;
    const iconId = `planning-aero-icon-${aeroId}`;
    
    const content = document.getElementById(contentId);
    const icon = document.getElementById(iconId);
    
    if (!content) {
        console.error(`Élément non trouvé: ${contentId}`);
        return;
    }
    
    if (!icon) {
        console.error(`Élément non trouvé: ${iconId}`);
        return;
    }
    
    // Toggle l'affichage
    if (content.style.display === 'none' || content.classList.contains('collapsed')) {
        // Ouvrir
        content.style.display = 'block';
        content.classList.remove('collapsed');
        content.classList.add('expanded');
        icon.style.transform = 'rotate(180deg)';
    } else {
        // Fermer
        content.style.display = 'none';
        content.classList.remove('expanded');
        content.classList.add('collapsed');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Fonction générique pour compatibilité avec d'autres sections
function toggleAeroGroup(groupId) {
    // Si c'est un ID de planning
    if (groupId.startsWith('plan-')) {
        const aeroId = groupId.replace('plan-', '');
        togglePlanningAeroGroup(aeroId);
        return;
    }
    
    // Sinon, gestion générique
    const content = document.getElementById(`group-content-${groupId}`);
    const icon = document.getElementById(`icon-${groupId}`);
    
    if (!content || !icon) {
        console.error(`Élément non trouvé: group-content-${groupId} ou icon-${groupId}`);
        return;
    }
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        content.classList.remove('collapsed');
        content.classList.add('expanded');
        icon.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        content.classList.remove('expanded');
        content.classList.add('collapsed');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Gestion de la pagination
function changePlanningPage(page) {
    window.currentPlanningPage = page;
    loadPlannings();
}

// Suppression avec confirmation (Modèle Aerodrome)
function confirmDeletePlanning(id) {
    if (confirm("🚨 Souhaitez-vous vraiment supprimer cette planification ?")) {
        plannings = plannings.filter(p => String(p.id) !== String(id));
        saveToStorage('plannings', plannings);
        loadPlannings();
        showNotification("Mission supprimée", "warning");
    }
}

// Fonction pour voir (en lecture seule)
function viewPlanning(id) {
    const p = plannings.find(x => String(x.id) === String(id));
    if (!p) return;
    
    editPlanning(id); // Ouvre la modale habituelle
    document.getElementById('planningModalTitle').textContent = 'Consultation du Planning';
    
    // Masquer le bouton de sauvegarde pour la consultation
    const saveBtn = document.querySelector('#modalPlanning .btn-primary[onclick="savePlanning()"]');
    if (saveBtn) saveBtn.style.display = 'none';
}

// Fonction pour supprimer avec confirmation (alternative)
function confirmDelete(id) {
    if (confirm("🚨 Êtes-vous certain de vouloir supprimer cette planification ? Cette action est irréversible.")) {
        plannings = plannings.filter(p => String(p.id) !== String(id));
        saveToStorage('plannings', plannings);
        showNotification('Planning supprimé avec succès', 'warning');
        loadPlannings(); // Rafraîchir la vue
        if (typeof updateDashboard === 'function') updateDashboard();
    }
}

// Fonction utilitaire pour formatter les dates
function formatDate(dateTimeStr) {
    const date = new Date(dateTimeStr);
    return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
        function editPlanning(id) {
    const p = plannings.find(x => String(x.id) === String(id));
    if (!p) {
        showNotification('Planning non trouvé', 'danger');
        return;
    }
    
    initPlanningModal(); // Prépare les listes d'abord
    
    document.getElementById('planningId').value = p.id;
    document.getElementById('planningModalTitle').textContent = 'Modifier Planning';
    document.getElementById('planningAerodrome').value = p.aerodromeId;
    document.getElementById('planningType').value = p.type;
    document.getElementById('planningDateDebut').value = p.dateDebut;
    document.getElementById('planningDateFin').value = p.dateFin;
    document.getElementById('planningObjectifs').value = p.objectifs || '';
    document.getElementById('planningStatus').value = p.status;
    document.getElementById('planningChef').value = p.chef;
    
    // Sélection multiple des membres de l'équipe
    const equipeSelect = document.getElementById('planningEquipe');
    Array.from(equipeSelect.options).forEach(opt => {
        opt.selected = p.equipe.includes(opt.value);
    });
    
    openModal('modalPlanning');
}

function savePlanning() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'danger');
        return;
    }
    
    const fields = {
        id: document.getElementById('planningId').value || 'plan-' + Date.now(),
        aerodromeId: document.getElementById('planningAerodrome').value,
        type: document.getElementById('planningType').value,
        dateDebut: document.getElementById('planningDateDebut').value,
        dateFin: document.getElementById('planningDateFin').value,
        chef: document.getElementById('planningChef').value,
        equipe: Array.from(document.getElementById('planningEquipe').selectedOptions).map(o => o.value),
        objectifs: document.getElementById('planningObjectifs').value,
        status: document.getElementById('planningStatus').value
    };
    
    // Validation stricte
    if (!fields.aerodromeId || !fields.chef || fields.equipe.length === 0) {
        showNotification('Veuillez sélectionner au moins un chef et un membre d\'équipe', 'danger');
        return;
    }
    
    const idx = plannings.findIndex(x => x.id === fields.id);
    if (idx >= 0) {
        plannings[idx] = fields;
        showNotification('Planning mis à jour', 'success');
    } else {
        plannings.push(fields);
        showNotification('Planning créé', 'success');
    }
    
    saveToStorage('plannings', plannings);
    closeModal('modalPlanning');
    loadPlannings();
    if (typeof updateDashboard === 'function') updateDashboard();
    if (typeof updateAllCalendars === 'function') updateAllCalendars();
}

        function deletePlanning(id) {
            if (!checkPermission('delete')) {
                showNotification('Permission refusée. Vous n\'avez pas les droits pour supprimer.', 'danger');
                return;
            }
            
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce planning ?')) {
                return;
            }
            
            plannings = plannings.filter(p => p.id !== id);
            saveToStorage('plannings', plannings);
            
            loadPlannings();
            updateDashboard();
            showNotification('Planning supprimé avec succès', 'success');
        }

        // ========== FILTRES PLANNING ==========
        function filterPlannings() {
            const type = document.getElementById('filterPlanningType').value;
            const status = document.getElementById('filterPlanningStatus').value;
            const date = document.getElementById('filterPlanningDate').value;
            const search = document.getElementById('searchPlanningKeyword').value.toLowerCase();
            
            let filtered = [...plannings];
            
            // Filtre par type
            if (type) {
                filtered = filtered.filter(p => p.type === type);
            }
            
            // Filtre par statut
            if (status) {
                filtered = filtered.filter(p => p.status === status);
            }
            
            // Filtre par date
            if (date) {
                filtered = filtered.filter(p => {
                    return p.dateDebut && p.dateDebut.startsWith(date);
                });
            }
            
            // Filtre par recherche textuelle
            if (search) {
                filtered = filtered.filter(p => {
                    const aerodrome = aerodromes.find(a => a.id === p.aerodromeId);
                    const chef = inspectors.find(i => i.id === p.chef);
                    const equipeMembres = p.equipe.map(id => {
                        const i = inspectors.find(x => x.id === id);
                        return i ? `${i.lastName} ${i.firstName}` : '';
                    }).join(' ');
                    
                    const searchText = `
                        ${aerodrome?.code || ''}
                        ${aerodrome?.name || ''}
                        ${chef ? `${chef.lastName} ${chef.firstName}` : ''}
                        ${equipeMembres}
                        ${p.type || ''}
                        ${p.status || ''}
                        ${p.objectifs || ''}
                    `.toLowerCase();
                    
                    return searchText.includes(search);
                });
            }
            
            loadPlannings(filtered);
        }

        function resetPlanningFilters() {
            document.getElementById('filterPlanningType').value = '';
            document.getElementById('filterPlanningStatus').value = '';
            document.getElementById('filterPlanningDate').value = '';
            document.getElementById('searchPlanningKeyword').value = '';
            
            loadPlannings();
            showNotification('Filtres réinitialisés', 'info');
        }

        function sortPlannings(field, direction = 'asc') {
            const sorted = [...plannings].sort((a, b) => {
                let valueA, valueB;
                
                switch(field) {
                    case 'date':
                        valueA = new Date(a.dateDebut);
                        valueB = new Date(b.dateDebut);
                        break;
                    case 'status':
                        const statusOrder = {
                            'Planifié': 1,
                            'En cours': 2,
                            'Terminé': 3,
                            'Reporté': 4,
                            'Annulé': 5
                        };
                        valueA = statusOrder[a.status] || 99;
                        valueB = statusOrder[b.status] || 99;
                        break;
                    case 'aerodrome':
                        const aeroA = aerodromes.find(x => x.id === a.aerodromeId);
                        const aeroB = aerodromes.find(x => x.id === b.aerodromeId);
                        valueA = aeroA ? aeroA.name : '';
                        valueB = aeroB ? aeroB.name : '';
                        break;
                    default:
                        valueA = a[field] || '';
                        valueB = b[field] || '';
                }
                
                if (direction === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            loadPlannings(sorted);
        }


        // ============ FONCTIONS POUR DOSSIERS ============
   
let dossiersCurrentPage = 1;
const dossiersPerPage = 12;
let dossiersSortField = 'startDate';
let dossiersSortDirection = 'desc';

// Fonction principale de chargement des dossiers
function loadDossiers(filteredList = null) {
    const container = document.getElementById('dossiersList');
    const dashboard = document.getElementById('dossiersDashboard');
    const countElement = document.getElementById('dossiersCount');
    
    if (!container) return;
    
    const list = filteredList || dossiers || [];
    
    // 1. CALCUL DES STATISTIQUES
    const now = new Date();
    const stats = {
        total: list.length,
        enCours: list.filter(d => d.status === 'En cours').length,
        traites: list.filter(d => d.status === 'Terminé').length,
        enRetard: list.filter(d => {
            if (d.status === 'Terminé') return false;
            if (!d.deadline) return false;
            return new Date(d.deadline) < now;
        }).length,
        nouveaux: list.filter(d => d.status === 'Nouveau').length,
        enAttente: list.filter(d => d.status === 'En attente').length
    };
    
    // 2. MINI TABLEAU DE BORD
    dashboard.innerHTML = `
        <!-- Carte Total Dossiers -->
        <div style="background: white; border-left: 4px solid #1e3a8a; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-folder" style="color: #1e3a8a;"></i> TOTAL DOSSIERS
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.total}</div>
                </div>
                <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-clipboard-list" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
        
        <!-- Carte Dossiers en Cours -->
        <div style="background: white; border-left: 4px solid #0284c7; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-sync-alt fa-spin" style="color: #0284c7;"></i> EN COURS
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.enCours}</div>
                </div>
                <div style="background: linear-gradient(135deg, #0284c7 0%, #38bdf8 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-hourglass-half" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
        
        <!-- Carte Dossiers Traités -->
        <div style="background: white; border-left: 4px solid #059669; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-check-circle" style="color: #059669;"></i> TRAITÉS
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.traites}</div>
                </div>
                <div style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-flag-checkered" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
        
        <!-- Carte En Retard -->
        <div style="background: white; border-left: 4px solid #dc2626; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i> EN RETARD
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.enRetard}</div>
                </div>
                <div style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-exclamation" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
    `;
    
    // 3. MISE À JOUR DU COMPTEUR ET PROGRESSION
    countElement.textContent = list.length;
    updateDossierProgress(list);
    
    if (list.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #64748b;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: #cbd5e1;"></i>
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">Aucun dossier trouvé</div>
                <div>Essayez de modifier vos filtres ou ajoutez un nouveau dossier</div>
            </div>
        `;
        return;
    }
    
    // 4. TRI ET PAGINATION
    const sortedList = sortDossiersList(list);
    const totalPages = Math.ceil(sortedList.length / dossiersPerPage);
    const startIndex = (dossiersCurrentPage - 1) * dossiersPerPage;
    const paginatedList = sortedList.slice(startIndex, startIndex + dossiersPerPage);
    
    // 5. GÉNÉRATION DES CARTES
    let html = '';
    
    paginatedList.forEach(dossier => {
        // Calcul des indicateurs
        const isDelayed = calculateDelaiStatus(dossier) === 'En retard';
        const daysUntilDeadline = calculateDaysUntilDeadline(dossier);
        const tasksCount = dossier.tasks?.length || 0;
        const completedTasks = dossier.tasks?.filter(t => t.status === 'Terminée').length || 0;
        const progress = dossier.progress || 0;
        
        // Classes CSS
        const priorityClass = dossier.priority === 'Urgente' ? 'priority-urgent' : 
                             dossier.priority === 'Haute' ? 'priority-high' : 'priority-normal';
        const statusClass = dossier.status === 'Terminé' ? 'status-termine' :
                           dossier.status === 'En cours' ? 'status-en-cours' :
                           dossier.status === 'En attente' ? 'status-en-attente' :
                           dossier.status === 'Archivé' ? 'status-archive' : 'status-nouveau';
        
        // Couleur de progression
        let progressColor = '#10b981'; // Vert
        if (progress < 30) progressColor = '#ef4444'; // Rouge
        else if (progress < 70) progressColor = '#f59e0b'; // Orange
        
        html += `
            <div class="dossier-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; position: relative;">
                ${isDelayed ? `
                    <div style="position: absolute; top: 10px; right: 10px; background: #dc2626; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase;">
                        <i class="fas fa-clock"></i> En retard
                    </div>
                ` : ''}
                
                <!-- En-tête -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 800; color: #1e293b; margin-bottom: 5px;">${dossier.reference}</div>
                            <div style="font-size: 13px; color: #475569;">${dossier.type}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
                            <span class="status-badge ${statusClass}" style="font-size: 11px;">
                                ${dossier.status}
                            </span>
                            <span class="priority-badge ${priorityClass}" style="font-size: 11px;">
                                ${dossier.priority}
                            </span>
                        </div>
                    </div>
                    
                    <div style="font-size: 13px; color: #64748b; margin-bottom: 5px;">
                        <i class="fas fa-building"></i> ${dossier.service}
                    </div>
                    <div style="font-size: 12px; color: #94a3b8;">
                        <i class="far fa-calendar"></i> Ouvert le ${new Date(dossier.startDate).toLocaleDateString('fr-FR')}
                        ${dossier.deadline ? `
                            • <i class="fas fa-clock" style="${isDelayed ? 'color: #dc2626;' : ''}"></i> ${new Date(dossier.deadline).toLocaleDateString('fr-FR')}
                        ` : ''}
                    </div>
                </div>
                
                <!-- Description -->
                <div style="font-size: 13px; color: #475569; margin-bottom: 15px; line-height: 1.5;">
                    ${dossier.description.substring(0, 100)}${dossier.description.length > 100 ? '...' : ''}
                </div>
                
                <!-- Progression -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #475569;">Progression</div>
                        <div style="font-size: 14px; font-weight: 700; color: ${progressColor};">${progress}%</div>
                    </div>
                    <div style="background: #e2e8f0; height: 6px; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${progress}%; height: 100%; background: ${progressColor}; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: #64748b;">
                        <div><i class="fas fa-tasks"></i> ${completedTasks}/${tasksCount} tâches</div>
                        ${daysUntilDeadline !== null ? `
                            <div style="${isDelayed ? 'color: #dc2626; font-weight: 600;' : ''}">
                                ${isDelayed ? '-' : ''}${Math.abs(daysUntilDeadline)} jour(s)
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 8px;">
                    <button onclick="viewDossierDetails('${dossier.id}')" 
                            style="flex: 1; background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-eye"></i> Détails
                    </button>
                    ${checkPermission('write') ? `
                    <button onclick="editDossier('${dossier.id}')" 
                            style="flex: 1; background: #1e3a8a; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    ` : ''}
                    ${checkPermission('delete') ? `
                    <button onclick="deleteDossier('${dossier.id}')" 
                            style="background: #fee2e2; border: 1px solid #fca5a5; color: #dc2626; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trash"></i>
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // 6. MISE À JOUR DE LA PAGINATION
    document.getElementById('dossiersCurrentPage').textContent = dossiersCurrentPage;
}

// Fonctions utilitaires
function calculateDelaiStatus(dossier) {
    if (!dossier.deadline || dossier.status === 'Terminé' || dossier.status === 'Archivé') {
        return 'Dans les délais';
    }
    
    const now = new Date();
    const deadline = new Date(dossier.deadline);
    
    return deadline < now ? 'En retard' : 'Dans les délais';
}

function calculateDaysUntilDeadline(dossier) {
    if (!dossier.deadline) return null;
    
    const now = new Date();
    const deadline = new Date(dossier.deadline);
    const diffTime = deadline - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
}

function updateDossierProgress(list = dossiers) {
    if (!list || list.length === 0) {
        document.getElementById('dossier-global-progress').textContent = '0%';
        document.getElementById('dossier-global-progress-bar').style.width = '0%';
        document.getElementById('dossier-completed').textContent = '0';
        document.getElementById('dossier-in-progress').textContent = '0';
        document.getElementById('dossier-delayed').textContent = '0';
        document.getElementById('dossier-new').textContent = '0';
        return;
    }
    
    let totalProgress = 0;
    let completedCount = 0;
    let inProgressCount = 0;
    let delayedCount = 0;
    let newCount = 0;
    
    list.forEach(dossier => {
        totalProgress += dossier.progress || 0;
        
        switch(dossier.status) {
            case 'Terminé': completedCount++; break;
            case 'En cours': inProgressCount++; break;
            case 'Nouveau': newCount++; break;
        }
        
        if (calculateDelaiStatus(dossier) === 'En retard') {
            delayedCount++;
        }
    });
    
    const averageProgress = Math.round(totalProgress / list.length);
    
    document.getElementById('dossier-global-progress').textContent = averageProgress + '%';
    document.getElementById('dossier-global-progress-bar').style.width = averageProgress + '%';
    document.getElementById('dossier-completed').textContent = completedCount;
    document.getElementById('dossier-in-progress').textContent = inProgressCount;
    document.getElementById('dossier-delayed').textContent = delayedCount;
    document.getElementById('dossier-new').textContent = newCount;
}

// Fonctions de tri
function sortDossiersList(list) {
    return list.sort((a, b) => {
        let aValue = a[dossiersSortField];
        let bValue = b[dossiersSortField];
        
        // Gestion des dates
        if (dossiersSortField.includes('date') || dossiersSortField.includes('Date')) {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        }
        
        // Gestion des valeurs nulles
        if (!aValue && bValue) return dossiersSortDirection === 'asc' ? -1 : 1;
        if (aValue && !bValue) return dossiersSortDirection === 'asc' ? 1 : -1;
        if (!aValue && !bValue) return 0;
        
        // Comparaison
        if (aValue < bValue) return dossiersSortDirection === 'asc' ? -1 : 1;
        if (aValue > bValue) return dossiersSortDirection === 'asc' ? 1 : -1;
        return 0;
    });
}

// Fonctions de pagination
function changeDossierPage(direction) {
    const totalItems = dossiers.length;
    const totalPages = Math.ceil(totalItems / dossiersPerPage);
    
    if (direction === 'prev' && dossiersCurrentPage > 1) {
        dossiersCurrentPage--;
    } else if (direction === 'next' && dossiersCurrentPage < totalPages) {
        dossiersCurrentPage++;
    }
    
    loadDossiers();
}

// Fonctions de filtrage
function applyDossierFilters() {
    const typeFilter = document.getElementById('filterDossierType')?.value || '';
    const statusFilter = document.getElementById('filterDossierStatus')?.value || '';
    const priorityFilter = document.getElementById('filterDossierPriority')?.value || '';
    const serviceFilter = document.getElementById('filterDossierService')?.value || '';
    const searchFilter = document.getElementById('searchDossier')?.value.toLowerCase() || '';
    const showDelayedOnly = document.getElementById('filterDelayed')?.checked || false;
    
    let filtered = dossiers;
    
    // Filtre par type
    if (typeFilter) {
        filtered = filtered.filter(d => d.type === typeFilter);
    }
    
    // Filtre par statut
    if (statusFilter) {
        filtered = filtered.filter(d => d.status === statusFilter);
    }
    
    // Filtre par priorité
    if (priorityFilter) {
        filtered = filtered.filter(d => d.priority === priorityFilter);
    }
    
    // Filtre par service
    if (serviceFilter) {
        filtered = filtered.filter(d => d.service === serviceFilter);
    }
    
    // Filtre par recherche
    if (searchFilter) {
        filtered = filtered.filter(d => 
            d.reference.toLowerCase().includes(searchFilter) ||
            d.description.toLowerCase().includes(searchFilter)
        );
    }
    
    // Filtre par retard
    if (showDelayedOnly) {
        filtered = filtered.filter(d => calculateDelaiStatus(d) === 'En retard');
    }
    
    // Réinitialiser la page à 1 lors du filtrage
    dossiersCurrentPage = 1;
    
    loadDossiers(filtered);
}

function resetDossierFilters() {
    document.getElementById('filterDossierType').value = '';
    document.getElementById('filterDossierStatus').value = '';
    document.getElementById('filterDossierPriority').value = '';
    document.getElementById('filterDossierService').value = '';
    document.getElementById('searchDossier').value = '';
    document.getElementById('filterDelayed').checked = false;
    
    dossiersCurrentPage = 1;
    loadDossiers();
}

// Fonctions d'export
function exportDossiers() {
    const filtered = getFilteredDossiers();
    
    // Créer le contenu CSV
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Référence,Type,Description,Service,Date Ouverture,Date Limite,Priorité,Statut,Progression,Tâches Complétées,Tâches Total\n";
    
    filtered.forEach(dossier => {
        const tasksCompleted = dossier.tasks?.filter(t => t.status === 'Terminée').length || 0;
        const tasksTotal = dossier.tasks?.length || 0;
        
        csvContent += `"${dossier.reference}","${dossier.type}","${dossier.description}","${dossier.service}","${dossier.startDate}","${dossier.deadline || ''}","${dossier.priority}","${dossier.status}","${dossier.progress || 0}%","${tasksCompleted}","${tasksTotal}"\n`;
    });
    
    // Télécharger le fichier
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `dossiers_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Export réalisé avec succès', 'success');
}

function getFilteredDossiers() {
    const typeFilter = document.getElementById('filterDossierType')?.value || '';
    const statusFilter = document.getElementById('filterDossierStatus')?.value || '';
    const priorityFilter = document.getElementById('filterDossierPriority')?.value || '';
    const serviceFilter = document.getElementById('filterDossierService')?.value || '';
    const searchFilter = document.getElementById('searchDossier')?.value.toLowerCase() || '';
    const showDelayedOnly = document.getElementById('filterDelayed')?.checked || false;
    
    let filtered = dossiers;
    
    if (typeFilter) filtered = filtered.filter(d => d.type === typeFilter);
    if (statusFilter) filtered = filtered.filter(d => d.status === statusFilter);
    if (priorityFilter) filtered = filtered.filter(d => d.priority === priorityFilter);
    if (serviceFilter) filtered = filtered.filter(d => d.service === serviceFilter);
    if (searchFilter) filtered = filtered.filter(d => 
        d.reference.toLowerCase().includes(searchFilter) ||
        d.description.toLowerCase().includes(searchFilter)
    );
    if (showDelayedOnly) filtered = filtered.filter(d => calculateDelaiStatus(d) === 'En retard');
    
    return filtered;
}

// Fonctions existantes (gardées telles quelles mais adaptées)
function initDossierModal() {
    document.getElementById('dossierId').value = '';
    document.getElementById('dossierReference').value = '';
    document.getElementById('dossierType').value = '';
    document.getElementById('dossierDescription').value = '';
    document.getElementById('dossierService').value = '';
    document.getElementById('dossierInspector').innerHTML = '<option value="">Sélectionner un inspecteur...</option>';
    
    // Ajouter les options d'inspecteurs
    inspectors?.forEach(inspector => {
        const option = document.createElement('option');
        option.value = inspector.id;
        option.textContent = `${inspector.lastName} ${inspector.firstName} (${inspector.specialty})`;
        document.getElementById('dossierInspector').appendChild(option);
    });
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dossierStartDate').value = today;
    document.getElementById('dossierDeadline').value = '';
    document.getElementById('dossierPriority').value = 'Normale';
    document.getElementById('dossierStatus').value = 'Nouveau';
    document.getElementById('dossierTasks').innerHTML = '';
    document.getElementById('dossierModalTitle').textContent = 'Nouveau Dossier';
}

function saveDossier() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée. Seul l\'administrateur peut créer/modifier des dossiers.', 'error');
        return;
    }
    
    const reference = document.getElementById('dossierReference').value;
    const type = document.getElementById('dossierType').value;
    const description = document.getElementById('dossierDescription').value;
    const service = document.getElementById('dossierService').value;
    
    if (!reference || !type || !description || !service) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        // Récupérer les tâches
        const tasks = [];
        const taskElements = document.querySelectorAll('#dossierTasks .task-item');
        taskElements.forEach(taskElement => {
            const taskId = taskElement.querySelector('.task-id')?.value || 'task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const taskName = taskElement.querySelector('.task-name')?.value;
            const taskStatus = taskElement.querySelector('.task-status')?.value || 'Nouvelle';
            const taskProgress = parseInt(taskElement.querySelector('.task-progress')?.value || 0);
            const taskDeadline = taskElement.querySelector('.task-deadline')?.value;
            const taskResponsible = taskElement.querySelector('.task-responsible')?.value;
            
            if (taskName) {
                tasks.push({
                    id: taskId,
                    name: taskName,
                    status: taskStatus,
                    progress: taskProgress,
                    deadline: taskDeadline,
                    responsible: taskResponsible,
                    files: []
                });
            }
        });
        
        const dossier = {
            id: document.getElementById('dossierId').value || 'doss-' + Date.now(),
            reference: reference,
            type: type,
            description: description,
            service: service,
            inspectorId: document.getElementById('dossierInspector').value,
            startDate: document.getElementById('dossierStartDate').value,
            deadline: document.getElementById('dossierDeadline').value,
            priority: document.getElementById('dossierPriority').value,
            status: document.getElementById('dossierStatus').value,
            tasks: tasks,
            dateCreation: new Date().toISOString()
        };
        
        // Calculer la progression globale
        dossier.progress = calculateDossierProgress(dossier);
        
        const existingIndex = dossiers.findIndex(d => d.id === dossier.id);
        if (existingIndex >= 0) {
            dossiers[existingIndex] = dossier;
            showNotification('Dossier modifié avec succès!', 'success');
        } else {
            dossiers.push(dossier);
            showNotification('Dossier créé avec succès!', 'success');
        }
        
        closeModal('modalDossier');
        loadDossiers();
        hideLoading();
        saveAllData();
    }, 800);
}

function calculateDossierProgress(dossier) {
    if (!dossier.tasks || dossier.tasks.length === 0) return 0;
    
    const totalProgress = dossier.tasks.reduce((sum, task) => sum + (task.progress || 0), 0);
    return Math.round(totalProgress / dossier.tasks.length);
}

function addTask() {
    const tasksContainer = document.getElementById('dossierTasks');
    const taskId = 'task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    const taskHtml = `
        <div class="task-item" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
            <input type="hidden" class="task-id" value="${taskId}">
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <input type="text" class="task-name" placeholder="Nom de la tâche" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;" required>
                </div>
                <div>
                    <select class="task-status" style="padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
                        <option value="Nouvelle">Nouvelle</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminée">Terminée</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" class="task-progress" min="0" max="100" value="0" style="width: 60px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <span style="font-size: 14px; color: #64748b;">%</span>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <input type="date" class="task-deadline" placeholder="Date limite" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="flex: 1;">
                    <input type="text" class="task-responsible" placeholder="Responsable" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button type="button" class="btn btn-secondary" onclick="addTaskFile(this)" style="margin-right: 10px; padding: 6px 12px; font-size: 12px;">
                    <i class="fas fa-paperclip"></i> Ajouter fichier
                </button>
                <button type="button" class="btn btn-danger" onclick="removeTask(this)" style="padding: 6px 12px; font-size: 12px;">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
                <div class="task-files" style="margin-top: 10px;"></div>
            </div>
        </div>
    `;
    
    tasksContainer.insertAdjacentHTML('beforeend', taskHtml);
}

function removeTask(button) {
    button.closest('.task-item').remove();
}

function addTaskFile(button) {
    const taskItem = button.closest('.task-item');
    const filesContainer = taskItem.querySelector('.task-files');
    
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.style.display = 'none';
    fileInput.multiple = true;
    
    fileInput.onchange = function(e) {
        for (let file of e.target.files) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.style.display = 'flex';
            fileItem.style.alignItems = 'center';
            fileItem.style.marginBottom = '5px';
            fileItem.style.padding = '8px';
            fileItem.style.background = 'white';
            fileItem.style.borderRadius = '4px';
            fileItem.style.border = '1px solid #e2e8f0';
            
            fileItem.innerHTML = `
                <div class="file-icon" style="width: 30px; height: 30px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; margin-right: 10px;">
                    <i class="fas fa-file"></i>
                </div>
                <div style="flex: 1; font-size: 12px;">
                    <div>${file.name}</div>
                    <div style="color: #64748b;">${(file.size / 1024).toFixed(2)} KB</div>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #dc2626; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            filesContainer.appendChild(fileItem);
        }
    };
    
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

function editDossier(id) {
    const dossier = dossiers.find(d => d.id === id);
    if (!dossier) {
        showNotification('Dossier non trouvé', 'error');
        return;
    }
    
    document.getElementById('dossierId').value = dossier.id;
    document.getElementById('dossierReference').value = dossier.reference;
    document.getElementById('dossierType').value = dossier.type;
    document.getElementById('dossierDescription').value = dossier.description;
    document.getElementById('dossierService').value = dossier.service;
    document.getElementById('dossierInspector').value = dossier.inspectorId || '';
    document.getElementById('dossierStartDate').value = dossier.startDate;
    document.getElementById('dossierDeadline').value = dossier.deadline || '';
    document.getElementById('dossierPriority').value = dossier.priority || 'Normale';
    document.getElementById('dossierStatus').value = dossier.status;
    
    // Charger les tâches
    const tasksContainer = document.getElementById('dossierTasks');
    tasksContainer.innerHTML = '';
    
    if (dossier.tasks && dossier.tasks.length > 0) {
        dossier.tasks.forEach(task => {
            addTask();
            const lastTask = tasksContainer.lastElementChild;
            
            lastTask.querySelector('.task-id').value = task.id;
            lastTask.querySelector('.task-name').value = task.name;
            lastTask.querySelector('.task-status').value = task.status;
            lastTask.querySelector('.task-progress').value = task.progress || 0;
            lastTask.querySelector('.task-deadline').value = task.deadline || '';
            lastTask.querySelector('.task-responsible').value = task.responsible || '';
        });
    }
    
    document.getElementById('dossierModalTitle').textContent = 'Modifier le Dossier';
    openModal('modalDossier');
}

function viewDossierDetails(id) {
    const dossier = dossiers.find(d => d.id === id);
    if (!dossier) return;
    
    const inspector = dossier.inspectorId ? inspectors?.find(i => i.id === dossier.inspectorId) : null;
    const isDelayed = calculateDelaiStatus(dossier) === 'En retard';
    const daysUntilDeadline = calculateDaysUntilDeadline(dossier);
    
    let details = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: #1e3a8a; margin-bottom: 20px; border-bottom: 2px solid #1e3a8a; padding-bottom: 10px;">
                <i class="fas fa-folder"></i> Détails du Dossier - ${dossier.reference}
            </h3>
            
            <!-- En-tête avec statuts -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 14px; color: #475569; margin-bottom: 5px;">${dossier.type}</div>
                    <div style="font-size: 20px; font-weight: 700; color: #1e293b;">${dossier.description}</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
                    <span class="status-badge status-${dossier.status.toLowerCase().replace(' ', '-')}" style="font-size: 12px;">
                        ${dossier.status}
                    </span>
                    <span class="priority-badge priority-${dossier.priority.toLowerCase()}" style="font-size: 12px;">
                        ${dossier.priority}
                    </span>
                    ${isDelayed ? `
                        <span style="background: #fee2e2; color: #dc2626; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">
                            <i class="fas fa-exclamation-triangle"></i> En retard
                        </span>
                    ` : ''}
                </div>
            </div>
            
            <!-- Informations principales -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: #1e3a8a; margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-info-circle"></i> Informations Générales
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                        <div style="font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 5px;">Service Responsable</div>
                        <div style="font-size: 14px; color: #1e293b; font-weight: 600;">${dossier.service}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 5px;">Inspecteur Assigné</div>
                        <div style="font-size: 14px; color: #1e293b; font-weight: 600;">
                            ${inspector ? `${inspector.lastName} ${inspector.firstName}` : 'Non assigné'}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 5px;">Date d'Ouverture</div>
                        <div style="font-size: 14px; color: #1e293b; font-weight: 600;">${new Date(dossier.startDate).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 5px;">Date Limite</div>
                        <div style="font-size: 14px; color: ${isDelayed ? '#dc2626' : '#1e293b'}; font-weight: 600;">
                            ${dossier.deadline ? new Date(dossier.deadline).toLocaleDateString('fr-FR') : 'Non définie'}
                            ${daysUntilDeadline !== null ? `
                                <div style="font-size: 12px; color: ${isDelayed ? '#dc2626' : '#64748b'}; font-weight: ${isDelayed ? '700' : '400'};">
                                    ${isDelayed ? 'Retard de ' + Math.abs(daysUntilDeadline) + ' jour(s)' : daysUntilDeadline + ' jour(s) restant(s)'}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progression -->
            <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #0284c7;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #0284c7; font-size: 16px; margin: 0;">
                        <i class="fas fa-chart-line"></i> Progression Globale
                    </h4>
                    <div style="font-size: 24px; font-weight: 800; color: #0284c7;">${dossier.progress || 0}%</div>
                </div>
                <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                    <div style="width: ${dossier.progress || 0}%; height: 100%; background: linear-gradient(90deg, #0284c7 0%, #38bdf8 100%);"></div>
                </div>
            </div>
    `;
    
    // Section Tâches
    if (dossier.tasks && dossier.tasks.length > 0) {
        details += `
            <div style="margin-bottom: 20px;">
                <h4 style="color: #1e3a8a; margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-tasks"></i> Tâches (${dossier.tasks.length})
                </h4>
                <div style="display: grid; gap: 10px;">
                    ${dossier.tasks.map(task => {
                        const taskStatusClass = task.status === 'Terminée' ? 'status-termine' :
                                              task.status === 'En cours' ? 'status-en-cours' : 'status-nouveau';
                        const taskProgressColor = task.progress < 30 ? '#ef4444' :
                                                task.progress < 70 ? '#f59e0b' : '#10b981';
                        
                        return `
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; border-left: 4px solid ${taskProgressColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-weight: 700; color: #1e293b; font-size: 14px;">${task.name}</div>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <span class="status-badge ${taskStatusClass}" style="font-size: 11px;">
                                            ${task.status}
                                        </span>
                                        <span style="font-weight: 700; color: ${taskProgressColor}; font-size: 14px;">
                                            ${task.progress}%
                                        </span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                    <div>
                                        <div style="color: #64748b; font-size: 12px;">Responsable</div>
                                        <div style="font-weight: 600;">${task.responsible || 'Non assigné'}</div>
                                    </div>
                                    <div>
                                        <div style="color: #64748b; font-size: 12px;">Échéance</div>
                                        <div style="font-weight: 600;">${task.deadline ? new Date(task.deadline).toLocaleDateString('fr-FR') : 'Non définie'}</div>
                                    </div>
                                </div>
                                ${task.files && task.files.length > 0 ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                                        <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">Fichiers joints:</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                            ${task.files.map(file => `
                                                <span style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #475569;">
                                                    <i class="fas fa-paperclip"></i> ${file.name || 'Fichier'}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    } else {
        details += `
            <div style="text-align: center; padding: 30px; background: #f8fafc; border-radius: 12px; margin-bottom: 20px;">
                <i class="fas fa-tasks" style="font-size: 48px; color: #cbd5e1; margin-bottom: 15px; display: block;"></i>
                <div style="color: #64748b; font-size: 16px;">Aucune tâche définie pour ce dossier</div>
            </div>
        `;
    }
    
    details += `
            <!-- Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                <button onclick="closeModal('modalCustom')" 
                        style="background: #f1f5f9; border: 2px solid #cbd5e1; color: #475569; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    Fermer
                </button>
                ${checkPermission('write') ? `
                <button onclick="editDossier('${dossier.id}')" 
                        style="background: #1e3a8a; border: none; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    openModal('modalCustom');
}

function deleteDossier(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée. Seul l\'administrateur peut supprimer des dossiers.', 'error');
        return;
    }
    
    const dossier = dossiers.find(d => d.id === id);
    if (!dossier) return;
    
    const tasksCount = dossier.tasks?.length || 0;
    
    let confirmMessage = `Êtes-vous sûr de vouloir supprimer le dossier "${dossier.reference}" ?`;
    
    if (tasksCount > 0) {
        confirmMessage += `\n\n${tasksCount} tâche(s) seront supprimée(s).`;
    }
    
    if (confirm(confirmMessage)) {
        dossiers = dossiers.filter(d => d.id !== id);
        loadDossiers();
        saveAllData();
        showNotification('Dossier supprimé avec succès', 'success');
    }
}    

// Fonction pour charger les tâches de dossiers terminées
function loadDossierTasks() {
    const dossierId = document.getElementById('selectDossierTermine')?.value;
    const taskSelect = document.getElementById('selectTaskTerminee');
    
    if (!dossierId || !taskSelect) return;
    
    const dossier = dossiers.find(d => d.id === dossierId);
    const completedTasks = dossier?.tasks?.filter(t => t.status === 'Terminée') || [];
    
    taskSelect.innerHTML = '<option value="">Sélectionner une tâche...</option>' + 
        completedTasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
}

function showTaskFileUpload() {
    const taskId = document.getElementById('selectTaskTerminee')?.value;
    const section = document.getElementById('taskFileSection');
    
    if (taskId && section) {
        section.style.display = 'block';
    }
}

function triggerTaskFileUpload() {
    document.getElementById('taskFileInput')?.click();
}

function handleTaskFiles(input) {
    const fileList = document.getElementById('taskFileList');
    if (!fileList) return;
    
    Array.from(input.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${input.files.length} fichier(s) ajouté(s)`, 'success');
}


        // ============ FONCTIONS POUR DASHBOARD ============
        
function updateDashboard() {
    // Statistiques de base
    document.getElementById('stat-aerodromes').textContent = aerodromes.length;
    document.getElementById('stat-certifies').textContent = certifications.filter(c => c.status === 'Terminée').length;
    document.getElementById('stat-homologues').textContent = homologations.filter(h => h.status === 'Approuvée').length;
    document.getElementById('stat-inspecteurs').textContent = inspectors.length;
    
    // Calculer les pourcentages pour les barres de progression
    const totalAerodromes = Math.max(aerodromes.length, 1);
    const certifiedPercent = (certifications.filter(c => c.status === 'Terminée').length / totalAerodromes) * 100;
    const homologatedPercent = (homologations.filter(h => h.status === 'Approuvée').length / totalAerodromes) * 100;
    
    document.getElementById('progress-aerodromes').style.width = '100%';
    document.getElementById('progress-certifies').style.width = Math.min(certifiedPercent, 100) + '%';
    document.getElementById('progress-homologues').style.width = Math.min(homologatedPercent, 100) + '%';
    document.getElementById('progress-inspecteurs').style.width = '100%';
    
    // Statistiques avancées
    const now = new Date();
    const upcomingInspections = plannings.filter(p => {
        const startDate = new Date(p.dateDebut);
        return startDate > now && p.status === 'Planifié';
    }).length;
    
    const upcomingTrainings = formations.filter(f => {
        const startDate = new Date(f.startDate);
        return startDate > now && f.status === 'Planifiée';
    }).length;
    
    const delayedDossiers = dossiers.filter(d => {
        if (!d.deadline) return false;
        const deadline = new Date(d.deadline);
        return deadline < now && d.progress < 100;
    }).length;
    
    const riskAerodromes = aerodromes.filter(a => a.riskLevel === 'Élevé').length;
    
    document.getElementById('stat-inspections-a-venir').textContent = upcomingInspections;
    document.getElementById('stat-formations-a-venir').textContent = upcomingTrainings;
    document.getElementById('stat-dossiers-retard').textContent = delayedDossiers;
    document.getElementById('stat-aerodromes-risque').textContent = riskAerodromes;
    
    // Mettre à jour les barres de progression des indicateurs avancés
    document.getElementById('progress-inspections-a-venir').style.width = Math.min((upcomingInspections / Math.max(plannings.length, 1)) * 100, 100) + '%';
    document.getElementById('progress-formations-a-venir').style.width = Math.min((upcomingTrainings / Math.max(formations.length, 1)) * 100, 100) + '%';
    document.getElementById('progress-dossiers-retard').style.width = Math.min((delayedDossiers / Math.max(dossiers.length, 1)) * 100, 100) + '%';
    document.getElementById('progress-aerodromes-risque').style.width = Math.min((riskAerodromes / Math.max(aerodromes.length, 1)) * 100, 100) + '%';
    
    // 🔥 CORRECTION IMPORTANTE : Mettre à jour les indicateurs de performance
    updatePerformanceIndicators();
    
    updateInspectorsPerformance();
    updateServicesPerformance();

    // Mettre à jour les niveaux de risque
    updateRiskLevels();
    
   // Mettre à jour les tendances
    updateTrends();
}

        function updatePerformanceIndicators() {
    // 1. Taux de conformité global
    const totalSurveillances = surveillances.length;
    if (totalSurveillances > 0) {
        const totalConformite = surveillances.reduce((sum, s) => sum + (s.conformite || 0), 0);
        const globalConformity = Math.round(totalConformite / totalSurveillances);
        
        document.getElementById('performance-conformite-global').innerHTML = `
            <strong>${globalConformity}%</strong> de conformité moyenne
            <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
                Basé sur ${totalSurveillances} inspection(s)
            </div>
        `;
        document.getElementById('progress-conformite-global').style.width = globalConformity + '%';
        
        // Couleur dynamique
        let conformiteColor = 'var(--danger-color)';
        if (globalConformity >= 80) conformiteColor = 'var(--success-color)';
        else if (globalConformity >= 60) conformiteColor = 'var(--warning-color)';
        document.getElementById('progress-conformite-global').style.background = `linear-gradient(90deg, ${conformiteColor} 0%, ${conformiteColor} 100%)`;
    } else {
        document.getElementById('performance-conformite-global').innerHTML = `
            <strong>N/A</strong>
            <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
                Aucune inspection enregistrée
            </div>
        `;
        document.getElementById('progress-conformite-global').style.width = '0%';
    }
    
    // 2. Certifications en cours
    const ongoingCertifications = certifications.filter(c => c.status === 'En cours').length;
    const totalCertifications = Math.max(certifications.length, 1);
    const certPercent = (ongoingCertifications / totalCertifications) * 100;
    
    document.getElementById('performance-certifications-cours').innerHTML = `
        <strong>${ongoingCertifications}</strong> certification(s) en cours
        <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
            Sur ${certifications.length} au total
        </div>
    `;
    document.getElementById('progress-certifications-cours').style.width = certPercent + '%';
    
    // 3. Niveau de risque moyen
    const riskValues = { 'Faible': 1, 'Moyen': 2, 'Élevé': 3 };
    const totalRisk = aerodromes.reduce((sum, a) => sum + (riskValues[a.riskLevel] || 0), 0);
    const avgRisk = aerodromes.length > 0 ? totalRisk / aerodromes.length : 1;
    const riskPercent = ((avgRisk - 1) / 2) * 100;
    
    let riskLabel = 'Faible';
    let riskColor = 'var(--success-color)';
    if (avgRisk >= 2.5) {
        riskLabel = 'Élevé';
        riskColor = 'var(--danger-color)';
    } else if (avgRisk >= 1.5) {
        riskLabel = 'Moyen';
        riskColor = 'var(--warning-color)';
    }
    
    document.getElementById('performance-risque-moyen').innerHTML = `
        <strong>${avgRisk.toFixed(1)}/3</strong> - ${riskLabel}
        <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
            ${aerodromes.filter(a => a.riskLevel === 'Élevé').length} aérodrome(s) à risque élevé
        </div>
    `;
    document.getElementById('progress-risque-moyen').style.width = riskPercent + '%';
    document.getElementById('progress-risque-moyen').style.background = `linear-gradient(90deg, ${riskColor} 0%, ${riskColor} 100%)`;
    
    // 4. Inspections en retard
    const now = new Date();
    const delayedInspections = plannings.filter(p => {
        const endDate = new Date(p.dateFin);
        return endDate < now && p.status !== 'Terminé';
    }).length;
    const totalInspections = Math.max(plannings.length, 1);
    const delayPercent = (delayedInspections / totalInspections) * 100;
    
    document.getElementById('performance-inspections-retard').innerHTML = `
        <strong>${delayedInspections}</strong> inspection(s) en retard
        <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
            ${Math.round(delayPercent)}% du total
        </div>
    `;
    document.getElementById('progress-inspections-retard').style.width = delayPercent + '%';
}

        function updateRiskLevels() {
    const container = document.getElementById('risk-levels-container');
    const riskCounts = {
        'Faible': aerodromes.filter(a => a.riskLevel === 'Faible').length,
        'Moyen': aerodromes.filter(a => a.riskLevel === 'Moyen').length,
        'Élevé': aerodromes.filter(a => a.riskLevel === 'Élevé').length
    };
    
    const total = aerodromes.length;
    
    container.innerHTML = Object.entries(riskCounts).map(([level, count]) => {
        let color = 'var(--success-color)';
        let icon = 'check-circle';
        let bgGradient = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
        
        if (level === 'Moyen') {
            color = 'var(--warning-color)';
            icon = 'exclamation-triangle';
            bgGradient = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
        } else if (level === 'Élevé') {
            color = 'var(--danger-color)';
            icon = 'exclamation-circle';
            bgGradient = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
        }
        
        const percent = total > 0 ? (count / total) * 100 : 0;
        
        // Récupérer la liste des aérodromes de ce niveau
        const aerodromesOfLevel = aerodromes.filter(a => a.riskLevel === level);
        const aerodromesList = aerodromesOfLevel.map(a => `• ${a.code} - ${a.name}`).join('\n');
        
        return `
            <div class="stat-card" 
                 style="cursor: pointer; background: ${bgGradient}; border-left: 4px solid ${color};"
                 onclick="viewAerodromesByRisk('${level}')"
                 title="${count > 0 ? 'Cliquez pour voir les détails\n\n' + aerodromesList : 'Aucun aérodrome'}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: ${color}; margin: 0;">${count}</h3>
                    <div style="width: 50px; height: 50px; background: ${color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                        <i class="fas fa-${icon}"></i>
                    </div>
                </div>
                
                <p style="margin-bottom: 15px; font-weight: 600; color: ${color};">
                    Aérodromes ${level}
                </p>
                
                <div class="progress-bar" style="margin-bottom: 10px; height: 8px;">
                    <div class="progress-fill" style="width: ${percent}%; background: ${color}; transition: width 1s ease-out;"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: center; font-size: 14px; color: ${color}; font-weight: 600;">
                        ${percent.toFixed(1)}% du total
                    </div>
                    <div style="color: ${color}; opacity: 0.7;">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
                
                ${count > 0 ? `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; font-size: 12px; max-height: 100px; overflow-y: auto;">
                        <strong>Aérodromes concernés :</strong><br>
                        ${aerodromesOfLevel.slice(0, 3).map(a => `• ${a.code}`).join('<br>')}
                        ${aerodromesOfLevel.length > 3 ? `<br>• ... et ${aerodromesOfLevel.length - 3} autre(s)` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function updateTrends() {
    const now = new Date();
    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const sixtyDaysAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);
    
    // Certifications des 30 derniers jours
    const recentCerts = certifications.filter(c => {
        const date = new Date(c.dateCreation || c.dateDebut);
        return date >= thirtyDaysAgo;
    }).length;
    
    const previousCerts = certifications.filter(c => {
        const date = new Date(c.dateCreation || c.dateDebut);
        return date >= sixtyDaysAgo && date < thirtyDaysAgo;
    }).length;
    
    const certPercent = previousCerts > 0 ? ((recentCerts - previousCerts) / previousCerts * 100) : 0;
    document.getElementById('trend-certifications').textContent = recentCerts;
    document.getElementById('trend-cert-percent').textContent = Math.abs(certPercent).toFixed(0) + '%';
    
    // Inspections des 30 derniers jours
    const recentInsp = plannings.filter(p => {
        const date = new Date(p.dateDebut);
        return date >= thirtyDaysAgo && p.status === 'Terminé';
    }).length;
    
    const previousInsp = plannings.filter(p => {
        const date = new Date(p.dateDebut);
        return date >= sixtyDaysAgo && date < thirtyDaysAgo && p.status === 'Terminé';
    }).length;
    
    const inspPercent = previousInsp > 0 ? ((recentInsp - previousInsp) / previousInsp * 100) : 0;
    document.getElementById('trend-inspections').textContent = recentInsp;
    document.getElementById('trend-insp-percent').textContent = Math.abs(inspPercent).toFixed(0) + '%';
    
    // Événements des 30 derniers jours
    const recentEvents = evenements.filter(e => {
        const date = new Date(e.date);
        return date >= thirtyDaysAgo;
    }).length;
    
    const previousEvents = evenements.filter(e => {
        const date = new Date(e.date);
        return date >= sixtyDaysAgo && date < thirtyDaysAgo;
    }).length;
    
    const eventPercent = previousEvents > 0 ? ((recentEvents - previousEvents) / previousEvents * 100) : 0;
    document.getElementById('trend-evenements').textContent = recentEvents;
    document.getElementById('trend-event-percent').textContent = Math.abs(eventPercent).toFixed(0) + '%';
}

// ============ FONCTIONS PERFORMANCES INSPECTEURS ============

function updateInspectorSelects() {
            const inspectorSelects = document.querySelectorAll('select[id$="Inspector"], select[id="dossierInspector"]');
            inspectorSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Sélectionner un inspecteur...</option>' + 
                    inspectors.map(i => `<option value="${i.id}">${i.lastName} ${i.firstName} (${i.specialty})</option>`).join('');
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

function updateUserSelects() {
            // Cette fonction sera implémentée plus tard pour les utilisateurs
        }

function calculateInspectorPerformance(inspectorId) {
    const now = new Date();
    const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
    const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
    
    // Dossiers traités/mois
    const dossiersTraites = dossiers.filter(d => {
        const dossierDate = new Date(d.dateCreation);
        return d.inspectorId === inspectorId && 
               d.status === 'Terminé' && 
               dossierDate >= oneMonthAgo;
    }).length;
    
    // Inspections réalisées/semestre
    const inspectionsRealisees = plannings.filter(p => {
        const planningDate = new Date(p.dateDebut);
        return (p.equipe && p.equipe.includes(inspectorId)) && 
               p.status === 'Terminé' && 
               planningDate >= sixMonthsAgo;
    }).length;
    
    // Formations effectuées/an
    const formationsEffectuees = formations.filter(f => {
        const formationDate = new Date(f.startDate);
        return (f.participants && f.participants.includes(inspectorId)) && 
               f.status === 'Terminée' && 
               formationDate >= oneYearAgo;
    }).length;
    
    // Surveillances réalisées
    const surveillancesRealisees = surveillances.filter(s => {
        return (s.inspecteurs && s.inspecteurs.includes(inspectorId));
    }).length;
    
    // Taux de conformité moyen
    const surveillancesInspecteur = surveillances.filter(s => 
        s.inspecteurs && s.inspecteurs.includes(inspectorId)
    );
    const tauxConformite = surveillancesInspecteur.length > 0
        ? Math.round(surveillancesInspecteur.reduce((sum, s) => sum + (s.conformite || 0), 0) / surveillancesInspecteur.length)
        : 0;
    
    return {
        dossiersTraites,
        inspectionsRealisees,
        formationsEffectuees,
        surveillancesRealisees,
        tauxConformite
    };
}

function updateInspectorsPerformance() {
    const container = document.getElementById('inspectors-performance-container');
    if (!container) return;
    
    if (inspectors.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-secondary);">
                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5; display: block;"></i>
                <p>Aucun inspecteur enregistré</p>
            </div>
        `;
        return;
    }
    
    // Calculer les performances pour chaque inspecteur
    const inspectorsWithPerf = inspectors.map(inspector => {
        const perf = calculateInspectorPerformance(inspector.id);
        return { ...inspector, performance: perf };
    });
    
    // Trier par nombre de dossiers traités (les plus actifs en premier)
    inspectorsWithPerf.sort((a, b) => 
        b.performance.dossiersTraites - a.performance.dossiersTraites
    );
    
    // Afficher top 6 inspecteurs
    const topInspectors = inspectorsWithPerf.slice(0, 6);
    
    container.innerHTML = topInspectors.map(inspector => {
        const perf = inspector.performance;
        
        // Calculer un score global (sur 100)
        const scoreGlobal = Math.min(100, Math.round(
            (perf.dossiersTraites * 10) +
            (perf.inspectionsRealisees * 5) +
            (perf.formationsEffectuees * 8) +
            (perf.tauxConformite * 0.3)
        ));
        
        let scoreColor = 'var(--danger-color)';
        if (scoreGlobal >= 70) scoreColor = 'var(--success-color)';
        else if (scoreGlobal >= 40) scoreColor = 'var(--warning-color)';
        
        let statusClass = 'status-active';
        if (inspector.status === 'En congé') statusClass = 'status-onleave';
        else if (inspector.status === 'En formation') statusClass = 'status-intraining';
        else if (inspector.status === 'Inactif') statusClass = 'status-closed';
        
        return `
            <div class="stat-card" style="cursor: pointer;" onclick="viewInspectorPerformanceDetails('${inspector.id}')">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                            ${inspector.lastName} ${inspector.firstName}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${inspector.specialty}
                        </div>
                        <span class="status-badge ${statusClass}" style="margin-top: 5px; font-size: 10px;">
                            ${inspector.status}
                        </span>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: ${scoreColor};">
                            ${scoreGlobal}
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary);">
                            Score
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div class="progress-bar" style="height: 8px;">
                        <div class="progress-fill" style="width: ${scoreGlobal}%; background: ${scoreColor};"></div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                    <div>
                        <i class="fas fa-folder"></i> <strong>${perf.dossiersTraites}</strong> dossiers/mois
                    </div>
                    <div>
                        <i class="fas fa-calendar-check"></i> <strong>${perf.inspectionsRealisees}</strong> inspect/sem.
                    </div>
                    <div>
                        <i class="fas fa-graduation-cap"></i> <strong>${perf.formationsEffectuees}</strong> form/an
                    </div>
                    <div>
                        <i class="fas fa-chart-line"></i> <strong>${perf.tauxConformite}%</strong> conformité
                    </div>
                </div>
                
                <div style="margin-top: 10px; font-size: 11px; color: var(--primary-color); font-weight: 600; text-align: right;">
                    <i class="fas fa-arrow-right"></i> Voir détails
                </div>
            </div>
        `;
    }).join('');
}

// ============ FONCTIONS PERFORMANCES SERVICES ============

function calculateServicePerformance(serviceName) {
    const now = new Date();
    const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    
    // Filtrer les dossiers du service
    const dossiersDuService = dossiers.filter(d => 
        d.service === serviceName
    );
    
    // Dossiers ce mois
    const dossiersMois = dossiersDuService.filter(d => {
        const dDate = new Date(d.dateCreation);
        return dDate >= oneMonthAgo;
    }).length;
    
    if (serviceName === 'Service Normes d\'Aérodromes') {
        // Certifications - utiliser un nom différent pour la variable locale
        const certificationsCount = certifications.filter(c => {
            const cDate = new Date(c.dateCreation);
            return cDate >= oneMonthAgo;
        }).length;
        
        // Homologations - même problème ici !
        const homologationsCount = homologations.filter(h => {
            const hDate = new Date(h.dateCreation);
            return hDate >= oneMonthAgo;
        }).length;
        
        // Inspections liées aux normes
        const inspections = plannings.filter(p => 
            p.type === 'Programmée' && p.status === 'Terminé'
        ).length;
        
        // Taux de conformité moyen
        const surveillancesNormes = surveillances.filter(s => 
            s.type && s.type.includes('Certification') || s.type.includes('Homologation')
        );
        const tauxConformite = surveillancesNormes.length > 0
            ? Math.round(surveillancesNormes.reduce((sum, s) => sum + (s.conformite || 0), 0) / surveillancesNormes.length)
            : 0;
        
        return {
            dossiersMois,
            certifications: certificationsCount, // retourner avec le bon nom
            homologations: homologationsCount,
            inspections,
            tauxConformite
        };
    } else {
        // Même problème avec 'evenements' ici !
        const evenementsCount = evenements.filter(e => {
            const eDate = new Date(e.date);
            return eDate >= oneMonthAgo;
        }).length;
        
        // Audits de sécurité
        const audits = surveillances.filter(s => 
            s.type && (s.type.includes('Sécurité') || s.type.includes('Surveillance'))
        ).length;
        
        // Plans d'action
        const plansAction = plansActions.filter(p => {
            const pDate = new Date(p.startDate);
            return pDate >= oneMonthAgo;
        }).length;
        
        // Taux de résolution (événements clôturés / total)
        const evenementsClotures = evenements.filter(e => e.status === 'Clôturé').length;
        const tauxResolution = evenementsCount > 0
            ? Math.round((evenementsClotures / evenementsCount) * 100)
            : 0;
        
        return {
            dossiersMois,
            evenements: evenementsCount,
            audits,
            plansAction,
            tauxResolution
        };
    }
}

function updateServicesPerformance() {
    // Service Normes
    const perfNormes = calculateServicePerformance('Service Normes d\'Aérodromes');
    document.getElementById('stat-normes-dossiers').textContent = perfNormes.dossiersMois;
    document.getElementById('stat-normes-certifs').textContent = perfNormes.certifications || 0;
    document.getElementById('stat-normes-homologs').textContent = perfNormes.homologations || 0;
    document.getElementById('stat-normes-inspections').textContent = perfNormes.inspections || 0;
    document.getElementById('stat-normes-conformite').textContent = (perfNormes.tauxConformite || 0) + '%';
    
    // Service Sécurité
    const perfSecurite = calculateServicePerformance('Service Sécurité des Aérodromes');
    document.getElementById('stat-securite-dossiers').textContent = perfSecurite.dossiersMois;
    document.getElementById('stat-securite-events').textContent = perfSecurite.evenements || 0;
    document.getElementById('stat-securite-audits').textContent = perfSecurite.audits || 0;
    document.getElementById('stat-securite-plans').textContent = perfSecurite.plansAction || 0;
    document.getElementById('stat-securite-resolution').textContent = (perfSecurite.tauxResolution || 0) + '%';
}

// ============ FONCTIONS DE VISUALISATION DÉTAILLÉE ============

function viewInspectorPerformanceDetails(inspectorId) {
    const inspector = inspectors.find(i => i.id === inspectorId);
    if (!inspector) return;
    
    const perf = calculateInspectorPerformance(inspectorId);
    
    // Obtenir les détails des activités
    const dossiersDetails = dossiers.filter(d => d.inspectorId === inspectorId && d.status === 'Terminé')
        .slice(0, 5)
        .map(d => `<li>${d.reference} - ${new Date(d.dateCreation).toLocaleDateString('fr-FR')}</li>`)
        .join('') || '<li>Aucun dossier terminé récemment</li>';
    
    const inspectionsDetails = plannings.filter(p => 
        p.equipe && p.equipe.includes(inspectorId) && p.status === 'Terminé'
    )
        .slice(0, 5)
        .map(p => {
            const aero = aerodromes.find(a => a.id === p.aerodromeId);
            return `<li>${aero?.code || 'N/A'} - ${new Date(p.dateDebut).toLocaleDateString('fr-FR')}</li>`;
        })
        .join('') || '<li>Aucune inspection terminée récemment</li>';
    
    const formationsDetails = formations.filter(f => 
        f.participants && f.participants.includes(inspectorId)
    )
        .slice(0, 5)
        .map(f => `<li>${f.title} - ${new Date(f.startDate).toLocaleDateString('fr-FR')}</li>`)
        .join('') || '<li>Aucune formation suivie récemment</li>';
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                Performances de ${inspector.lastName} ${inspector.firstName}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Vue d'ensemble</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Dossiers traités ce mois</div>
                        <div class="detail-value" style="font-size: 32px; color: var(--success-color);">
                            ${perf.dossiersTraites}
                        </div>
                    </div>
                    <div>
                        <div class="detail-label">Inspections ce semestre</div>
                        <div class="detail-value" style="font-size: 32px; color: var(--info-color);">
                            ${perf.inspectionsRealisees}
                        </div>
                    </div>
                    <div>
                        <div class="detail-label">Formations cette année</div>
                        <div class="detail-value" style="font-size: 32px; color: var(--accent-color);">
                            ${perf.formationsEffectuees}
                        </div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Surveillances totales</div>
                        <div class="detail-value">${perf.surveillancesRealisees}</div>
                    </div>
                    <div>
                        <div class="detail-label">Taux de conformité moyen</div>
                        <div class="detail-value">
                            <span style="font-size: 24px; color: ${perf.tauxConformite >= 70 ? 'var(--success-color)' : 'var(--warning-color)'};">
                                ${perf.tauxConformite}%
                            </span>
                        </div>
                    </div>
                    <div>
                        <div class="detail-label">Spécialité</div>
                        <div class="detail-value">${inspector.specialty}</div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Derniers dossiers terminés</h4>
                <ul style="padding-left: 20px;">
                    ${dossiersDetails}
                </ul>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Dernières inspections réalisées</h4>
                <ul style="padding-left: 20px;">
                    ${inspectionsDetails}
                </ul>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Formations suivies</h4>
                <ul style="padding-left: 20px;">
                    ${formationsDetails}
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function viewServiceDetails(serviceType) {
    const serviceName = serviceType === 'normes' 
        ? 'Service Normes d\'Aérodromes' 
        : 'Service Sécurité des Aérodromes';
    
    const perf = calculateServicePerformance(serviceName);
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                Performances du ${serviceName}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Statistiques du mois en cours</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Dossiers traités</div>
                        <div class="detail-value" style="font-size: 48px; color: var(--primary-color);">
                            ${perf.dossiersMois}
                        </div>
                    </div>
                    ${serviceType === 'normes' ? `
                        <div>
                            <div class="detail-label">Certifications</div>
                            <div class="detail-value" style="font-size: 32px; color: var(--success-color);">
                                ${perf.certifications || 0}
                            </div>
                        </div>
                        <div>
                            <div class="detail-label">Homologations</div>
                            <div class="detail-value" style="font-size: 32px; color: var(--info-color);">
                                ${perf.homologations || 0}
                            </div>
                        </div>
                    ` : `
                        <div>
                            <div class="detail-label">Événements traités</div>
                            <div class="detail-value" style="font-size: 32px; color: var(--warning-color);">
                                ${perf.evenements || 0}
                            </div>
                        </div>
                        <div>
                            <div class="detail-label">Plans d'action</div>
                            <div class="detail-value" style="font-size: 32px; color: var(--accent-color);">
                                ${perf.plansAction || 0}
                            </div>
                        </div>
                    `}
                </div>
                
                ${serviceType === 'normes' ? `
                    <div class="detail-row">
                        <div>
                            <div class="detail-label">Inspections réalisées</div>
                            <div class="detail-value">${perf.inspections || 0}</div>
                        </div>
                        <div>
                            <div class="detail-label">Taux de conformité moyen</div>
                            <div class="detail-value">
                                <span style="font-size: 24px; color: ${perf.tauxConformite >= 70 ? 'var(--success-color)' : 'var(--warning-color)'};">
                                    ${perf.tauxConformite || 0}%
                                </span>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="detail-row">
                        <div>
                            <div class="detail-label">Audits de sécurité</div>
                            <div class="detail-value">${perf.audits || 0}</div>
                        </div>
                        <div>
                            <div class="detail-label">Taux de résolution</div>
                            <div class="detail-value">
                                <span style="font-size: 24px; color: ${perf.tauxResolution >= 70 ? 'var(--success-color)' : 'var(--warning-color)'};">
                                    ${perf.tauxResolution || 0}%
                                </span>
                            </div>
                        </div>
                    </div>
                `}
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Membres de l'équipe</h4>
                <div style="padding: 15px; background: var(--light-bg); border-radius: 8px;">
                    ${inspectors.filter(i => 
                        (serviceType === 'normes' && i.specialty && 
                         (i.specialty.includes('Exploitation') || i.specialty.includes('Génie'))) ||
                        (serviceType === 'securite' && i.specialty && i.specialty.includes('Sécurité'))
                    ).map(i => `
                        <div style="padding: 10px; margin-bottom: 5px; background: white; border-radius: 6px;">
                            <strong>${i.lastName} ${i.firstName}</strong> - ${i.specialty}
                        </div>
                    `).join('') || '<p>Aucun inspecteur assigné à ce service</p>'}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function refreshDashboard() {
    showLoading();
    showNotification('Actualisation du tableau de bord...', 'info');
    
    setTimeout(() => {
        updateDashboard();
        updateAlertes();
        hideLoading();
        showNotification('Tableau de bord actualisé avec succès!', 'success');
    }, 1000);
}

function exportDashboardData() {
    showLoading();
    
    setTimeout(() => {
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        const dashboardData = {
            dateExport: now.toISOString(),
            periode: '30 derniers jours',
            statistiques: {
                aerodromes: {
                    total: aerodromes.length,
                    certifies: certifications.filter(c => c.status === 'Terminée').length,
                    homologues: homologations.filter(h => h.status === 'Approuvée').length,
                    aRisque: aerodromes.filter(a => a.riskLevel === 'Élevé').length
                },
                inspections: {
                    total: plannings.length,
                    aVenir: plannings.filter(p => new Date(p.dateDebut) > now && p.status === 'Planifié').length,
                    enRetard: plannings.filter(p => new Date(p.dateFin) < now && p.status !== 'Terminé').length,
                    recentesTerminees: plannings.filter(p => {
                        const date = new Date(p.dateDebut);
                        return date >= thirtyDaysAgo && p.status === 'Terminé';
                    }).length
                },
                conformite: {
                    moyenne: surveillances.length > 0 
                        ? Math.round(surveillances.reduce((sum, s) => sum + (s.conformite || 0), 0) / surveillances.length)
                        : 0,
                    totalInspections: surveillances.length
                },
                formations: {
                    total: formations.length,
                    aVenir: formations.filter(f => new Date(f.startDate) > now && f.status === 'Planifiée').length,
                    inspecteurs: inspectors.length
                },
                evenements: {
                    total: evenements.length,
                    recents: evenements.filter(e => new Date(e.date) >= thirtyDaysAgo).length,
                    critiques: evenements.filter(e => e.gravite === 'Critique' && e.status !== 'Clôturé').length
                }
            }
        };
        
        // Créer un blob et télécharger
        const dataStr = JSON.stringify(dashboardData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dashboard_export_${now.toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        hideLoading();
        showNotification('Export réussi! Fichier téléchargé.', 'success');
    }, 800);
}

// Fonction pour voir les aérodromes par niveau de risque
function viewAerodromesByRisk(riskLevel) {
    showTab('aerodromes');
    setTimeout(() => {
        const filtered = aerodromes.filter(a => a.riskLevel === riskLevel);
        if (filtered.length > 0) {
            loadAerodromes(filtered);
            showNotification(`${filtered.length} aérodrome(s) avec risque ${riskLevel}`, 'info');
        } else {
            loadAerodromes();
            showNotification(`Aucun aérodrome avec risque ${riskLevel}`, 'info');
        }
    }, 300);
}

// ============ GESTION DES ALERTES EN TEMPS RÉEL ============

let alertesFiltrees = 'toutes';
let alertesNonLues = 0;

function calculerDelaiJours(dateCible) {
    if (!dateCible) return null;
    const maintenant = new Date();
    const dateLimite = new Date(dateCible);
    const diffTemps = dateLimite.getTime() - maintenant.getTime();
    const diffJours = Math.ceil(diffTemps / (1000 * 60 * 60 * 24));
    return diffJours;
}

function getCouleurAlerte(delaiJours, typeAlerte) {
    if (delaiJours === null) return null;
    
    if (typeAlerte === 'certificat') {
        // Certificats aérodrome : 8 mois vert, 6 mois jaune, 3 mois orange, <3 mois rouge
        if (delaiJours >= 240) return 'basse'; // 8+ mois
        if (delaiJours >= 180) return 'moyenne'; // 6-8 mois
        if (delaiJours >= 90) return 'moyenne'; // 3-6 mois
        if (delaiJours >= 0) return 'haute'; // 0-3 mois
        return 'haute'; // Expiré
    } else if (typeAlerte === 'inspection') {
        // Inspections : 1 mois vert, 1 semaine jaune, < semaine orange, retard rouge
        if (delaiJours > 30) return null; // Plus d'un mois
        if (delaiJours >= 7) return 'basse'; // 1 semaine à 1 mois
        if (delaiJours >= 3) return 'moyenne'; // 3 à 7 jours
        if (delaiJours >= 0) return 'moyenne'; // 0 à 3 jours
        return 'haute'; // En retard
    } else if (typeAlerte === 'plan_action') {
        // Plans d'actions : 1 mois vert, 2 semaines jaune, 1 semaine orange, retard rouge
        if (delaiJours > 30) return null;
        if (delaiJours >= 14) return 'basse';
        if (delaiJours >= 7) return 'moyenne';
        if (delaiJours >= 0) return 'moyenne';
        return 'haute';
    } else if (typeAlerte === 'formation') {
        // Formations : 1 mois vert, 2 semaines jaune, 1 semaine orange, retard rouge
        if (delaiJours > 30) return null;
        if (delaiJours >= 14) return 'basse';
        if (delaiJours >= 7) return 'moyenne';
        if (delaiJours >= 0) return 'moyenne';
        return 'haute';
    }
    return null;
}

function verifierAlertesCertificats() {
    const alertes = [];
    const maintenant = new Date();
    
    aerodromes.forEach(aerodrome => {
        if (!aerodrome.certificatExpiration) return;
        
        const expDate = new Date(aerodrome.certificatExpiration);
        const delaiJours = calculerDelaiJours(aerodrome.certificatExpiration);
        const couleur = getCouleurAlerte(delaiJours, 'certificat');
        
        if (couleur) {
            let message = '';
            let statut = '';
            
            if (couleur === 'basse') {
                message = `Certificat ${aerodrome.code} expire dans ${Math.floor(delaiJours/30)} mois`;
                statut = 'info';
            } else if (couleur === 'moyenne') {
                message = `Certificat ${aerodrome.code} expire dans ${Math.floor(delaiJours/30)} mois - Renouvellement imminent`;
                statut = 'avertissement';
            } else if (couleur === 'haute') {
                if (delaiJours < 0) {
                    message = `Certificat ${aerodrome.code} EXPIRÉ il y a ${-delaiJours} jours`;
                } else {
                    message = `Certificat ${aerodrome.code} expire dans ${delaiJours} jours`;
                }
                statut = 'urgence';
            }
            
            // Vérifier si un renouvellement est en cours
            const renouvellementEnCours = certifications.some(cert => 
                cert.aerodromeId === aerodrome.id && 
                (cert.type === 'Renouvellement' || cert.type === 'Modification') && 
                ['En cours', 'En attente'].includes(cert.status)
            );
            
            if (!renouvellementEnCours) {
                alertes.push({
                    id: `cert_${aerodrome.id}_${Date.now()}`,
                    type: 'certificat',
                    aerodrome: aerodrome.code,
                    message: message,
                    urgence: couleur,
                    statut: statut,
                    dateExpiration: aerodrome.certificatExpiration,
                    delaiJours: delaiJours,
                    action: () => {
                        showTab('certification');
                        openModal('modalCertification');
                        document.getElementById('certAerodrome').value = aerodrome.id;
                        loadAerodromeDetails();
                    },
                    lue: false
                });
            }
        }
    });
    
    return alertes;
}

function verifierAlertesInspections() {
    const alertes = [];
    
    plannings.forEach(planning => {
        if (!planning.dateDebut || planning.status === 'Annulé' || planning.status === 'Reporté') return;
        
        const delaiJours = calculerDelaiJours(planning.dateDebut);
        const couleur = getCouleurAlerte(delaiJours, 'inspection');
        
        if (couleur) {
            let message = '';
            let statut = '';
            
            if (couleur === 'basse') {
                message = `Inspection ${planning.type} à ${planning.aerodrome} dans ${delaiJours} jours`;
                statut = 'info';
            } else if (couleur === 'moyenne') {
                message = `Inspection ${planning.type} à ${planning.aerodrome} dans ${delaiJours} jours`;
                statut = 'avertissement';
            } else if (couleur === 'haute') {
                if (delaiJours < 0) {
                    message = `Inspection ${planning.type} à ${planning.aerodrome} EN RETARD de ${-delaiJours} jours`;
                } else {
                    message = `Inspection ${planning.type} à ${planning.aerodrome} DEMAIN`;
                }
                statut = 'urgence';
            }
            
            // Vérifier si l'inspection est en cours
            if (planning.status !== 'En cours') {
                alertes.push({
                    id: `insp_${planning.id}_${Date.now()}`,
                    type: 'inspection',
                    aerodrome: planning.aerodrome,
                    message: message,
                    urgence: couleur,
                    statut: statut,
                    dateInspection: planning.dateDebut,
                    delaiJours: delaiJours,
                    planningId: planning.id,
                    action: () => {
                        showTab('planning');
                        highlightPlanning(planning.id);
                    },
                    lue: false
                });
            }
        }
    });
    
    return alertes;
}

function verifierAlertesPlansActions() {
    const alertes = [];
    
    plansActions.forEach(plan => {
        if (!plan.deadline || plan.status === 'Clôturé') return;
        
        const delaiJours = calculerDelaiJours(plan.deadline);
        const couleur = getCouleurAlerte(delaiJours, 'plan_action');
        
        if (couleur) {
            let message = '';
            let statut = '';
            
            if (couleur === 'basse') {
                message = `Plan d'action ${plan.reference} - Échéance dans ${delaiJours} jours`;
                statut = 'info';
            } else if (couleur === 'moyenne') {
                message = `Plan d'action ${plan.reference} - Échéance dans ${delaiJours} jours`;
                statut = 'avertissement';
            } else if (couleur === 'haute') {
                if (delaiJours < 0) {
                    message = `Plan d'action ${plan.reference} - EN RETARD de ${-delaiJours} jours`;
                } else {
                    message = `Plan d'action ${plan.reference} - Échéance DANS ${delaiJours} JOURS`;
                }
                statut = 'urgence';
            }
            
            alertes.push({
                id: `plan_${plan.id}_${Date.now()}`,
                type: 'plan_action',
                reference: plan.reference,
                message: message,
                urgence: couleur,
                statut: statut,
                deadline: plan.deadline,
                delaiJours: delaiJours,
                planId: plan.id,
                action: () => {
                    showTab('plans-actions');
                    highlightPlanAction(plan.id);
                },
                lue: false
            });
        }
    });
    
    return alertes;
}

function verifierAlertesFormations() {
    const alertes = [];
    
    formations.forEach(formation => {
        if (!formation.startDate || formation.status !== 'Planifiée') return;
        
        const delaiJours = calculerDelaiJours(formation.startDate);
        const couleur = getCouleurAlerte(delaiJours, 'formation');
        
        if (couleur) {
            let message = '';
            let statut = '';
            
            if (couleur === 'basse') {
                message = `Formation ${formation.title} dans ${delaiJours} jours`;
                statut = 'info';
            } else if (couleur === 'moyenne') {
                message = `Formation ${formation.title} dans ${delaiJours} jours - À confirmer`;
                statut = 'avertissement';
            } else if (couleur === 'haute') {
                if (delaiJours < 0) {
                    message = `Formation ${formation.title} EN RETARD de ${-delaiJours} jours`;
                } else {
                    message = `Formation ${formation.title} DANS ${delaiJours} JOURS`;
                }
                statut = 'urgence';
            }
            
            alertes.push({
                id: `form_${formation.id}_${Date.now()}`,
                type: 'formation',
                titre: formation.title,
                message: message,
                urgence: couleur,
                statut: statut,
                dateFormation: formation.startDate,
                delaiJours: delaiJours,
                formationId: formation.id,
                action: () => {
                    showTab('formation');
                    highlightFormation(formation.id);
                },
                lue: false
            });
        }
    });
    
    return alertes;
}

function genererToutesAlertes() {
    const toutesAlertes = [
        ...verifierAlertesCertificats(),
        ...verifierAlertesInspections(),
        ...verifierAlertesPlansActions(),
        ...verifierAlertesFormations()
    ];
    
    // Trier par urgence (haute > moyenne > basse) puis par délai
    toutesAlertes.sort((a, b) => {
        const priorite = { 'haute': 3, 'moyenne': 2, 'basse': 1 };
        if (priorite[b.urgence] !== priorite[a.urgence]) {
            return priorite[b.urgence] - priorite[a.urgence];
        }
        return a.delaiJours - b.delaiJours;
    });
    
    return toutesAlertes;
}

function afficherAlertes() {
    const container = document.getElementById('alertesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    let toutesAlertes = genererToutesAlertes();
    
    // Filtrer selon le filtre actif
    if (alertesFiltrees !== 'toutes') {
        toutesAlertes = toutesAlertes.filter(alerte => alerte.type === alertesFiltrees);
    }
    
    // Compter les alertes non lues
    alertesNonLues = toutesAlertes.filter(a => !a.lue).length;
    
    if (toutesAlertes.length === 0) {
        container.innerHTML = `
            <div class="aucune-alerte">
                <i class="fas fa-check-circle"></i>
                <p style="font-weight: 600; color: var(--success-color); margin-bottom: 5px;">Aucune alerte active</p>
                <p style="font-size: 13px; color: var(--text-secondary);">Toutes les tâches sont à jour</p>
            </div>
        `;
        return;
    }
    
    toutesAlertes.forEach((alerte, index) => {
        const alerteElement = document.createElement('div');
        alerteElement.className = `alerte-item alerte-urgence-${alerte.urgence} ${!alerte.lue ? 'nouvelle-alerte' : ''}`;
        alerteElement.onclick = function() {
            alerte.action();
            marquerAlerteLue(alerte.id);
            this.classList.remove('nouvelle-alerte');
        };
        alerteElement.setAttribute('data-id', alerte.id);
        alerteElement.setAttribute('data-type', alerte.type);
        alerteElement.style.animationDelay = `${index * 0.1}s`;
        
        let icon = '';
        let iconClass = '';
        if (alerte.type === 'certificat') {
            icon = 'fa-certificate';
            iconClass = 'alerte-icon-certificat';
        } else if (alerte.type === 'inspection') {
            icon = 'fa-clipboard-check';
            iconClass = 'alerte-icon-inspection';
        } else if (alerte.type === 'plan_action') {
            icon = 'fa-clipboard-list';
            iconClass = 'alerte-icon-plan_action';
        } else if (alerte.type === 'formation') {
            icon = 'fa-graduation-cap';
            iconClass = 'alerte-icon-formation';
        }
        
        alerteElement.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 15px;">
                <div class="alerte-icon alerte-icon-urgence-${alerte.urgence}">
                    <i class="fas ${icon}"></i>
                </div>
                <div style="flex: 1;">
                    <div class="alerte-message">${alerte.message}</div>
                    <div class="alerte-details">
                        <div>
                            <span class="alerte-type alerte-type-${alerte.type.replace('_', '')}">
                                ${alerte.type === 'plan_action' ? 'Plan Action' : alerte.type.charAt(0).toUpperCase() + alerte.type.slice(1)}
                            </span>
                            <span class="alerte-date" style="margin-left: 8px;">
                                ${new Date(alerte[alerte.type === 'certificat' ? 'dateExpiration' : 
                                                alerte.type === 'inspection' ? 'dateInspection' : 
                                                alerte.type === 'plan_action' ? 'deadline' : 'dateFormation']).toLocaleDateString('fr-FR')}
                            </span>
                        </div>
                        <div class="alerte-statut alerte-statut-${alerte.statut}">
                            ${alerte.statut.toUpperCase()}
                        </div>
                    </div>
                </div>
            </div>
            ${!alerte.lue ? '<div style="position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: var(--danger-color); border-radius: 50%;"></div>' : ''}
        `;
        
        container.appendChild(alerteElement);
    });
}

function filtrerAlertes(type) {
    alertesFiltrees = type;
    
    // Mettre à jour les boutons actifs
    document.querySelectorAll('.btn-alerte-filtre').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.currentTarget.classList.add('active');
    
    afficherAlertes();
}

function marquerAlerteLue(alerteId) {
    // Dans une vraie application, vous sauvegarderiez cela dans une base de données
    console.log(`Alerte ${alerteId} marquée comme lue`);
    
    // Mettre à jour l'affichage
    const alerteElement = document.querySelector(`[data-id="${alerteId}"]`);
    if (alerteElement) {
        alerteElement.classList.remove('nouvelle-alerte');
        const pointRouge = alerteElement.querySelector('div[style*="background: var(--danger-color)"]');
        if (pointRouge) pointRouge.remove();
    }
}

function marquerToutesAlertesLues() {
    const alertes = genererToutesAlertes();
    alertes.forEach(alerte => {
        marquerAlerteLue(alerte.id);
    });
    
    afficherAlertes();
    showNotification('Toutes les alertes ont été marquées comme lues', 'success');
}

function highlightPlanning(planningId) {
    const elements = document.querySelectorAll('.planning-card');
    elements.forEach(el => {
        if (el.getAttribute('data-id') === planningId) {
            el.style.boxShadow = '0 0 0 3px var(--warning-color)';
            el.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => {
                el.style.boxShadow = '';
                el.style.animation = '';
            }, 3000);
        }
    });
}

function highlightPlanAction(planId) {
    const elements = document.querySelectorAll('.plan-action-card');
    elements.forEach(el => {
        if (el.getAttribute('data-id') === planId) {
            el.style.boxShadow = '0 0 0 3px var(--accent-color)';
            el.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => {
                el.style.boxShadow = '';
                el.style.animation = '';
            }, 3000);
        }
    });
}

function highlightFormation(formationId) {
    const elements = document.querySelectorAll('.formation-card');
    elements.forEach(el => {
        if (el.getAttribute('data-id') === formationId) {
            el.style.boxShadow = '0 0 0 3px #7b1fa2';
            el.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => {
                el.style.boxShadow = '';
                el.style.animation = '';
            }, 3000);
        }
    });
}

function startAlertesMonitoring() {
    // Afficher les alertes immédiatement
    afficherAlertes();
    
    // Rafraîchir les alertes toutes les minutes
    setInterval(afficherAlertes, 60 * 1000);
    
    // Afficher une notification quand il y a de nouvelles alertes
    let dernierNombreAlertes = 0;
    setInterval(() => {
        const alertes = genererToutesAlertes();
        const nouvellesAlertes = alertes.filter(a => !a.lue);
        
        if (nouvellesAlertes.length > dernierNombreAlertes) {
            showNotification(`${nouvellesAlertes.length} nouvelle(s) alerte(s)`, 'warning');
        }
        
        dernierNombreAlertes = nouvellesAlertes.length;
    }, 30 * 1000);
    
    console.log('Système d\'alertes démarré');
}

function showNotification(message, type) {
    // Créer une notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}


	// ============ FONCTIONS D'INTERACTION DASHBOARD ============

function viewRiskAerodromes() {
    showTab('aerodromes');
    setTimeout(() => {
        const riskAerodromes = aerodromes.filter(a => a.riskLevel === 'Élevé');
        if (riskAerodromes.length > 0) {
            showNotification(`${riskAerodromes.length} aérodrome(s) à risque élevé trouvé(s)`, 'warning');
            // Optionnel : filtrer automatiquement
            loadAerodromes(riskAerodromes);
        } else {
            showNotification('Aucun aérodrome à risque élevé', 'success');
        }
    }, 300);
}

function viewUpcomingInspections() {
    showTab('planning');
    setTimeout(() => {
        const now = new Date();
        const upcoming = plannings.filter(p => {
            const startDate = new Date(p.dateDebut);
            return startDate > now && p.status === 'Planifié';
        });
        if (upcoming.length > 0) {
            showNotification(`${upcoming.length} inspection(s) à venir`, 'info');
            loadPlannings(upcoming);
        } else {
            showNotification('Aucune inspection à venir', 'info');
        }
    }, 300);
}

function viewUpcomingFormations() {
    showTab('formation');
    setTimeout(() => {
        const now = new Date();
        const upcoming = formations.filter(f => {
            const startDate = new Date(f.startDate);
            return startDate > now && f.status === 'Planifiée';
        });
        if (upcoming.length > 0) {
            showNotification(`${upcoming.length} formation(s) à venir`, 'info');
            loadFormations(upcoming);
        } else {
            showNotification('Aucune formation à venir', 'info');
        }
    }, 300);
}

function viewDelayedDossiers() {
    showTab('dossiers');
    setTimeout(() => {
        const now = new Date();
        const delayed = dossiers.filter(d => {
            if (!d.deadline) return false;
            const deadline = new Date(d.deadline);
            return deadline < now && d.progress < 100;
        });
        if (delayed.length > 0) {
            showNotification(`${delayed.length} dossier(s) en retard`, 'warning');
            loadDossiers(delayed);
        } else {
            showNotification('Aucun dossier en retard', 'success');
        }
    }, 300);
}

        function updateAlertes() {
    const container = document.getElementById('alertes-container');
    if (!container) {
        console.log('Container alertes-container non trouvé');
        return;
    }
    
    console.log('Mise à jour des alertes, total:', alertes.length);
    
    // Créer des alertes basées sur les données
    const alertesGenerees = [];
    const aujourdhui = new Date();
    
    // 1. ALERTES POUR AÉRODROMES À HAUT RISQUE
    const aerodromesRisque = aerodromes.filter(a => a.riskLevel === 'Élevé');
    if (aerodromesRisque.length > 0) {
        alertesGenerees.push({
            type: 'critical',
            title: '⚠️ Aérodromes à Risque Élevé',
            message: `${aerodromesRisque.length} aérodrome(s) nécessite(nt) une attention immédiate`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: aerodromesRisque.map(a => `• ${a.code} - ${a.name}`).join('\n'),
            color: '#c62828'
        });
    }

    // 2. ALERTES POUR INSPECTIONS À VENIR (7 PROCHAINS JOURS)
    const prochainesInspections = plannings.filter(p => {
        const datePlanning = new Date(p.dateDebut);
        const diffJours = Math.ceil((datePlanning - aujourdhui) / (1000 * 60 * 60 * 24));
        return diffJours > 0 && diffJours <= 7 && p.status === 'Planifié';
    });
    
    if (prochainesInspections.length > 0) {
        alertesGenerees.push({
            type: 'warning',
            title: '📅 Inspections à Venir',
            message: `${prochainesInspections.length} inspection(s) programmée(s) dans les 7 prochains jours`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: prochainesInspections.map(p => {
                const aero = aerodromes.find(a => a.id === p.aerodromeId);
                const dateInsp = new Date(p.dateDebut);
                return `• ${aero?.code || 'N/A'} - ${dateInsp.toLocaleDateString('fr-FR')}`;
            }).join('\n'),
            color: '#f57c00'
        });
    }

    // 3. ALERTES POUR DOSSIERS EN RETARD
    const dossiersRetard = dossiers.filter(d => {
        if (!d.deadline) return false;
        const deadline = new Date(d.deadline);
        return deadline < aujourdhui && d.status !== 'Terminé';
    });
    
    if (dossiersRetard.length > 0) {
        alertesGenerees.push({
            type: 'critical',
            title: '🚨 Dossiers en Retard',
            message: `${dossiersRetard.length} dossier(s) ont dépassé leur échéance`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: dossiersRetard.map(d => {
                const retardJours = Math.ceil((aujourdhui - new Date(d.deadline)) / (1000 * 60 * 60 * 24));
                return `• ${d.reference} - Retard: ${retardJours} jour(s)`;
            }).join('\n'),
            color: '#c62828'
        });
    }

    // 4. ALERTES POUR FORMATIONS À VENIR (14 PROCHAINS JOURS)
    const prochainesFormations = formations.filter(f => {
        const dateFormation = new Date(f.startDate);
        const diffJours = Math.ceil((dateFormation - aujourdhui) / (1000 * 60 * 60 * 24));
        return diffJours > 0 && diffJours <= 14 && f.status === 'Planifiée';
    });
    
    if (prochainesFormations.length > 0) {
        alertesGenerees.push({
            type: 'info',
            title: '🎓 Formations à Venir',
            message: `${prochainesFormations.length} formation(s) dans les 2 prochaines semaines`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: prochainesFormations.map(f => {
                const dateForm = new Date(f.startDate);
                return `• ${f.title} - ${dateForm.toLocaleDateString('fr-FR')}`;
            }).join('\n'),
            color: '#0277bd'
        });
    }

    // 5. ALERTES POUR PLANS D'ACTIONS EN RETARD
    const plansRetard = plansActions.filter(p => {
        if (!p.deadline) return false;
        const deadline = new Date(p.deadline);
        return deadline < aujourdhui && p.status !== 'Clôturé';
    });
    
    if (plansRetard.length > 0) {
        alertesGenerees.push({
            type: 'warning',
            title: '⏰ Plans d\'Actions en Retard',
            message: `${plansRetard.length} plan(s) d'action(s) en retard`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: plansRetard.map(p => `• ${p.reference} - ${p.title}`).join('\n'),
            color: '#f57c00'
        });
    }

    // 6. ALERTES POUR CERTIFICATIONS EN COURS
    const certificationsEnCours = certifications.filter(c => c.status === 'En cours');
    if (certificationsEnCours.length > 0) {
        alertesGenerees.push({
            type: 'info',
            title: '📋 Certifications en Cours',
            message: `${certificationsEnCours.length} certification(s) en cours de traitement`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: certificationsEnCours.map(c => {
                const aero = aerodromes.find(a => a.id === c.aerodromeId);
                return `• ${aero?.code || 'N/A'} - ${aero?.name || 'Inconnu'}`;
            }).join('\n'),
            color: '#0277bd'
        });
    }

    // 7. ALERTES POUR ÉVÉNEMENTS CRITIQUES NON CLÔTURÉS
    const evenementsCritiques = evenements.filter(e => 
        e.gravite === 'Critique' && e.status !== 'Clôturé'
    );
    
    if (evenementsCritiques.length > 0) {
        alertesGenerees.push({
            type: 'critical',
            title: '🔴 Événements Critiques Non Clôturés',
            message: `${evenementsCritiques.length} événement(s) critique(s) nécessite(nt) un suivi`,
            date: aujourdhui.toLocaleDateString('fr-FR'),
            details: evenementsCritiques.map(e => {
                const aero = aerodromes.find(a => a.id === e.aerodromeId);
                return `• ${aero?.code || 'N/A'} - ${e.type}`;
            }).join('\n'),
            color: '#c62828'
        });
    }

    console.log('Alertes générées:', alertesGenerees.length);

    // Afficher les alertes
    if (alertesGenerees.length === 0) {
        container.innerHTML = `
            <div class="alert alert-success" style="animation: fadeIn 0.3s ease-out;">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>✅ Aucune alerte active</strong>
                    <p>Toutes les activités sont à jour</p>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = alertesGenerees.map(alerte => `
            <div class="alert-card ${alerte.type}" style="animation: slideInRight 0.3s ease-out; border-left: 6px solid ${alerte.color};">
                <div class="alert-header">
                    <div class="alert-title">
                        ${alerte.title}
                    </div>
                    <div class="alert-date">${alerte.date}</div>
                </div>
                <p style="margin: 10px 0; font-size: 15px; font-weight: 500;">${alerte.message}</p>
                ${alerte.details ? `<details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: var(--primary-color); font-weight: 600;">Voir les détails</summary>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px; white-space: pre-line; font-size: 13px;">
                        ${alerte.details}
                    </div>
                </details>` : ''}
            </div>
        `).join('');
    }

    // Mettre à jour les statistiques
    document.getElementById('stat-aerodromes-risque').textContent = aerodromesRisque.length;
    document.getElementById('stat-inspections-a-venir').textContent = prochainesInspections.length;
    document.getElementById('stat-formations-a-venir').textContent = prochainesFormations.length;
    document.getElementById('stat-dossiers-retard').textContent = dossiersRetard.length;
    
    // Mettre à jour les barres de progression
    const totalAerodromes = aerodromes.length || 1;
    document.getElementById('progress-aerodromes-risque').style.width = `${(aerodromesRisque.length / totalAerodromes) * 100}%`;
    
    const totalInspections = plannings.length || 1;
    document.getElementById('progress-inspections-a-venir').style.width = `${(prochainesInspections.length / totalInspections) * 100}%`;
    
    const totalFormations = formations.length || 1;
    document.getElementById('progress-formations-a-venir').style.width = `${(prochainesFormations.length / totalFormations) * 100}%`;
    
    const totalDossiers = dossiers.length || 1;
    document.getElementById('progress-dossiers-retard').style.width = `${(dossiersRetard.length / totalDossiers) * 100}%`;
}

        // ============ FONCTIONS DE SAUVEGARDE ET CHARGEMENT ============
        function saveAllData() {
            const data = {
                aerodromes,
                certifications,
                homologations,
                plannings,
                surveillances,
                registres,
                inspectors,
                formations,
                dossiers,
                plansActions,
                utilisateurs,
                evenements,
                alertes,
                kitFiles,
                lastSave: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('sgda_data', JSON.stringify(data));
                console.log('Données sauvegardées avec succès');
                return true;
            } catch (e) {
                console.error('Erreur lors de la sauvegarde:', e);
                return false;
            }
        }

        function loadSavedData() {
    try {
        console.log('🔄 Chargement des données...');
        
        // PRIORITÉ 1 : Format unique 'sgda_data' (votre saveAllData actuel)
        const mainData = localStorage.getItem('sgda_data');
        if (mainData) {
            const data = JSON.parse(mainData);
            aerodromes = data.aerodromes || [];
            certifications = data.certifications || [];
            homologations = data.homologations || [];
            plannings = data.plannings || [];
            surveillances = data.surveillances || [];
            registres = data.registres || [];
            inspectors = data.inspectors || [];
            formations = data.formations || [];
            dossiers = data.dossiers || [];
            plansActions = data.planningsActions || [];  // Note: plansActions
            utilisateurs = data.utilisateurs || [];
            evenements = data.evenements || [];
            alertes = data.alertes || [];
            kitFiles = data.kitFiles || [];
            
            console.log('✅ CHARGÉ depuis sgda_data:', {
                aerodromes: aerodromes.length,
                certifications: certifications.length,
                plannings: plannings.length,
                dossiers: dossiers.length
            });
            updateAllTabs();
            showNotification('Données restaurées avec succès', 'success');
            return;
        }
        
        // PRIORITÉ 2 : Ancien format avec clés séparées (fallback)
        console.log('🔄 Essai format clés séparées...');
        aerodromes = loadFromStorage('aerodromes', []);
        certifications = loadFromStorage('certifications', []);
        homologations = loadFromStorage('homologations', []);
        plannings = loadFromStorage('plannings', []);
        surveillances = loadFromStorage('surveillances', []);
        registres = loadFromStorage('registres', []);
        inspectors = loadFromStorage('inspectors', []);
        formations = loadFromStorage('formations', []);
        dossiers = loadFromStorage('dossiers', []);
        plansActions = loadFromStorage('plansActions', []);
        utilisateurs = loadFromStorage('utilisateurs', []);
        evenements = loadFromStorage('evenements', []);
        alertes = loadFromStorage('alertes', []);
        kitFiles = loadFromStorage('kitFiles', []);
        
        // PRIORITÉ 3 : MIGRATION automatique vers sgda_data si données trouvées
        if (certifications.length > 0 || aerodromes.length > 0) {
            saveAllData();  // Sauvegarde au bon format
            console.log('✅ MIGRATION vers sgda_data effectuée');
        }
        
        console.log('✅ TOTAL chargé:', {
            aerodromes: aerodromes.length,
            certifications: certifications.length,
            plannings: plannings.length,
            dossiers: dossiers.length,
            evenements: evenements.length
        });
        
        if (aerodromes.length > 0 || certifications.length > 0) {
            updateAllTabs();
            showNotification('Données restaurées avec succès', 'success');
        }
        
    } catch (e) {
        console.error('❌ Erreur loadSavedData:', e);
        showNotification('Erreur chargement données', 'error');
    }
}

	function loadFromStorage(key, defaultValue = []) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error(`❌ loadFromStorage ${key}:`, e);
        return defaultValue;
    }
}


        // ============ FONCTIONS POUR CERTIFICATIONS ============
        
        function initCertificationModal() {
            document.getElementById('certificationId').value = '';
            document.getElementById('certModalTitle').textContent = 'Nouvelle Certification';
            document.getElementById('certAerodrome').value = '';
            document.getElementById('certDateDebut').value = new Date().toISOString().split('T')[0];
            document.getElementById('certRemarques').value = '';
            
            // Réinitialiser toutes les phases
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`certPhase${i}Status`).value = 'pending';
                document.getElementById(`certPhase${i}Date`).value = '';
                document.getElementById(`certPhase${i}Responsable`).value = '';
                document.getElementById(`certPhase${i}Comment`).value = '';
                document.getElementById(`certPhase${i}CommentList`).innerHTML = '';
                document.getElementById(`certPhase${i}FileList`).innerHTML = '';
                updateCertPhaseColor(i);
            }
            
            // Masquer les détails de l'aérodrome
            document.getElementById('aerodromeDetails').style.display = 'none';
            
            // Charger la liste des aérodromes
            updateAerodromeSelects();
        }

        function loadAerodromeDetails() {
            const aerodromeId = document.getElementById('certAerodrome').value;
            const detailsDiv = document.getElementById('aerodromeDetails');
            
            if (!aerodromeId) {
                detailsDiv.style.display = 'none';
                return;
            }
            
            const aerodrome = aerodromes.find(a => a.id === aerodromeId);
            if (aerodrome) {
                document.getElementById('detailCodeOaci').textContent = aerodrome.code;
                document.getElementById('detailVille').textContent = aerodrome.city;
                document.getElementById('detailType').textContent = aerodrome.type;
                document.getElementById('detailStatut').textContent = aerodrome.status;
                detailsDiv.style.display = 'block';
            }
        }

        function saveCertification() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée. Vous n\'avez pas les droits pour créer/modifier des certifications.', 'error');
        return;
    }
    
    const aerodromeId = document.getElementById('certAerodrome').value;
    const dateDebut = document.getElementById('certDateDebut').value;
    
    if (!aerodromeId || !dateDebut) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    // VÃ©rifier si une homologation active existe pour cet aÃ©rodrome
    const homologationActive = homologations.find(h => 
        h.aerodromeId === aerodromeId && 
        (h.status === 'En cours' || h.status === 'En attente')
    );
    
    if (homologationActive) {
        const aerodrome = aerodromes.find(a => a.id === aerodromeId);
        showNotification(
            `Impossible de certifier ${aerodrome?.name || 'cet aérodrome'}. Une homologation est déjà en cours (${homologationActive.numero || 'sans numéro'}).`, 
            'error'
        );
        return;
    }
    
    // VÃ©rifier si une certification active existe dÃ©jÃ 
    const certId = document.getElementById('certificationId').value;
    const certificationActive = certifications.find(c => 
        c.aerodromeId === aerodromeId && 
        c.id !== certId &&
        (c.status === 'En cours' || c.status === 'En attente')
    );
    
    if (certificationActive) {
        const aerodrome = aerodromes.find(a => a.id === aerodromeId);
        showNotification(
            `Une certification est déjà en cours pour ${aerodrome?.name || 'cet aérodrome'}.`, 
            'error'
        );
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        // Collecter les données des phases avec FICHIERS
        const phases = [];
        for (let i = 1; i <= 5; i++) {
            const comments = [];
            const commentElements = document.querySelectorAll(`#certPhase${i}CommentList .comment-item`);
            commentElements.forEach(el => {
                comments.push({
                    author: el.querySelector('.comment-author')?.textContent || '',
                    date: el.querySelector('.comment-date')?.textContent || '',
                    text: el.querySelector('.comment-text')?.textContent || ''
                });
            });
            
            // NOUVEAU : Collecter les fichiers
            const files = [];
            const fileElements = document.querySelectorAll(`#certPhase${i}FileList .file-item`);
            fileElements.forEach(el => {
                const fileName = el.querySelector('div[style*="font-weight: 600"]')?.textContent || '';
                const fileSize = el.querySelector('div[style*="font-size: 12px"]')?.textContent || '';
                if (fileName) {
                    files.push({
                        name: fileName,
                        size: fileSize,
                        dateAjout: new Date().toISOString(),
                        ajoutePar: currentUser
                    });
                }
            });
            
            phases.push({
                id: i,
                status: document.getElementById(`certPhase${i}Status`).value,
                date: document.getElementById(`certPhase${i}Date`).value,
                responsable: document.getElementById(`certPhase${i}Responsable`).value,
                comments: comments,
                files: files  // NOUVEAU
            });
        }
        
        const certification = {
            id: document.getElementById('certificationId').value || 'cert-' + Date.now(),
            aerodromeId: aerodromeId,
            dateDebut: dateDebut,
            remarques: document.getElementById('certRemarques').value,
            phases: phases,
            status: calculateCertificationStatus(phases),
            dateCreation: new Date().toISOString()
        };
        
        const existingIndex = certifications.findIndex(c => c.id === certification.id);
        if (existingIndex >= 0) {
            certifications[existingIndex] = certification;
            showNotification('Certification modifiée avec succès!', 'success');
        } else {
            certifications.push(certification);
            showNotification('Certification créée avec succès!', 'success');
        }
        
        closeModal('modalCertification');
        loadCertifications();
        updateDashboard();
        hideLoading();
        saveAllData();
    }, 800);
}

        function calculateCertificationStatus(phases) {
            const completedPhases = phases.filter(p => p.status === 'completed').length;
            if (completedPhases === phases.length) return 'Terminée';
            if (completedPhases > 0) return 'En cours';
            return 'En attente';
        }

function loadCertifications(filteredList = null) {
    const container = document.getElementById('certificationsList');
    if (!container) return;
    
    const list = filteredList || certifications;

    // 1. CALCUL DES STATISTIQUES
    const stats = {
        total: list.length,
        enCours: list.filter(c => c.status === 'En cours').length,
        enAttente: list.filter(c => c.status === 'En attente').length,
        terminees: list.filter(c => c.status === 'Terminée').length,
        totalFiles: list.reduce((sum, c) => sum + (c.phases?.reduce((s, p) => s + (p.files?.length || 0), 0) || 0), 0)
    };

    // 2. MINI TABLEAU DE BORD AVEC OMBRE ÉLÉGANTE
    let html = `
        <div style="background: white; border-radius: 10px; padding: 20px 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; flex-wrap: nowrap; gap: 15px; width: 100%;">
                <!-- Carte Total -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #0ea5e9; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(14, 165, 233, 0.25);">
                            <i class="fas fa-folder-open" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Total</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.total}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte En Cours -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #06b6d4; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(6, 182, 212, 0.25);">
                            <i class="fas fa-sync-alt fa-spin" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Cours</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enCours}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte En Attente -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #f59e0b; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25);">
                            <i class="fas fa-clock" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Attente</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enAttente}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte Documents -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #8b5cf6; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(139, 92, 246, 0.25);">
                            <i class="fas fa-file-alt" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Documents</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.totalFiles}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION FILTRES -->
        <div style="background: white; border-left: 4px solid #0ea5e9; border-radius: 10px; padding: 20px 25px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <!-- Filtre Aérodrome -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-plane-departure" style="color: #0ea5e9; font-size: 14px;"></i>
                        Aérodrome
                    </label>
                    <select id="filterAerodrome" onchange="applyCertificationFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les aérodromes</option>
                        ${aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('')}
                    </select>
                </div>

                <!-- Filtre Statut -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-tasks" style="color: #06b6d4; font-size: 14px;"></i>
                        Statut
                    </label>
                    <select id="filterStatus" onchange="applyCertificationFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les statuts</option>
                        <option value="En cours">En cours</option>
                        <option value="En attente">En attente</option>
                        <option value="Terminée">Terminée</option>
                    </select>
                </div>

                <!-- Filtre Phase -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-layer-group" style="color: #8b5cf6; font-size: 14px;"></i>
                        Phase
                    </label>
                    <select id="filterPhase" onchange="applyCertificationFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Toutes les phases</option>
                        <option value="completed">Phases terminées</option>
                        <option value="in-progress">Phases en cours</option>
                        <option value="pending">Phases en attente</option>
                    </select>
                </div>

                <!-- Bouton Réinitialiser -->
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="resetCertificationFilters()" 
                            style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border: none; color: white; padding: 11px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-redo-alt" style="font-size: 13px;"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    `;

    if (list.length === 0) {
        container.innerHTML = html + `
            <div style="text-align:center; padding:80px 20px; background: white; border-radius: 12px; border: 2px dashed #e2e8f0;">
                <i class="fas fa-search" style="font-size: 48px; color: #cbd5e1; margin-bottom: 16px;"></i>
                <div style="font-size: 18px; font-weight: 700; color: #64748b; margin-bottom: 8px;">Aucune certification trouvée</div>
                <div style="font-size: 14px; color: #94a3b8;">Essayez de modifier vos filtres</div>
            </div>
        `;
        return;
    }

    // 3. GROUPEMENT PAR AÉRODROME
    const grouped = list.reduce((acc, c) => {
        if (!acc[c.aerodromeId]) acc[c.aerodromeId] = [];
        acc[c.aerodromeId].push(c);
        return acc;
    }, {});

    // 4. GRILLE DES AÉRODROMES
    html += `<div class="cert-grid-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">`;

    Object.entries(grouped).forEach(([aeroId, certs], index) => {
        const aero = aerodromes.find(a => String(a.id) === String(aeroId));
        const sectionId = `cert-group-${aeroId}`;
        const isExpanded = index === 0;

        html += `
            <div style="border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div onclick="toggleGroup('${sectionId}')" 
                     style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); color: white; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 15px; min-width: 0; overflow: hidden;">
                        <div style="background: rgba(255,255,255,0.25); padding: 10px 15px; border-radius: 8px; font-weight: 800; font-size: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0;">
                            ${aero?.code || 'AD'}
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <h4 style="margin:0; font-size:16px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${aero?.name || 'Aérodrome'}</h4>
                            <span style="font-size:11px; opacity:0.95;">
                                <i class="fas fa-certificate"></i> ${certs.length} Certification(s)
                            </span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down" id="icon-${sectionId}" style="transition: transform 0.3s; flex-shrink: 0; ${isExpanded ? 'transform: rotate(180deg);' : ''}"></i>
                </div>

                <div id="${sectionId}" style="${isExpanded ? 'display: block;' : 'display: none;'} padding: 25px; background: #f8fafc;">
                    ${certs.map(c => renderCertificationCard(c)).join('')}
                </div>
            </div>
        `;
    });

    html += `</div>`;
    container.innerHTML = html;
}

function renderCertificationCard(cert) {
    const completedPhases = cert.phases?.filter(p => p.status === 'completed').length || 0;
    const totalPhases = cert.phases?.length || 5;
    const globalProgress = Math.round((completedPhases / totalPhases) * 100);
    const allFiles = cert.phases?.flatMap(p => (p.files || []).map(f => ({ ...f, phaseId: p.id }))) || [];

    const phaseNames = [
        "Expression Intérêt",
        "Demande Formelle",
        "Vérification sur site",
        "Délivrance certificat",
        "Publication du Statut"
    ];

    return `
        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <!-- En-tête -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                <div>
                    <div style="font-weight: 900; color: #0ea5e9; font-size: 14px; letter-spacing: 0.5px;">
                        <i class="fas fa-certificate"></i> CERT-${cert.id.substring(5, 11).toUpperCase()}
                    </div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 5px;">
                        <i class="far fa-calendar-alt"></i> Ouvert le ${new Date(cert.dateDebut).toLocaleDateString('fr-FR')}
                    </div>
                </div>
                <span style="background: ${cert.status === 'En cours' ? '#dbeafe' : cert.status === 'Terminée' ? '#d1fae5' : '#fef3c7'}; 
                             color: ${cert.status === 'En cours' ? '#0369a1' : cert.status === 'Terminée' ? '#065f46' : '#92400e'}; 
                             border: 2px solid ${cert.status === 'En cours' ? '#7dd3fc' : cert.status === 'Terminée' ? '#6ee7b7' : '#fcd34d'}; 
                             padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase;">
                    ${cert.status}
                </span>
            </div>

            <!-- Progression Globale -->
            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase;">
                        <i class="fas fa-chart-line"></i> Progression Globale
                    </span>
                    <span style="font-size: 12px; font-weight: 800; color: #0ea5e9;">${globalProgress}%</span>
                </div>
                <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #0ea5e9 0%, #38bdf8 100%); height: 100%; width: ${globalProgress}%; transition: width 0.3s;"></div>
                </div>
            </div>

            <!-- Phases -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 12px;">
                    <i class="fas fa-tasks"></i> Détail des Phases (${completedPhases}/${totalPhases})
                </div>
                <div style="display: grid; gap: 10px;">
                    ${cert.phases?.map((phase, idx) => {
                        const progress = phase.status === 'completed' ? 100 : phase.status === 'in-progress' ? 50 : 0;
                        const phaseFiles = phase.files || [];
                        
                        return `
                            <div style="background: ${phase.status === 'completed' ? '#f0fdf4' : phase.status === 'in-progress' ? '#dbeafe' : '#fef3c7'}; 
                                        border: 2px solid ${phase.status === 'completed' ? '#86efac' : phase.status === 'in-progress' ? '#7dd3fc' : '#fcd34d'}; 
                                        border-radius: 8px; padding: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="background: white; color: ${phase.status === 'completed' ? '#059669' : phase.status === 'in-progress' ? '#0369a1' : '#b45309'}; 
                                                     width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; 
                                                     font-weight: 800; font-size: 11px; border: 2px solid currentColor;">
                                            Ph.${idx + 1}
                                        </span>
                                        <span style="font-size: 11px; font-weight: 700; color: #1e293b;">${phaseNames[idx] || `Phase ${idx + 1}`}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        ${phaseFiles.length > 0 ? `
                                            <span style="background: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; color: #8b5cf6;">
                                                <i class="fas fa-paperclip"></i> ${phaseFiles.length}
                                            </span>
                                        ` : ''}
                                        <span style="font-size: 10px; font-weight: 800; color: ${phase.status === 'completed' ? '#059669' : phase.status === 'in-progress' ? '#0369a1' : '#b45309'};">
                                            ${progress}%
                                        </span>
                                    </div>
                                </div>
                                <div style="background: white; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: ${phase.status === 'completed' ? '#10b981' : phase.status === 'in-progress' ? '#0ea5e9' : '#f59e0b'}; 
                                                height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Fichiers -->
            ${allFiles.length > 0 ? `
                <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 10px;">
                        <i class="fas fa-file-alt"></i> Documents Joints (${allFiles.length})
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${allFiles.slice(0, 4).map(f => `
                            <div onclick="viewFile('${f.name}')" 
                                 style="background: white; border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 6px; 
                                        font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 6px; 
                                        transition: all 0.2s; font-weight: 600;">
                                <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
                                <span style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</span>
                                <span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-size: 9px;">Ph.${f.phaseId}</span>
                            </div>
                        `).join('')}
                        ${allFiles.length > 4 ? `
                            <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; font-size: 10px; color: #64748b; font-weight: 600;">
                                +${allFiles.length - 4} autres
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}

            <!-- Actions -->
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="viewCertificationDetails('${cert.id}')" 
                        style="background: white; border: 2px solid #0ea5e9; color: #0ea5e9; padding: 10px 16px; 
                               border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; 
                               transition: all 0.3s; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-eye"></i> VOIR
                </button>
                <button onclick="editCertification('${cert.id}')" 
                        style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); border: none; color: white; 
                               padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; 
                               transition: all 0.3s; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);">
                    <i class="fas fa-edit"></i> MODIFIER
                </button>
                <button onclick="deleteCertification('${cert.id}')" 
                        style="background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 10px 16px; 
                               border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; 
                               transition: all 0.3s; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-trash"></i> SUPPRIMER
                </button>
            </div>
        </div>
    `;
}

// FONCTIONS DE FILTRAGE
function applyCertificationFilters() {
    const aerodromeFilter = document.getElementById('filterAerodrome')?.value || '';
    const statusFilter = document.getElementById('filterStatus')?.value || '';
    const phaseFilter = document.getElementById('filterPhase')?.value || '';

    let filtered = certifications;

    // Filtre par aérodrome
    if (aerodromeFilter) {
        filtered = filtered.filter(c => String(c.aerodromeId) === String(aerodromeFilter));
    }

    // Filtre par statut
    if (statusFilter) {
        filtered = filtered.filter(c => c.status === statusFilter);
    }

    // Filtre par phase
    if (phaseFilter) {
        filtered = filtered.filter(c => {
            return c.phases?.some(p => p.status === phaseFilter);
        });
    }

    loadCertifications(filtered);
}

function resetCertificationFilters() {
    // Réinitialiser les selects
    const filterAerodrome = document.getElementById('filterAerodrome');
    const filterStatus = document.getElementById('filterStatus');
    const filterPhase = document.getElementById('filterPhase');

    if (filterAerodrome) filterAerodrome.value = '';
    if (filterStatus) filterStatus.value = '';
    if (filterPhase) filterPhase.value = '';

    // Recharger toutes les certifications
    loadCertifications();
}

// Fonctions utilitaires
function viewFile(fileName, extension) {
    console.log("Visualisation de :", fileName);
    alert("Ouverture du fichier : " + fileName);
}

function downloadFile(fileName) {
    console.log("Téléchargement de :", fileName);
    showNotification("Téléchargement de " + fileName + " démarré", "success");
}

function toggleGroup(groupId) {
    const content = document.getElementById(groupId);
    const icon = document.getElementById(`icon-${groupId}`);
    
    if (!content) return;
    
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    
    if (icon) {
        icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }
}
   
function editCertification(id) {
    const cert = certifications.find(c => c.id === id);
    if (!cert) {
        showNotification('Certification non trouvée', 'error');
        return;
    }
    
    document.getElementById('certificationId').value = cert.id;
    document.getElementById('certModalTitle').textContent = 'Modifier Certification';
    document.getElementById('certAerodrome').value = cert.aerodromeId;
    document.getElementById('certDateDebut').value = cert.dateDebut;
    document.getElementById('certRemarques').value = cert.remarques || '';
    
    loadAerodromeDetails();
    
    // Charger les phases AVEC fichiers
    if (cert.phases && cert.phases.length > 0) {
        cert.phases.forEach(phase => {
            document.getElementById(`certPhase${phase.id}Status`).value = phase.status;
            document.getElementById(`certPhase${phase.id}Date`).value = phase.date || '';
            document.getElementById(`certPhase${phase.id}Responsable`).value = phase.responsable || '';
            
            // Charger les commentaires
            const commentList = document.getElementById(`certPhase${phase.id}CommentList`);
            if (phase.comments && commentList) {
                commentList.innerHTML = phase.comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-author">${comment.author}</div>
                            <div class="comment-date">${comment.date}</div>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                    </div>
                `).join('');
            }
            
            // NOUVEAU : Charger les fichiers
            const fileList = document.getElementById(`certPhase${phase.id}FileList`);
            if (phase.files && fileList) {
                fileList.innerHTML = phase.files.map(file => {
                    const extension = file.name.split('.').pop().toLowerCase();
                    let iconClass = 'fa-file';
                    if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) iconClass = 'fa-file-image';
                    else if (extension === 'pdf') iconClass = 'fa-file-pdf';
                    else if (['doc', 'docx'].includes(extension)) iconClass = 'fa-file-word';
                    else if (['xls', 'xlsx'].includes(extension)) iconClass = 'fa-file-excel';
                    
                    return `
                        <div class="file-item">
                            <div class="file-icon">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${file.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${file.size}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Ajouté le ${new Date(file.dateAjout).toLocaleDateString('fr-FR')} par ${file.ajoutePar}</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="viewFile('${file.name}', '${extension}')" 
                                        style="background: var(--info-color); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
                                        title="Visualiser">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="downloadFile('${file.name}')" 
                                        style="background: var(--success-color); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
                                        title="Télécharger">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="removeFileFromPhase('${cert.id}', ${phase.id}, '${file.name}')" 
                                        style="background: var(--danger-color); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
                                        title="Supprimer">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateCertPhaseColor(phase.id);
        });
    }
    
    openModal('modalCertification');
}

        function viewCertificationDetails(id) {
    const cert = certifications.find(c => c.id === id);
    if (!cert) return;
    
    const aerodrome = aerodromes.find(a => a.id === cert.aerodromeId);
    
    const phaseNames = [
        "Expression d'intérêt",
        "Évaluation de la demande formelle",
        "Vérification sur site",
        "Délivrance du certificat",
        "Publication du statut"
    ];
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                Détails de la Certification - ${aerodrome?.code || 'Inconnu'}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Informations Générales</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Aérodrome</div>
                        <div class="detail-value">${aerodrome?.name || 'Inconnu'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Date de début</div>
                        <div class="detail-value">${new Date(cert.dateDebut).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div>
                        <div class="detail-label">Statut</div>
                        <div class="detail-value">${cert.status}</div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Phases de Certification</h4>
                ${cert.phases?.map((phase, index) => {
                    let statusColor = 'var(--warning-color)';
                    let statusText = 'En attente';
                    if (phase.status === 'completed') {
                        statusColor = 'var(--success-color)';
                        statusText = 'Terminée ✓';
                    } else if (phase.status === 'in-progress') {
                        statusColor = 'var(--info-color)';
                        statusText = 'En cours';
                    }
                    
                    return `
                        <div style="background: var(--light-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <div style="font-weight: 700; color: var(--primary-color); font-size: 16px; flex: 1;">
                                    Phase ${phase.id}: ${phaseNames[index]}
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    ${statusText}
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 14px; margin-bottom: 15px;">
                                <div><strong>Date:</strong> ${phase.date ? new Date(phase.date).toLocaleDateString('fr-FR') : 'Non définie'}</div>
                                <div><strong>Responsable:</strong> ${phase.responsable || 'Non assigné'}</div>
                                <div><strong>Fichiers:</strong> ${phase.files?.length || 0}</div>
                            </div>
                            
                            ${phase.files && phase.files.length > 0 ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <strong style="color: var(--primary-color); display: block; margin-bottom: 10px;">
                                        <i class="fas fa-paperclip"></i> Documents (${phase.files.length})
                                    </strong>
                                    <div style="display: grid; gap: 8px;">
                                        ${phase.files.map(file => {
                                            const ext = file.name.split('.').pop().toLowerCase();
                                            let icon = 'fa-file';
                                            let color = '#666';
                                            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                                                icon = 'fa-file-image';
                                                color = '#9c27b0';
                                            } else if (ext === 'pdf') {
                                                icon = 'fa-file-pdf';
                                                color = '#dc3545';
                                            } else if (['doc', 'docx'].includes(ext)) {
                                                icon = 'fa-file-word';
                                                color = '#2b579a';
                                            } else if (['xls', 'xlsx'].includes(ext)) {
                                                icon = 'fa-file-excel';
                                                color = '#217346';
                                            }
                                            
                                            return `
                                                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border-color);">
                                                    <i class="fas ${icon}" style="font-size: 24px; color: ${color};"></i>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div style="font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                                                        <div style="font-size: 11px; color: var(--text-secondary);">${file.size} • ${new Date(file.dateAjout).toLocaleDateString('fr-FR')}</div>
                                                    </div>
                                                    <div style="display: flex; gap: 5px;">
                                                        <button onclick="viewFile('${file.name}', '${ext}')" class="btn btn-info" style="padding: 6px 10px; font-size: 12px;">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button onclick="downloadFile('${file.name}')" class="btn btn-success" style="padding: 6px 10px; font-size: 12px;">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${phase.comments && phase.comments.length > 0 ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <strong style="color: var(--primary-color); display: block; margin-bottom: 10px;">
                                        <i class="fas fa-comments"></i> Commentaires (${phase.comments.length})
                                    </strong>
                                    ${phase.comments.map(c => `
                                        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 13px; border-left: 3px solid var(--info-color);">
                                            <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 4px;">
                                                ${c.author} <span style="font-weight: normal; color: var(--text-secondary); font-size: 11px;">• ${c.date}</span>
                                            </div>
                                            <div style="color: var(--text-primary);">${c.text}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('') || '<p>Aucune phase définie</p>'}
            </div>
            
            ${cert.remarques ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Remarques</h4>
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px;">
                        ${cert.remarques}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

        function deleteCertification(id) {
            if (!checkPermission('delete')) {
                showNotification('Permission refusée. Vous n\'avez pas les droits pour supprimer.', 'error');
                return;
            }
            
            if (confirm('Êtes-vous sûr de vouloir supprimer cette certification ?')) {
                certifications = certifications.filter(c => c.id !== id);
                loadCertifications();
                updateDashboard();
                showNotification('Certification supprimée avec succès', 'success');
                saveAllData();
            }
        }

        function addCertComment(phaseId) {
            const commentText = document.getElementById(`certPhase${phaseId}Comment`).value.trim();
            if (!commentText) {
                showNotification('Veuillez saisir un commentaire', 'warning');
                return;
            }
            
            const commentList = document.getElementById(`certPhase${phaseId}CommentList`);
            const commentHtml = `
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-author">${currentUser}</div>
                        <div class="comment-date">${new Date().toLocaleString('fr-FR')}</div>
                    </div>
                    <div class="comment-text">${commentText}</div>
                </div>
            `;
            
            commentList.insertAdjacentHTML('beforeend', commentHtml);
            document.getElementById(`certPhase${phaseId}Comment`).value = '';
            showNotification('Commentaire ajouté', 'success');
        }

        function updateCertPhaseColor(phaseId) {
            const status = document.getElementById(`certPhase${phaseId}Status`).value;
            const phaseCard = document.querySelector(`#certPhase${phaseId}Status`).closest('.phase-card');
            
            phaseCard.style.borderLeftColor = 
                status === 'completed' ? 'var(--success-color)' :
                status === 'in-progress' ? 'var(--info-color)' :
                'var(--warning-color)';
        }

        function triggerCertFileUpload(phaseId) {
            const input = document.getElementById(`certPhase${phaseId}FileInput`);
            input.click();
        }

        function handleCertFiles(input, phaseId) {
    const fileList = document.getElementById(`certPhase${phaseId}FileList`);
    
    Array.from(input.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const extension = file.name.split('.').pop().toLowerCase();
        let iconClass = 'fa-file';
        if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) iconClass = 'fa-file-image';
        else if (extension === 'pdf') iconClass = 'fa-file-pdf';
        else if (['doc', 'docx'].includes(extension)) iconClass = 'fa-file-word';
        else if (['xls', 'xlsx'].includes(extension)) iconClass = 'fa-file-excel';
        
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas ${iconClass}"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
            <div style="display: flex; gap: 5px;">
                <button onclick="viewFile('${file.name}', '${extension}')" 
                        style="background: var(--info-color); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
                        title="Visualiser">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="downloadFile('${file.name}')" 
                        style="background: var(--success-color); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
                        title="TÃ©lÃ©charger">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="this.closest('.file-item').remove()" 
                        style="background: var(--danger-color); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
                        title="Supprimer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${input.files.length} fichier(s) ajoutÃ©(s)`, 'success');
}

        function filterCertifications() {
            const type = document.getElementById('filterCertificationType')?.value || '';
            const status = document.getElementById('filterCertificationStatus')?.value || '';
            const date = document.getElementById('filterCertificationDate')?.value || '';
            const search = document.getElementById('searchCertificationKeyword')?.value.toLowerCase() || '';
            
            let filtered = [...certifications];
            
            if (type) filtered = filtered.filter(c => c.type === type);
            if (status) filtered = filtered.filter(c => c.status === status);
            if (date) filtered = filtered.filter(c => c.dateDebut >= date);
            
            if (search) {
                filtered = filtered.filter(c => {
                    const aerodrome = aerodromes.find(a => a.id === c.aerodromeId);
                    const searchText = `${aerodrome?.code || ''} ${aerodrome?.name || ''} ${c.status || ''}`.toLowerCase();
                    return searchText.includes(search);
                });
            }
            
            loadCertifications(filtered);
        }

        function resetCertificationFilters() {
            if (document.getElementById('filterCertificationType')) document.getElementById('filterCertificationType').value = '';
            if (document.getElementById('filterCertificationStatus')) document.getElementById('filterCertificationStatus').value = '';
            if (document.getElementById('filterCertificationDate')) document.getElementById('filterCertificationDate').value = '';
            if (document.getElementById('searchCertificationKeyword')) document.getElementById('searchCertificationKeyword').value = '';
            loadCertifications();
        }

        function sortCertifications(field, direction = 'asc') {
            const sorted = [...certifications].sort((a, b) => {
                let aVal, bVal;
                
                if (field === 'date') {
                    aVal = new Date(a.dateDebut);
                    bVal = new Date(b.dateDebut);
                } else if (field === 'reference') {
                    aVal = a.id || '';
                    bVal = b.id || '';
                } else {
                    aVal = a[field] || '';
                    bVal = b[field] || '';
                }
                
                return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });
            
            loadCertifications(sorted);
        }

        function searchCertifications() {
            const search = document.getElementById('searchCertification')?.value.toLowerCase() || '';
            
            if (!search) {
                loadCertifications();
                return;
            }
            
            const filtered = certifications.filter(cert => {
                const aerodrome = aerodromes.find(a => a.id === cert.aerodromeId);
                const searchText = `
                    ${aerodrome?.code || ''}
                    ${aerodrome?.name || ''}
                    ${cert.status || ''}
                    ${cert.remarques || ''}
                `.toLowerCase();
                return searchText.includes(search);
            });
            
            loadCertifications(filtered);
        }

        // ============ FONCTIONS POUR HOMOLOGATIONS ============
        
        function initHomologationModal() {
            document.getElementById('homologationId').value = '';
            document.getElementById('homologationModalTitle').textContent = 'Nouvelle Homologation';
            document.getElementById('homologAerodrome').value = '';
            document.getElementById('homologType').value = '';
            document.getElementById('homologDateDebut').value = new Date().toISOString().split('T')[0];
            document.getElementById('homologDateFin').value = '';
            document.getElementById('homologNumero').value = '';
            document.getElementById('homologOrganisme').value = 'ANACIM';
            document.getElementById('homologStatus').value = 'En attente';
            document.getElementById('homologRemarques').value = '';
            
            // Réinitialiser les phases
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`homologPhase${i}Status`).value = 'pending';
                document.getElementById(`homologPhase${i}Date`).value = '';
                document.getElementById(`homologPhase${i}Responsable`).value = '';
                document.getElementById(`homologPhase${i}Comment`).value = '';
                document.getElementById(`homologPhase${i}CommentList`).innerHTML = '';
                document.getElementById(`homologPhase${i}FileList`).innerHTML = '';
                updateHomologPhaseColor(i);
            }
            
            updateAerodromeSelects();
        }

        function saveHomologation() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const aerodromeId = document.getElementById('homologAerodrome').value;
    const type = document.getElementById('homologType').value;
    const dateDebut = document.getElementById('homologDateDebut').value;
    
    if (!aerodromeId || !type || !dateDebut) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    // Vérifications des processus existants
    const certificationActive = certifications.find(c => 
        c.aerodromeId === aerodromeId && 
        (c.status === 'En cours' || c.status === 'En attente')
    );
    
    if (certificationActive) {
        const aerodrome = aerodromes.find(a => a.id === aerodromeId);
        showNotification(
            `Impossible d'homologuer ${aerodrome?.name || 'cet aérodrome'}. Une certification est déjà en cours.`, 
            'error'
        );
        return;
    }
    
    const homologId = document.getElementById('homologationId').value;
    const homologationActive = homologations.find(h => 
        h.aerodromeId === aerodromeId && 
        h.id !== homologId &&
        (h.status === 'En cours' || h.status === 'En attente')
    );
    
    if (homologationActive) {
        const aerodrome = aerodromes.find(a => a.id === aerodromeId);
        showNotification(
            `Une homologation est déjà en cours pour ${aerodrome?.name || 'cet aérodrome'}.`, 
            'error'
        );
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        const phases = [];
        for (let i = 1; i <= 3; i++) {
            const comments = [];
            const commentElements = document.querySelectorAll(`#homologPhase${i}CommentList .comment-item`);
            commentElements.forEach(el => {
                comments.push({
                    author: el.querySelector('.comment-author')?.textContent || '',
                    date: el.querySelector('.comment-date')?.textContent || '',
                    text: el.querySelector('.comment-text')?.textContent || ''
                });
            });
            
            // Récupérer les fichiers de cette phase
            const phaseFiles = dragDropFiles[`homolog-phase-${i}`] || [];
            
            phases.push({
                id: i,
                status: document.getElementById(`homologPhase${i}Status`).value,
                date: document.getElementById(`homologPhase${i}Date`).value,
                responsable: document.getElementById(`homologPhase${i}Responsable`).value,
                comments: comments,
                files: phaseFiles // Sauvegarder les fichiers
            });
        }
        
        const homologation = {
            id: homologId || 'homolog-' + Date.now(),
            aerodromeId: aerodromeId,
            type: type,
            dateDebut: dateDebut,
            dateFin: document.getElementById('homologDateFin').value,
            numero: document.getElementById('homologNumero').value,
            organisme: document.getElementById('homologOrganisme').value,
            status: document.getElementById('homologStatus').value,
            remarques: document.getElementById('homologRemarques').value,
            phases: phases,
            dateCreation: new Date().toISOString()
        };
        
        const existingIndex = homologations.findIndex(h => h.id === homologation.id);
        if (existingIndex >= 0) {
            homologations[existingIndex] = homologation;
            showNotification('Homologation modifiée avec succès!', 'success');
        } else {
            homologations.push(homologation);
            showNotification('Homologation créée avec succès!', 'success');
        }
        
        // Réinitialiser le stockage temporaire des fichiers
        for (let i = 1; i <= 3; i++) {
            delete dragDropFiles[`homolog-phase-${i}`];
        }
        
        closeModal('modalHomologation');
        loadHomologations();
        updateDashboard();
        hideLoading();
        saveAllData();
    }, 800);
}

function loadHomologations(filteredList = null) {
    const container = document.getElementById('homologationsList');
    if (!container) return;
    
    const list = filteredList || (typeof homologations !== 'undefined' ? homologations : []);

    // 1. CALCUL DES STATISTIQUES
    const stats = {
        total: list.length,
        enCours: list.filter(h => h.status === 'En cours').length,
        enAttente: list.filter(h => h.status === 'En attente').length,
        approuvees: list.filter(h => h.status === 'Approuvée').length,
        totalFiles: list.reduce((sum, h) => sum + (h.phases?.reduce((s, p) => s + (p.files?.length || 0), 0) || 0), 0)
    };

    // 2. MINI TABLEAU DE BORD AVEC OMBRE ÉLÉGANTE (harmonisé avec certifications)
    let html = `
        <div style="background: white; border-radius: 10px; padding: 20px 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; flex-wrap: nowrap; gap: 15px; width: 100%;">
                <!-- Carte Total -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #1e3a8a; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(30, 58, 138, 0.25);">
                            <i class="fas fa-clipboard-check" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Total</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.total}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte En Cours -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #0284c7; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #0284c7 0%, #38bdf8 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(2, 132, 199, 0.25);">
                            <i class="fas fa-sync-alt fa-spin" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Cours</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enCours}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte En Attente -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #f59e0b; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25);">
                            <i class="fas fa-clock" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Attente</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enAttente}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte Documents -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #8b5cf6; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(139, 92, 246, 0.25);">
                            <i class="fas fa-file-alt" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Documents</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.totalFiles}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION FILTRES (harmonisée avec certifications) -->
        <div style="background: white; border-left: 4px solid #1e3a8a; border-radius: 10px; padding: 20px 25px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <!-- Filtre Aérodrome -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-plane-departure" style="color: #1e3a8a; font-size: 14px;"></i>
                        Aérodrome
                    </label>
                    <select id="filterHomologAerodrome" onchange="applyHomologationFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les aérodromes</option>
                        ${typeof aerodromes !== 'undefined' ? aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('') : ''}
                    </select>
                </div>

                <!-- Filtre Statut -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-tasks" style="color: #0284c7; font-size: 14px;"></i>
                        Statut
                    </label>
                    <select id="filterHomologStatus" onchange="applyHomologationFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les statuts</option>
                        <option value="En cours">En cours</option>
                        <option value="En attente">En attente</option>
                        <option value="Approuvée">Approuvée</option>
                    </select>
                </div>

                <!-- Filtre Phase -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-layer-group" style="color: #8b5cf6; font-size: 14px;"></i>
                        Phase
                    </label>
                    <select id="filterHomologPhase" onchange="applyHomologationFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Toutes les phases</option>
                        <option value="completed">Phases terminées</option>
                        <option value="in-progress">Phases en cours</option>
                        <option value="pending">Phases en attente</option>
                    </select>
                </div>

                <!-- Bouton Réinitialiser -->
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="resetHomologationFilters()" 
                            style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border: none; color: white; padding: 11px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-redo-alt" style="font-size: 13px;"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    `;

    if (list.length === 0) {
        container.innerHTML = html + `
            <div style="text-align:center; padding:80px 20px; background: white; border-radius: 12px; border: 2px dashed #e2e8f0;">
                <i class="fas fa-search" style="font-size: 48px; color: #cbd5e1; margin-bottom: 16px;"></i>
                <div style="font-size: 18px; font-weight: 700; color: #64748b; margin-bottom: 8px;">Aucune homologation trouvée</div>
                <div style="font-size: 14px; color: #94a3b8;">Essayez de modifier vos filtres</div>
            </div>
        `;
        return;
    }

    // 3. GROUPEMENT PAR AÉRODROME
    const grouped = list.reduce((acc, h) => {
        if (!acc[h.aerodromeId]) acc[h.aerodromeId] = [];
        acc[h.aerodromeId].push(h);
        return acc;
    }, {});

    // 4. GRILLE DES AÉRODROMES
    html += `<div class="homolog-grid-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">`;

    Object.entries(grouped).forEach(([aeroId, homologs], index) => {
        const aero = typeof aerodromes !== 'undefined' ? aerodromes.find(a => String(a.id) === String(aeroId)) : null;
        const sectionId = `homolog-group-${aeroId}`;
        const isExpanded = index === 0;

        html += `
            <div style="border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div onclick="toggleGroup('${sectionId}')" 
                     style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 15px; min-width: 0; overflow: hidden;">
                        <div style="background: rgba(255,255,255,0.25); padding: 10px 15px; border-radius: 8px; font-weight: 800; font-size: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); flex-shrink: 0;">
                            ${aero?.code || 'AD'}
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <h4 style="margin:0; font-size:16px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${aero?.name || 'Aérodrome'}</h4>
                            <span style="font-size:11px; opacity:0.95;">
                                <i class="fas fa-clipboard-check"></i> ${homologs.length} Homologation(s)
                            </span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down" id="icon-${sectionId}" style="transition: transform 0.3s; flex-shrink: 0; ${isExpanded ? 'transform: rotate(180deg);' : ''}"></i>
                </div>

                <div id="${sectionId}" style="${isExpanded ? 'display: block;' : 'display: none;'} padding: 25px; background: #f8fafc;">
                    ${homologs.map(h => renderHomologationCard(h)).join('')}
                </div>
            </div>
        `;
    });

    html += `</div>`;
    container.innerHTML = html;
}

function renderHomologationCard(homolog) {
    const completedPhases = homolog.phases?.filter(p => p.status === 'completed').length || 0;
    const totalPhases = homolog.phases?.length || 3;
    const globalProgress = Math.round((completedPhases / totalPhases) * 100);
    const allFiles = homolog.phases?.flatMap(p => (p.files || []).map(f => ({ ...f, phaseId: p.id }))) || [];

    const phaseNames = [
        "Évaluation formelle",
        "Vérification site",
        "Délivrance décision"
    ];

    return `
        <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <!-- En-tête -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                <div>
                    <div style="font-weight: 900; color: #1e3a8a; font-size: 14px; letter-spacing: 0.5px;">
                        <i class="fas fa-clipboard-check"></i> HOMOLOG-${homolog.id.substring(7, 13).toUpperCase()}
                    </div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 5px;">
                        <i class="far fa-calendar-alt"></i> Ouvert le ${new Date(homolog.dateDebut).toLocaleDateString('fr-FR')}
                    </div>
                </div>
                <span style="background: ${homolog.status === 'En cours' ? '#dbeafe' : homolog.status === 'Approuvée' ? '#d1fae5' : '#fef3c7'}; 
                             color: ${homolog.status === 'En cours' ? '#0369a1' : homolog.status === 'Approuvée' ? '#065f46' : '#92400e'}; 
                             border: 2px solid ${homolog.status === 'En cours' ? '#7dd3fc' : homolog.status === 'Approuvée' ? '#6ee7b7' : '#fcd34d'}; 
                             padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase;">
                    ${homolog.status}
                </span>
            </div>

            <!-- Progression Globale -->
            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase;">
                        <i class="fas fa-chart-line"></i> Progression Globale
                    </span>
                    <span style="font-size: 12px; font-weight: 800; color: #1e3a8a;">${globalProgress}%</span>
                </div>
                <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%); height: 100%; width: ${globalProgress}%; transition: width 0.3s;"></div>
                </div>
            </div>

            <!-- Phases -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 12px;">
                    <i class="fas fa-tasks"></i> Détail des Phases (${completedPhases}/${totalPhases})
                </div>
                <div style="display: grid; gap: 10px;">
                    ${homolog.phases?.map((phase, idx) => {
                        const progress = phase.status === 'completed' ? 100 : phase.status === 'in-progress' ? 50 : 0;
                        const phaseFiles = phase.files || [];
                        
                        return `
                            <div style="background: ${phase.status === 'completed' ? '#f0fdf4' : phase.status === 'in-progress' ? '#dbeafe' : '#fef3c7'}; 
                                        border: 2px solid ${phase.status === 'completed' ? '#86efac' : phase.status === 'in-progress' ? '#7dd3fc' : '#fcd34d'}; 
                                        border-radius: 8px; padding: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="background: white; color: ${phase.status === 'completed' ? '#059669' : phase.status === 'in-progress' ? '#0369a1' : '#b45309'}; 
                                                     width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; 
                                                     font-weight: 800; font-size: 11px; border: 2px solid currentColor;">
                                            Ph.${idx + 1}
                                        </span>
                                        <span style="font-size: 11px; font-weight: 700; color: #1e293b;">${phaseNames[idx] || `Phase ${idx + 1}`}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        ${phaseFiles.length > 0 ? `
                                            <span style="background: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; color: #8b5cf6;">
                                                <i class="fas fa-paperclip"></i> ${phaseFiles.length}
                                            </span>
                                        ` : ''}
                                        <span style="font-size: 10px; font-weight: 800; color: ${phase.status === 'completed' ? '#059669' : phase.status === 'in-progress' ? '#0369a1' : '#b45309'};">
                                            ${progress}%
                                        </span>
                                    </div>
                                </div>
                                <div style="background: white; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: ${phase.status === 'completed' ? '#10b981' : phase.status === 'in-progress' ? '#0ea5e9' : '#f59e0b'}; 
                                                height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Fichiers -->
            ${allFiles.length > 0 ? `
                <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 10px;">
                        <i class="fas fa-file-alt"></i> Documents Joints (${allFiles.length})
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${allFiles.slice(0, 4).map(f => `
                            <div onclick="viewFile('${f.name}')" 
                                 style="background: white; border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 6px; 
                                        font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 6px; 
                                        transition: all 0.2s; font-weight: 600;">
                                <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
                                <span style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.name}</span>
                                <span style="background: #e0e7ff; color: #3730a3; padding: 2px 6px; border-radius: 4px; font-size: 9px;">Ph.${f.phaseId}</span>
                            </div>
                        `).join('')}
                        ${allFiles.length > 4 ? `
                            <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 6px; font-size: 10px; color: #64748b; font-weight: 600;">
                                +${allFiles.length - 4} autres
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}

            <!-- Actions -->
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="viewHomologationDetails('${homolog.id}')" 
                        style="background: white; border: 2px solid #1e3a8a; color: #1e3a8a; padding: 10px 16px; 
                               border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; 
                               transition: all 0.3s; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-eye"></i> VOIR
                </button>
                <button onclick="editHomologation('${homolog.id}')" 
                        style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border: none; color: white; 
                               padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; 
                               transition: all 0.3s; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);">
                    <i class="fas fa-edit"></i> MODIFIER
                </button>
                <button onclick="deleteHomologation('${homolog.id}')" 
                        style="background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 10px 16px; 
                               border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; 
                               transition: all 0.3s; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-trash"></i> SUPPRIMER
                </button>
            </div>
        </div>
    `;
}

// FONCTIONS DE FILTRAGE
function applyHomologationFilters() {
    const aerodromeFilter = document.getElementById('filterHomologAerodrome')?.value || '';
    const statusFilter = document.getElementById('filterHomologStatus')?.value || '';
    const phaseFilter = document.getElementById('filterHomologPhase')?.value || '';

    let filtered = typeof homologations !== 'undefined' ? homologations : [];

    // Filtre par aérodrome
    if (aerodromeFilter) {
        filtered = filtered.filter(h => String(h.aerodromeId) === String(aerodromeFilter));
    }

    // Filtre par statut
    if (statusFilter) {
        filtered = filtered.filter(h => h.status === statusFilter);
    }

    // Filtre par phase
    if (phaseFilter) {
        filtered = filtered.filter(h => {
            return h.phases?.some(p => p.status === phaseFilter);
        });
    }

    loadHomologations(filtered);
}

function resetHomologationFilters() {
    // Réinitialiser les selects
    const filterAerodrome = document.getElementById('filterHomologAerodrome');
    const filterStatus = document.getElementById('filterHomologStatus');
    const filterPhase = document.getElementById('filterHomologPhase');

    if (filterAerodrome) filterAerodrome.value = '';
    if (filterStatus) filterStatus.value = '';
    if (filterPhase) filterPhase.value = '';

    // Recharger toutes les homologations
    loadHomologations();
}

// Fonctions utilitaires (si pas déjà présentes)
function viewFile(fileName) {
    console.log("Visualisation de :", fileName);
    alert("Ouverture du fichier : " + fileName);
}

function editHomologation(id) {
    const homolog = homologations.find(h => h.id === id);
    if (!homolog) return;
    
    document.getElementById('homologationId').value = homolog.id;
    document.getElementById('homologationModalTitle').textContent = 'Modifier Homologation';
    document.getElementById('homologAerodrome').value = homolog.aerodromeId;
    document.getElementById('homologType').value = homolog.type;
    document.getElementById('homologDateDebut').value = homolog.dateDebut;
    document.getElementById('homologDateFin').value = homolog.dateFin || '';
    document.getElementById('homologNumero').value = homolog.numero || '';
    document.getElementById('homologOrganisme').value = homolog.organisme || 'ANACIM';
    document.getElementById('homologStatus').value = homolog.status;
    document.getElementById('homologRemarques').value = homolog.remarques || '';
    
    // Réinitialiser le stockage temporaire
    for (let i = 1; i <= 3; i++) {
        dragDropFiles[`homolog-phase-${i}`] = [];
    }
    
    // Charger les phases
    if (homolog.phases) {
        homolog.phases.forEach(phase => {
            document.getElementById(`homologPhase${phase.id}Status`).value = phase.status;
            document.getElementById(`homologPhase${phase.id}Date`).value = phase.date || '';
            document.getElementById(`homologPhase${phase.id}Responsable`).value = phase.responsable || '';
            
            // Charger les commentaires
            const commentList = document.getElementById(`homologPhase${phase.id}CommentList`);
            if (phase.comments) {
                commentList.innerHTML = phase.comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-author">${comment.author}</div>
                            <div class="comment-date">${comment.date}</div>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                    </div>
                `).join('');
            }
            
            // Charger les fichiers existants
            const fileList = document.getElementById(`homologPhase${phase.id}FileList`);
            fileList.innerHTML = '';
            
            if (phase.files && phase.files.length > 0) {
                // Restaurer dans dragDropFiles
                dragDropFiles[`homolog-phase-${phase.id}`] = phase.files;
                
                // Afficher dans l'interface
                phase.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.setAttribute('data-file-id', file.id);
                    fileItem.innerHTML = `
                        <div class="file-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${file.name}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                ${(file.size / 1024).toFixed(2)} KB • ${new Date(file.uploadDate).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                        <button onclick="previewFile('${file.id}', 'homolog-phase-${phase.id}')" 
                                style="background: none; border: none; color: var(--info-color); cursor: pointer; margin-right: 10px;"
                                title="Prévisualiser">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="downloadFile('${file.id}', 'homolog-phase-${phase.id}')" 
                                style="background: none; border: none; color: var(--success-color); cursor: pointer; margin-right: 10px;"
                                title="Télécharger">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="removeFileFromList(this, '${file.id}', 'homolog-phase-${phase.id}')" 
                                style="background: none; border: none; color: var(--danger-color); cursor: pointer;"
                                title="Supprimer">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
            }
            
            updateHomologPhaseColor(phase.id);
        });
    }
    
    openModal('modalHomologation');
}

        function viewHomologationDetails(id) {
    const homolog = homologations.find(h => h.id === id);
    if (!homolog) return;
    
    const aerodrome = aerodromes.find(a => a.id === homolog.aerodromeId);
    
    const phaseNames = [
        "Évaluation de la demande formelle",
        "Vérification sur site",
        "Délivrance de la décision d'homologation"
    ];
    
    // Compter le total de fichiers
    const totalFiles = homolog.phases?.reduce((sum, p) => sum + (p.files?.length || 0), 0) || 0;
    
    const details = `
        <div class="aerodrome-detail-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--primary-color); margin: 0;">
                    Détails de l'Homologation - ${aerodrome?.code || 'Inconnu'}
                </h3>
                <button class="btn btn-success" onclick="generateHomologationReport('${homolog.id}')">
                    <i class="fas fa-file-pdf"></i> Générer Rapport
                </button>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Informations Générales</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Aérodrome</div>
                        <div class="detail-value">${aerodrome?.name || 'Inconnu'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${homolog.type}</div>
                    </div>
                    <div>
                        <div class="detail-label">Statut</div>
                        <div class="detail-value">${homolog.status}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Numéro</div>
                        <div class="detail-value">${homolog.numero || 'Non attribué'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Organisme</div>
                        <div class="detail-value">${homolog.organisme || 'Non spécifié'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Période</div>
                        <div class="detail-value">
                            ${new Date(homolog.dateDebut).toLocaleDateString('fr-FR')}
                            ${homolog.dateFin ? ' - ' + new Date(homolog.dateFin).toLocaleDateString('fr-FR') : ''}
                        </div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Total fichiers</div>
                        <div class="detail-value">
                            <i class="fas fa-file"></i> ${totalFiles} document(s)
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Phases d'Homologation</h4>
                ${homolog.phases?.map((phase, index) => {
                    let statusColor = 'var(--warning-color)';
                    let statusText = 'En attente';
                    let statusIcon = 'clock';
                    
                    if (phase.status === 'completed') {
                        statusColor = 'var(--success-color)';
                        statusText = 'Terminée';
                        statusIcon = 'check-circle';
                    } else if (phase.status === 'in-progress') {
                        statusColor = 'var(--info-color)';
                        statusText = 'En cours';
                        statusIcon = 'spinner';
                    }
                    
                    const phaseFiles = phase.files || [];
                    
                    return `
                        <div style="background: var(--light-bg); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 6px solid ${statusColor};">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px; font-size: 16px;">
                                        <i class="fas fa-${statusIcon}" style="color: ${statusColor};"></i>
                                        Phase ${phase.id}: ${phaseNames[index]}
                                    </div>
                                    <span class="badge" style="background: ${statusColor};">${statusText}</span>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px; margin-bottom: 15px;">
                                <div>
                                    <strong>Date:</strong> ${phase.date ? new Date(phase.date).toLocaleDateString('fr-FR') : 'Non définie'}
                                </div>
                                <div>
                                    <strong>Responsable:</strong> ${phase.responsable || 'Non assigné'}
                                </div>
                                <div>
                                    <strong>Documents:</strong> <i class="fas fa-file"></i> ${phaseFiles.length} fichier(s)
                                </div>
                            </div>
                            
                            ${phaseFiles.length > 0 ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                                    <strong style="color: var(--primary-color); display: block; margin-bottom: 10px;">
                                        <i class="fas fa-paperclip"></i> Fichiers joints (${phaseFiles.length})
                                    </strong>
                                    <div class="evidence-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                        ${phaseFiles.map(file => {
                                            const fileExt = file.name.split('.').pop().toLowerCase();
                                            let fileIcon = 'fa-file';
                                            let fileColor = 'var(--primary-color)';
                                            
                                            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                                                fileIcon = 'fa-file-image';
                                                fileColor = '#9c27b0';
                                            } else if (fileExt === 'pdf') {
                                                fileIcon = 'fa-file-pdf';
                                                fileColor = '#f44336';
                                            } else if (['doc', 'docx'].includes(fileExt)) {
                                                fileIcon = 'fa-file-word';
                                                fileColor = '#2196f3';
                                            } else if (['xls', 'xlsx'].includes(fileExt)) {
                                                fileIcon = 'fa-file-excel';
                                                fileColor = '#4caf50';
                                            }
                                            
                                            return `
                                                <div class="evidence-item" style="background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); transition: all 0.3s;">
                                                    <div style="text-align: center; margin-bottom: 8px;">
                                                        <i class="fas ${fileIcon}" style="font-size: 32px; color: ${fileColor};"></i>
                                                    </div>
                                                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; word-break: break-word;">
                                                        ${file.name}
                                                    </div>
                                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                                                        ${(file.size / 1024).toFixed(2)} KB
                                                    </div>
                                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                                        <button class="btn btn-info" onclick='previewStoredFile(${JSON.stringify(file)})' style="padding: 6px 10px; font-size: 11px;">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-success" onclick='downloadStoredFile(${JSON.stringify(file)})' style="padding: 6px 10px; font-size: 11px;">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${phase.comments && phase.comments.length > 0 ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border-color);">
                                    <strong style="color: var(--primary-color); display: block; margin-bottom: 10px;">
                                        <i class="fas fa-comments"></i> Commentaires (${phase.comments.length})
                                    </strong>
                                    ${phase.comments.map(c => `
                                        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--info-color);">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                                <strong style="font-size: 13px; color: var(--primary-color);">${c.author}</strong>
                                                <span style="font-size: 11px; color: var(--text-secondary);">${c.date}</span>
                                            </div>
                                            <div style="font-size: 13px;">${c.text}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('') || '<p>Aucune phase définie</p>'}
            </div>
            
            ${homolog.remarques ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-comment-alt"></i> Remarques
                    </h4>
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px;">
                        ${homolog.remarques}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

	// Fonction pour prévisualiser un fichier stocké
function previewStoredFile(file) {
    const modal = document.getElementById('modalFilePreview');
    const content = document.getElementById('filePreviewContent');
    
    const fileType = file.type;
    const fileName = file.name.toLowerCase();
    
    if (fileType.startsWith('image/')) {
        content.innerHTML = `<img src="${file.data}" alt="${file.name}" style="max-width: 100%; max-height: 90vh; object-fit: contain;">`;
    } else if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
        content.innerHTML = `<iframe src="${file.data}" style="width: 90vw; height: 90vh; border: none;"></iframe>`;
    } else if (fileType.startsWith('text/')) {
        fetch(file.data)
            .then(r => r.text())
            .then(text => {
                content.innerHTML = `<pre style="padding: 20px; background: white; max-width: 90vw; max-height: 90vh; overflow: auto; white-space: pre-wrap;">${text}</pre>`;
            });
    } else {
        content.innerHTML = `
            <div style="padding: 40px; text-align: center; background: white; border-radius: 12px;">
                <i class="fas fa-file" style="font-size: 64px; color: var(--primary-color); margin-bottom: 20px;"></i>
                <h3>Aperçu non disponible</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Ce type de fichier ne peut pas être prévisualisé.<br>
                    <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)
                </p>
                <button class="btn btn-primary" onclick='downloadStoredFile(${JSON.stringify(file)})'>
                    <i class="fas fa-download"></i> Télécharger le fichier
                </button>
            </div>
        `;
    }
    
    modal.classList.add('active');
}

// Fonction pour télécharger un fichier stocké
function downloadStoredFile(file) {
    const link = document.createElement('a');
    link.href = file.data;
    link.download = file.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`Téléchargement de ${file.name}...`, 'success');
}

        function deleteHomologation(id) {
            if (!checkPermission('delete')) {
                showNotification('Permission refusée.', 'error');
                return;
            }
            
            if (confirm('Êtes-vous sûr de vouloir supprimer cette homologation ?')) {
                homologations = homologations.filter(h => h.id !== id);
                loadHomologations();
                updateDashboard();
                showNotification('Homologation supprimée avec succès', 'success');
                saveAllData();
            }
        }

        function addHomologComment(phaseId) {
            const commentText = document.getElementById(`homologPhase${phaseId}Comment`).value.trim();
            if (!commentText) {
                showNotification('Veuillez saisir un commentaire', 'warning');
                return;
            }
            
            const commentList = document.getElementById(`homologPhase${phaseId}CommentList`);
            const commentHtml = `
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-author">${currentUser}</div>
                        <div class="comment-date">${new Date().toLocaleString('fr-FR')}</div>
                    </div>
                    <div class="comment-text">${commentText}</div>
                </div>
            `;
            
            commentList.insertAdjacentHTML('beforeend', commentHtml);
            document.getElementById(`homologPhase${phaseId}Comment`).value = '';
            showNotification('Commentaire ajouté', 'success');
        }

        function updateHomologPhaseColor(phaseId) {
            const status = document.getElementById(`homologPhase${phaseId}Status`).value;
            const phaseCard = document.querySelector(`#homologPhase${phaseId}Status`).closest('.phase-card');
            
            if (phaseCard) {
                phaseCard.style.borderLeftColor = 
                    status === 'completed' ? 'var(--success-color)' :
                    status === 'in-progress' ? 'var(--info-color)' :
                    'var(--warning-color)';
            }
        }

        function triggerHomologFileUpload(phaseId) {
            const input = document.getElementById(`homologPhase${phaseId}FileInput`);
            input.click();
        }

function handleHomologFiles(input, phaseId) {
    const fileList = document.getElementById(`homologPhase${phaseId}FileList`);
    
    Array.from(input.files).forEach(file => {
        // Créer un identifiant unique pour le fichier
        const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // Lire le fichier en base64 pour le stockage
        const reader = new FileReader();
        reader.onload = function(e) {
            const fileData = {
                id: fileId,
                name: file.name,
                size: file.size,
                type: file.type,
                data: e.target.result, // Base64 data
                uploadDate: new Date().toISOString()
            };
            
            // Stocker dans dragDropFiles temporairement
            if (!dragDropFiles[`homolog-phase-${phaseId}`]) {
                dragDropFiles[`homolog-phase-${phaseId}`] = [];
            }
            dragDropFiles[`homolog-phase-${phaseId}`].push(fileData);
        };
        reader.readAsDataURL(file);
        
        // Afficher dans l'interface
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.setAttribute('data-file-id', fileId);
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    ${(file.size / 1024).toFixed(2)} KB • ${new Date().toLocaleDateString('fr-FR')}
                </div>
            </div>
            <button onclick="previewFile('${fileId}', 'homolog-phase-${phaseId}')" 
                    style="background: none; border: none; color: var(--info-color); cursor: pointer; margin-right: 10px;"
                    title="Prévisualiser">
                <i class="fas fa-eye"></i>
            </button>
            <button onclick="downloadFile('${fileId}', 'homolog-phase-${phaseId}')" 
                    style="background: none; border: none; color: var(--success-color); cursor: pointer; margin-right: 10px;"
                    title="Télécharger">
                <i class="fas fa-download"></i>
            </button>
            <button onclick="removeFileFromList(this, '${fileId}', 'homolog-phase-${phaseId}')" 
                    style="background: none; border: none; color: var(--danger-color); cursor: pointer;"
                    title="Supprimer">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${input.files.length} fichier(s) ajouté(s)`, 'success');
}

	// Fonction pour supprimer un fichier de la liste
function removeFileFromList(button, fileId, context) {
    // Retirer du DOM
    button.closest('.file-item').remove();
    
    // Retirer du stockage temporaire
    if (dragDropFiles[context]) {
        dragDropFiles[context] = dragDropFiles[context].filter(f => f.id !== fileId);
    }
    
    showNotification('Fichier retiré', 'info');
}

// Fonction pour prévisualiser un fichier
function previewFile(fileId, context) {
    const file = dragDropFiles[context]?.find(f => f.id === fileId);
    
    if (!file) {
        showNotification('Fichier non trouvé', 'error');
        return;
    }
    
    const modal = document.getElementById('modalFilePreview');
    const content = document.getElementById('filePreviewContent');
    
    // Déterminer le type de fichier
    const fileType = file.type;
    const fileName = file.name.toLowerCase();
    
    if (fileType.startsWith('image/')) {
        // Afficher l'image
        content.innerHTML = `<img src="${file.data}" alt="${file.name}" style="max-width: 100%; max-height: 90vh; object-fit: contain;">`;
    } else if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
        // Afficher le PDF
        content.innerHTML = `<iframe src="${file.data}" style="width: 90vw; height: 90vh; border: none;"></iframe>`;
    } else if (fileType.startsWith('text/') || fileName.endsWith('.txt')) {
        // Afficher le texte
        fetch(file.data)
            .then(r => r.text())
            .then(text => {
                content.innerHTML = `<pre style="padding: 20px; background: white; max-width: 90vw; max-height: 90vh; overflow: auto;">${text}</pre>`;
            });
    } else {
        // Type non supporté pour la prévisualisation
        content.innerHTML = `
            <div style="padding: 40px; text-align: center; background: white; border-radius: 12px;">
                <i class="fas fa-file" style="font-size: 64px; color: var(--primary-color); margin-bottom: 20px;"></i>
                <h3>Aperçu non disponible</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Ce type de fichier ne peut pas être prévisualisé.<br>
                    <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)
                </p>
                <button class="btn btn-primary" onclick="downloadFile('${fileId}', '${context}')">
                    <i class="fas fa-download"></i> Télécharger le fichier
                </button>
            </div>
        `;
    }
    
    modal.classList.add('active');
}

// Fonction pour télécharger un fichier
function downloadFile(fileId, context) {
    const file = dragDropFiles[context]?.find(f => f.id === fileId);
    
    if (!file) {
        showNotification('Fichier non trouvé', 'error');
        return;
    }
    
    // Créer un lien de téléchargement
    const link = document.createElement('a');
    link.href = file.data;
    link.download = file.name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`Téléchargement de ${file.name}...`, 'success');
}

        function filterHomologations() {
            const type = document.getElementById('filterHomologationType')?.value || '';
            const status = document.getElementById('filterHomologationStatus')?.value || '';
            const date = document.getElementById('filterHomologationDate')?.value || '';
            const search = document.getElementById('searchHomologationKeyword')?.value.toLowerCase() || '';
            
            let filtered = [...homologations];
            
            if (type) filtered = filtered.filter(h => h.type === type);
            if (status) filtered = filtered.filter(h => h.status === status);
            if (date) filtered = filtered.filter(h => h.dateDebut >= date);
            
            if (search) {
                filtered = filtered.filter(h => {
                    const aerodrome = aerodromes.find(a => a.id === h.aerodromeId);
                    const searchText = `${aerodrome?.code || ''} ${aerodrome?.name || ''} ${h.numero || ''} ${h.status || ''}`.toLowerCase();
                    return searchText.includes(search);
                });
            }
            
            loadHomologations(filtered);
        }

        function resetHomologationFilters() {
            if (document.getElementById('filterHomologationType')) document.getElementById('filterHomologationType').value = '';
            if (document.getElementById('filterHomologationStatus')) document.getElementById('filterHomologationStatus').value = '';
            if (document.getElementById('filterHomologationDate')) document.getElementById('filterHomologationDate').value = '';
            if (document.getElementById('searchHomologationKeyword')) document.getElementById('searchHomologationKeyword').value = '';
            loadHomologations();
        }

        function sortHomologations(field, direction = 'asc') {
            const sorted = [...homologations].sort((a, b) => {
                let aVal, bVal;
                
                if (field === 'date') {
                    aVal = new Date(a.dateDebut);
                    bVal = new Date(b.dateDebut);
                } else if (field === 'numero') {
                    aVal = a.numero || '';
                    bVal = b.numero || '';
                } else {
                    aVal = a[field] || '';
                    bVal = b[field] || '';
                }
                
                return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });
            
            loadHomologations(sorted);
        }

        function searchHomologations() {
            const search = document.getElementById('searchHomologation')?.value.toLowerCase() || '';
            
            if (!search) {
                loadHomologations();
                return;
            }
            
            const filtered = homologations.filter(homolog => {
                const aerodrome = aerodromes.find(a => a.id === homolog.aerodromeId);
                const searchText = `
                    ${aerodrome?.code || ''}
                    ${aerodrome?.name || ''}
                    ${homolog.numero || ''}
                    ${homolog.type || ''}
                    ${homolog.status || ''}
                    ${homolog.remarques || ''}
                `.toLowerCase();
                return searchText.includes(search);
            });
            
            loadHomologations(filtered);
        }

	// ============ FONCTIONS POUR SURVEILLANCE ============

function initSurveillanceModal() {
    document.getElementById('surveillanceId').value = '';
    document.getElementById('surveillanceModalTitle').textContent = 'Nouvelle Inspection/Audit';
    document.getElementById('surveillanceAerodrome').value = '';
    document.getElementById('surveillanceType').value = '';
    document.getElementById('surveillanceDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('surveillanceConformite').value = 0;
    document.getElementById('surveillanceObservations').value = '';
    document.getElementById('surveillanceStatus').value = 'Planifié';
    document.getElementById('ecartsContainer').innerHTML = '';
    document.getElementById('surveillanceFileList').innerHTML = '';
    document.getElementById('surveillanceAerodromeInfo').style.display = 'none';
    
    updateConformiteValue();
    updateAerodromeSelects();
    updateInspectorSelects();
    
    // Charger les inspecteurs dans le select multiple
    const inspecteurSelect = document.getElementById('surveillanceInspecteurs');
    inspecteurSelect.innerHTML = '';
    inspectors.forEach(i => {
        const option = document.createElement('option');
        option.value = i.id;
        option.textContent = `${i.lastName} ${i.firstName} (${i.specialty})`;
        inspecteurSelect.appendChild(option);
    });
}

function updateAerodromeInfo() {
    const aerodromeId = document.getElementById('surveillanceAerodrome').value;
    const infoDiv = document.getElementById('surveillanceAerodromeInfo');
    
    if (!aerodromeId) {
        infoDiv.style.display = 'none';
        return;
    }
    
    const aerodrome = aerodromes.find(a => a.id === aerodromeId);
    if (aerodrome) {
        document.getElementById('infoCode').textContent = aerodrome.code;
        document.getElementById('infoVille').textContent = aerodrome.city;
        document.getElementById('infoType').textContent = aerodrome.type;
        document.getElementById('infoStatut').textContent = aerodrome.status;
        infoDiv.style.display = 'block';
    }
}

function updateConformiteValue() {
    const value = document.getElementById('surveillanceConformite').value;
    document.getElementById('conformiteValue').textContent = value + '%';
    document.getElementById('conformiteFill').style.width = value + '%';
    document.getElementById('conformiteLabel').textContent = value + '%';
    
    // Changer la couleur selon le taux
    let color = 'var(--danger-color)';
    if (value >= 70) color = 'var(--success-color)';
    else if (value >= 40) color = 'var(--warning-color)';
    
    document.getElementById('conformiteFill').style.background = color;
}

function addEcart() {
    const container = document.getElementById('ecartsContainer');
    const ecartId = 'ecart-' + Date.now();
    
    const ecartHtml = `
        <div class="ecart-item" data-id="${ecartId}" style="margin-bottom: 15px; padding: 15px; background: var(--light-bg); border-radius: 8px; border-left: 4px solid var(--danger-color);">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Description de l'écart</label>
                    <input type="text" class="ecart-description" placeholder="Description de l'écart constaté" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label>Niveau de risque</label>
                    <select class="ecart-risk" style="width: 100%;">
                        <option value="Élevé">Élevé</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Faible">Faible</option>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="removeEcart('${ecartId}')" style="padding: 10px 15px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
                <label>Action corrective recommandée</label>
                <textarea class="ecart-action" rows="2" placeholder="Action corrective recommandée..." style="width: 100%;"></textarea>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', ecartHtml);
}

function removeEcart(ecartId) {
    const ecart = document.querySelector(`[data-id="${ecartId}"]`);
    if (ecart) {
        ecart.remove();
    }
}

function triggerSurveillanceFileUpload() {
    document.getElementById('surveillanceFileInput').click();
}

function handleSurveillanceFiles(input) {
    const fileList = document.getElementById('surveillanceFileList');
    
    Array.from(input.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${input.files.length} fichier(s) ajouté(s)`, 'success');
}

function saveSurveillance() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const aerodromeId = document.getElementById('surveillanceAerodrome').value;
    const type = document.getElementById('surveillanceType').value;
    const date = document.getElementById('surveillanceDate').value;
    const conformite = parseInt(document.getElementById('surveillanceConformite').value);
    const inspecteurs = Array.from(document.getElementById('surveillanceInspecteurs').selectedOptions).map(o => o.value);
    
    if (!aerodromeId || !type || !date || inspecteurs.length === 0) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        // Collecter les écarts
        const ecarts = [];
        const ecartElements = document.querySelectorAll('#ecartsContainer .ecart-item');
        ecartElements.forEach(el => {
            const description = el.querySelector('.ecart-description')?.value;
            const risk = el.querySelector('.ecart-risk')?.value;
            const action = el.querySelector('.ecart-action')?.value;
            
            if (description) {
                ecarts.push({ description, risk, action });
            }
        });
        
        const surveillance = {
            id: document.getElementById('surveillanceId').value || 'surv-' + Date.now(),
            aerodromeId: aerodromeId,
            type: type,
            date: date,
            conformite: conformite,
            inspecteurs: inspecteurs,
            ecarts: ecarts,
            observations: document.getElementById('surveillanceObservations').value,
            status: document.getElementById('surveillanceStatus').value,
            dateCreation: new Date().toISOString()
        };
        
        const existingIndex = surveillances.findIndex(s => s.id === surveillance.id);
        if (existingIndex >= 0) {
            surveillances[existingIndex] = surveillance;
            showNotification('Inspection/Audit modifié avec succès!', 'success');
        } else {
            surveillances.push(surveillance);
            showNotification('Inspection/Audit créé avec succès!', 'success');
        }
        
        closeModal('modalSurveillance');
        loadSurveillances();
        updateDashboard();
        hideLoading();
        saveAllData();
    }, 800);
}

function loadSurveillances(filteredList = null) {
    const container = document.getElementById('surveillanceList');
    if (!container) return;
    
    // Réinitialiser le style du container
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '20px';
    container.style.width = '100%';
    container.style.padding = '20px';
    
    let list = filteredList || surveillances || [];
    
    // ============================================
    // 1. CALCUL DES STATISTIQUES POUR LE TABLEAU DE BORD
    // ============================================
    
    // Nombre d'inspections par aérodrome
    const inspectionsParAerodrome = {};
    aerodromes.forEach(aero => {
        const count = list.filter(s => String(s.aerodromeId) === String(aero.id)).length;
        inspectionsParAerodrome[aero.id] = {
            code: aero.code,
            name: aero.name,
            count: count,
            conformiteMoyenne: 0,
            ecartsRisque: 0
        };
    });
    
    // Taux de conformité par aérodrome
    aerodromes.forEach(aero => {
        const inspectionsAero = list.filter(s => String(s.aerodromeId) === String(aero.id));
        if (inspectionsAero.length > 0) {
            const totalConformite = inspectionsAero.reduce((sum, s) => sum + (s.conformite || 0), 0);
            inspectionsParAerodrome[aero.id].conformiteMoyenne = Math.round(totalConformite / inspectionsAero.length);
            
            // Nombre d'écarts à risque élevé
            const totalEcartsRisque = inspectionsAero.reduce((sum, s) => 
                sum + (s.ecarts?.filter(e => e.risk === 'Élevé' || e.risk === 'Critique').length || 0), 0);
            inspectionsParAerodrome[aero.id].ecartsRisque = totalEcartsRisque;
        }
    });
    
    // Aérodromes avec le plus fort et le plus faible taux de conformité
    const aeroAvecConformite = Object.values(inspectionsParAerodrome)
        .filter(a => a.count > 0)
        .sort((a, b) => b.conformiteMoyenne - a.conformiteMoyenne);
    
    const aeroFortConformite = aeroAvecConformite.slice(0, 3);
    const aeroFaibleConformite = [...aeroAvecConformite].reverse().slice(0, 3);
    
    // Aérodromes à risques (avec le plus d'écarts)
    const aeroAvecRisques = Object.values(inspectionsParAerodrome)
        .filter(a => a.count > 0)
        .sort((a, b) => b.ecartsRisque - a.ecartsRisque)
        .slice(0, 5);
    
    // Statistiques globales
    const stats = {
        total: list.length,
        activeCount: list.filter(s => s.status === 'En cours' || s.status === 'Planifié').length,
        avgConformite: list.length > 0 
            ? Math.round(list.reduce((sum, s) => sum + (s.conformite || 0), 0) / list.length)
            : 0,
        highRiskEcarts: list.reduce((sum, s) => 
            sum + (s.ecarts?.filter(e => e.risk === 'Élevé' || e.risk === 'Critique').length || 0), 0),
        thisMonth: (() => {
            const now = new Date();
            return list.filter(s => {
                try {
                    const sDate = new Date(s.date);
                    return sDate.getMonth() === now.getMonth() && sDate.getFullYear() === now.getFullYear();
                } catch {
                    return false;
                }
            }).length;
        })()
    };
    
    // Mise à jour des statistiques affichées ailleurs si nécessaire
    if (document.getElementById('stat-surveillance-active')) {
        document.getElementById('stat-surveillance-active').textContent = stats.activeCount;
        document.getElementById('stat-moyenne-conformite').textContent = stats.avgConformite + '%';
        document.getElementById('stat-ecarts-risque').textContent = stats.highRiskEcarts;
        document.getElementById('stat-inspections-mois').textContent = stats.thisMonth;
    }
    
    // ============================================
    // 2. CONSTRUCTION DU HTML
    // ============================================
    let html = '';
    
    // ============================================
    // 2.1. TABLEAU DE BORD
    // ============================================
    html += `
        <div style="width: 100%; background: white; border-radius: 10px; padding: 20px 25px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08); border-left: 4px solid #2563eb;">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-tachometer-alt" style="color: #2563eb;"></i>
                Tableau de Bord des Inspections
            </h3>
            
            <!-- Ligne 1: Cartes de statistiques -->
            <div style="display: flex; flex-wrap: nowrap; gap: 15px; width: 100%; margin-bottom: 25px;">
                <!-- Carte Total Inspections -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #2563eb; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);">
                            <i class="fas fa-shield-alt" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Total Inspections</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.total}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Carte Conformité Moyenne -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #10b981; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(16, 185, 129, 0.25);">
                            <i class="fas fa-percent" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Conformité Moyenne</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.avgConformite}%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Carte Écarts à Risque -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #ef4444; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(239, 68, 68, 0.25);">
                            <i class="fas fa-exclamation-triangle" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Écarts à Risque</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.highRiskEcarts}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Carte Ce Mois -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #8b5cf6; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(139, 92, 246, 0.25);">
                            <i class="fas fa-calendar-alt" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Ce Mois</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.thisMonth}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ligne 2: Visualisations -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Aérodromes à fort taux de conformité -->
                <div style="background: #f0f9ff; border-radius: 10px; padding: 15px; border: 1px solid #dbeafe;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #1e40af; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-trophy" style="color: #f59e0b;"></i>
                        Meilleure Conformité
                    </h4>
                    ${aeroFortConformite.length > 0 ? 
                        aeroFortConformite.map(aero => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #dbeafe; font-size: 13px;">
                                <span style="font-weight: 600; color: #1e293b;">${aero.code}</span>
                                <span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 12px;">
                                    ${aero.conformiteMoyenne}%
                                </span>
                            </div>
                        `).join('')
                        : '<p style="color: #64748b; font-size: 13px; margin: 10px 0;">Aucune donnée</p>'
                    }
                </div>
                
                <!-- Aérodromes à faible taux de conformité -->
                <div style="background: #fef2f2; border-radius: 10px; padding: 15px; border: 1px solid #fee2e2;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #991b1b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                        Surveillance Requise
                    </h4>
                    ${aeroFaibleConformite.length > 0 ? 
                        aeroFaibleConformite.map(aero => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #fee2e2; font-size: 13px;">
                                <span style="font-weight: 600; color: #1e293b;">${aero.code}</span>
                                <span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 12px;">
                                    ${aero.conformiteMoyenne}%
                                </span>
                            </div>
                        `).join('')
                        : '<p style="color: #64748b; font-size: 13px; margin: 10px 0;">Aucune donnée</p>'
                    }
                </div>
                
                <!-- Aérodromes à risques -->
                <div style="background: #fffbeb; border-radius: 10px; padding: 15px; border: 1px solid #fef3c7;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: #92400e; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-radiation-alt" style="color: #f59e0b;"></i>
                        Aérodromes à Risques
                    </h4>
                    ${aeroAvecRisques.length > 0 ? 
                        aeroAvecRisques.map(aero => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #fef3c7; font-size: 13px;">
                                <span style="font-weight: 600; color: #1e293b;">${aero.code}</span>
                                <span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 12px;">
                                    ${aero.ecartsRisque} écart(s)
                                </span>
                            </div>
                        `).join('')
                        : '<p style="color: #64748b; font-size: 13px; margin: 10px 0;">Aucune donnée</p>'
                    }
                </div>
            </div>
            
            <!-- Ligne 3: Inspections par aérodrome -->
            <div style="background: #f8fafc; border-radius: 10px; padding: 15px; border: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 15px 0; font-size: 14px; font-weight: 700; color: #475569; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-bar" style="color: #475569;"></i>
                    Inspections par Aérodrome
                </h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${aerodromes.filter(aero => inspectionsParAerodrome[aero.id]?.count > 0).map(aero => {
                        const data = inspectionsParAerodrome[aero.id];
                        return `
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 15px; flex: 1; min-width: 150px;">
                                <div style="font-weight: 800; font-size: 12px; color: #1e293b; margin-bottom: 5px;">${data.code}</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 22px; font-weight: 800; color: #2563eb;">${data.count}</span>
                                    <div style="text-align: right;">
                                        <div style="font-size: 11px; color: #64748b;">Conformité</div>
                                        <div style="font-size: 13px; font-weight: 700; color: ${data.conformiteMoyenne >= 70 ? '#10b981' : data.conformiteMoyenne >= 40 ? '#f59e0b' : '#ef4444'}">
                                            ${data.conformiteMoyenne}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    // ============================================
    // 2.2. SECTION FILTRES
    // ============================================
    html += `
        <div style="width: 100%; background: white; border-left: 4px solid #2563eb; border-radius: 10px; padding: 20px 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <!-- Filtre Aérodrome -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-plane-departure" style="color: #2563eb; font-size: 14px;"></i>
                        Aérodrome
                    </label>
                    <select id="filterSurveillanceAerodrome" onchange="applySurveillanceFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les aérodromes</option>
                        ${aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('')}
                    </select>
                </div>
                
                <!-- Filtre Niveau de Conformité -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-percent" style="color: #10b981; font-size: 14px;"></i>
                        Niveau de Conformité
                    </label>
                    <select id="filterSurveillanceConformite" onchange="applySurveillanceFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les niveaux</option>
                        <option value="excellent">Excellent (90-100%)</option>
                        <option value="bon">Bon (70-89%)</option>
                        <option value="moyen">Moyen (40-69%)</option>
                        <option value="faible">Faible (0-39%)</option>
                    </select>
                </div>
                
                <!-- Filtre Date -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-calendar-alt" style="color: #8b5cf6; font-size: 14px;"></i>
                        Période
                    </label>
                    <select id="filterSurveillanceDate" onchange="applySurveillanceFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Toute période</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                        <option value="quarter">Ce trimestre</option>
                        <option value="year">Cette année</option>
                    </select>
                </div>
                
                <!-- Filtre Statut -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-tasks" style="color: #f59e0b; font-size: 14px;"></i>
                        Statut
                    </label>
                    <select id="filterSurveillanceStatus" onchange="applySurveillanceFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les statuts</option>
                        <option value="Planifié">Planifié</option>
                        <option value="En cours">En cours</option>
                        <option value="Terminé">Terminé</option>
                        <option value="Validé">Validé</option>
                        <option value="Annulé">Annulé</option>
                    </select>
                </div>
                
                <!-- Bouton Réinitialiser -->
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="resetSurveillanceFilters()" 
                            style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border: none; color: white; padding: 11px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-redo-alt" style="font-size: 13px;"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // ============================================
    // 2.3. VÉRIFICATION DES DONNÉES
    // ============================================
    if (list.length === 0) {
        html += `
            <div style="width: 100%; text-align: center; padding: 60px; color: #94a3b8; background: #f8fafc; border-radius: 20px; border: 2px dashed #e2e8f0;">
                <i class="fas fa-eye" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3 style="font-size: 20px; font-weight: 600;">Aucune inspection/audit trouvé</h3>
                <p>Modifiez vos filtres ou créez une nouvelle inspection.</p>
            </div>
        `;
        container.innerHTML = html;
        return;
    }
    
    // ============================================
    // 2.4. EN-TÊTE
    // ============================================
    html += `
        <div style="width: 100%; background: linear-gradient(135deg, #2563eb, #1e40af); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700;"><i class="fas fa-shield-alt"></i> Inspections & Audits</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 14px;">Total : ${list.length} inspection(s) • ${stats.avgConformite}% de conformité moyenne</p>
                </div>
                <button onclick="openModal('modalSurveillance')" class="btn" 
                        style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s;">
                    <i class="fas fa-plus-circle" style="font-size: 16px;"></i>
                    Nouvelle Inspection
                </button>
            </div>
        </div>
    `;
    
    // ============================================
    // 2.5. GROUPES PAR AÉRODROME
    // ============================================
    const grouped = list.reduce((acc, s) => {
        const key = s.aerodromeId;
        if (!acc[key]) acc[key] = [];
        acc[key].push(s);
        return acc;
    }, {});
    
    html += Object.entries(grouped).map(([aeroId, inspections], index) => {
        const aero = aerodromes.find(a => String(a.id) === String(aeroId));
        const contentId = `surv-aero-content-${aeroId}`;
        const iconId = `surv-aero-icon-${aeroId}`;
        const isFirstGroup = index === 0;
        
        // Statistiques pour cet aérodrome
        const statsAero = inspectionsParAerodrome[aeroId] || { 
            count: 0, 
            conformiteMoyenne: 0, 
            ecartsRisque: 0 
        };
        
        return `
            <div style="width: 100%; border: 1px solid #e2e8f0; border-radius: 14px; overflow: hidden; background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <div onclick="toggleSurveillanceAeroGroup('${aeroId}')" 
                     style="background: linear-gradient(135deg, #1e40af, #2563eb); color: white; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                        <div style="background: rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 16px; border: 1px solid rgba(255,255,255,0.3);">
                            ${aero?.code || 'AD'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${aero?.name || 'Aérodrome Inconnu'}</h4>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 2px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <span><i class="fas fa-shield-alt"></i> ${statsAero.count} inspection(s)</span>
                                <span><i class="fas fa-percent"></i> ${statsAero.conformiteMoyenne}% de conformité</span>
                                ${statsAero.ecartsRisque > 0 ? `<span style="color: #fecaca; font-weight: 800;"><i class="fas fa-exclamation-triangle"></i> ${statsAero.ecartsRisque} écart(s) à risque</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span class="badge" style="background: rgba(255,255,255,0.25); font-size: 13px; padding: 6px 12px; font-weight: 600;">${inspections.length} mission(s)</span>
                        <i class="fas fa-chevron-down" id="${iconId}" style="transition: transform 0.3s ease; font-size: 1.2em; ${isFirstGroup ? 'transform: rotate(180deg);' : ''}"></i>
                    </div>
                </div>

                <div id="${contentId}" class="surv-group-content ${isFirstGroup ? 'expanded' : 'collapsed'}" style="${isFirstGroup ? 'display: block;' : 'display: none;'} padding: 25px; background: #f8fafc; border-top: 1px solid #e2e8f0; transition: all 0.3s ease-in-out;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
                        ${inspections.map(surv => renderSurveillanceCard(surv)).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // ============================================
    // 2.6. PAGINATION (si nécessaire)
    // ============================================
    const itemsPerPage = 20; // Augmenté pour inclure le tableau de bord
    const totalPages = Math.ceil(list.length / itemsPerPage);
    
    if (totalPages > 1) {
        html += `
            <div style="width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <button onclick="changeSurveillancePage(${window.currentSurveillancePage - 1 || 1})" 
                        ${(window.currentSurveillancePage || 1) === 1 ? 'disabled' : ''} 
                        style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.3s;">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                
                <div style="display: flex; gap: 5px;">
                    ${Array.from({length: Math.min(totalPages, 5)}, (_, i) => {
                        let page;
                        const current = window.currentSurveillancePage || 1;
                        if (totalPages <= 5) {
                            page = i + 1;
                        } else if (current <= 3) {
                            page = i + 1;
                        } else if (current >= totalPages - 2) {
                            page = totalPages - 4 + i;
                        } else {
                            page = current - 2 + i;
                        }
                        return `
                        <button onclick="changeSurveillancePage(${page})" 
                                style="background: ${page === (window.currentSurveillancePage || 1) ? '#2563eb' : '#f8fafc'}; 
                                        color: ${page === (window.currentSurveillancePage || 1) ? 'white' : '#475569'}; 
                                        border: 1px solid ${page === (window.currentSurveillancePage || 1) ? '#2563eb' : '#e2e8f0'}; 
                                        padding: 8px 12px; min-width: 40px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px;">
                            ${page}
                        </button>
                    `}).join('')}
                </div>
                
                <button onclick="changeSurveillancePage(${window.currentSurveillancePage + 1 || 2})" 
                        ${(window.currentSurveillancePage || 1) === totalPages ? 'disabled' : ''} 
                        style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.3s;">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ============================================
// FONCTIONS DE FILTRAGE
// ============================================

function applySurveillanceFilters() {
    const aerodromeFilter = document.getElementById('filterSurveillanceAerodrome')?.value;
    const conformiteFilter = document.getElementById('filterSurveillanceConformite')?.value;
    const dateFilter = document.getElementById('filterSurveillanceDate')?.value;
    const statusFilter = document.getElementById('filterSurveillanceStatus')?.value;
    
    let filtered = [...surveillances];
    
    // Filtre par aérodrome
    if (aerodromeFilter) {
        filtered = filtered.filter(s => String(s.aerodromeId) === String(aerodromeFilter));
    }
    
    // Filtre par niveau de conformité
    if (conformiteFilter) {
        filtered = filtered.filter(s => {
            switch(conformiteFilter) {
                case 'excellent': return s.conformite >= 90;
                case 'bon': return s.conformite >= 70 && s.conformite < 90;
                case 'moyen': return s.conformite >= 40 && s.conformite < 70;
                case 'faible': return s.conformite < 40;
                default: return true;
            }
        });
    }
    
    // Filtre par date
    if (dateFilter) {
        const now = new Date();
        filtered = filtered.filter(s => {
            try {
                const sDate = new Date(s.date);
                switch(dateFilter) {
                    case 'today':
                        return sDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay());
                        weekStart.setHours(0, 0, 0, 0);
                        return sDate >= weekStart;
                    case 'month':
                        return sDate.getMonth() === now.getMonth() && sDate.getFullYear() === now.getFullYear();
                    case 'quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        return Math.floor(sDate.getMonth() / 3) === quarter && sDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return sDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            } catch {
                return false;
            }
        });
    }
    
    // Filtre par statut
    if (statusFilter) {
        filtered = filtered.filter(s => s.status === statusFilter);
    }
    
    loadSurveillances(filtered);
}

function resetSurveillanceFilters() {
    document.getElementById('filterSurveillanceAerodrome').value = '';
    document.getElementById('filterSurveillanceConformite').value = '';
    document.getElementById('filterSurveillanceDate').value = '';
    document.getElementById('filterSurveillanceStatus').value = '';
    loadSurveillances();
}

function toggleSurveillanceAeroGroup(aeroId) {
    const contentId = `surv-aero-content-${aeroId}`;
    const iconId = `surv-aero-icon-${aeroId}`;
    
    const content = document.getElementById(contentId);
    const icon = document.getElementById(iconId);
    
    if (!content || !icon) return;
    
    // Toggle l'affichage
    if (content.style.display === 'none' || content.classList.contains('collapsed')) {
        content.style.display = 'block';
        content.classList.remove('collapsed');
        content.classList.add('expanded');
        icon.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        content.classList.remove('expanded');
        content.classList.add('collapsed');
        icon.style.transform = 'rotate(0deg)';
    }
}

// ============================================
// FONCTION RENDER SURVEILLANCE CARD (manquante)
// ============================================

function renderSurveillanceCard(surv) {
    // Trouver l'aérodrome correspondant
    const aero = aerodromes.find(a => String(a.id) === String(surv.aerodromeId));
    
    // Couleur de la conformité
    const getConformiteColor = (percent) => {
        if (percent >= 90) return '#10b981';
        if (percent >= 70) return '#3b82f6';
        if (percent >= 40) return '#f59e0b';
        return '#ef4444';
    };
    
    // Couleur du statut
    const getStatusColor = (status) => {
        switch(status) {
            case 'Validé':
            case 'Terminé': return '#10b981';
            case 'En cours': return '#3b82f6';
            case 'Planifié': return '#f59e0b';
            case 'Annulé': return '#ef4444';
            default: return '#64748b';
        }
    };
    
    // Format date
    const formatDate = (dateStr) => {
        if (!dateStr) return 'Non définie';
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        } catch {
            return 'Date invalide';
        }
    };
    
    // Liste des inspecteurs
    const inspecteursList = surv.inspecteurs?.map(id => {
        const insp = inspectors?.find(i => String(i.id) === String(id));
        return insp ? `${insp.lastName} ${insp.firstName?.charAt(0)}.` : 'Inconnu';
    }).join(', ') || 'Non assignés';
    
    // Nombre d'écarts à risque
    const ecartsRisque = surv.ecarts?.filter(e => e.risk === 'Élevé' || e.risk === 'Critique').length || 0;
    
    const conformiteColor = getConformiteColor(surv.conformite || 0);
    const statusColor = getStatusColor(surv.status);
    
    return `
        <div class="surveillance-card" data-surv-id="${surv.id}" 
             style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; transition: all 0.3s ease; cursor: pointer;"
             onclick="viewSurveillanceDetails('${surv.id}')">
            
            <!-- En-tête avec type et date -->
            <div style="background: linear-gradient(135deg, ${conformiteColor}20, ${conformiteColor}10); padding: 18px; border-bottom: 2px solid ${conformiteColor}30;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div style="flex: 1; min-width: 0;">
                        <h5 style="margin: 0 0 6px 0; font-size: 16px; font-weight: 700; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${surv.type || 'Inspection'}
                        </h5>
                        <p style="margin: 0; font-size: 13px; color: #475569; opacity: 0.9; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-calendar-alt" style="font-size: 12px;"></i>
                            ${formatDate(surv.date)}
                        </p>
                    </div>
                    <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">
                        ${surv.status || 'Non défini'}
                    </span>
                </div>
                
                <!-- Barre de conformité -->
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Conformité</span>
                        <span style="font-size: 14px; font-weight: 800; color: ${conformiteColor};">${surv.conformite || 0}%</span>
                    </div>
                    <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, ${conformiteColor}, ${conformiteColor}80); height: 100%; width: ${surv.conformite || 0}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Corps de la carte -->
            <div style="padding: 18px;">
                <!-- Informations -->
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 18px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #f8fafc; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #2563eb;">
                            <i class="fas fa-plane-departure" style="font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;">Aérodrome</div>
                            <div style="font-size: 14px; font-weight: 700; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${aero?.code || 'AD'} - ${aero?.name || 'Inconnu'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #f8fafc; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #8b5cf6;">
                            <i class="fas fa-user-tie" style="font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;">Inspecteurs</div>
                            <div style="font-size: 13px; font-weight: 600; color: #334155; line-height: 1.3; max-height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                ${inspecteursList}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #f8fafc; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;">Écarts à Risque</div>
                            <div style="font-size: 14px; font-weight: 700; color: ${ecartsRisque > 0 ? '#ef4444' : '#10b981'}">
                                ${ecartsRisque} écart(s)
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Observations -->
                <div style="border-top: 1px solid #e2e8f0; padding-top: 14px;">
                    <div style="font-size: 12px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-comment-alt"></i>
                        Observations
                    </div>
                    <div style="font-size: 13px; color: #475569; line-height: 1.4; max-height: 60px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                        ${surv.observations || 'Aucune observation'}
                    </div>
                </div>
            </div>
            
            <!-- Footer avec actions -->
            <div style="background: #f8fafc; padding: 15px 18px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 12px; color: #64748b; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-paperclip" style="font-size: 11px;"></i>
                    ${surv.files?.length || 0} pièce(s) jointe(s)
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="event.stopPropagation(); editSurveillance('${surv.id}')" 
                            style="background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <i class="fas fa-edit" style="font-size: 13px;"></i>
                    </button>
                    <button onclick="event.stopPropagation(); viewSurveillanceDetails('${surv.id}')" 
                            style="background: #2563eb; border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <i class="fas fa-eye" style="font-size: 13px;"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function editSurveillance(id) {
    const surv = surveillances.find(s => s.id === id);
    if (!surv) return;
    
    document.getElementById('surveillanceId').value = surv.id;
    document.getElementById('surveillanceModalTitle').textContent = 'Modifier Inspection/Audit';
    document.getElementById('surveillanceAerodrome').value = surv.aerodromeId;
    document.getElementById('surveillanceType').value = surv.type;
    document.getElementById('surveillanceDate').value = surv.date;
    document.getElementById('surveillanceConformite').value = surv.conformite;
    document.getElementById('surveillanceObservations').value = surv.observations || '';
    document.getElementById('surveillanceStatus').value = surv.status;
    
    updateConformiteValue();
    updateAerodromeInfo();
    
    // Charger les inspecteurs
    const inspecteurSelect = document.getElementById('surveillanceInspecteurs');
    Array.from(inspecteurSelect.options).forEach(option => {
        option.selected = surv.inspecteurs?.includes(option.value);
    });
    
    // Charger les écarts
    const ecartsContainer = document.getElementById('ecartsContainer');
    ecartsContainer.innerHTML = '';
    if (surv.ecarts) {
        surv.ecarts.forEach(ecart => {
            addEcart();
            const lastEcart = ecartsContainer.lastElementChild;
            lastEcart.querySelector('.ecart-description').value = ecart.description || '';
            lastEcart.querySelector('.ecart-risk').value = ecart.risk || 'Élevé';
            lastEcart.querySelector('.ecart-action').value = ecart.action || '';
        });
    }
    
    openModal('modalSurveillance');
}

function viewSurveillanceDetails(id) {
    const surv = surveillances.find(s => s.id === id);
    if (!surv) return;
    
    const aerodrome = aerodromes.find(a => a.id === surv.aerodromeId);
    const inspecteursList = surv.inspecteurs?.map(id => {
        const insp = inspectors.find(i => i.id === id);
        return insp ? `${insp.lastName} ${insp.firstName} (${insp.specialty})` : 'Inconnu';
    }).join(', ') || 'Non assignés';
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                Détails de l'Inspection/Audit - ${aerodrome?.code || 'Inconnu'}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Informations Générales</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Aérodrome</div>
                        <div class="detail-value">${aerodrome?.name || 'Inconnu'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${surv.type}</div>
                    </div>
                    <div>
                        <div class="detail-label">Date</div>
                        <div class="detail-value">${new Date(surv.date).toLocaleDateString('fr-FR')}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Taux de Conformité</div>
                        <div class="detail-value">${surv.conformite}%</div>
                    </div>
                    <div>
                        <div class="detail-label">Statut</div>
                        <div class="detail-value">${surv.status}</div>
                    </div>
                    <div>
                        <div class="detail-label">Inspecteurs</div>
                        <div class="detail-value">${inspecteursList}</div>
                    </div>
                </div>
            </div>
            
            ${surv.ecarts && surv.ecarts.length > 0 ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Écarts Constatés (${surv.ecarts.length})</h4>
                    <div class="ecart-grid">
                        ${surv.ecarts.map(ecart => {
                            let riskColor = 'var(--danger-color)';
                            if (ecart.risk === 'Moyen') riskColor = 'var(--warning-color)';
                            else if (ecart.risk === 'Faible') riskColor = 'var(--success-color)';
                            
                            return `
                                <div class="ecart-item" style="border-left-color: ${riskColor};">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <div class="ecart-title">${ecart.description}</div>
                                        <span class="badge" style="background: ${riskColor};">${ecart.risk}</span>
                                    </div>
                                    ${ecart.action ? `
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            <strong>Action recommandée:</strong> ${ecart.action}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${surv.observations ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Observations</h4>
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px; line-height: 1.6;">
                        ${surv.observations}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function deleteSurveillance(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette inspection/audit ?')) {
        surveillances = surveillances.filter(s => s.id !== id);
        loadSurveillances();
        updateDashboard();
        showNotification('Inspection/Audit supprimé avec succès', 'success');
        saveAllData();
    }
}

function filterSurveillances() {
    const type = document.getElementById('filterSurveillanceType')?.value || '';
    const status = document.getElementById('filterSurveillanceStatus')?.value || '';
    const date = document.getElementById('filterSurveillanceDate')?.value || '';
    const search = document.getElementById('searchSurveillanceKeyword')?.value.toLowerCase() || '';
    
    let filtered = [...surveillances];
    
    if (type) filtered = filtered.filter(s => s.type === type);
    if (status) filtered = filtered.filter(s => s.status === status);
    if (date) filtered = filtered.filter(s => s.date >= date);
    
    if (search) {
        filtered = filtered.filter(s => {
            const aerodrome = aerodromes.find(a => a.id === s.aerodromeId);
            const searchText = `${aerodrome?.code || ''} ${aerodrome?.name || ''} ${s.type || ''} ${s.observations || ''}`.toLowerCase();
            return searchText.includes(search);
        });
    }
    
    loadSurveillances(filtered);
}

function resetSurveillanceFilters() {
    if (document.getElementById('filterSurveillanceType')) document.getElementById('filterSurveillanceType').value = '';
    if (document.getElementById('filterSurveillanceStatus')) document.getElementById('filterSurveillanceStatus').value = '';
    if (document.getElementById('filterSurveillanceDate')) document.getElementById('filterSurveillanceDate').value = '';
    if (document.getElementById('searchSurveillanceKeyword')) document.getElementById('searchSurveillanceKeyword').value = '';
    loadSurveillances();
}

function sortSurveillances(field, direction = 'asc') {
    const sorted = [...surveillances].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'date') {
            aVal = new Date(a.date);
            bVal = new Date(b.date);
        } else if (field === 'conformite') {
            aVal = a.conformite || 0;
            bVal = b.conformite || 0;
        } else {
            aVal = a[field] || '';
            bVal = b[field] || '';
        }
        
        return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    
    loadSurveillances(sorted);
}

function searchSurveillances() {
    const search = document.getElementById('searchSurveillance')?.value.toLowerCase() || '';
    
    if (!search) {
        loadSurveillances();
        return;
    }
    
    const filtered = surveillances.filter(surv => {
        const aerodrome = aerodromes.find(a => a.id === surv.aerodromeId);
        const searchText = `
            ${aerodrome?.code || ''}
            ${aerodrome?.name || ''}
            ${surv.type || ''}
            ${surv.status || ''}
            ${surv.observations || ''}
        `.toLowerCase();
        return searchText.includes(search);
    });
    
    loadSurveillances(filtered);
}


// ============ FONCTIONS POUR REGISTRES ============

// Variables globales pour la pagination et filtres
let registresCurrentPage = 1;
const registresPerPage = 10;
let registresSortField = 'dateDebut';
let registresSortDirection = 'desc';
let registreFiles = {};
let expandedGroups = { 'certification': true, 'homologation': true };

// Fonction principale de chargement des registres
function loadRegistres(filteredList = null) {
    const container = document.getElementById('registresTable');
    const groupContainer = document.getElementById('registresGroupContainer');
    const dashboard = document.getElementById('registresDashboard');
    const countElement = document.getElementById('registresCount');
    
    if (!container) return;
    
    const list = filteredList || registres || [];
    
    // 1. CALCUL DES STATISTIQUES
    const now = new Date();
    const stats = {
        total: list.length,
        enCours: list.filter(r => r.status === 'En cours').length,
        expires: list.filter(r => r.status === 'Expiré').length,
        suspendus: list.filter(r => r.status === 'Suspendu').length,
        annules: list.filter(r => r.status === 'Annulé').length,
        certification: list.filter(r => r.type === 'Certification').length,
        homologation: list.filter(r => r.type === 'Homologation').length
    };
    
    // 2. MINI TABLEAU DE BORD
    dashboard.innerHTML = `
        <!-- Carte Total Dossiers -->
        <div style="background: white; border-left: 4px solid #1e3a8a; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-book" style="color: #1e3a8a;"></i> TOTAL REGISTRES
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.total}</div>
                </div>
                <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-clipboard-list" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
        
        <!-- Carte Certifications -->
        <div style="background: white; border-left: 4px solid #0284c7; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-certificate" style="color: #0284c7;"></i> CERTIFICATIONS
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.certification}</div>
                </div>
                <div style="background: linear-gradient(135deg, #0284c7 0%, #38bdf8 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-certificate" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
        
        <!-- Carte Homologations -->
        <div style="background: white; border-left: 4px solid #059669; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-stamp" style="color: #059669;"></i> HOMOLOGATIONS
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.homologation}</div>
                </div>
                <div style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-stamp" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
        
        <!-- Carte En Cours -->
        <div style="background: white; border-left: 4px solid #8b5cf6; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-sync-alt fa-spin" style="color: #8b5cf6;"></i> EN COURS
                    </div>
                    <div style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 8px 0;">${stats.enCours}</div>
                </div>
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-hourglass-half" style="color: white; font-size: 20px;"></i>
                </div>
            </div>
        </div>
    `;
    
    // 3. MISE À JOUR DU COMPTEUR
    countElement.textContent = list.length;
    
    if (list.length === 0) {
        groupContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #64748b; background: white; border-radius: 12px;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: #cbd5e1;"></i>
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">Aucun registre trouvé</div>
                <div>Essayez de modifier vos filtres ou ajoutez un nouveau registre</div>
            </div>
        `;
        return;
    }
    
    // 4. CRÉATION DES GROUPEMENTS
    createRegistreGroups(list);
    
    // 5. INITIALISATION DES FILTRES
    initRegistreFilters();
}

// Fonction pour créer les groupements par type
function createRegistreGroups(list) {
    const groupContainer = document.getElementById('registresGroupContainer');
    
    // Séparer les registres par type
    const certifications = list.filter(r => r.type === 'Certification');
    const homologations = list.filter(r => r.type === 'Homologation');
    
    let html = '';
    
    // Groupement Certification
    html += createGroupElement('certification', 'Certifications', certifications, '#0284c7', 'fas fa-certificate');
    
    // Groupement Homologation
    html += createGroupElement('homologation', 'Homologations', homologations, '#059669', 'fas fa-stamp');
    
    groupContainer.innerHTML = html;
    
    // Ajouter les événements pour les repilements/dépilements
    document.querySelectorAll('.group-header').forEach(header => {
        const groupId = header.getAttribute('data-group');
        header.addEventListener('click', () => toggleGroup(groupId));
    });
}

// Fonction pour créer un groupe
function createGroupElement(id, title, items, color, icon) {
    const isExpanded = expandedGroups[id];
    const itemCount = items.length;
    const now = new Date();
    
    // Statistiques du groupe
    const stats = {
        enCours: items.filter(r => r.status === 'En cours').length,
        expires: items.filter(r => r.status === 'Expiré').length,
        suspendus: items.filter(r => r.status === 'Suspendu').length,
        annules: items.filter(r => r.status === 'Annulé').length
    };
    
    return `
        <div class="registre-group" style="margin-bottom: 20px;">
            <div class="group-header" data-group="${id}" 
                 style="background: white; border-left: 4px solid ${color}; border-radius: 12px; padding: 20px; margin-bottom: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="background: ${color}; color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <i class="${icon}"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: ${color}; font-size: 18px;">${title}</h3>
                        <div style="font-size: 13px; color: #64748b; display: flex; gap: 15px; margin-top: 5px;">
                            <span><strong>${itemCount}</strong> registre(s)</span>
                            <span style="color: #0284c7;"><i class="fas fa-play-circle"></i> ${stats.enCours} en cours</span>
                            <span style="color: #dc2626;"><i class="fas fa-calendar-times"></i> ${stats.expires} expirés</span>
                            <span style="color: #f59e0b;"><i class="fas fa-pause-circle"></i> ${stats.suspendus} suspendus</span>
                            <span style="color: #6b7280;"><i class="fas fa-ban"></i> ${stats.annules} annulés</span>
                        </div>
                    </div>
                </div>
                <div>
                    <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}" style="color: ${color}; font-size: 18px;"></i>
                </div>
            </div>
            
            <div class="group-content" id="group-content-${id}" 
                 style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: ${isExpanded ? 'block' : 'none'};">
                ${items.length > 0 ? createGroupTable(items, id) : `
                    <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                        <i class="fas fa-inbox" style="font-size: 36px; margin-bottom: 10px; color: #cbd5e1;"></i>
                        <div>Aucun registre dans ce groupe</div>
                    </div>
                `}
            </div>
        </div>
    `;
}

// Fonction pour créer le tableau d'un groupe
function createGroupTable(items, groupId) {
    let html = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Référence</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Aérodrome</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Période</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Responsable</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Statut</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Délai</th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    items.forEach(registre => {
        // Calcul du statut de délai
        const delaiStatus = calculateDelaiStatus(registre);
        const delaiClass = delaiStatus === 'Dans les délais' ? 'delai-ok' : 
                         delaiStatus === 'En retard' ? 'delai-retard' : 'delai-normal';
        
        // Info sur l'aérodrome
        let aerodromeInfo = '';
        if (registre.aerodromeId) {
            const aerodrome = aerodromes?.find(a => a.id === registre.aerodromeId);
            if (aerodrome) {
                aerodromeInfo = `<div style="font-size: 12px; color: #64748b;">${aerodrome.code}</div><div style="font-size: 11px; color: #94a3b8;">${aerodrome.name.substring(0, 20)}${aerodrome.name.length > 20 ? '...' : ''}</div>`;
            }
        }
        
        // Vérifier si expiré
        const isExpired = registre.status !== 'Expiré' && new Date(registre.dateFin) < new Date();
        
        html += `
            <tr style="border-bottom: 1px solid #e2e8f0; ${isExpired ? 'background: #fef2f2;' : ''}">
                <td style="padding: 15px;">
                    <div style="font-weight: 700; color: #1e3a8a;">${registre.reference}</div>
                    ${registre.description ? `<div style="font-size: 12px; color: #64748b; margin-top: 4px;">${registre.description.substring(0, 40)}${registre.description.length > 40 ? '...' : ''}</div>` : ''}
                </td>
                <td style="padding: 15px;">
                    ${aerodromeInfo || '<div style="color: #94a3b8; font-style: italic;">Non associé</div>'}
                </td>
                <td style="padding: 15px;">
                    <div><strong>Début:</strong> ${new Date(registre.dateDebut).toLocaleDateString('fr-FR')}</div>
                    <div><strong>Fin:</strong> ${registre.dateFin ? new Date(registre.dateFin).toLocaleDateString('fr-FR') : 'Non définie'}</div>
                </td>
                <td style="padding: 15px;">
                    <div>${registre.responsable}</div>
                    <div style="font-size: 12px; color: #64748b;">${registre.service}</div>
                </td>
                <td style="padding: 15px;">
                    <span class="status-badge status-${registre.status.toLowerCase().replace('é', 'e')}">
                        ${registre.status}${isExpired ? ' (Expiré)' : ''}
                    </span>
                </td>
                <td style="padding: 15px;">
                    <span class="status-badge ${delaiClass}">
                        ${delaiStatus}
                    </span>
                </td>
                <td style="padding: 15px;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="viewRegistreDetails('${registre.id}')" title="Voir les détails">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${checkPermission('write') ? `
                        <button class="btn btn-info btn-sm" onclick="editRegistre('${registre.id}')" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                        ${registre.certificationId || registre.homologationId ? `
                        <button class="btn btn-success btn-sm" onclick="showProcessReport('${registre.id}')" title="Voir le rapport">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        ` : ''}
                        ${checkPermission('delete') ? `
                        <button class="btn btn-danger btn-sm" onclick="deleteRegistre('${registre.id}')" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    return html;
}

// Fonction pour basculer l'état d'un groupe
function toggleGroup(groupId) {
    expandedGroups[groupId] = !expandedGroups[groupId];
    const content = document.getElementById(`group-content-${groupId}`);
    const icon = document.querySelector(`[data-group="${groupId}"] .fas.fa-chevron-up, [data-group="${groupId}"] .fas.fa-chevron-down`);
    
    if (content) {
        content.style.display = expandedGroups[groupId] ? 'block' : 'none';
    }
    
    if (icon) {
        icon.className = expandedGroups[groupId] ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    }
}

// Fonction pour calculer le statut de délai
function calculateDelaiStatus(registre) {
    if (!registre.dateDebut || !registre.dateFin) return 'Non défini';
    
    const dateDebut = new Date(registre.dateDebut);
    const dateFin = new Date(registre.dateFin);
    const now = new Date();
    
    if (registre.status === 'Annulé' || registre.status === 'Suspendu') {
        return 'Suspendu';
    }
    
    if (registre.status === 'Expiré') {
        return 'Expiré';
    }
    
    if (registre.status === 'En cours') {
        // Vérifier si en retard
        const delaiAttendu = 30; // 30 jours pour traitement
        const joursEcoules = Math.ceil((now - dateDebut) / (1000 * 60 * 60 * 24));
        
        // Vérifier si proche de l'expiration
        const joursRestants = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));
        
        if (joursRestants < 0) {
            return 'Expiré';
        } else if (joursRestants <= 7) {
            return 'Échéance proche';
        } else if (joursEcoules > delaiAttendu) {
            return 'En retard';
        } else {
            return 'Dans les délais';
        }
    }
    
    return 'Non applicable';
}

// Fonction de tri des registres
function sortRegistres(field) {
    if (registresSortField === field) {
        registresSortDirection = registresSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        registresSortField = field;
        registresSortDirection = 'asc';
    }
    
    loadRegistres();
}

function sortRegistresList(list) {
    return list.sort((a, b) => {
        let aValue = a[registresSortField];
        let bValue = b[registresSortField];
        
        // Gestion des dates
        if (registresSortField.includes('date')) {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        }
        
        // Gestion des valeurs nulles
        if (!aValue && bValue) return registresSortDirection === 'asc' ? -1 : 1;
        if (aValue && !bValue) return registresSortDirection === 'asc' ? 1 : -1;
        if (!aValue && !bValue) return 0;
        
        // Comparaison
        if (aValue < bValue) return registresSortDirection === 'asc' ? -1 : 1;
        if (aValue > bValue) return registresSortDirection === 'asc' ? 1 : -1;
        return 0;
    });
}

// Fonctions de pagination
function changeRegistrePage(direction) {
    const totalItems = registres.length;
    const totalPages = Math.ceil(totalItems / registresPerPage);
    
    if (direction === 'prev' && registresCurrentPage > 1) {
        registresCurrentPage--;
    } else if (direction === 'next' && registresCurrentPage < totalPages) {
        registresCurrentPage++;
    }
    
    loadRegistres();
}

// Fonctions de filtrage
function initRegistreFilters() {
    const filterAerodrome = document.getElementById('filterRegistreAerodrome');
    if (filterAerodrome && filterAerodrome.options.length === 1) {
        // Ajouter les aérodromes
        aerodromes?.forEach(aerodrome => {
            const option = document.createElement('option');
            option.value = aerodrome.id;
            option.textContent = `${aerodrome.code} - ${aerodrome.name}`;
            filterAerodrome.appendChild(option);
        });
    }
}

function applyRegistreFilters() {
    const typeFilter = document.getElementById('filterRegistreType')?.value || '';
    const statusFilter = document.getElementById('filterRegistreStatus')?.value || '';
    const aerodromeFilter = document.getElementById('filterRegistreAerodrome')?.value || '';
    const periodFilter = document.getElementById('filterRegistrePeriod')?.value || '';
    
    let filtered = registres;
    
    // Filtre par type
    if (typeFilter) {
        filtered = filtered.filter(r => r.type === typeFilter);
    }
    
    // Filtre par statut
    if (statusFilter) {
        filtered = filtered.filter(r => r.status === statusFilter);
    }
    
    // Filtre par aérodrome
    if (aerodromeFilter) {
        filtered = filtered.filter(r => r.aerodromeId === aerodromeFilter);
    }
    
    // Filtre par période
    if (periodFilter) {
        const now = new Date();
        filtered = filtered.filter(r => {
            if (!r.dateDebut) return false;
            const dateDebut = new Date(r.dateDebut);
            const dateFin = new Date(r.dateFin);
            
            switch (periodFilter) {
                case 'current':
                    return r.status === 'En cours' || (dateDebut <= now && dateFin >= now);
                case 'past':
                    return dateFin < now || r.status === 'Expiré' || r.status === 'Annulé';
                case 'future':
                    return dateDebut > now;
                default:
                    return true;
            }
        });
    }
    
    // Réinitialiser la page à 1 lors du filtrage
    registresCurrentPage = 1;
    
    loadRegistres(filtered);
}

function resetRegistreFilters() {
    document.getElementById('filterRegistreType').value = '';
    document.getElementById('filterRegistreStatus').value = '';
    document.getElementById('filterRegistreAerodrome').value = '';
    document.getElementById('filterRegistrePeriod').value = '';
    
    registresCurrentPage = 1;
    loadRegistres();
}

// Fonctions de gestion des registres
function initRegistreModal() {
    document.getElementById('formRegistre').reset();
    document.getElementById('registreId').value = '';
    document.getElementById('registreVerificationInfo').style.display = 'none';
    document.getElementById('registreFileList').innerHTML = '';
    
    // Charger les aérodromes
    const aerodromeSelect = document.getElementById('registreAerodrome');
    aerodromeSelect.innerHTML = '<option value="">Sélectionner...</option>';
    
    aerodromes?.forEach(aerodrome => {
        const option = document.createElement('option');
        option.value = aerodrome.id;
        option.textContent = `${aerodrome.code} - ${aerodrome.name}`;
        aerodromeSelect.appendChild(option);
    });
    
    // Définir les dates par défaut
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('registreDateDebut').value = today;
    
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    document.getElementById('registreDateFin').value = nextMonth.toISOString().split('T')[0];
}

function saveRegistre() {
    const registreId = document.getElementById('registreId').value;
    const type = document.getElementById('registreType').value;
    const reference = document.getElementById('registreReference').value.trim();
    const dateDebut = document.getElementById('registreDateDebut').value;
    const dateFin = document.getElementById('registreDateFin').value;
    const responsable = document.getElementById('registreResponsable').value.trim();
    const service = document.getElementById('registreService').value;
    const description = document.getElementById('registreDescription').value.trim();
    const status = document.getElementById('registreStatus').value;
    const priority = document.getElementById('registrePriority').value;
    const aerodromeId = document.getElementById('registreAerodrome').value;
    
    // Validation
    if (!type || !reference || !dateDebut || !dateFin || !responsable || !service || !status) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'danger');
        return;
    }
    
    // Vérifier la date de fin
    if (new Date(dateFin) < new Date(dateDebut)) {
        showNotification('La date de fin ne peut pas être antérieure à la date de début', 'danger');
        return;
    }
    
    const registre = {
        id: registreId || generateId(),
        type,
        reference,
        dateDebut,
        dateFin,
        responsable,
        service,
        description,
        status,
        priority,
        aerodromeId: aerodromeId || null,
        dateCreation: new Date().toISOString().split('T')[0],
        createdBy: currentUser,
        certificationId: null,
        homologationId: null,
        files: registreFiles[registreId] || []
    };
    
    // Mettre à jour le statut si expiré
    const now = new Date();
    const dateFinObj = new Date(dateFin);
    if (dateFinObj < now && status === 'En cours') {
        registre.status = 'Expiré';
    }
    
    // Sauvegarder
    const index = registres.findIndex(r => r.id === registre.id);
    if (index !== -1) {
        registres[index] = registre;
    } else {
        registres.push(registre);
    }
    
    // Gestion des fichiers
    if (registreFiles[registre.id]) {
        registre.files = registreFiles[registre.id];
        delete registreFiles[registre.id];
    }
    
    saveToLocalStorage();
    loadRegistres();
    closeModal('modalRegistre');
    
    showNotification('Registre enregistré avec succès', 'success');
}

function editRegistre(id) {
    const reg = registres.find(r => r.id === id);
    if (!reg) return;
    
    document.getElementById('registreId').value = reg.id;
    document.getElementById('registreType').value = reg.type;
    document.getElementById('registreReference').value = reg.reference;
    document.getElementById('registreDateDebut').value = reg.dateDebut;
    document.getElementById('registreDateFin').value = reg.dateFin;
    document.getElementById('registreResponsable').value = reg.responsable;
    document.getElementById('registreService').value = reg.service;
    document.getElementById('registreDescription').value = reg.description || '';
    document.getElementById('registreStatus').value = reg.status;
    document.getElementById('registrePriority').value = reg.priority || 'Normal';
    document.getElementById('registreAerodrome').value = reg.aerodromeId || '';
    
    // Afficher les fichiers existants
    const fileList = document.getElementById('registreFileList');
    fileList.innerHTML = '';
    if (reg.files && reg.files.length > 0) {
        reg.files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${file.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${file.size}</div>
                </div>
                <button onclick="removeRegistreFile('${reg.id}', '${file.name}')" 
                        style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    document.getElementById('registreModalTitle').textContent = 'Modifier le Registre';
    openModal('modalRegistre');
}

function viewRegistreDetails(id) {
    const reg = registres.find(r => r.id === id);
    if (!reg) return;
    
    let details = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                <i class="fas fa-book"></i> Détails du Registre - ${reg.reference}
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                <div class="detail-card">
                    <div class="detail-label">Type de Registre</div>
                    <div class="detail-value">${reg.type}</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Statut</div>
                    <div class="detail-value"><span class="status-badge status-${reg.status.toLowerCase().replace('é', 'e')}">${reg.status}</span></div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Date Début</div>
                    <div class="detail-value">${new Date(reg.dateDebut).toLocaleDateString('fr-FR')}</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Date Fin</div>
                    <div class="detail-value">${new Date(reg.dateFin).toLocaleDateString('fr-FR')}</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Responsable</div>
                    <div class="detail-value">${reg.responsable}</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Service</div>
                    <div class="detail-value">${reg.service}</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Priorité</div>
                    <div class="detail-value">${reg.priority || 'Normal'}</div>
                </div>
                <div class="detail-card">
                    <div class="detail-label">Date de Création</div>
                    <div class="detail-value">${new Date(reg.dateCreation).toLocaleDateString('fr-FR')}</div>
                </div>
            </div>
            
            ${reg.description ? `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                        <i class="fas fa-align-left"></i> Description
                    </h4>
                    <p style="color: #334155; line-height: 1.6;">${reg.description}</p>
                </div>
            ` : ''}
            
            ${reg.files && reg.files.length > 0 ? `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #8b5cf6;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-paperclip"></i> Fichiers Associés (${reg.files.length})
                    </h4>
                    <div style="display: grid; gap: 10px;">
                        ${reg.files.map(file => `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 20px;"></i>
                                    <div>
                                        <div style="font-weight: 600;">${file.name}</div>
                                        <div style="font-size: 12px; color: #64748b;">${file.size || 'Taille inconnue'}</div>
                                    </div>
                                </div>
                                <button onclick="downloadFile('${file.name}')" 
                                        style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-download"></i> Télécharger
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                <button onclick="closeModal('modalCustom')" 
                        style="background: #f1f5f9; border: 2px solid #cbd5e1; color: #475569; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Fermer
                </button>
                ${checkPermission('write') ? `
                <button onclick="editRegistre('${reg.id}')" 
                        style="background: var(--primary-color); border: none; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-edit"></i> Modifier
                </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    openModal('modalCustom');
}

function deleteRegistre(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer ce registre ? Cette action est irréversible.')) {
        registres = registres.filter(r => r.id !== id);
        saveToLocalStorage();
        loadRegistres();
        showNotification('Registre supprimé avec succès', 'success');
    }
}

// Fonctions de gestion des fichiers
function triggerRegistreFileUpload() {
    document.getElementById('registreFileInput').click();
}

function handleRegistreFile(input) {
    const registreId = document.getElementById('registreId').value || 'new';
    const fileList = document.getElementById('registreFileList');
    
    if (input.files.length > 0) {
        const file = input.files[0];
        
        // Vérifier la taille (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showNotification('Le fichier ne doit pas dépasser 10MB', 'danger');
            return;
        }
        
        // Vérifier le type
        const allowedTypes = ['application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if (!allowedTypes.includes(file.type)) {
            showNotification('Seuls les fichiers PDF, Excel et Word sont autorisés', 'danger');
            return;
        }
        
        const fileData = {
            name: file.name,
            size: formatFileSize(file.size),
            type: file.type,
            lastModified: new Date(file.lastModified).toLocaleDateString('fr-FR')
        };
        
        // Ajouter au tableau des fichiers temporaires
        if (!registreFiles[registreId]) {
            registreFiles[registreId] = [];
        }
        registreFiles[registreId].push(fileData);
        
        // Afficher dans la liste
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${formatFileSize(file.size)}</div>
            </div>
            <button onclick="removeRegistreFile('${registreId}', '${file.name}')" 
                    style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
        
        showNotification('Fichier ajouté avec succès', 'success');
    }
}

function removeRegistreFile(registreId, fileName) {
    if (registreFiles[registreId]) {
        registreFiles[registreId] = registreFiles[registreId].filter(f => f.name !== fileName);
    }
    
    // Mettre à jour l'affichage
    const fileList = document.getElementById('registreFileList');
    fileList.innerHTML = '';
    
    if (registreFiles[registreId]) {
        registreFiles[registreId].forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${file.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${file.size}</div>
                </div>
                <button onclick="removeRegistreFile('${registreId}', '${file.name}')" 
                        style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    showNotification('Fichier supprimé', 'info');
}

// Fonctions de vérification
function updateRegistreAerodromeInfo(aerodromeId) {
    const processType = document.getElementById('registreProcessType').value;
    if (!aerodromeId || !processType) return;
    
    const verificationDiv = document.getElementById('registreVerificationInfo');
    const requirementsList = document.getElementById('registreRequirementsList');
    
    verificationDiv.style.display = 'block';
    
    let requirements = [];
    
    if (processType === 'certification') {
        const certification = certifications?.find(c => 
            c.aerodromeId === aerodromeId && 
            c.status === 'Terminée'
        );
        
        if (certification) {
            requirements.push(`<div style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Certification trouvée: ${certification.reference || certification.id}</div>`);
            
            // Vérifier si la certification est complète
            if (isCertificationComplete(certification.id)) {
                requirements.push('<div style="color: var(--success-color);"><strong>✓ Certification complète et valide</strong></div>');
            } else {
                requirements.push('<div style="color: var(--danger-color);"><strong>✗ Certification incomplète</strong></div>');
            }
        } else {
            requirements.push('<div style="color: var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Aucune certification terminée trouvée</div>');
        }
        
    } else if (processType === 'homologation') {
        const homologation = homologations?.find(h => 
            h.aerodromeId === aerodromeId && 
            h.status === 'Approuvée'
        );
        
        if (homologation) {
            requirements.push(`<div style="color: var(--success-color);"><i class="fas fa-check-circle"></i> Homologation trouvée: ${homologation.numero || homologation.id}</div>`);
            
            // Vérifier si l'homologation est complète
            if (isHomologationComplete(homologation.id)) {
                requirements.push('<div style="color: var(--success-color);"><strong>✓ Homologation complète et valide</strong></div>');
            } else {
                requirements.push('<div style="color: var(--danger-color);"><strong>✗ Homologation incomplète</strong></div>');
            }
        } else {
            requirements.push('<div style="color: var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Aucune homologation approuvée trouvée</div>');
        }
    }
    
    requirementsList.innerHTML = requirements.join('');
}

function updateRegistreRequirements() {
    const aerodromeId = document.getElementById('registreAerodrome').value;
    if (aerodromeId) {
        updateRegistreAerodromeInfo(aerodromeId);
    }
}

// Fonctions d'export et de rapport
function exportRegistres() {
    const filtered = getFilteredRegistres();
    
    // Créer le contenu CSV
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Type,Référence,Date Début,Date Fin,Responsable,Service,Statut,Priorité,Aérodrome\n";
    
    filtered.forEach(registre => {
        const aerodrome = aerodromes?.find(a => a.id === registre.aerodromeId);
        const aerodromeName = aerodrome ? `${aerodrome.code} - ${aerodrome.name}` : 'Non associé';
        
        csvContent += `"${registre.type}","${registre.reference}","${registre.dateDebut}","${registre.dateFin}","${registre.responsable}","${registre.service}","${registre.status}","${registre.priority || 'Normal'}","${aerodromeName}"\n`;
    });
    
    // Télécharger le fichier
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `registres_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Export réalisé avec succès', 'success');
}

function generateReport() {
    showNotification('Génération du rapport en cours...', 'info');
    
    setTimeout(() => {
        const reportData = {
            date: new Date().toLocaleDateString('fr-FR'),
            totalRegistres: registres.length,
            enCours: registres.filter(r => r.status === 'En cours').length,
            expires: registres.filter(r => r.status === 'Expiré').length,
            suspendus: registres.filter(r => r.status === 'Suspendu').length,
            annules: registres.filter(r => r.status === 'Annulé').length,
            parType: {
                Certification: registres.filter(r => r.type === 'Certification').length,
                Homologation: registres.filter(r => r.type === 'Homologation').length
            },
            parService: {}
        };
        
        // Calcul par service
        registres.forEach(registre => {
            if (!reportData.parService[registre.service]) {
                reportData.parService[registre.service] = 0;
            }
            reportData.parService[registre.service]++;
        });
        
        // Afficher le rapport
        showReportModal(reportData);
        
        showNotification('Rapport généré avec succès!', 'success');
    }, 1500);
}

function showReportModal(reportData) {
    let reportHTML = `
        <div style="max-width: 800px; margin: 0 auto;">
            <h3 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                <i class="fas fa-chart-bar"></i> Rapport des Registres
            </h3>
            
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #1e3a8a;">
                        <div style="font-size: 12px; color: #64748b; font-weight: 600;">TOTAL REGISTRES</div>
                        <div style="font-size: 24px; font-weight: 800; color: #1e293b;">${reportData.totalRegistres}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <div style="font-size: 12px; color: #64748b; font-weight: 600;">EN COURS</div>
                        <div style="font-size: 24px; font-weight: 800; color: #1e293b;">${reportData.enCours}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="font-size: 12px; color: #64748b; font-weight: 600;">EXPIRÉS</div>
                        <div style="font-size: 24px; font-weight: 800; color: #1e293b;">${reportData.expires}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 12px; color: #64748b; font-weight: 600;">SUSPENDUS</div>
                        <div style="font-size: 24px; font-weight: 800; color: #1e293b;">${reportData.suspendus}</div>
                    </div>
                </div>
                
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Répartition par Type</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span>Certification</span>
                        <span style="background: #0284c7; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600;">${reportData.parType.Certification || 0}</span>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span>Homologation</span>
                        <span style="background: #059669; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600;">${reportData.parType.Homologation || 0}</span>
                    </div>
                </div>
                
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Répartition par Service</h4>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    ${Object.entries(reportData.parService).map(([service, count]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                            <span>${service}</span>
                            <span style="font-weight: 600;">${count}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeModal('modalCustom')" 
                        style="background: #f1f5f9; border: 2px solid #cbd5e1; color: #475569; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Fermer
                </button>
                <button onclick="printReport()" 
                        style="background: var(--primary-color); border: none; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-print"></i> Imprimer
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = reportHTML;
    openModal('modalCustom');
}

function getFilteredRegistres() {
    const typeFilter = document.getElementById('filterRegistreType')?.value || '';
    const statusFilter = document.getElementById('filterRegistreStatus')?.value || '';
    const aerodromeFilter = document.getElementById('filterRegistreAerodrome')?.value || '';
    const periodFilter = document.getElementById('filterRegistrePeriod')?.value || '';
    
    let filtered = registres;
    
    if (typeFilter) filtered = filtered.filter(r => r.type === typeFilter);
    if (statusFilter) filtered = filtered.filter(r => r.status === statusFilter);
    if (aerodromeFilter) filtered = filtered.filter(r => r.aerodromeId === aerodromeFilter);
    
    if (periodFilter) {
        const now = new Date();
        filtered = filtered.filter(r => {
            if (!r.dateDebut) return false;
            const dateDebut = new Date(r.dateDebut);
            const dateFin = new Date(r.dateFin);
            
            switch (periodFilter) {
                case 'current': return r.status === 'En cours' || (dateDebut <= now && dateFin >= now);
                case 'past': return dateFin < now || r.status === 'Expiré' || r.status === 'Annulé';
                case 'future': return dateDebut > now;
                default: return true;
            }
        });
    }
    
    return filtered;
}

// Fonction utilitaire pour formater la taille des fichiers
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ============ FONCTIONS POUR PLANS D'ACTIONS ============

// Initialiser le modal
function initPlanActionModal() {
    document.getElementById('planActionId').value = '';
    document.getElementById('planActionReference').value = '';
    document.getElementById('planActionAerodrome').value = '';
    document.getElementById('planActionDescription').value = '';
    document.getElementById('planActionRiskLevel').value = '';
    document.getElementById('planActionEmissionDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('planActionItems').innerHTML = '';
    
    // Champs cachés pour compatibilité
    document.getElementById('planActionTitle').value = '';
    document.getElementById('planActionStartDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('planActionDeadline').value = '';
    document.getElementById('planActionResponsible').value = '';
    document.getElementById('planActionStatus').value = 'Nouveau';
    
    updateAerodromeSelects();
    updatePlanActionFilters();
    loadClosedPlansSelector();
}

// Mettre à jour les selects de filtres
function updatePlanActionFilters() {
    const aerodromeFilter = document.getElementById('filterPlanActionAerodrome');
    if (aerodromeFilter && typeof aerodromes !== 'undefined') {
        aerodromeFilter.innerHTML = '<option value="">Tous les aérodromes</option>' +
            aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
    }
}

// Calculer les statistiques
function updatePlanActionStats(filteredPlans = null) {
    const plans = filteredPlans || plansActions;
    
    const total = plans.length;
    const enCours = plans.filter(p => p.status === 'En cours').length;
    const clotures = plans.filter(p => p.status === 'Clôturé').length;
    
    let totalActions = 0;
    let totalTaux = 0;
    let risquesCritiques = 0;
    
    plans.forEach(p => {
        if (p.actions) {
            totalActions += p.actions.length;
            p.actions.forEach(a => {
                totalTaux += (a.taux || 0);
            });
        }
        if (p.riskLevel === 'Critique') risquesCritiques++;
    });
    
    const tauxMoyen = totalActions > 0 ? Math.round(totalTaux / totalActions) : 0;
    
    document.getElementById('stat-plans-total').textContent = total;
    document.getElementById('stat-plans-encours').textContent = enCours;
    document.getElementById('stat-plans-clotures').textContent = clotures;
    document.getElementById('stat-actions-total').textContent = totalActions;
    document.getElementById('stat-taux-moyen').textContent = tauxMoyen + '%';
    document.getElementById('stat-risque-critique').textContent = risquesCritiques;
}

// Filtrer les plans d'actions
function filterPlansActions() {
    const aerodromeId = document.getElementById('filterPlanActionAerodrome')?.value || '';
    const status = document.getElementById('filterPlanActionStatus')?.value || '';
    const risk = document.getElementById('filterPlanActionRisk')?.value || '';
    const period = document.getElementById('filterPlanActionPeriod')?.value || '';
    const dateStart = document.getElementById('filterPlanActionDateStart')?.value || '';
    const dateEnd = document.getElementById('filterPlanActionDateEnd')?.value || '';
    const search = document.getElementById('searchPlanActionKeyword')?.value.toLowerCase() || '';
    
    // Afficher/masquer les dates personnalisées
    const customDateRow = document.getElementById('customDateRow');
    if (customDateRow) {
        customDateRow.style.display = period === 'custom' ? 'grid' : 'none';
    }
    
    let filtered = [...plansActions];
    
    // Filtre par aérodrome
    if (aerodromeId) {
        filtered = filtered.filter(p => p.aerodromeId === aerodromeId);
    }
    
    // Filtre par statut
    if (status) {
        filtered = filtered.filter(p => p.status === status);
    }
    
    // Filtre par niveau de risque
    if (risk) {
        filtered = filtered.filter(p => p.riskLevel === risk);
    }
    
    // Filtre par période
    if (period && period !== 'custom') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        filtered = filtered.filter(p => {
            const planDate = new Date(p.emissionDate || p.startDate);
            
            if (period === 'today') {
                return planDate >= today;
            } else if (period === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                return planDate >= weekAgo;
            } else if (period === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                return planDate >= monthAgo;
            }
            return true;
        });
    }
    
    // Filtre par dates personnalisées
    if (period === 'custom' && (dateStart || dateEnd)) {
        filtered = filtered.filter(p => {
            const planDate = new Date(p.emissionDate || p.startDate);
            if (dateStart && planDate < new Date(dateStart)) return false;
            if (dateEnd && planDate > new Date(dateEnd)) return false;
            return true;
        });
    }
    
    // Recherche par mot-clé
    if (search) {
        filtered = filtered.filter(p => {
            const aerodrome = aerodromes.find(a => a.id === p.aerodromeId);
            const searchText = `
                ${p.reference || ''} 
                ${p.title || ''} 
                ${p.description || ''}
                ${aerodrome?.code || ''} 
                ${aerodrome?.name || ''}
            `.toLowerCase();
            return searchText.includes(search);
        });
    }
    
    // Mettre à jour l'affichage selon le mode de vue
    if (currentViewMode === 'grouped') {
        loadPlansActionsGrouped(filtered);
    } else {
        loadPlansActionsGrid(filtered);
    }
    
    updatePlanActionStats(filtered);
    
    // Mettre à jour le compteur
    const countElement = document.getElementById('planActionCount');
    if (countElement) {
        countElement.textContent = `${filtered.length} résultat(s)`;
    }
}

// Réinitialiser les filtres
function resetPlanActionFilters() {
    if (document.getElementById('filterPlanActionAerodrome')) 
        document.getElementById('filterPlanActionAerodrome').value = '';
    if (document.getElementById('filterPlanActionStatus')) 
        document.getElementById('filterPlanActionStatus').value = '';
    if (document.getElementById('filterPlanActionRisk')) 
        document.getElementById('filterPlanActionRisk').value = '';
    if (document.getElementById('filterPlanActionPeriod')) 
        document.getElementById('filterPlanActionPeriod').value = '';
    if (document.getElementById('filterPlanActionDateStart')) 
        document.getElementById('filterPlanActionDateStart').value = '';
    if (document.getElementById('filterPlanActionDateEnd')) 
        document.getElementById('filterPlanActionDateEnd').value = '';
    if (document.getElementById('searchPlanActionKeyword')) 
        document.getElementById('searchPlanActionKeyword').value = '';
    
    const customDateRow = document.getElementById('customDateRow');
    if (customDateRow) customDateRow.style.display = 'none';
    
    if (currentViewMode === 'grouped') {
        loadPlansActionsGrouped();
    } else {
        loadPlansActionsGrouped();
    }
    
    updatePlanActionStats();
    
    const countElement = document.getElementById('planActionCount');
    if (countElement) {
        countElement.textContent = `${plansActions.length} résultat(s)`;
    }
}

// Trier les plans d'actions
function sortPlansActions(field, direction = 'asc') {
    const sorted = [...plansActions].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'date') {
            aVal = new Date(a.emissionDate || a.startDate);
            bVal = new Date(b.emissionDate || b.startDate);
        } else if (field === 'risk') {
            const riskOrder = { 'Critique': 4, 'Élevé': 3, 'Moyen': 2, 'Faible': 1 };
            aVal = riskOrder[a.riskLevel] || 0;
            bVal = riskOrder[b.riskLevel] || 0;
        } else {
            aVal = a[field] || '';
            bVal = b[field] || '';
        }
        
        return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    
    if (currentViewMode === 'grouped') {
        loadPlansActionsGrouped(sorted);
    } else {
        loadPlansActionsGrid(sorted);
    }
}

// Changer le mode d'affichage
function switchViewMode(mode) {
    currentViewMode = mode;
    
    // Mettre à jour les boutons
    document.querySelectorAll('.view-toggle button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[onclick="switchViewMode('${mode}')"]`).classList.add('active');
    
    filterPlansActions();
}

function loadPlansActionsGrouped(filteredList = null) {
    const container = document.getElementById('plansActionsList');
    if (!container) return;
    
    // Réinitialiser le style du container
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '20px';
    container.style.width = '100%';
    container.style.padding = '20px';
    
    let list = filteredList || plansActions || [];
    
    // CALCUL DES STATISTIQUES POUR LE TABLEAU DE BORD
    const stats = {
        total: list.length,
        parAerodrome: {},
        enCours: list.filter(p => {
            const actions = p.actions || [];
            const toutesTerminees = actions.length > 0 && actions.every(a => a.taux === 100);
            const toutesNonCommencees = actions.length > 0 && actions.every(a => a.taux === 0);
            return !toutesTerminees && !toutesNonCommencees;
        }).length,
        termines: list.filter(p => {
            const actions = p.actions || [];
            return actions.length > 0 && actions.every(a => a.taux === 100);
        }).length,
        enAttente: list.filter(p => {
            const actions = p.actions || [];
            return actions.length > 0 && actions.every(a => a.taux === 0);
        }).length,
        critiques: list.filter(p => p.riskLevel === 'Critique').length,
        eleves: list.filter(p => p.riskLevel === 'Élevé').length,
        enRetard: list.filter(p => {
            const actions = p.actions || [];
            return actions.some(a => a.deadline && new Date(a.deadline) < new Date() && a.taux < 100);
        }).length
    };

    // Calcul par aérodrome
    aerodromes.forEach(aero => {
        const count = list.filter(p => String(p.aerodromeId) === String(aero.id)).length;
        if (count > 0) {
            stats.parAerodrome[aero.code] = count;
        }
    });

    // Taux de mise en œuvre
    const totalActions = list.reduce((sum, p) => sum + (p.actions?.length || 0), 0);
    const actionsTerminees = list.reduce((sum, p) => sum + (p.actions?.filter(a => a.taux === 100).length || 0), 0);
    const tauxMiseEnOeuvre = totalActions > 0 ? Math.round((actionsTerminees / totalActions) * 100) : 0;

    // Construire le HTML
    let html = '';

    // 1. TABLEAU DE BORD
    html += `
        <div style="width: 100%; background: white; border-radius: 10px; padding: 20px 25px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08);">
            <div style="display: flex; flex-wrap: nowrap; gap: 15px; width: 100%;">
                <!-- Carte Total PAC -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #ef4444; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(239, 68, 68, 0.25);">
                            <i class="fas fa-clipboard-check" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Total PAC</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.total}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte En Cours -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #0284c7; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #0284c7 0%, #38bdf8 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(2, 132, 199, 0.25);">
                            <i class="fas fa-sync-alt fa-spin" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Cours</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enCours}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte En Retard -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #f59e0b; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25);">
                            <i class="fas fa-exclamation-triangle" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">En Retard</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${stats.enRetard}</div>
                        </div>
                    </div>
                </div>

                <!-- Carte Taux de Mise en Œuvre -->
                <div style="flex: 1 1 0; min-width: 0; background: white; border-left: 3px solid #10b981; padding: 14px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 8px rgba(16, 185, 129, 0.25);">
                            <i class="fas fa-chart-line" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="min-width: 0; overflow: hidden;">
                            <div style="font-size: 10px; color: #64748b; font-weight: 600; text-transform: uppercase; white-space: nowrap; letter-spacing: 0.5px;">Mise en Œuvre</div>
                            <div style="font-size: 26px; font-weight: 800; color: #0f172a; line-height: 1;">${tauxMiseEnOeuvre}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 2. SECTION FILTRES
    html += `
        <div style="width: 100%; background: white; border-left: 4px solid #ef4444; border-radius: 10px; padding: 20px 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <!-- Filtre Aérodrome -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-plane-departure" style="color: #ef4444; font-size: 14px;"></i>
                        Aérodrome
                    </label>
                    <select id="filterPlanActionAerodrome" onchange="applyPlanActionFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les aérodromes</option>
                        ${aerodromes.map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('')}
                    </select>
                </div>

                <!-- Filtre Niveau de Risque -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-radiation" style="color: #f59e0b; font-size: 14px;"></i>
                        Niveau de Risque
                    </label>
                    <select id="filterPlanActionRisk" onchange="applyPlanActionFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les niveaux</option>
                        <option value="Critique">Critique</option>
                        <option value="Élevé">Élevé</option>
                        <option value="Moyen">Moyen</option>
                        <option value="Faible">Faible</option>
                    </select>
                </div>

                <!-- Filtre État -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                        <i class="fas fa-tasks" style="color: #0284c7; font-size: 14px;"></i>
                        État de Mise en Œuvre
                    </label>
                    <select id="filterPlanActionStatus" onchange="applyPlanActionFilters()" 
                            style="width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #1e293b; background: white; cursor: pointer; transition: all 0.3s;">
                        <option value="">Tous les états</option>
                        <option value="en-attente">En attente (0%)</option>
                        <option value="en-cours">En cours (1-99%)</option>
                        <option value="termine">Terminé (100%)</option>
                        <option value="en-retard">En retard</option>
                    </select>
                </div>

                <!-- Bouton Réinitialiser -->
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="resetPlanActionFilters()" 
                            style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border: none; color: white; padding: 11px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.25); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-redo-alt" style="font-size: 13px;"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    `;

    // Vérifier si on a des données
    if (list.length === 0) {
        html += `
            <div style="width: 100%; text-align: center; padding: 60px; color: #94a3b8; background: #f8fafc; border-radius: 20px; border: 2px dashed #e2e8f0;">
                <i class="fas fa-clipboard-list" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3 style="font-size: 20px; font-weight: 600;">Aucun plan d'action trouvé</h3>
                <p>Modifiez vos filtres ou créez un nouveau plan.</p>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    // 3. EN-TÊTE
    html += `
        <div style="width: 100%; background: linear-gradient(135deg, #ef4444, #dc2626); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700;"><i class="fas fa-clipboard-check"></i> Plans d'Actions Correctives</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 14px;">Total : ${list.length} plan(s) d'action • ${stats.critiques} critique(s) • ${stats.eleves} élevé(s)</p>
                </div>
                <button onclick="openModal('modalPlanAction')" class="btn" 
                        style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s;">
                    <i class="fas fa-plus-circle" style="font-size: 16px;"></i>
                    Nouveau Plan d'Action
                </button>
            </div>
        </div>
    `;

    // 4. GROUPES PAR AÉRODROME
    const grouped = list.reduce((acc, p) => {
        if (!acc[p.aerodromeId]) acc[p.aerodromeId] = [];
        acc[p.aerodromeId].push(p);
        return acc;
    }, {});

    html += Object.entries(grouped).map(([aeroId, plans], index) => {
        const aero = aerodromes.find(a => String(a.id) === String(aeroId));
        const contentId = `planaction-aero-content-${aeroId}`;
        const iconId = `planaction-aero-icon-${aeroId}`;
        const isFirstGroup = index === 0;
        
        // Statistiques pour cet aérodrome
        const statsAero = {
            total: plans.length,
            critiques: plans.filter(p => p.riskLevel === 'Critique').length,
            eleves: plans.filter(p => p.riskLevel === 'Élevé').length,
            enRetard: plans.filter(p => {
                const actions = p.actions || [];
                return actions.some(a => a.deadline && new Date(a.deadline) < new Date() && a.taux < 100);
            }).length,
            tauxMiseEnOeuvre: 0
        };

        const totalActionsAero = plans.reduce((sum, p) => sum + (p.actions?.length || 0), 0);
        const actionsTermineesAero = plans.reduce((sum, p) => sum + (p.actions?.filter(a => a.taux === 100).length || 0), 0);
        if (totalActionsAero > 0) {
            statsAero.tauxMiseEnOeuvre = Math.round((actionsTermineesAero / totalActionsAero) * 100);
        }

        return `
            <div style="width: 100%; border: 1px solid #e2e8f0; border-radius: 14px; overflow: hidden; background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <div onclick="togglePlanActionAeroGroup('${aeroId}')" 
                     style="background: linear-gradient(135deg, #dc2626, #ef4444); color: white; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 20px; flex: 1;">
                        <div style="background: rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 16px; border: 1px solid rgba(255,255,255,0.3);">
                            ${aero?.code || 'AD'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${aero?.name || 'Aérodrome Inconnu'}</h4>
                            <div style="font-size: 13px; opacity: 0.9; margin-top: 2px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <span><i class="fas fa-file-alt"></i> ${statsAero.total} plan(s)</span>
                                <span><i class="fas fa-tasks"></i> ${statsAero.tauxMiseEnOeuvre}% réalisé</span>
                                ${statsAero.critiques > 0 ? `<span style="color: #fecaca; font-weight: 800;"><i class="fas fa-radiation"></i> ${statsAero.critiques} critique(s)</span>` : ''}
                                ${statsAero.eleves > 0 && statsAero.critiques === 0 ? `<span style="color: #fed7aa; font-weight: 800;"><i class="fas fa-exclamation-triangle"></i> ${statsAero.eleves} élevé(s)</span>` : ''}
                                ${statsAero.enRetard > 0 ? `<span style="color: #fef3c7; font-weight: 800;"><i class="fas fa-clock"></i> ${statsAero.enRetard} en retard</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span class="badge" style="background: rgba(255,255,255,0.25); font-size: 13px; padding: 6px 12px; font-weight: 600;">${plans.length} dossier(s)</span>
                        <i class="fas fa-chevron-down" id="${iconId}" style="transition: transform 0.3s ease; font-size: 1.2em; ${isFirstGroup ? 'transform: rotate(180deg);' : ''}"></i>
                    </div>
                </div>

                <div id="${contentId}" class="planaction-group-content ${isFirstGroup ? 'expanded' : 'collapsed'}" style="${isFirstGroup ? 'display: block;' : 'display: none;'} padding: 25px; background: #f8fafc; border-top: 1px solid #e2e8f0; transition: all 0.3s ease-in-out;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
                        ${plans.map(p => renderPlanCard(p)).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

function renderPlanCard(plan) {
    // Trouver l'aérodrome correspondant
    const aero = aerodromes.find(a => String(a.id) === String(plan.aerodromeId));
    
    // Calculer le taux de réalisation global du plan
    const actions = plan.actions || [];
    const totalTaux = actions.reduce((sum, a) => sum + (a.taux || 0), 0);
    const tauxMoyen = actions.length > 0 ? Math.round(totalTaux / actions.length) : 0;
    
    // Vérifier si des actions sont en retard
    const hasLateActions = actions.some(a => {
        if (!a.deadline) return false;
        const deadline = new Date(a.deadline);
        const today = new Date();
        return deadline < today && a.taux < 100;
    });
    
    // Déterminer le statut global
    let status = 'En attente';
    let statusColor = '#94a3b8';
    let statusIcon = 'fa-clock';
    
    if (actions.length === 0) {
        status = 'Aucune action';
        statusColor = '#94a3b8';
        statusIcon = 'fa-ban';
    } else if (actions.every(a => a.taux === 100)) {
        status = 'Terminé';
        statusColor = '#10b981';
        statusIcon = 'fa-check-circle';
    } else if (actions.some(a => a.taux > 0 && a.taux < 100)) {
        status = 'En cours';
        statusColor = '#0284c7';
        statusIcon = 'fa-sync-alt fa-spin';
    } else if (hasLateActions) {
        status = 'En retard';
        statusColor = '#f59e0b';
        statusIcon = 'fa-exclamation-triangle';
    } else if (actions.every(a => a.taux === 0)) {
        status = 'Non commencé';
        statusColor = '#ef4444';
        statusIcon = 'fa-times-circle';
    }
    
    // Couleur du niveau de risque
    const riskColors = {
        'Critique': '#ef4444',
        'Élevé': '#f59e0b',
        'Moyen': '#3b82f6',
        'Faible': '#10b981'
    };
    
    const riskColor = riskColors[plan.riskLevel] || '#94a3b8';
    
    // Format date
    const formatDate = (dateStr) => {
        if (!dateStr) return 'Non définie';
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        } catch {
            return 'Date invalide';
        }
    };
    
    return `
        <div class="plan-card" data-plan-id="${plan.id}" 
             style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; transition: all 0.3s ease; cursor: pointer;"
             onclick="openPlanActionDetail('${plan.id}')">
            
            <!-- En-tête avec risque -->
            <div style="background: linear-gradient(135deg, ${riskColor}20, ${riskColor}10); padding: 18px; border-bottom: 2px solid ${riskColor}30;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div style="flex: 1; min-width: 0;">
                        <h5 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${plan.reference || 'PAC-' + plan.id}
                        </h5>
                        <p style="margin: 0; font-size: 13px; color: #475569; opacity: 0.9;">
                            ${plan.title || 'Plan sans titre'}
                        </p>
                    </div>
                    <span style="background: ${riskColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">
                        ${plan.riskLevel || 'Non défini'}
                    </span>
                </div>
                
                <!-- Barre de progression -->
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Progression</span>
                        <span style="font-size: 14px; font-weight: 800; color: #0f172a;">${tauxMoyen}%</span>
                    </div>
                    <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, ${riskColor}, ${riskColor}80); height: 100%; width: ${tauxMoyen}%; border-radius: 4px; transition: width 0.5s ease;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Corps de la carte -->
            <div style="padding: 18px;">
                <!-- Informations -->
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 18px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #f8fafc; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #ef4444;">
                            <i class="fas fa-plane-departure" style="font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;">Aérodrome</div>
                            <div style="font-size: 14px; font-weight: 700; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${aero?.code || 'AD'} - ${aero?.name || 'Inconnu'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #f8fafc; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: ${statusColor};">
                            <i class="fas ${statusIcon}" style="font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;">Statut</div>
                            <div style="font-size: 14px; font-weight: 700; color: ${statusColor};">${status}</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: #f8fafc; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #8b5cf6;">
                            <i class="fas fa-calendar-alt" style="font-size: 14px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 2px;">Création</div>
                            <div style="font-size: 14px; font-weight: 700; color: #0f172a;">${formatDate(plan.creationDate)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="border-top: 1px solid #e2e8f0; padding-top: 14px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 12px; font-weight: 700; color: #475569; text-transform: uppercase;">
                            <i class="fas fa-tasks" style="margin-right: 6px;"></i>
                            Actions (${actions.length})
                        </div>
                        ${hasLateActions ? 
                            `<span style="font-size: 11px; color: #f59e0b; font-weight: 800;">
                                <i class="fas fa-exclamation-triangle"></i> En retard
                            </span>` : ''
                        }
                    </div>
                    
                    ${actions.slice(0, 3).map(action => `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 13px; font-weight: 600; color: #334155; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${action.title || 'Action sans titre'}
                                </div>
                                <div style="font-size: 11px; color: #64748b; display: flex; justify-content: space-between;">
                                    <span>${formatDate(action.deadline)}</span>
                                    <span style="font-weight: 700; color: ${action.taux === 100 ? '#10b981' : action.taux > 0 ? '#0284c7' : '#ef4444'}">${action.taux || 0}%</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    
                    ${actions.length > 3 ? `
                        <div style="text-align: center; padding: 10px 0; color: #64748b; font-size: 12px; font-weight: 600;">
                            + ${actions.length - 3} autre(s) action(s)
                        </div>
                    ` : ''}
                    
                    ${actions.length === 0 ? `
                        <div style="text-align: center; padding: 15px 0; color: #94a3b8; font-size: 13px;">
                            <i class="fas fa-clipboard-list" style="margin-right: 8px;"></i>
                            Aucune action définie
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- Footer avec bouton -->
            <div style="background: #f8fafc; padding: 15px 18px; border-top: 1px solid #e2e8f0; text-align: right;">
                <button onclick="event.stopPropagation(); openPlanActionDetail('${plan.id}')" 
                        style="background: linear-gradient(135deg, ${riskColor}, ${riskColor}80); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fas fa-eye" style="font-size: 13px;"></i>
                    Consulter
                </button>
            </div>
        </div>
    `;
}

function applyPlanActionFilters() {
    const aerodromeFilter = document.getElementById('filterPlanActionAerodrome')?.value;
    const riskFilter = document.getElementById('filterPlanActionRisk')?.value;
    const statusFilter = document.getElementById('filterPlanActionStatus')?.value;
    
    let filtered = [...plansActions];
    
    // Filtre par aérodrome
    if (aerodromeFilter) {
        filtered = filtered.filter(p => String(p.aerodromeId) === String(aerodromeFilter));
    }
    
    // Filtre par niveau de risque
    if (riskFilter) {
        filtered = filtered.filter(p => p.riskLevel === riskFilter);
    }
    
    // Filtre par état de mise en œuvre
    if (statusFilter) {
        filtered = filtered.filter(p => {
            const actions = p.actions || [];
            
            switch(statusFilter) {
                case 'en-attente':
                    // Toutes les actions à 0%
                    return actions.length > 0 && actions.every(a => a.taux === 0);
                case 'en-cours':
                    // Au moins une action entre 1% et 99%
                    return actions.some(a => a.taux > 0 && a.taux < 100);
                case 'termine':
                    // Toutes les actions à 100%
                    return actions.length > 0 && actions.every(a => a.taux === 100);
                case 'en-retard':
                    // Au moins une action en retard
                    return actions.some(a => a.deadline && new Date(a.deadline) < new Date() && a.taux < 100);
                default:
                    return true;
            }
        });
    }
    
    loadPlansActionsGrouped(filtered);
}

function resetPlanActionFilters() {
    document.getElementById('filterPlanActionAerodrome').value = '';
    document.getElementById('filterPlanActionRisk').value = '';
    document.getElementById('filterPlanActionStatus').value = '';
    loadPlansActionsGrouped();
}

function togglePlanActionAeroGroup(aeroId) {
    console.log('Toggling group for aeroId:', aeroId); // Debug
    
    const contentId = `planaction-aero-content-${aeroId}`;
    const iconId = `planaction-aero-icon-${aeroId}`;
    
    const content = document.getElementById(contentId);
    const icon = document.getElementById(iconId);
    
    if (!content) {
        console.error(`Élément non trouvé: ${contentId}`);
        return;
    }
    
    if (!icon) {
        console.error(`Élément non trouvé: ${iconId}`);
        return;
    }
    
    // Toggle l'affichage
    if (content.style.display === 'none' || content.classList.contains('collapsed')) {
        // Ouvrir
        content.style.display = 'block';
        content.classList.remove('collapsed');
        content.classList.add('expanded');
        icon.style.transform = 'rotate(180deg)';
    } else {
        // Fermer
        content.style.display = 'none';
        content.classList.remove('expanded');
        content.classList.add('collapsed');
        icon.style.transform = 'rotate(0deg)';
    }
}


function savePlanAction() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const reference = document.getElementById('planActionReference').value;
    const aerodromeId = document.getElementById('planActionAerodrome').value;
    const description = document.getElementById('planActionDescription').value;
    const riskLevel = document.getElementById('planActionRiskLevel').value;
    const emissionDate = document.getElementById('planActionEmissionDate').value;
    
    if (!reference || !aerodromeId || !description || !riskLevel || !emissionDate) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    // Collecter les actions
    const actions = [];
    const actionElements = document.querySelectorAll('#planActionItems .action-item');
    
    if (actionElements.length === 0) {
        showNotification('Veuillez ajouter au moins une action corrective', 'error');
        return;
    }
    
    let hasError = false;
    
    actionElements.forEach((actionEl, index) => {
        const actionId = actionEl.querySelector('.action-id')?.value || 'action-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const startDate = actionEl.querySelector('.action-start-date')?.value;
        const deadline = actionEl.querySelector('.action-deadline')?.value;
        const descriptionAction = actionEl.querySelector('.action-description')?.value;
        const taux = actionEl.querySelector('.action-taux')?.value;
        const responsible = actionEl.querySelector('.action-responsible')?.value;
        
        // Validation des champs obligatoires
        if (!startDate || !deadline || !descriptionAction || !taux || !responsible) {
            showNotification(`Action ${index + 1}: Tous les champs sont obligatoires`, 'error');
            hasError = true;
            return;
        }
        
        // Déterminer le statut basé sur le taux
        let status = 'Nouvelle';
        if (taux === '0') status = 'Nouvelle';
        else if (taux === '100') status = 'Clôturée';
        else status = 'En cours';
        
        // Créer l'action avec les bonnes propriétés
        const action = {
            id: actionId,
            libelle: descriptionAction, // Nom de l'action
            description: descriptionAction,
            responsable: responsible,
            taux: parseInt(taux),
            startDate: startDate,
            deadline: deadline,
            status: status,
            files: []
        };
        
        actions.push(action);
    });
    
    if (hasError) return;
    
    showLoading();
    
    setTimeout(() => {
        // Calculer les dates min/max des actions
        const startDates = actions.map(a => new Date(a.startDate));
        const deadlines = actions.map(a => new Date(a.deadline));
        const minStartDate = new Date(Math.min(...startDates)).toISOString().split('T')[0];
        const maxDeadline = new Date(Math.max(...deadlines)).toISOString().split('T')[0];
        
        // Trouver le premier responsable (pour compatibilité)
        const firstResponsible = actions[0]?.responsable || '';
        
        // Déterminer le statut global du plan
        let planStatus = 'Nouveau';
        const allClosed = actions.every(a => a.status === 'Clôturée');
        const someInProgress = actions.some(a => a.status === 'En cours');
        
        if (allClosed) {
            planStatus = 'Clôturé';
        } else if (someInProgress) {
            planStatus = 'En cours';
        }
        
        // Créer le plan d'action avec la structure CORRECTE
        const planAction = {
            id: document.getElementById('planActionId').value || 'pa-' + Date.now(),
            reference: reference,
            aerodromeId: aerodromeId,
            description: description,
            riskLevel: riskLevel,
            emissionDate: emissionDate,
            startDate: minStartDate,
            deadline: maxDeadline,
            status: planStatus,
            actions: actions,
            dateCreation: new Date().toISOString(),
            // Champs obligatoires pour l'affichage
            type: description, // Pour l'affichage "undefined" sur la capture
            title: `Plan d'action ${reference}` // Pour avoir un titre
        };
        
        const existingIndex = plansActions.findIndex(p => p.id === planAction.id);
        if (existingIndex >= 0) {
            plansActions[existingIndex] = planAction;
            showNotification('Plan d\'action modifié avec succès!', 'success');
        } else {
            plansActions.push(planAction);
            showNotification('Plan d\'action créé avec succès!', 'success');
        }
        
        closeModal('modalPlanAction');
        
        // Recharger selon le mode de vue
        if (currentViewMode === 'grouped') {
            loadPlansActionsGrouped();
        } else {
            loadPlansActionsGrouped();
        }
        
        loadClosedPlansSelector();
        updateDashboard();
        hideLoading();
        saveAllData();
        updateAllCalendars();
    }, 800);
}

function addActionItem() {
    const container = document.getElementById('planActionItems');
    const actionId = 'action-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    const actionHtml = `
        <div class="action-item" style="background: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-color);">
            <input type="hidden" class="action-id" value="${actionId}">
            
            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                <i class="fas fa-wrench"></i> Action Corrective
            </h4>
            
            <!-- Ligne 1: Dates -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date de Début <span style="color: red;">*</span></label>
                    <input type="date" class="action-start-date" style="width: 100%; padding: 10px;" required>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date de Fin <span style="color: red;">*</span></label>
                    <input type="date" class="action-deadline" style="width: 100%; padding: 10px;" required>
                </div>
            </div>
            
            <!-- Ligne 2: Intitulé -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Intitulé de l'Action Corrective <span style="color: red;">*</span></label>
                <textarea class="action-description" rows="3" style="width: 100%; padding: 10px;" placeholder="Décrivez l'action corrective à mettre en œuvre..." required></textarea>
            </div>
            
            <!-- Ligne 3: Taux et Responsable -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Taux de Mise en Œuvre <span style="color: red;">*</span></label>
                    <select class="action-taux" style="width: 100%; padding: 10px;" onchange="handleActionTauxChange(this)" required>
                        <option value="">Sélectionner...</option>
                        <option value="0">0% - Non démarré</option>
                        <option value="25">25% - En cours initial</option>
                        <option value="75">75% - Avancé</option>
                        <option value="100">100% - Complété</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Responsable <span style="color: red;">*</span></label>
                    <input type="text" class="action-responsible" style="width: 100%; padding: 10px;" placeholder="Nom du responsable" required>
                </div>
            </div>
            
            <!-- Section Preuves (cachée par défaut) -->
            <div class="action-preuves-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--primary-color);">
                <div style="background: #e3f2fd; padding: 12px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                    <i class="fas fa-info-circle" style="color: #2196f3;"></i>
                    <strong style="color: #1976d2;">Preuves de clôture obligatoires</strong>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #1976d2;">
                        Veuillez fournir au moins une preuve (photo, rapport, validation client, etc.)
                    </p>
                </div>
                
                <div class="file-upload-zone" onclick="triggerFileUpload('${actionId}')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4 style="margin: 10px 0 5px 0;">Déposer les preuves ici</h4>
                    <p style="margin: 0; color: #666;">ou cliquez pour parcourir</p>
                    <small style="color: #999;">Photos, rapports PDF, documents de validation</small>
                    <input type="file" id="file-input-${actionId}" class="action-files-input" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" style="display: none;" onchange="handleActionFilesUpload(this, '${actionId}')">
                </div>
                
                <div class="file-list-container" id="file-list-${actionId}"></div>
            </div>
            
            <div style="text-align: right; margin-top: 15px;">
                <button type="button" class="btn btn-danger" onclick="removeActionItem(this)">
                    <i class="fas fa-trash"></i> Supprimer cette action
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', actionHtml);
}

// Gérer le changement de taux pour afficher/masquer la section preuves
function handleActionTauxChange(selectElement) {
    const actionItem = selectElement.closest('.action-item');
    const preuvesSection = actionItem.querySelector('.action-preuves-section');
    const taux = selectElement.value;
    
    if (taux === '100') {
        preuvesSection.style.display = 'block';
    } else {
        preuvesSection.style.display = 'none';
        // Réinitialiser les fichiers
        const actionId = actionItem.querySelector('.action-id').value;
        const fileList = document.getElementById(`file-list-${actionId}`);
        if (fileList) fileList.innerHTML = '';
        const fileInput = document.getElementById(`file-input-${actionId}`);
        if (fileInput) fileInput.value = '';
    }
}

// Déclencher l'upload de fichiers
function triggerFileUpload(actionId) {
    document.getElementById(`file-input-${actionId}`).click();
}

// Gérer l'upload des fichiers
function handleActionFilesUpload(input, actionId) {
    const files = Array.from(input.files);
    const fileList = document.getElementById(`file-list-${actionId}`);
    
    files.forEach(file => {
        // Vérifier la taille (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showNotification(`Le fichier ${file.name} est trop volumineux (max 10MB)`, 'error');
            return;
        }
        
        const fileId = Date.now() + Math.random();
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.id = `file-item-${fileId}`;
        fileItem.setAttribute('data-filename', file.name);
        fileItem.setAttribute('data-filesize', file.size);
        
        fileItem.innerHTML = `
            <div class="file-item-info">
                <i class="fas fa-file" style="color: var(--primary-color);"></i>
                <div>
                    <div style="font-weight: 600;">${file.name}</div>
                    <small style="color: #666;">${formatFileSize(file.size)}</small>
                </div>
            </div>
            <div class="file-item-actions">
                <button type="button" onclick="removeFileItem('${fileId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${files.length} fichier(s) ajouté(s)`, 'success');
}

// Supprimer un fichier de la liste
function removeFileItem(fileId) {
    const fileItem = document.getElementById(`file-item-${fileId}`);
    if (fileItem) {
        fileItem.remove();
    }
}

// Formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function removeActionItem(button) {
    button.closest('.action-item').remove();
}


function toggleAeroVisibility(id) {
    // Ancien code pour cacher/afficher les aérodromes
    if (!window.hiddenAeros) window.hiddenAeros = [];
    const index = window.hiddenAeros.indexOf(id);
    if (index > -1) window.hiddenAeros.splice(index, 1);
    else window.hiddenAeros.push(id);
    
    // CHANGEMENT : Appeler la nouvelle fonction
    loadPlansActionsGrouped();
}

function editPlanAction(id) {
    const plan = plansActions.find(p => p.id === id);
    if (!plan) return;
    
    document.getElementById('planActionId').value = plan.id;
    document.getElementById('planActionReference').value = plan.reference;
    document.getElementById('planActionAerodrome').value = plan.aerodromeId;
    document.getElementById('planActionDescription').value = plan.description;
    document.getElementById('planActionRiskLevel').value = plan.riskLevel || '';
    document.getElementById('planActionEmissionDate').value = plan.emissionDate || plan.startDate;
    
    // Charger les actions
    const actionsContainer = document.getElementById('planActionItems');
    actionsContainer.innerHTML = '';
    
    if (plan.actions && plan.actions.length > 0) {
        plan.actions.forEach(action => {
            // Ajouter une action vide d'abord
            addActionItem();
            
            // Remplir les champs de la dernière action ajoutée
            const actionItems = document.querySelectorAll('#planActionItems .action-item');
            const lastAction = actionItems[actionItems.length - 1];
            
            lastAction.querySelector('.action-id').value = action.id;
            lastAction.querySelector('.action-start-date').value = action.startDate || '';
            lastAction.querySelector('.action-deadline').value = action.deadline || '';
            lastAction.querySelector('.action-description').value = action.description || '';
            lastAction.querySelector('.action-taux').value = action.taux?.toString() || '';
            lastAction.querySelector('.action-responsible').value = action.responsible || '';
            
            // Afficher la section preuves si taux = 100%
            if (action.taux === 100) {
                const preuvesSection = lastAction.querySelector('.action-preuves-section');
                if (preuvesSection) {
                    preuvesSection.style.display = 'block';
                    
                    // Afficher les fichiers existants
                    if (action.files && action.files.length > 0) {
                        const fileList = lastAction.querySelector(`#file-list-${action.id}`);
                        action.files.forEach(file => {
                            const fileId = Date.now() + Math.random();
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            fileItem.id = `file-item-${fileId}`;
                            fileItem.setAttribute('data-filename', file.name);
                            fileItem.setAttribute('data-filesize', file.size);
                            
                            fileItem.innerHTML = `
                                <div class="file-item-info">
                                    <i class="fas fa-file" style="color: var(--primary-color);"></i>
                                    <div>
                                        <div style="font-weight: 600;">${file.name}</div>
                                        <small style="color: #666;">${formatFileSize(file.size)}</small>
                                    </div>
                                </div>
                                <div class="file-item-actions">
                                    <button type="button" onclick="removeFileItem('${fileId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            
                            fileList.appendChild(fileItem);
                        });
                    }
                }
            }
        });
    }
    
    openModal('modalPlanAction');
}

function viewPlanActionDetails(id) {
    const plan = plansActions.find(p => p.id === id);
    if (!plan) return;
    
    const aerodrome = aerodromes.find(a => a.id === plan.aerodromeId);
    
    // Badge de risque
    let riskBadgeColor = '#4caf50';
    if (plan.riskLevel === 'Critique') riskBadgeColor = '#d32f2f';
    else if (plan.riskLevel === 'Élevé') riskBadgeColor = '#f57c00';
    else if (plan.riskLevel === 'Moyen') riskBadgeColor = '#fbc02d';
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                <i class="fas fa-clipboard-list"></i> Détails du Plan d'Action - ${plan.reference}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> Informations sur la Constatation
                </h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Référence</div>
                        <div class="detail-value">${plan.reference}</div>
                    </div>
                    <div>
                        <div class="detail-label">Aérodrome</div>
                        <div class="detail-value">${aerodrome?.code || 'Inconnu'} - ${aerodrome?.name || 'Inconnu'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Statut</div>
                        <div class="detail-value">${plan.status}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Niveau de Risque</div>
                        <div class="detail-value">
                            <span style="background: ${riskBadgeColor}; color: white; padding: 5px 15px; border-radius: 15px; font-weight: bold;">
                                ${plan.riskLevel || 'Non défini'}
                            </span>
                        </div>
                    </div>
                    <div>
                        <div class="detail-label">Date d'Émission</div>
                        <div class="detail-value">${new Date(plan.emissionDate || plan.startDate).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div>
                        <div class="detail-label">Date de Création</div>
                        <div class="detail-value">${new Date(plan.dateCreation).toLocaleDateString('fr-FR')}</div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Description de la Constatation</h4>
                <div style="padding: 15px; background: var(--light-bg); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                    ${plan.description}
                </div>
            </div>
            
            ${plan.actions && plan.actions.length > 0 ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-tools"></i> Actions Correctives (${plan.actions.length})
                    </h4>
                    ${plan.actions.map((action, index) => {
                        let tauxClass = 'taux-0';
                        if (action.taux === 25) tauxClass = 'taux-25';
                        else if (action.taux === 75) tauxClass = 'taux-75';
                        else if (action.taux === 100) tauxClass = 'taux-100';
                        
                        return `
                            <div style="background: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-color);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <h5 style="color: var(--primary-color); margin: 0;">
                                        <i class="fas fa-wrench"></i> Action ${index + 1}
                                    </h5>
                                    <span class="taux-indicator ${tauxClass}">${action.taux || 0}%</span>
                                </div>
                                
                                <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 5px;">
                                    <strong style="color: var(--primary-color);">Intitulé:</strong><br>
                                    ${action.description}
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                    <div>
                                        <strong><i class="fas fa-calendar-alt"></i> Date de début:</strong><br>
                                        ${action.startDate ? new Date(action.startDate).toLocaleDateString('fr-FR') : 'Non définie'}
                                    </div>
                                    <div>
                                        <strong><i class="fas fa-calendar-check"></i> Date de fin:</strong><br>
                                        ${action.deadline ? new Date(action.deadline).toLocaleDateString('fr-FR') : 'Non définie'}
                                    </div>
                                    <div>
                                        <strong><i class="fas fa-user"></i> Responsable:</strong><br>
                                        ${action.responsible || 'Non assigné'}
                                    </div>
                                    <div>
                                        <strong><i class="fas fa-info-circle"></i> Statut:</strong><br>
                                        ${action.status || 'Nouvelle'}
                                    </div>
                                </div>
                                
                                ${action.files && action.files.length > 0 ? `
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                        <strong style="color: var(--success-color);">
                                            <i class="fas fa-paperclip"></i> Preuves de clôture (${action.files.length})
                                        </strong>
                                        <div style="margin-top: 10px;">
                                            ${action.files.map(file => `
                                                <div style="padding: 8px; background: white; border-radius: 4px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;">
                                                    <i class="fas fa-file" style="color: var(--primary-color);"></i>
                                                    <span style="font-weight: 600;">${file.name}</span>
                                                    <small style="color: #666;">(${formatFileSize(file.size)})</small>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function deletePlanAction(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const plan = plansActions.find(p => p.id === id);
    if (!plan) return;
    
    const actionsCount = plan.actions?.length || 0;
    
    let confirmMessage = `Êtes-vous sûr de vouloir supprimer le plan d'action "${plan.reference}" ?`;
    
    if (actionsCount > 0) {
        confirmMessage += `\n\n${actionsCount} action(s) corrective(s) seront supprimée(s).`;
    }
    
    if (confirm(confirmMessage)) {
        showLoading();
        
        setTimeout(() => {
            const result = deletePlanActionWithCascade(id);
            
            if (result.success) {
                loadPlansActionsGrouped();
                loadClosedPlansSelector();
                updateDashboard();
                updateAllCalendars();
                autoSaveAll();
                
                hideLoading();
                showNotification(result.message, 'success');
            }
        }, 300);
    }
}

// Fonctions pour l'ajout de fichiers aux actions clôturées
function loadClosedPlansSelector() {
    const select = document.getElementById('selectPlanCloture');
    if (!select) return;
    
    const plansWithClosedActions = plansActions.filter(p => 
        p.actions && p.actions.some(a => a.status === 'Clôturée')
    );
    
    select.innerHTML = '<option value="">Sélectionner un plan...</option>' + 
        plansWithClosedActions.map(p => `<option value="${p.id}">${p.reference} - ${p.title}</option>`).join('');
}

function loadPlanActions() {
    const planId = document.getElementById('selectPlanCloture')?.value;
    const actionSelect = document.getElementById('selectActionCloturee');
    
    if (!planId || !actionSelect) return;
    
    const plan = plansActions.find(p => p.id === planId);
    const closedActions = plan?.actions?.filter(a => a.status === 'Clôturée') || [];
    
    actionSelect.innerHTML = '<option value="">Sélectionner une action...</option>' + 
        closedActions.map(a => `<option value="${a.id}">${a.description}</option>`).join('');
}

function showActionFileUpload() {
    const actionId = document.getElementById('selectActionCloturee')?.value;
    const section = document.getElementById('actionFileSection');
    
    if (actionId && section) {
        section.style.display = 'block';
    }
}

function triggerActionFileUpload() {
    document.getElementById('actionFileInput')?.click();
}

function handleActionFiles(input) {
    const fileList = document.getElementById('actionFileList');
    if (!fileList) return;
    
    Array.from(input.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${input.files.length} fichier(s) ajouté(s)`, 'success');
}
   
// ============ FONCTIONS POUR LE TABLEAU DE BORD ONGLET FORMATION ============

function updateFormationDashboard() {
    const formationTab = document.getElementById('formation');
    if (!formationTab || !formationTab.classList.contains('active')) {
        return;
    }
    
    if (!inspectors || !Array.isArray(inspectors) || !formations || !Array.isArray(formations)) {
        console.warn('Données manquantes pour le tableau de bord des formations');
        return;
    }
    
    try {
        function updateStatElement(elementId, value) {
            const element = document.getElementById(elementId);
            if (element && element.textContent !== undefined) {
                element.textContent = value;
            }
        }
        
        const actifs = inspectors.filter(i => i && i.status === 'Actif').length;
        const conge = inspectors.filter(i => i && i.status === 'En congé').length;
        const enFormation = inspectors.filter(i => i && i.status === 'En formation').length;
        
        const formationsActives = formations.filter(f => f && (f.status === 'Planifiée' || f.status === 'En cours'));
        const totalFormations = formationsActives.length;
        const moyenne = inspectors.length > 0 ? (totalFormations / inspectors.length).toFixed(1) : '0.0';
        
        const formationsTerminees = formations.filter(f => f && f.status === 'Terminée').length;
        const total = formations.length;
        const taux = total > 0 ? Math.round((formationsTerminees / total) * 100) : 0;
        
        updateStatElement('stat-inspecteurs-actifs', actifs);
        updateStatElement('stat-inspecteurs-conge', conge);
        updateStatElement('stat-inspecteurs-formation', enFormation);
        updateStatElement('stat-formations-par-inspecteur', moyenne);
        updateStatElement('stat-execution', taux + '%');
        
    } catch (error) {
        console.error('Erreur dans updateFormationDashboard:', error);
    }
}

// ============ FONCTIONS POUR INSPECTEURS ============

function updateInspectorSelects() {
    const inspectorSelects = document.querySelectorAll('select[id$="Inspector"], select[id="dossierInspector"]');
    inspectorSelects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Sélectionner un inspecteur...</option>' + 
            inspectors.map(i => `<option value="${i.id}">${i.lastName} ${i.firstName} (${i.specialty})</option>`).join('');
        if (currentValue) {
            select.value = currentValue;
        }
    });
}

function initInspectorModal() {
    document.getElementById('inspectorId').value = '';
    document.getElementById('inspectorModalTitle').textContent = 'Nouvel Inspecteur';
    document.getElementById('inspectorLastName').value = '';
    document.getElementById('inspectorFirstName').value = '';
    document.getElementById('inspectorMatricule').value = '';
    document.getElementById('inspectorType').value = '';
    document.getElementById('inspectorSpecialty').value = '';
    document.getElementById('inspectorService').value = '';
    document.getElementById('inspectorStatus').value = 'Actif';
    document.getElementById('inspectorEmail').value = '';
    document.getElementById('inspectorPhone').value = '';
    document.getElementById('inspectorStartDate').value = '';
    document.getElementById('inspectorTrainings').value = '';
}

function saveInspector() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const lastName = document.getElementById('inspectorLastName').value;
    const firstName = document.getElementById('inspectorFirstName').value;
    const matricule = document.getElementById('inspectorMatricule').value;
    const type = document.getElementById('inspectorType').value;
    const service = document.getElementById('inspectorService').value;
    const specialty = document.getElementById('inspectorSpecialty').value;
    const status = document.getElementById('inspectorStatus').value;
    
    if (!lastName || !firstName || !matricule || !type || !service || !specialty || !status) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        const inspector = {
            id: document.getElementById('inspectorId').value || 'insp-' + Date.now(),
            lastName: lastName,
            firstName: firstName,
            matricule: matricule,
            type: type,
            service: service,
            specialty: specialty,
            status: status,
            email: document.getElementById('inspectorEmail').value,
            phone: document.getElementById('inspectorPhone').value,
            startDate: document.getElementById('inspectorStartDate').value,
            trainings: document.getElementById('inspectorTrainings').value,
            dateCreation: new Date().toISOString()
        };
        
        const existingIndex = inspectors.findIndex(i => i.id === inspector.id);
        if (existingIndex >= 0) {
            inspectors[existingIndex] = inspector;
            showNotification('Inspecteur modifié avec succès!', 'success');
        } else {
            inspectors.push(inspector);
            showNotification('Inspecteur créé avec succès!', 'success');
        }
        
        closeModal('modalInspector');
        loadInspectors();
        updateInspectorSelects();
        updateFormationDashboard();
        hideLoading();
        saveAllData();
    }, 800);
}

function loadInspectors(filteredList = null) {
    const container = document.getElementById('inspectorsList');
    if (!container) return;
    
    const list = filteredList || (typeof inspectors !== 'undefined' ? inspectors : []);
    
    updateFormationDashboard();

    if (list.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 50px; background: white; border-radius: 12px; border: 1px solid #e0e6ed;">
                <i class="fas fa-users-slash" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                <h3 style="color: #2c3e50; margin-bottom: 10px;">Aucun inspecteur trouvé</h3>
                <p style="color: #7f8c8d;">La recherche n'a retourné aucun résultat ou la base est vide.</p>
            </div>
        `;
        return;
    }

    const itemsPerPage = 8;
    const currentPage = window.currentInspectorPage || 1;
    const totalPages = Math.ceil(list.length / itemsPerPage);
    const safeCurrentPage = currentPage > totalPages ? totalPages : currentPage;
    
    const startIndex = (safeCurrentPage - 1) * itemsPerPage;
    const pagedInspectors = list.slice(startIndex, startIndex + itemsPerPage);

    const groupedByService = pagedInspectors.reduce((acc, inspector) => {
        const service = inspector.service || 'Services Centraux / Autres';
        if (!acc[service]) acc[service] = [];
        acc[service].push(inspector);
        return acc;
    }, {});

    let html = '';

    Object.keys(groupedByService).forEach(serviceName => {
        html += `
            <div class="service-group-header" style="grid-column: 1 / -1; margin: 20px 0 10px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-sitemap"></i> ${serviceName.toUpperCase()}</span>
                <span style="font-size: 14px; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 20px;">${groupedByService[serviceName].length} personnel(s)</span>
            </div>
        `;

        html += groupedByService[serviceName].map(inspector => {
            let statusClass = 'status-active';
            let statusColor = '#4caf50';
            if (inspector.status === 'En congé') {
                statusClass = 'status-onleave';
                statusColor = '#f57c00';
            } else if (inspector.status === 'En formation') {
                statusClass = 'status-intraining';
                statusColor = '#2196f3';
            } else if (inspector.status === 'Inactif') {
                statusClass = 'status-closed';
                statusColor = '#d32f2f';
            }
            
            const initials = `${inspector.firstName.charAt(0)}${inspector.lastName.charAt(0)}`.toUpperCase();

            return `
                <div class="inspector-card" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e0e6ed; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; transition: transform 0.2s ease;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; flex-shrink: 0;">
                                ${initials}
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 3px;">${inspector.lastName} ${inspector.firstName}</div>
                                <div style="font-size: 14px; color: #1a237e; font-weight: 600;">${inspector.specialty}</div>
                            </div>
                        </div>
                        <span style="padding: 5px 12px; background: ${statusColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: 600;">${inspector.status}</span>
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin: 10px 0; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;">
                        <i class="fas fa-id-card"></i> <strong>${inspector.matricule}</strong> • ${inspector.type}
                    </div>
                    
                    <div style="flex-grow: 1; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 14px;">
                            ${inspector.email ? `
                                <div style="display: flex; align-items: center; gap: 8px; overflow: hidden; text-overflow: ellipsis;">
                                    <i class="fas fa-envelope" style="color: #1a237e; width: 18px;"></i> 
                                    <span>${inspector.email}</span>
                                </div>
                            ` : ''}
                            ${inspector.phone ? `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-phone" style="color: #1a237e; width: 18px;"></i> 
                                    <span>${inspector.phone}</span>
                                </div>
                            ` : ''}
                            ${inspector.startDate ? `
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px; color: #455a64;">
                                    <i class="fas fa-calendar-check" style="width: 18px;"></i> 
                                    <span>En fonction: ${new Date(inspector.startDate).toLocaleDateString('fr-FR')}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: auto;">
                        <button class="btn btn-primary" onclick="editInspector('${inspector.id}')" title="Modifier" style="padding: 10px 0; font-size: 14px;">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn btn-info" onclick="viewInspectorDetails('${inspector.id}')" title="Détails" style="padding: 10px 0; font-size: 14px;">
                            <i class="fas fa-eye"></i> Détails
                        </button>
                        <button class="btn btn-danger" onclick="deleteInspector('${inspector.id}')" title="Supprimer" style="padding: 10px 0; font-size: 14px;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    });

    if (totalPages > 1) {
        html += `
            <div style="grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 30px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e0e6ed;">
                <button onclick="changeInspectorPage(${safeCurrentPage - 1})" ${safeCurrentPage === 1 ? 'disabled' : ''} 
                        class="btn btn-secondary" style="padding: 10px 20px; font-size: 14px;">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                <span style="font-size: 15px; color: #666; font-weight: 600;">Page ${safeCurrentPage} sur ${totalPages}</span>
                <button onclick="changeInspectorPage(${safeCurrentPage + 1})" ${safeCurrentPage === totalPages ? 'disabled' : ''} 
                        class="btn btn-secondary" style="padding: 10px 20px; font-size: 14px;">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }

    container.innerHTML = html;
    const formationTab = document.getElementById('formation');
    if (formationTab && formationTab.classList.contains('active')) {
        updateFormationDashboard();
    }
}

function changeInspectorPage(page) {
    if (page < 1) return;
    const totalPages = Math.ceil(inspectors.length / 8);
    if (page > totalPages) return;
    
    window.currentInspectorPage = page;
    loadInspectors();
}

function editInspector(id) {
    const inspector = inspectors.find(i => i.id === id);
    if (!inspector) return;
    
    document.getElementById('inspectorId').value = inspector.id;
    document.getElementById('inspectorModalTitle').textContent = 'Modifier Inspecteur';
    document.getElementById('inspectorLastName').value = inspector.lastName;
    document.getElementById('inspectorFirstName').value = inspector.firstName;
    document.getElementById('inspectorMatricule').value = inspector.matricule;
    document.getElementById('inspectorType').value = inspector.type;
    document.getElementById('inspectorService').value = inspector.service || '';
    document.getElementById('inspectorSpecialty').value = inspector.specialty;
    document.getElementById('inspectorStatus').value = inspector.status;
    document.getElementById('inspectorEmail').value = inspector.email || '';
    document.getElementById('inspectorPhone').value = inspector.phone || '';
    document.getElementById('inspectorStartDate').value = inspector.startDate || '';
    document.getElementById('inspectorTrainings').value = inspector.trainings || '';
    
    openModal('modalInspector');
}

function viewInspectorDetails(id) {
    const inspector = inspectors.find(i => i.id === id);
    if (!inspector) return;
    
    const inspectorFormations = formations.filter(f => 
        f.participants && f.participants.includes(inspector.id)
    );
    
    const inspectorPlannings = plannings.filter(p => 
        p.equipe && p.equipe.includes(inspector.id)
    );
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px; font-size: 24px;">
                <i class="fas fa-user-tie"></i> Profil de l'Inspecteur - ${inspector.lastName} ${inspector.firstName}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Informations Personnelles</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Nom complet</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.lastName} ${inspector.firstName}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Matricule</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.matricule}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Type</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.type}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Service</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.service || 'Non spécifié'}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Spécialité</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.specialty}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Statut</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.status}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Date de prise de fonction</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.startDate ? new Date(inspector.startDate).toLocaleDateString('fr-FR') : 'Non spécifiée'}</div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Contact</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Email</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.email || 'Non spécifié'}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Téléphone</div>
                        <div class="detail-value" style="font-size: 16px;">${inspector.phone || 'Non spécifié'}</div>
                    </div>
                </div>
            </div>
            
            ${inspectorFormations.length > 0 ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Formations (${inspectorFormations.length})</h4>
                    ${inspectorFormations.map(f => `
                        <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary-color);">
                            <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px; font-size: 16px;">${f.title}</div>
                            <div style="font-size: 14px; color: #666;">
                                ${new Date(f.startDate).toLocaleDateString('fr-FR')} - ${new Date(f.endDate).toLocaleDateString('fr-FR')}
                                <span style="margin-left: 10px; padding: 2px 8px; background: ${f.status === 'Terminée' ? '#4caf50' : f.status === 'En cours' ? '#2196f3' : '#f57c00'}; color: white; border-radius: 12px; font-size: 12px;">${f.status}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${inspectorPlannings.length > 0 ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Inspections récentes (${inspectorPlannings.length})</h4>
                    ${inspectorPlannings.slice(0, 5).map(p => {
                        const aerodrome = aerodromes.find(a => a.id === p.aerodromeId);
                        return `
                            <div style="background: var(--light-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--secondary-color);">
                                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px; font-size: 16px;">
                                    ${aerodrome?.code || 'Inconnu'} - ${p.type}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    ${new Date(p.dateDebut).toLocaleDateString('fr-FR')} • 
                                    <span style="padding: 2px 8px; background: ${p.status === 'Terminé' ? '#4caf50' : p.status === 'En cours' ? '#2196f3' : '#f57c00'}; color: white; border-radius: 12px; font-size: 12px;">${p.status}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : ''}
            
            ${inspector.trainings ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Formations suivies</h4>
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px; white-space: pre-line; font-size: 16px;">
                        ${inspector.trainings}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function deleteInspector(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const inspector = inspectors.find(i => i.id === id);
    if (!inspector) return;
    
    const planningsCount = plannings.filter(p => 
        (p.equipe && p.equipe.includes(id)) || p.chef === id
    ).length;
    const surveillancesCount = surveillances.filter(s => 
        s.inspecteurs && s.inspecteurs.includes(id)
    ).length;
    const dossiersCount = dossiers.filter(d => d.inspectorId === id).length;
    const formationsCount = formations.filter(f => 
        f.participants && f.participants.includes(id)
    ).length;
    
    const totalLinked = planningsCount + surveillancesCount + dossiersCount + formationsCount;
    
    let confirmMessage = `Êtes-vous sûr de vouloir supprimer l'inspecteur "${inspector.lastName} ${inspector.firstName}" ?`;
    
    if (totalLinked > 0) {
        confirmMessage += `\n\n⚠️ ATTENTION : Il sera retiré de :`;
        if (planningsCount > 0) confirmMessage += `\n- ${planningsCount} planning(s)`;
        if (surveillancesCount > 0) confirmMessage += `\n- ${surveillancesCount} surveillance(s)`;
        if (dossiersCount > 0) confirmMessage += `\n- ${dossiersCount} dossier(s)`;
        if (formationsCount > 0) confirmMessage += `\n- ${formationsCount} formation(s)`;
        confirmMessage += `\n\nCette action est irréversible !`;
    }
    
    if (confirm(confirmMessage)) {
        showLoading();
        
        setTimeout(() => {
            const result = deleteInspectorWithCascade(id);
            
            if (result.success) {
                loadInspectors();
                updateInspectorSelects();
                updateFormationDashboard();
                updateAllCalendars();
                autoSaveAll();
                
                hideLoading();
                
                alert(result.message);
                showNotification('Suppression effectuée avec succès', 'success');
            }
        }, 300);
    }
}

function filterInspectors() {
    const specialty = document.getElementById('filterSpecialty')?.value || '';
    const status = document.getElementById('filterStatus')?.value || '';
    
    let filtered = [...inspectors];
    
    if (specialty) filtered = filtered.filter(i => i.specialty === specialty);
    if (status) filtered = filtered.filter(i => i.status === status);
    
    loadInspectors(filtered);
}

function sortInspectors(field) {
    const sorted = [...inspectors].sort((a, b) => {
        if (field === 'name') {
            return (a.lastName + a.firstName).localeCompare(b.lastName + b.firstName);
        } else if (field === 'date') {
            return new Date(b.startDate || 0) - new Date(a.startDate || 0);
        }
        return 0;
    });
    
    loadInspectors(sorted);
}

// ============ FONCTIONS POUR FORMATIONS ============

function initFormationModal() {
    document.getElementById('formationId').value = '';
    document.getElementById('formationModalTitle').textContent = 'Nouvelle Formation';
    document.getElementById('formationTitle').value = '';
    document.getElementById('formationStartDate').value = '';
    document.getElementById('formationEndDate').value = '';
    document.getElementById('formationType').value = '';
    document.getElementById('formationOrganizer').value = 'ANACIM';
    document.getElementById('formationDescription').value = '';
    document.getElementById('formationStatus').value = 'Planifiée';
    document.getElementById('formationFileList').innerHTML = '';
    
    const participantsSelect = document.getElementById('formationParticipants');
    participantsSelect.innerHTML = '';
    inspectors.forEach(i => {
        const option = document.createElement('option');
        option.value = i.id;
        option.textContent = `${i.lastName} ${i.firstName} (${i.specialty})`;
        participantsSelect.appendChild(option);
    });
}

function saveFormation() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const title = document.getElementById('formationTitle').value;
    const startDate = document.getElementById('formationStartDate').value;
    const endDate = document.getElementById('formationEndDate').value;
    const status = document.getElementById('formationStatus').value;
    
    if (!title || !startDate || !endDate || !status) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        const participants = Array.from(document.getElementById('formationParticipants').selectedOptions)
            .map(option => option.value);
        
        const formation = {
            id: document.getElementById('formationId').value || 'form-' + Date.now(),
            title: title,
            startDate: startDate,
            endDate: endDate,
            type: document.getElementById('formationType').value,
            organizer: document.getElementById('formationOrganizer').value,
            description: document.getElementById('formationDescription').value,
            participants: participants,
            status: status,
            dateCreation: new Date().toISOString(),
            files: [] // Les fichiers seront gérés séparément
        };
        
        const existingIndex = formations.findIndex(f => f.id === formation.id);
        if (existingIndex >= 0) {
            formations[existingIndex] = formation;
            showNotification('Formation modifiée avec succès!', 'success');
        } else {
            formations.push(formation);
            showNotification('Formation créée avec succès!', 'success');
        }
        
        closeModal('modalFormation');
        loadFormations();
        updateFormationDashboard();
        hideLoading();
        saveAllData();
        updateAllCalendars();
        
    }, 800);
}

function loadFormations(filteredList = null) {
    const container = document.getElementById('trainingsList');
    if (!container) return;
    
    const list = filteredList || (typeof formations !== 'undefined' ? formations : []);
    
    updateFormationDashboard();
    
    if (list.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 60px; background: white; border-radius: 12px; border: 1px solid #e0e6ed;">
                <i class="fas fa-graduation-cap" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                <h3 style="color: #2c3e50; font-size: 20px; margin-bottom: 10px;">Aucune formation enregistrée</h3>
                <p style="color: #7f8c8d; font-size: 16px;">La liste des formations est actuellement vide.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    list.forEach(formation => {
        // Couleur selon le statut
        let statusColor = '#7b1fa2'; // Planifiée par défaut
        if (formation.status === 'En cours') statusColor = '#f57c00';
        if (formation.status === 'Terminée') statusColor = '#4caf50';
        if (formation.status === 'Annulée') statusColor = '#d32f2f';
        
        // Liste des participants
        const participants = formation.participants?.map(pid => {
            const inspector = inspectors.find(i => i.id === pid);
            return inspector ? `${inspector.firstName} ${inspector.lastName.charAt(0)}.` : 'Inconnu';
        }).join(', ') || 'Aucun participant';
        
        html += `
            <div class="formation-card" style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e0e6ed; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div>
                        <h4 style="color: #1a237e; margin: 0 0 8px 0; font-size: 18px;">${formation.title}</h4>
                        <div style="display: flex; gap: 15px; font-size: 14px; color: #666;">
                            <span><i class="far fa-calendar"></i> ${new Date(formation.startDate).toLocaleDateString('fr-FR')}</span>
                            <span><i class="fas fa-arrow-right"></i></span>
                            <span><i class="far fa-calendar"></i> ${new Date(formation.endDate).toLocaleDateString('fr-FR')}</span>
                        </div>
                    </div>
                    <span style="padding: 5px 15px; background: ${statusColor}; color: white; border-radius: 20px; font-size: 12px; font-weight: 600;">
                        ${formation.status}
                    </span>
                </div>
                
                <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">
                        <i class="fas fa-users"></i> <strong>Participants:</strong> ${formation.participants?.length || 0}
                    </div>
                    <div style="font-size: 13px; color: #888; max-height: 40px; overflow: hidden; text-overflow: ellipsis;">
                        ${participants}
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <div style="font-size: 14px; color: #666;">
                        <i class="fas fa-building"></i> ${formation.organizer || 'ANACIM'}
                    </div>
                    <div class="action-buttons" style="display: flex; gap: 8px;">
                        <button class="btn btn-info" onclick="viewFormationDetails('${formation.id}')" title="Voir détails" style="padding: 8px 12px; font-size: 13px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary" onclick="editFormation('${formation.id}')" title="Modifier" style="padding: 8px 12px; font-size: 13px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteFormation('${formation.id}')" title="Supprimer" style="padding: 8px 12px; font-size: 13px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    const formationTab = document.getElementById('formation');
    if (formationTab && formationTab.classList.contains('active')) {
        updateFormationDashboard();
    }
}

function editFormation(id) {
    const formation = formations.find(f => f.id === id);
    if (!formation) return;
    
    document.getElementById('formationId').value = formation.id;
    document.getElementById('formationModalTitle').textContent = 'Modifier Formation';
    document.getElementById('formationTitle').value = formation.title;
    document.getElementById('formationStartDate').value = formation.startDate;
    document.getElementById('formationEndDate').value = formation.endDate;
    document.getElementById('formationType').value = formation.type || '';
    document.getElementById('formationOrganizer').value = formation.organizer || 'ANACIM';
    document.getElementById('formationDescription').value = formation.description || '';
    document.getElementById('formationStatus').value = formation.status;
    
    const participantsSelect = document.getElementById('formationParticipants');
    Array.from(participantsSelect.options).forEach(option => {
        option.selected = formation.participants?.includes(option.value);
    });
    
    openModal('modalFormation');
}

function viewFormationDetails(id) {
    const formation = formations.find(f => f.id === id);
    if (!formation) return;
    
    const participantsList = formation.participants?.map(pid => {
        const inspector = inspectors.find(i => i.id === pid);
        return inspector ? `${inspector.lastName} ${inspector.firstName} (${inspector.specialty})` : 'Inconnu';
    }).join(', ') || 'Aucun participant';
    
    // Gestion des fichiers/certificats
    const filesHTML = formation.files && formation.files.length > 0 ? `
        <div style="margin-top: 20px; border-top: 1px solid #e0e6ed; padding-top: 20px;">
            <h5 style="color: #1a237e; margin-bottom: 15px; font-size: 16px;">
                <i class="fas fa-file-certificate"></i> Certificats et Documents
            </h5>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                ${formation.files.map(file => `
                    <div style="display: flex; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #dee2e6; gap: 10px; min-width: 200px;">
                        <i class="fas fa-file-pdf" style="color: #d32f2f; font-size: 20px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
                            <div style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="viewCertificate('${file.id}', '${file.name}')" title="Visualiser" style="background: none; border: none; color: #1976d2; cursor: pointer;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="downloadCertificate('${file.id}', '${file.name}')" title="Télécharger" style="background: none; border: none; color: #4caf50; cursor: pointer;">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    ` : '';
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px; font-size: 24px;">
                <i class="fas fa-graduation-cap"></i> Détails de la Formation - ${formation.title}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Informations Générales</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Titre</div>
                        <div class="detail-value" style="font-size: 16px;">${formation.title}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Type</div>
                        <div class="detail-value" style="font-size: 16px;">${formation.type || 'Non spécifié'}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Statut</div>
                        <div class="detail-value" style="font-size: 16px;">
                            <span style="padding: 5px 10px; background: ${formation.status === 'Terminée' ? '#4caf50' : formation.status === 'En cours' ? '#2196f3' : formation.status === 'Annulée' ? '#d32f2f' : '#7b1fa2'}; color: white; border-radius: 12px;">${formation.status}</span>
                        </div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Date de début</div>
                        <div class="detail-value" style="font-size: 16px;">${new Date(formation.startDate).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Date de fin</div>
                        <div class="detail-value" style="font-size: 16px;">${new Date(formation.endDate).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div>
                        <div class="detail-label" style="font-size: 14px;">Organisateur</div>
                        <div class="detail-value" style="font-size: 16px;">${formation.organizer || 'Non spécifié'}</div>
                    </div>
                </div>
            </div>
            
            ${formation.description ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">Description</h4>
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px; font-size: 16px;">
                        ${formation.description}
                    </div>
                </div>
            ` : ''}
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">
                    Participants (${formation.participants?.length || 0})
                </h4>
                <div style="padding: 15px; background: var(--light-bg); border-radius: 8px; font-size: 16px;">
                    ${participantsList}
                </div>
            </div>
            
            ${filesHTML}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function deleteFormation(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const formation = formations.find(f => f.id === id);
    if (!formation) return;
    
    const participantsCount = formation.participants?.length || 0;
    
    let confirmMessage = `Êtes-vous sûr de vouloir supprimer la formation "${formation.title}" ?`;
    
    if (participantsCount > 0) {
        confirmMessage += `\n\n${participantsCount} participant(s) inscrit(s) seront affectés.`;
    }
    
    if (confirm(confirmMessage)) {
        showLoading();
        
        setTimeout(() => {
            const result = deleteFormationWithCascade(id);
            
            if (result.success) {
                loadFormations();
                updateFormationDashboard();
                updateAllCalendars();
                autoSaveAll();
                
                hideLoading();
                showNotification(result.message, 'success');
            }
        }, 300);
    }
}

function viewCertificate(fileId, fileName) {
    // Simuler l'ouverture d'un fichier (à adapter avec votre logique réelle)
    alert(`Visualisation du certificat: ${fileName}\n\nEnvironnement réel: Ceci ouvrirait le fichier dans une nouvelle fenêtre ou un visualiseur PDF.`);
    
    // Pour une implémentation réelle, vous pourriez:
    // 1. Ouvrir le fichier dans une nouvelle fenêtre
    // 2. Utiliser un visualiseur PDF intégré
    // 3. Télécharger et ouvrir le fichier
}

function downloadCertificate(fileId, fileName) {
    // Simuler le téléchargement
    alert(`Téléchargement du certificat: ${fileName}\n\nEnvironnement réel: Ceci téléchargerait le fichier sur l'ordinateur de l'utilisateur.`);
    
    // Pour une implémentation réelle, vous pourriez:
    // 1. Créer un lien de téléchargement dynamique
    // 2. Utiliser l'API File pour les téléchargements
    // 3. Gérer les fichiers depuis un serveur
}

function triggerFormationFileUpload() {
    document.getElementById('formationFileInput')?.click();
}

function handleFormationFiles(input) {
    const fileList = document.getElementById('formationFileList');
    if (!fileList) return;
    
    Array.from(input.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.style = 'display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; border: 1px solid #dee2e6;';
        fileItem.innerHTML = `
            <div style="margin-right: 10px; color: #1a237e;">
                <i class="fas fa-file-pdf" style="font-size: 20px;"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
                <div style="font-size: 12px; color: #666;">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 16px;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    showNotification(`${input.files.length} fichier(s) ajouté(s)`, 'success');
}

// ============ FONCTIONS CALENDRIER COMPLÈTES ============

function generateAnnualCalendar(containerId, events) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Filtrer uniquement les formations (pas les autres événements)
    const formationEvents = events.filter(event => 
        event.title && (event.status === 'Planifiée' || event.status === 'En cours' || event.status === 'Terminée' || event.status === 'Annulée')
    );
    
    const now = new Date();
    const currentYear = now.getFullYear();
    
    // Créer un conteneur grid avec 2 lignes maximum (6 mois par ligne)
    let calendarHTML = '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px;">';
    
    for (let month = 0; month < 12; month++) {
        calendarHTML += generateMonthCalendarFormations(month, currentYear, formationEvents);
    }
    
    calendarHTML += '</div>';
    container.innerHTML = calendarHTML;
}

// NOUVELLE FONCTION POUR GÉNÉRER LE CALENDRIER TRIMESTRIEL
function generateCalendar(containerId, events, type) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Générer le calendrier pour 3 mois (mois précédent, actuel, suivant)
    let calendarHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;">';
    
    for (let monthOffset = -1; monthOffset <= 1; monthOffset++) {
        const targetDate = new Date(currentYear, currentMonth + monthOffset, 1);
        const month = targetDate.getMonth();
        const year = targetDate.getFullYear();
        
        if (type === 'formation') {
            calendarHTML += generateMonthCalendarFormations(month, year, events);
        } else {
            // Pour les autres types (planning, action)
            calendarHTML += generateMonthCalendar(month, year, events, type);
        }
    }
    
    calendarHTML += '</div>';
    container.innerHTML = calendarHTML;
}

// Fonction pour les formations (version simplifiée)
function generateMonthCalendarFormations(month, year, events) {
    const monthNames = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 
                       'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const today = new Date();
    
    let html = `
        <div style="background: white; border-radius: 8px; padding: 12px; border: 1px solid #e0e6ed; box-shadow: 0 2px 6px rgba(0,0,0,0.03);">
            <h5 style="text-align: center; color: #1a237e; margin-bottom: 12px; font-size: 14px; font-weight: 700; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                ${monthNames[month]} ${year}
            </h5>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
    `;
    
    // Jours de la semaine (abréviations courtes)
    const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
    dayNames.forEach(day => {
        html += `<div style="text-align: center; font-weight: 600; padding: 4px; font-size: 11px; color: #1a237e;">${day}</div>`;
    });
    
    // Cases vides avant le premier jour
    for (let i = 0; i < firstDay; i++) {
        html += '<div style="background: #f9f9f9; min-height: 30px; border-radius: 3px;"></div>';
    }
    
    // Jours du mois
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const dateStr = currentDate.toISOString().split('T')[0];
        const isToday = currentDate.toDateString() === today.toDateString();
        const isPast = currentDate < today && !isToday;
        
        // Filtrer les formations pour ce jour
        const dayEvents = events.filter(e => {
            const eventStartDate = new Date(e.startDate);
            const eventEndDate = e.endDate ? new Date(e.endDate) : eventStartDate;
            return eventStartDate <= currentDate && currentDate <= eventEndDate;
        });
        
        // Compter par statut pour l'affichage
        const plannedCount = dayEvents.filter(e => e.status === 'Planifiée').length;
        const inProgressCount = dayEvents.filter(e => e.status === 'En cours').length;
        const completedCount = dayEvents.filter(e => e.status === 'Terminée').length;
        const cancelledCount = dayEvents.filter(e => e.status === 'Annulée').length;
        
        html += `
            <div style="background: ${isToday ? '#e3f2fd' : 'white'}; min-height: 30px; border-radius: 3px; padding: 2px; border: ${isToday ? '2px solid #1a237e' : '1px solid #f0f0f0'}; position: relative;">
                <div style="font-size: 11px; font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isPast ? '#aaa' : '#333'}; text-align: center;">
                    ${day}
                </div>
                ${dayEvents.length > 0 ? `
                    <div style="position: absolute; bottom: 1px; left: 1px; right: 1px; display: flex; gap: 1px;">
                        ${plannedCount > 0 ? `<div style="flex: 1; height: 3px; background: #7b1fa2; border-radius: 1px;"></div>` : ''}
                        ${inProgressCount > 0 ? `<div style="flex: 1; height: 3px; background: #f57c00; border-radius: 1px;"></div>` : ''}
                        ${completedCount > 0 ? `<div style="flex: 1; height: 3px; background: #4caf50; border-radius: 1px;"></div>` : ''}
                        ${cancelledCount > 0 ? `<div style="flex: 1; height: 3px; background: #d32f2f; border-radius: 1px;"></div>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    html += '</div></div>';
    return html;
}

// Fonction générique pour les autres calendriers (planning, actions)
function generateMonthCalendar(month, year, events, type) {
    const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                       'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const today = new Date();
    
    let html = `
        <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <h4 style="text-align: center; color: var(--primary-color); margin-bottom: 20px; font-size: 18px; font-weight: 700;">
                ${monthNames[month]} ${year}
            </h4>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;">
    `;
    
    // Jours de la semaine
    const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
    dayNames.forEach(day => {
        html += `<div style="text-align: center; font-weight: 600; padding: 10px; font-size: 13px; color: var(--primary-color);">${day}</div>`;
    });
    
    // Cases vides avant le premier jour
    for (let i = 0; i < firstDay; i++) {
        html += '<div style="background: #f9f9f9; min-height: 90px; border-radius: 6px;"></div>';
    }
    
    // Jours du mois
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const dateStr = currentDate.toISOString().split('T')[0];
        const isToday = currentDate.toDateString() === today.toDateString();
        const isPast = currentDate < today && !isToday;
        
        // Filtrer les événements pour ce jour
        const dayEvents = events.filter(e => {
            const eventDate = new Date(e.date || e.startDate || e.dateDebut);
            const eventEndDate = e.endDate ? new Date(e.endDate) : eventDate;
            return (eventDate <= currentDate && currentDate <= eventEndDate) || 
                   eventDate.toDateString() === currentDate.toDateString();
        });
        
        html += `
            <div style="background: ${isToday ? '#e3f2fd' : 'white'}; min-height: 90px; border-radius: 6px; padding: 5px; border: ${isToday ? '2px solid var(--primary-color)' : '1px solid #eee'}; position: relative;">
                <div style="font-size: 13px; font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isPast ? '#999' : 'var(--text-primary)'}; margin-bottom: 4px; padding: 2px 4px;">
                    ${day}
                </div>
                <div style="font-size: 11px; max-height: 70px; overflow-y: auto;">
                    ${dayEvents.map(e => formatCalendarEvent(e, type, isPast)).join('')}
                </div>
            </div>
        `;
    }
    
    html += '</div></div>';
    return html;
}

function formatCalendarEvent(event, type, isPast) {
    let className = '';
    let title = '';
    let icon = '';
    let bgColor = '#e3f2fd';
    
    if (type === 'planning') {
        const status = event.status || '';
        className = isPast && status !== 'Terminé' ? 'event-depasse' : 
                   status === 'En cours' ? 'event-action' : 'event-planning';
        title = `${event.type || ''} - ${getAerodromeName(event.aerodromeId)}`;
        icon = '<i class="fas fa-calendar-check"></i>';
        bgColor = status === 'Terminé' ? '#e8f5e9' : status === 'En cours' ? '#fff3e0' : '#f3e5f5';
    } else if (type === 'formation') {
        const status = event.status || '';
        if (status === 'Terminée') {
            className = 'event-planning';
            bgColor = '#e8f5e9';
        } else if (status === 'En cours') {
            className = 'event-action';
            bgColor = '#fff3e0';
        } else if (status === 'Annulée') {
            className = 'event-depasse';
            bgColor = '#ffebee';
        } else {
            className = 'event-formation';
            bgColor = '#f3e5f5';
        }
        title = event.title || '';
        icon = '<i class="fas fa-graduation-cap"></i>';
    } else if (type === 'action') {
        const now = new Date();
        const deadline = new Date(event.deadline);
        className = isPast && event.status !== 'Clôturé' ? 'event-depasse' : 
                   event.status === 'En cours' ? 'event-action' : 'event-planning';
        title = event.title || '';
        icon = '<i class="fas fa-tasks"></i>';
        bgColor = isPast && event.status !== 'Clôturé' ? '#ffebee' : '#e3f2fd';
    }
    
    return `
        <div class="calendar-event-item ${className}" title="${title}" 
             style="background: ${bgColor}; margin: 2px 0; padding: 3px 5px; border-radius: 3px; border-left: 3px solid var(--primary-color); font-size: 10px;">
            ${icon} ${title.substring(0, 12)}${title.length > 12 ? '...' : ''}
        </div>
    `;
}

function updateAllCalendars() {
    // Calendrier des plannings
    const planningEvents = plannings.map(p => ({
        ...p,
        date: p.dateDebut
    }));
    
    // Chercher les conteneurs et ne générer que s'ils existent
    const planningCalendar = document.getElementById('planningCalendar');
    if (planningCalendar) {
        generateCalendar('planningCalendar', planningEvents, 'planning');
    }
    
    // Calendrier ANNUEL des formations (modifié)
    const formationsCalendar = document.getElementById('formationsCalendar');
    if (formationsCalendar) {
        generateAnnualCalendar('formationsCalendar', formations);
    }
    
    // Calendrier des plans d'actions
    const actionEvents = plansActions.map(pa => ({
        ...pa,
        date: pa.deadline
    }));
    
    const actionsCalendar = document.getElementById('actionsCalendar');
    if (actionsCalendar) {
        generateCalendar('actionsCalendar', actionEvents, 'action');
    }
}

function getAerodromeName(aerodromeId) {
    if (!aerodromes) return 'Inconnu';
    const aerodrome = aerodromes.find(a => a.id === aerodromeId);
    return aerodrome ? aerodrome.code || aerodrome.name || 'Inconnu' : 'Inconnu';
}

// ============ FONCTIONS D'INITIALISATION ============

function initFormationTab() {
    const formationTab = document.getElementById('formation');
    if (!formationTab || !formationTab.classList.contains('active')) {
        return;
    }
    
    const inspectorsList = document.getElementById('inspectorsList');
    const trainingsList = document.getElementById('trainingsList');
    const formationsCalendar = document.getElementById('formationsCalendar');
    
    if (inspectorsList) loadInspectors();
    if (trainingsList) loadFormations();
    
    updateFormationDashboard();
    
    if (formationsCalendar) {
        generateAnnualCalendar('formationsCalendar', formations);
    }
}

// ============ FONCTIONS POUR KIT INSPECTEUR ============

let expandedCategories = new Set(['Reglementation', 'Procedures', 'Guides', 'Checklists']);

function initKitFileModal() {
    document.getElementById('kitFileId').value = '';
    document.getElementById('kitFileModalTitle').textContent = 'Nouveau Document du Kit Inspecteur';
    document.getElementById('kitFileName').value = '';
    document.getElementById('kitFileCategory').value = '';
    document.getElementById('kitFileDescription').value = '';
    document.getElementById('kitFileVersion').value = '';
    document.getElementById('kitFileDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('kitFileKeywords').value = '';
    document.getElementById('kitFileStatus').value = 'Actif';
    document.getElementById('kitFileList').innerHTML = '';
    
    // Désélectionner toutes les spécialités
    const specialtySelect = document.getElementById('kitFileSpecialty');
    Array.from(specialtySelect.options).forEach(option => {
        option.selected = false;
    });
}

function saveKitFile() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const name = document.getElementById('kitFileName').value;
    const category = document.getElementById('kitFileCategory').value;
    const status = document.getElementById('kitFileStatus').value;
    
    if (!name || !category || !status) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        const specialty = Array.from(document.getElementById('kitFileSpecialty').selectedOptions)
            .map(option => option.value);
        
        const kitFile = {
            id: document.getElementById('kitFileId').value || 'kit-' + Date.now(),
            name: name,
            category: category,
            description: document.getElementById('kitFileDescription').value,
            version: document.getElementById('kitFileVersion').value,
            date: document.getElementById('kitFileDate').value,
            specialty: specialty,
            keywords: document.getElementById('kitFileKeywords').value,
            status: status,
            dateCreation: new Date().toISOString(),
            // Simulation de fichier (dans une vraie application, ce serait un upload)
            fileName: document.getElementById('kitFileList').querySelector('.file-item') ? 
                     document.getElementById('kitFileList').querySelector('.file-item div').textContent : 
                     `${name}.pdf`,
            fileSize: "2.5 MB"
        };
        
        const existingIndex = kitFiles.findIndex(k => k.id === kitFile.id);
        if (existingIndex >= 0) {
            kitFiles[existingIndex] = kitFile;
            showNotification('Document modifié avec succès!', 'success');
        } else {
            kitFiles.push(kitFile);
            showNotification('Document créé avec succès!', 'success');
        }
        
        closeModal('modalKitFile');
        loadKitFiles();
        updateKitStats();
        hideLoading();
        saveAllData();
    }, 800);
}

function loadKitFiles(filteredList = null) {
    const container = document.getElementById('kitCategoriesContainer');
    if (!container) return;
    
    const list = filteredList || kitFiles;
    
    // Mettre à jour les statistiques
    updateKitStats();
    
    if (list.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-toolbox"></i>
                <h3>Aucun document</h3>
                <p>Cliquez sur "Ajouter un Document" pour commencer</p>
            </div>
        `;
        return;
    }
    
    // Grouper par catégorie
    const categories = {
        'Reglementation': [],
        'Procedures': [],
        'Guides': [],
        'Checklists': [],
        'Formulaires': [],
        'Rapports': []
    };
    
    list.forEach(file => {
        if (categories[file.category]) {
            categories[file.category].push(file);
        }
    });
    
    container.innerHTML = Object.entries(categories).map(([category, files]) => {
        if (files.length === 0) return '';
        
        const categoryNames = {
            'Reglementation': 'Règlementation',
            'Procedures': 'Procédures',
            'Guides': 'Guides',
            'Checklists': 'Check-lists',
            'Formulaires': 'Formulaires',
            'Rapports': 'Modèles de rapports'
        };
        
        const isExpanded = expandedCategories.has(category);
        const categoryColors = {
            'Reglementation': '#1e3a8a',
            'Procedures': '#0ea5e9',
            'Guides': '#10b981',
            'Checklists': '#f59e0b',
            'Formulaires': '#8b5cf6',
            'Rapports': '#dc2626'
        };
        
        return `
            <div class="kit-category">
                <div class="kit-category-header" onclick="toggleCategory('${category}')" style="cursor: pointer; background: ${categoryColors[category] || '#1e40af'};">
                    <div class="kit-category-title">
                        <i class="fas fa-folder${isExpanded ? '-open' : ''}"></i> 
                        ${categoryNames[category] || category}
                        <span class="kit-file-count">${files.length} document${files.length > 1 ? 's' : ''}</span>
                    </div>
                    <div class="kit-category-actions">
                        <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}"></i>
                    </div>
                </div>
                
                <div class="kit-files-list" style="display: ${isExpanded ? 'block' : 'none'};">
                    <div class="kit-files-grid">
                        ${files.map(file => {
                            const fileExtension = file.fileName ? file.fileName.split('.').pop().toLowerCase() : 'pdf';
                            let fileTypeClass = 'file-type-pdf';
                            let fileIcon = 'fa-file-pdf';
                            
                            if (['doc', 'docx'].includes(fileExtension)) {
                                fileTypeClass = 'file-type-doc';
                                fileIcon = 'fa-file-word';
                            } else if (['xls', 'xlsx'].includes(fileExtension)) {
                                fileTypeClass = 'file-type-xls';
                                fileIcon = 'fa-file-excel';
                            } else if (['ppt', 'pptx'].includes(fileExtension)) {
                                fileTypeClass = 'file-type-ppt';
                                fileIcon = 'fa-file-powerpoint';
                            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                                fileTypeClass = 'file-type-img';
                                fileIcon = 'fa-file-image';
                            } else if (fileExtension === 'zip') {
                                fileTypeClass = 'file-type-zip';
                                fileIcon = 'fa-file-archive';
                            }
                            
                            let statusClass = 'status-active';
                            if (file.status === 'Archivé') statusClass = 'status-closed';
                            else if (file.status === 'En révision') statusClass = 'status-pending';
                            
                            return `
                                <div class="kit-file-card" style="border-left: 4px solid ${categoryColors[file.category] || '#1e40af'}">
                                    <div class="kit-file-card-header">
                                        <div class="kit-file-icon-large">
                                            <i class="fas ${fileIcon}" style="font-size: 24px; color: ${categoryColors[file.category] || '#1e40af'};"></i>
                                        </div>
                                        <div class="kit-file-card-actions">
                                            <div class="dropdown">
                                                <button class="dropdown-toggle" style="background: none; border: none; cursor: pointer;">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="dropdown-menu">
                                                    <a href="#" onclick="viewDocument('${file.id}'); return false;">
                                                        <i class="fas fa-eye"></i> Visualiser
                                                    </a>
                                                    <a href="#" onclick="editKitFile('${file.id}'); return false;">
                                                        <i class="fas fa-edit"></i> Modifier
                                                    </a>
                                                    <a href="#" onclick="downloadKitFile('${file.id}'); return false;">
                                                        <i class="fas fa-download"></i> Télécharger
                                                    </a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="#" onclick="deleteKitFile('${file.id}'); return false;" style="color: var(--danger-color);">
                                                        <i class="fas fa-trash"></i> Supprimer
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="kit-file-card-body">
                                        <h4 class="kit-file-name" title="${file.name}">${file.name.length > 40 ? file.name.substring(0, 40) + '...' : file.name}</h4>
                                        
                                        ${file.description ? `
                                            <div class="kit-file-description">
                                                <p>${file.description.length > 100 ? file.description.substring(0, 100) + '...' : file.description}</p>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="kit-file-meta">
                                            <span class="file-type-badge ${fileTypeClass}">
                                                <i class="fas ${fileIcon}"></i> ${fileExtension.toUpperCase()}
                                            </span>
                                            <span class="status-badge ${statusClass}">
                                                ${file.status}
                                            </span>
                                        </div>
                                        
                                        <div class="kit-file-details">
                                            <div class="detail-item">
                                                <i class="fas fa-folder"></i>
                                                <span style="color: ${categoryColors[file.category] || '#1e40af'}; font-weight: 600;">${categoryNames[file.category] || file.category}</span>
                                            </div>
                                            ${file.version ? `
                                                <div class="detail-item">
                                                    <i class="fas fa-code-branch"></i>
                                                    <span>v${file.version}</span>
                                                </div>
                                            ` : ''}
                                            <div class="detail-item">
                                                <i class="fas fa-calendar"></i>
                                                <span>${new Date(file.date).toLocaleDateString('fr-FR')}</span>
                                            </div>
                                        </div>
                                        
                                        ${file.specialty && file.specialty.length > 0 ? `
                                            <div class="kit-file-specialties">
                                                <i class="fas fa-user-tie" style="color: #6b7280;"></i>
                                                ${file.specialty.map(s => `<span class="specialty-tag">${s}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="kit-file-card-footer">
                                        <button class="btn btn-primary btn-sm" onclick="viewDocument('${file.id}')" style="flex: 1;">
                                            <i class="fas fa-eye"></i> Voir
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="editKitFile('${file.id}')" style="flex: 1;">
                                            <i class="fas fa-edit"></i> Modifier
                                        </button>
                                        <button class="btn btn-success btn-sm" onclick="downloadKitFile('${file.id}')" style="flex: 1;">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleCategory(category) {
    if (expandedCategories.has(category)) {
        expandedCategories.delete(category);
    } else {
        expandedCategories.add(category);
    }
    loadKitFiles();
}

function updateKitStats() {
    const total = kitFiles.length;
    const reglementation = kitFiles.filter(f => f.category === 'Reglementation').length;
    const procedures = kitFiles.filter(f => f.category === 'Procedures').length;
    const guides = kitFiles.filter(f => f.category === 'Guides').length;
    const checklists = kitFiles.filter(f => f.category === 'Checklists').length;
    const formulaires = kitFiles.filter(f => f.category === 'Formulaires').length;
    const rapports = kitFiles.filter(f => f.category === 'Rapports').length;
    
    document.getElementById('stat-kit-total').textContent = total;
    document.getElementById('stat-kit-reglementation').textContent = reglementation;
    document.getElementById('stat-kit-procedures').textContent = procedures;
    document.getElementById('stat-kit-guides').textContent = guides;
    document.getElementById('stat-kit-checklists').textContent = checklists;
}

function editKitFile(id) {
    const file = kitFiles.find(f => f.id === id);
    if (!file) return;
    
    document.getElementById('kitFileId').value = file.id;
    document.getElementById('kitFileModalTitle').textContent = 'Modifier Document';
    document.getElementById('kitFileName').value = file.name;
    document.getElementById('kitFileCategory').value = file.category;
    document.getElementById('kitFileDescription').value = file.description || '';
    document.getElementById('kitFileVersion').value = file.version || '';
    document.getElementById('kitFileDate').value = file.date;
    document.getElementById('kitFileKeywords').value = file.keywords || '';
    document.getElementById('kitFileStatus').value = file.status;
    
    // Sélectionner les spécialités
    const specialtySelect = document.getElementById('kitFileSpecialty');
    Array.from(specialtySelect.options).forEach(option => {
        option.selected = file.specialty?.includes(option.value);
    });
    
    // Simuler le fichier téléchargé
    if (file.fileName) {
        const fileList = document.getElementById('kitFileList');
        fileList.innerHTML = `
            <div class="file-item">
                <div class="file-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${file.fileName}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${file.fileSize || '2.5 MB'}</div>
                </div>
                <button onclick="this.parentElement.remove();" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }
    
    openModal('modalKitFile');
}

function viewDocument(id) {
    const file = kitFiles.find(f => f.id === id);
    if (!file) return;
    
    const content = `
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="color: var(--primary-color); margin: 0;">
                    <i class="fas fa-file-alt"></i> ${file.name}
                </h3>
                <button class="btn btn-success" onclick="downloadKitFile('${file.id}')">
                    <i class="fas fa-download"></i> Télécharger
                </button>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Type de document</div>
                        <div>${file.category}</div>
                    </div>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Version</div>
                        <div>${file.version || 'Non spécifiée'}</div>
                    </div>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Date de publication</div>
                        <div>${new Date(file.date).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Statut</div>
                        <div>${file.status}</div>
                    </div>
                </div>
                
                ${file.description ? `
                    <div>
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Description</div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; line-height: 1.6;">
                            ${file.description}
                        </div>
                    </div>
                ` : ''}
                
                ${file.specialty && file.specialty.length > 0 ? `
                    <div>
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Spécialités concernées</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${file.specialty.map(s => `<span style="background: #dbeafe; color: #1e40af; padding: 5px 10px; border-radius: 20px; font-size: 14px;">${s}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${file.keywords ? `
                    <div>
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Mots-clés</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${file.keywords.split(',').map(k => k.trim()).filter(k => k).map(k => 
                                `<span style="background: #f3f4f6; color: #4b5563; padding: 5px 10px; border-radius: 20px; font-size: 14px;">${k}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Zone de visualisation du document (simulée) -->
                <div style="flex: 1; background: #f9fafb; border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <i class="fas fa-file-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 15px;"></i>
                        <div style="font-size: 18px; color: #374151; margin-bottom: 10px;">${file.fileName || file.name + '.pdf'}</div>
                        <div style="color: #6b7280;">Prévisualisation du document (2.5 MB)</div>
                        <button class="btn btn-primary" onclick="downloadKitFile('${file.id}')" style="margin-top: 20px;">
                            <i class="fas fa-download"></i> Télécharger le document complet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('documentViewerContent').innerHTML = content;
    openModal('modalDocumentViewer');
}

function deleteKitFile(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer ce document ? Cette action est irréversible.')) {
        kitFiles = kitFiles.filter(f => f.id !== id);
        loadKitFiles();
        updateKitStats();
        showNotification('Document supprimé avec succès', 'success');
        saveAllData();
    }
}

function downloadKitFile(id) {
    const file = kitFiles.find(f => f.id === id);
    if (file) {
        showNotification(`Téléchargement de "${file.name}"...`, 'info');
        
        // Simulation du téléchargement
        setTimeout(() => {
            // Dans une vraie application, vous utiliseriez:
            // window.location.href = file.downloadUrl;
            
            showNotification('Fichier téléchargé avec succès', 'success');
            
            // Créer un lien de téléchargement simulé
            const blob = new Blob([`Contenu du document: ${file.name}`], { type: 'application/pdf' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.fileName || file.name + '.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 1000);
    }
}

function triggerKitFileUpload() {
    document.getElementById('kitFileInput')?.click();
}

function handleKitFile(input) {
    const fileList = document.getElementById('kitFileList');
    if (!fileList) return;
    
    if (input.files.length > 0) {
        const file = input.files[0];
        
        // Vérifier la taille du fichier (max 50MB)
        if (file.size > 50 * 1024 * 1024) {
            showNotification('Le fichier est trop volumineux (max 50MB)', 'error');
            return;
        }
        
        // Pré-remplir le nom si vide
        const nameInput = document.getElementById('kitFileName');
        if (!nameInput.value) {
            nameInput.value = file.name.replace(/\.[^/.]+$/, ""); // Enlever l'extension
        }
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
            </div>
            <button onclick="this.parentElement.remove(); document.getElementById('kitFileInput').value = '';" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.innerHTML = '';
        fileList.appendChild(fileItem);
        showNotification('Fichier ajouté avec succès', 'success');
    }
}

function filterKitFiles() {
    const specialtyFilter = document.getElementById('filterSpecialty').value;
    const categoryFilter = document.getElementById('filterCategory').value;
    const statusFilter = document.getElementById('filterStatus').value;
    const searchFilter = document.getElementById('searchKitFile').value.toLowerCase();
    
    let filtered = kitFiles;
    
    if (specialtyFilter) {
        filtered = filtered.filter(f => 
            f.specialty?.includes(specialtyFilter) || 
            f.specialty?.includes('Toutes') ||
            !f.specialty || 
            f.specialty.length === 0
        );
    }
    
    if (categoryFilter) {
        filtered = filtered.filter(f => f.category === categoryFilter);
    }
    
    if (statusFilter) {
        filtered = filtered.filter(f => f.status === statusFilter);
    }
    
    if (searchFilter) {
        filtered = filtered.filter(f => 
            f.name.toLowerCase().includes(searchFilter) ||
            (f.description && f.description.toLowerCase().includes(searchFilter)) ||
            (f.keywords && f.keywords.toLowerCase().includes(searchFilter))
        );
    }
    
    loadKitFiles(filtered);
}

function resetKitFilters() {
    document.getElementById('filterSpecialty').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchKitFile').value = '';
    loadKitFiles();
}

function exportAllKitFiles() {
    showNotification('Préparation de l\'export de tous les fichiers...', 'info');
    
    setTimeout(() => {
        const exportData = {
            date: new Date().toISOString(),
            totalFiles: kitFiles.length,
            files: kitFiles.map(f => ({
                name: f.name,
                category: f.category,
                version: f.version,
                date: f.date,
                status: f.status,
                specialty: f.specialty,
                description: f.description,
                keywords: f.keywords
            }))
        };
        
        // Créer un fichier JSON téléchargeable
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `export-kit-inspecteur-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Export réussi! ' + kitFiles.length + ' fichiers exportés.', 'success');
    }, 1500);
}


// ============ FONCTIONS POUR UTILISATEURS ============

function initUtilisateurModal() {
    document.getElementById('utilisateurId').value = '';
    document.getElementById('utilisateurModalTitle').textContent = 'Nouvel Utilisateur';
    document.getElementById('utilisateurNom').value = '';
    document.getElementById('utilisateurPrenom').value = '';
    document.getElementById('utilisateurLogin').value = '';
    document.getElementById('utilisateurPassword').value = '';
    document.getElementById('utilisateurEmail').value = '';
    document.getElementById('utilisateurPhone').value = '';
    document.getElementById('utilisateurRole').value = '';
    document.getElementById('utilisateurService').value = '';
    document.getElementById('utilisateurDateDebut').value = '';
    document.getElementById('utilisateurStatus').value = 'Actif';
}

function saveUtilisateur() {
    if (!checkPermission('manage_users')) {
        showNotification('Permission refusée. Seul l\'administrateur peut gérer les utilisateurs.', 'error');
        return;
    }
    
    const nom = document.getElementById('utilisateurNom').value;
    const prenom = document.getElementById('utilisateurPrenom').value;
    const login = document.getElementById('utilisateurLogin').value;
    const password = document.getElementById('utilisateurPassword').value;
    const email = document.getElementById('utilisateurEmail').value;
    const role = document.getElementById('utilisateurRole').value;
    const status = document.getElementById('utilisateurStatus').value;
    
    if (!nom || !prenom || !login || !password || !email || !role || !status) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    // Vérifier si le login existe déjà
    const existingUser = utilisateurs.find(u => u.login === login && u.id !== document.getElementById('utilisateurId').value);
    if (existingUser) {
        showNotification('Ce login est déjà utilisé', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        const utilisateur = {
            id: document.getElementById('utilisateurId').value || 'user-' + Date.now(),
            nom: nom,
            prenom: prenom,
            login: login,
            password: password, // Dans un vrai système, il faudrait hasher le mot de passe
            email: email,
            phone: document.getElementById('utilisateurPhone').value,
            role: role,
            service: document.getElementById('utilisateurService').value,
            dateDebut: document.getElementById('utilisateurDateDebut').value,
            status: status,
            dateCreation: new Date().toISOString()
        };
        
        const existingIndex = utilisateurs.findIndex(u => u.id === utilisateur.id);
        if (existingIndex >= 0) {
            utilisateurs[existingIndex] = utilisateur;
            showNotification('Utilisateur modifié avec succès!', 'success');
        } else {
            utilisateurs.push(utilisateur);
            showNotification('Utilisateur créé avec succès!', 'success');
        }
        
        closeModal('modalUtilisateur');
        loadUtilisateurs();
        hideLoading();
        saveAllData();
    }, 800);
}

function loadUtilisateurs(filteredList = null) {
    const tbody = document.getElementById('utilisateursTable');
    if (!tbody) return;
    
    const list = filteredList || utilisateurs;
    
    if (list.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5; display: block;"></i>
                    <h3>Aucun utilisateur</h3>
                    <p>Cliquez sur "Nouvel Utilisateur" pour commencer</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = list.map(user => {
        let statusClass = 'status-active';
        if (user.status === 'Inactif') statusClass = 'status-closed';
        else if (user.status === 'Suspendu') statusClass = 'status-pending';
        
        let roleClass = 'permission-admin';
        if (user.role === 'inspecteur') roleClass = 'permission-inspecteur';
        else if (user.role === 'service_normes' || user.role === 'service_securite') roleClass = 'permission-service';
        
        const roleNames = {
            'admin': 'Administrateur',
            'inspecteur': 'Inspecteur',
            'service_normes': 'Service Normes',
            'service_securite': 'Service Sécurité',
            'consultant': 'Consultant'
        };
        
        return `
            <tr>
                <td><strong>${user.login}</strong></td>
                <td>${user.nom} ${user.prenom}</td>
                <td><span class="permission-badge ${roleClass}">${roleNames[user.role] || user.role}</span></td>
                <td>${user.service || 'Non spécifié'}</td>
                <td>${new Date(user.dateCreation).toLocaleDateString('fr-FR')}</td>
                <td><span class="status-badge ${statusClass}">${user.status}</span></td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-primary" onclick="editUtilisateur('${user.id}')" style="padding: 8px 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info" onclick="viewUtilisateurDetails('${user.id}')" style="padding: 8px 12px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteUtilisateur('${user.id}')" style="padding: 8px 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function editUtilisateur(id) {
    const user = utilisateurs.find(u => u.id === id);
    if (!user) return;
    
    document.getElementById('utilisateurId').value = user.id;
    document.getElementById('utilisateurModalTitle').textContent = 'Modifier Utilisateur';
    document.getElementById('utilisateurNom').value = user.nom;
    document.getElementById('utilisateurPrenom').value = user.prenom;
    document.getElementById('utilisateurLogin').value = user.login;
    document.getElementById('utilisateurPassword').value = user.password;
    document.getElementById('utilisateurEmail').value = user.email;
    document.getElementById('utilisateurPhone').value = user.phone || '';
    document.getElementById('utilisateurRole').value = user.role;
    document.getElementById('utilisateurService').value = user.service || '';
    document.getElementById('utilisateurDateDebut').value = user.dateDebut || '';
    document.getElementById('utilisateurStatus').value = user.status;
    
    openModal('modalUtilisateur');
}

function viewUtilisateurDetails(id) {
    const user = utilisateurs.find(u => u.id === id);
    if (!user) return;
    
    const roleNames = {
        'admin': 'Administrateur',
        'inspecteur': 'Inspecteur',
        'service_normes': 'Service Normes d\'Aérodromes',
        'service_securite': 'Service Sécurité des Aérodromes',
        'consultant': 'Consultant'
    };
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                Profil Utilisateur - ${user.nom} ${user.prenom}
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Informations Générales</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Nom complet</div>
                        <div class="detail-value">${user.nom} ${user.prenom}</div>
                    </div>
                    <div>
                        <div class="detail-label">Identifiant</div>
                        <div class="detail-value">${user.login}</div>
                    </div>
                    <div>
                        <div class="detail-label">Rôle</div>
                        <div class="detail-value">${roleNames[user.role] || user.role}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Service</div>
                        <div class="detail-value">${user.service || 'Non spécifié'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Statut</div>
                        <div class="detail-value">${user.status}</div>
                    </div>
                    <div>
                        <div class="detail-label">Date de création</div>
                        <div class="detail-value">${new Date(user.dateCreation).toLocaleDateString('fr-FR')}</div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Contact</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${user.email}</div>
                    </div>
                    <div>
                        <div class="detail-label">Téléphone</div>
                        <div class="detail-value">${user.phone || 'Non spécifié'}</div>
                    </div>
                    <div>
                        <div class="detail-label">Date de début</div>
                        <div class="detail-value">${user.dateDebut ? new Date(user.dateDebut).toLocaleDateString('fr-FR') : 'Non spécifiée'}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

function deleteUtilisateur(id) {
    if (!checkPermission('manage_users')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
        utilisateurs = utilisateurs.filter(u => u.id !== id);
        loadUtilisateurs();
        showNotification('Utilisateur supprimé avec succès', 'success');
        saveAllData();
    }
}

function filterUtilisateurs() {
    const role = document.getElementById('filterUserRole')?.value || '';
    const status = document.getElementById('filterUserStatus')?.value || '';
    const service = document.getElementById('filterUserService')?.value || '';
    const search = document.getElementById('searchUserKeyword')?.value.toLowerCase() || '';
    
    let filtered = [...utilisateurs];
    
    if (role) filtered = filtered.filter(u => u.role === role);
    if (status) filtered = filtered.filter(u => u.status === status);
    if (service) filtered = filtered.filter(u => u.service === service);
    
    if (search) {
        filtered = filtered.filter(u => {
            const searchText = `${u.nom || ''} ${u.prenom || ''} ${u.login || ''} ${u.email || ''}`.toLowerCase();
            return searchText.includes(search);
        });
    }
    
    loadUtilisateurs(filtered);
}

function resetUserFilters() {
    if (document.getElementById('filterUserRole')) document.getElementById('filterUserRole').value = '';
    if (document.getElementById('filterUserStatus')) document.getElementById('filterUserStatus').value = '';
    if (document.getElementById('filterUserService')) document.getElementById('filterUserService').value = '';
    if (document.getElementById('searchUserKeyword')) document.getElementById('searchUserKeyword').value = '';
    loadUtilisateurs();
}

function sortUtilisateurs(field, direction = 'asc') {
    currentUtilisateurSort = { field, direction };
    
    const sorted = [...utilisateurs].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'nom') {
            aVal = (a.nom + ' ' + a.prenom).toLowerCase();
            bVal = (b.nom + ' ' + b.prenom).toLowerCase();
        } else if (field === 'date') {
            aVal = new Date(a.dateCreation);
            bVal = new Date(b.dateCreation);
        } else {
            aVal = a[field] || '';
            bVal = b[field] || '';
        }
        
        return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    
    loadUtilisateurs(sorted);
}

// ============ FONCTIONS POUR ÉVÉNEMENTS ============

// Initialisation du graphique
function initEvenementsChart() {
    const ctx = document.getElementById('evenementsChart');
    if (!ctx) return;
    
    // Destruction du graphique existant
    if (chartEvenements) {
        chartEvenements.destroy();
    }
    
    // Données pour les 6 derniers mois
    const moisLabels = [];
    const donneesEvenements = [];
    const now = new Date();
    
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const mois = date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
        moisLabels.push(mois.charAt(0).toUpperCase() + mois.slice(1));
        
        // Compter les événements pour ce mois
        const debutMois = new Date(date.getFullYear(), date.getMonth(), 1);
        const finMois = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        const count = evenements.filter(e => {
            const eventDate = new Date(e.date);
            return eventDate >= debutMois && eventDate <= finMois;
        }).length;
        
        donneesEvenements.push(count);
    }
    
    // Création du graphique
    chartEvenements = new Chart(ctx, {
        type: 'line',
        data: {
            labels: moisLabels,
            datasets: [{
                label: 'Événements',
                data: donneesEvenements,
                backgroundColor: 'rgba(30, 64, 175, 0.1)',
                borderColor: '#1e40af',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

function initEvenementModal() {
    document.getElementById('evenementId').value = '';
    document.getElementById('evenementModalTitle').textContent = 'Nouvel Événement';
    document.getElementById('evenementAerodrome').value = '';
    document.getElementById('evenementType').value = '';
    document.getElementById('evenementDate').value = new Date().toISOString().slice(0, 16);
    document.getElementById('evenementGravite').value = 'Mineur';
    document.getElementById('evenementDescription').value = '';
    document.getElementById('evenementRapporteur').value = '';
    document.getElementById('evenementStatus').value = 'Signalé';
    document.getElementById('evenementActions').value = '';
    document.getElementById('evenementFileList').innerHTML = '';
    
    updateAerodromeSelects();
}

function saveEvenement() {
    if (!checkPermission('write')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    const aerodromeId = document.getElementById('evenementAerodrome').value;
    const type = document.getElementById('evenementType').value;
    const date = document.getElementById('evenementDate').value;
    const gravite = document.getElementById('evenementGravite').value;
    const description = document.getElementById('evenementDescription').value;
    const rapporteur = document.getElementById('evenementRapporteur').value;
    const status = document.getElementById('evenementStatus').value;
    
    if (!aerodromeId || !type || !date || !gravite || !description || !rapporteur || !status) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    showLoading();
    
    setTimeout(() => {
        // Récupérer les fichiers uploadés
        const files = [];
        const fileItems = document.getElementById('evenementFileList').querySelectorAll('.file-item');
        fileItems.forEach(item => {
            const fileName = item.querySelector('div:first-child').textContent;
            const fileSize = item.querySelector('div:last-child').textContent;
            files.push({
                id: 'file-' + Date.now() + Math.random(),
                name: fileName,
                size: fileSize,
                type: fileName.split('.').pop().toLowerCase()
            });
        });
        
        const evenement = {
            id: document.getElementById('evenementId').value || 'event-' + Date.now(),
            aerodromeId: aerodromeId,
            type: type,
            date: date,
            gravite: gravite,
            description: description,
            rapporteur: rapporteur,
            status: status,
            actions: document.getElementById('evenementActions').value,
            files: files,
            dateCreation: new Date().toISOString()
        };
        
        const existingIndex = evenements.findIndex(e => e.id === evenement.id);
        if (existingIndex >= 0) {
            evenements[existingIndex] = evenement;
            showNotification('Événement modifié avec succès!', 'success');
        } else {
            evenements.push(evenement);
            showNotification('Événement créé avec succès!', 'success');
        }
        
        closeModal('modalEvenement');
        loadEvenements();
        updateEvenementStats();
        initEvenementsChart();
        hideLoading();
        saveAllData();
    }, 800);
}

function loadEvenements(filteredList = null) {
    const container = document.getElementById('evenementsList');
    if (!container) return;
    
    const list = filteredList || evenements;
    
    if (list.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Aucun événement</h3>
                <p>Cliquez sur "Nouvel Événement" pour commencer</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = list.map(event => {
        const aerodrome = aerodromes.find(a => a.id === event.aerodromeId);
        
        // Classes et couleurs selon la gravité
        let graviteClass = 'badge-minor';
        let graviteIcon = 'info-circle';
        let cardBorderColor = '#10b981';
        
        if (event.gravite === 'Critique') {
            graviteClass = 'badge-critical';
            graviteIcon = 'skull-crossbones';
            cardBorderColor = '#dc2626';
        } else if (event.gravite === 'Majeur') {
            graviteClass = 'badge-major';
            graviteIcon = 'exclamation-triangle';
            cardBorderColor = '#f59e0b';
        }
        
        // Classes selon le statut
        let statusClass = 'status-pending';
        let statusIcon = 'clock';
        
        if (event.status === 'Clôturé') {
            statusClass = 'status-completed';
            statusIcon = 'check-circle';
        } else if (event.status === 'Traité') {
            statusClass = 'status-active';
            statusIcon = 'check';
        } else if (event.status === 'En investigation') {
            statusClass = 'status-investigation';
            statusIcon = 'search';
        }
        
        // Type d'événement avec icône
        let typeIcon = 'exclamation-circle';
        if (event.type === 'Accident') typeIcon = 'car-crash';
        else if (event.type === 'Incident') typeIcon = 'exclamation';
        else if (event.type === 'Non-conformité') typeIcon = 'times-circle';
        else if (event.type === 'Défaut') typeIcon = 'tools';
        else if (event.type === 'Météo') typeIcon = 'cloud-bolt';
        else if (event.type === 'Sécurité') typeIcon = 'shield-alt';
        
        return `
            <div class="event-card" style="border-left: 4px solid ${cardBorderColor}">
                <div class="event-header">
                    <div class="event-title">
                        <i class="fas fa-${typeIcon}"></i>
                        ${event.type}
                        <span class="event-aerodrome">${aerodrome?.code || 'Inconnu'}</span>
                    </div>
                    <div class="event-date">
                        <i class="far fa-clock"></i>
                        ${new Date(event.date).toLocaleDateString('fr-FR')}
                        ${new Date(event.date).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
                
                <div class="event-body">
                    <div class="event-meta">
                        <span class="${graviteClass}">
                            <i class="fas fa-${graviteIcon}"></i>
                            ${event.gravite}
                        </span>
                        <span class="${statusClass}">
                            <i class="fas fa-${statusIcon}"></i>
                            ${event.status}
                        </span>
                        ${event.files && event.files.length > 0 ? `
                            <span class="badge-files">
                                <i class="fas fa-paperclip"></i>
                                ${event.files.length} fichier(s)
                            </span>
                        ` : ''}
                    </div>
                    
                    <div class="event-description">
                        ${event.description.length > 150 ? event.description.substring(0, 150) + '...' : event.description}
                    </div>
                    
                    <div class="event-details">
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <span>${event.rapporteur}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${aerodrome?.name || 'Aérodrome inconnu'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>Créé le ${new Date(event.dateCreation).toLocaleDateString('fr-FR')}</span>
                        </div>
                    </div>
                    
                    ${event.actions ? `
                        <div class="event-actions">
                            <div class="event-actions-label">
                                <i class="fas fa-bolt"></i> Actions immédiates:
                            </div>
                            <div class="event-actions-content">
                                ${event.actions.length > 80 ? event.actions.substring(0, 80) + '...' : event.actions}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="event-footer">
                    <button class="btn btn-primary btn-sm" onclick="viewEventDetails('${event.id}')">
                        <i class="fas fa-eye"></i> Voir
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="editEvenement('${event.id}')">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    ${event.files && event.files.length > 0 ? `
                        <div class="dropdown">
                            <button class="btn btn-info btn-sm dropdown-toggle">
                                <i class="fas fa-download"></i> Fichiers
                            </button>
                            <div class="dropdown-menu">
                                ${event.files.map(file => `
                                    <a href="#" onclick="downloadEventFile('${event.id}', '${file.id}'); return false;">
                                        <i class="fas fa-file"></i> ${file.name} (${file.size})
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <button class="btn btn-danger btn-sm" onclick="deleteEvenement('${event.id}')">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function updateEvenementStats() {
    const total = evenements.length;
    const critiques = evenements.filter(e => e.gravite === 'Critique').length;
    const majeurs = evenements.filter(e => e.gravite === 'Majeur').length;
    const ouverts = evenements.filter(e => e.status !== 'Clôturé').length;
    
    const now = new Date();
    const thisMonth = evenements.filter(e => {
        const eDate = new Date(e.date);
        return eDate.getMonth() === now.getMonth() && eDate.getFullYear() === now.getFullYear();
    }).length;
    
    document.getElementById('stat-evenements-total').textContent = total;
    document.getElementById('stat-evenements-critiques').textContent = critiques;
    document.getElementById('stat-evenements-majeurs').textContent = majeurs;
    document.getElementById('stat-evenements-ouverts').textContent = ouverts;
    document.getElementById('stat-evenements-mois').textContent = thisMonth;
}

function viewEventDetails(id) {
    const event = evenements.find(e => e.id === id);
    if (!event) return;
    
    const aerodrome = aerodromes.find(a => a.id === event.aerodromeId);
    
    // Couleurs selon la gravité
    let graviteColor = '#10b981';
    let graviteIcon = 'info-circle';
    if (event.gravite === 'Critique') {
        graviteColor = '#dc2626';
        graviteIcon = 'skull-crossbones';
    } else if (event.gravite === 'Majeur') {
        graviteColor = '#f59e0b';
        graviteIcon = 'exclamation-triangle';
    }
    
    const content = `
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="color: var(--primary-color); margin: 0;">
                    <i class="fas fa-exclamation-triangle"></i> Détails de l'événement
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="editEvenement('${event.id}')">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button class="btn btn-danger" onclick="deleteEvenement('${event.id}')">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
            
            <div style="flex: 1; overflow-y: auto;">
                <!-- En-tête avec gravité et statut -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Gravité</div>
                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 15px; background: ${graviteColor}15; border-left: 4px solid ${graviteColor}; border-radius: 6px;">
                            <i class="fas fa-${graviteIcon}" style="color: ${graviteColor};"></i>
                            <span style="color: ${graviteColor}; font-weight: 600;">${event.gravite}</span>
                        </div>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Statut</div>
                        <div style="padding: 8px 15px; background: #f8fafc; border-left: 4px solid #0ea5e9; border-radius: 6px; font-weight: 600;">
                            ${event.status}
                        </div>
                    </div>
                    
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">Type</div>
                        <div style="padding: 8px 15px; background: #f8fafc; border-left: 4px solid #8b5cf6; border-radius: 6px; font-weight: 600;">
                            ${event.type}
                        </div>
                    </div>
                </div>
                
                <!-- Informations principales -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">
                            <i class="fas fa-map-marker-alt"></i> Aérodrome
                        </div>
                        <div>${aerodrome?.name || 'Inconnu'} (${aerodrome?.code || 'N/A'})</div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">
                            <i class="far fa-clock"></i> Date et heure
                        </div>
                        <div>${new Date(event.date).toLocaleString('fr-FR')}</div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">
                            <i class="fas fa-user"></i> Rapporteur
                        </div>
                        <div>${event.rapporteur}</div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">
                            <i class="fas fa-calendar"></i> Date de création
                        </div>
                        <div>${new Date(event.dateCreation).toLocaleString('fr-FR')}</div>
                    </div>
                </div>
                
                <!-- Description -->
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-align-left"></i> Description
                    </div>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; line-height: 1.6;">
                        ${event.description}
                    </div>
                </div>
                
                <!-- Actions immédiates -->
                ${event.actions ? `
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-bolt"></i> Actions immédiates
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; line-height: 1.6;">
                            ${event.actions}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Fichiers associés -->
                ${event.files && event.files.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-paperclip"></i> Fichiers associés (${event.files.length})
                        </div>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${event.files.map(file => {
                                    let fileIcon = 'fa-file';
                                    let fileColor = '#6b7280';
                                    
                                    const ext = file.type.toLowerCase();
                                    if (['pdf'].includes(ext)) {
                                        fileIcon = 'fa-file-pdf';
                                        fileColor = '#dc2626';
                                    } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                                        fileIcon = 'fa-file-image';
                                        fileColor = '#10b981';
                                    } else if (['doc', 'docx'].includes(ext)) {
                                        fileIcon = 'fa-file-word';
                                        fileColor = '#2563eb';
                                    } else if (['xls', 'xlsx'].includes(ext)) {
                                        fileIcon = 'fa-file-excel';
                                        fileColor = '#059669';
                                    }
                                    
                                    return `
                                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <i class="fas ${fileIcon}" style="color: ${fileColor}; font-size: 20px;"></i>
                                                <div>
                                                    <div style="font-weight: 600; color: #374151;">${file.name}</div>
                                                    <div style="font-size: 12px; color: #6b7280;">${file.size}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="btn btn-sm btn-primary" onclick="viewEventFile('${event.id}', '${file.id}')">
                                                    <i class="fas fa-eye"></i> Voir
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="downloadEventFile('${event.id}', '${file.id}')">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = content;
    document.getElementById('modalCustom').classList.add('active');
}

function editEvenement(id) {
    const event = evenements.find(e => e.id === id);
    if (!event) return;
    
    document.getElementById('evenementId').value = event.id;
    document.getElementById('evenementModalTitle').textContent = 'Modifier Événement';
    document.getElementById('evenementAerodrome').value = event.aerodromeId;
    document.getElementById('evenementType').value = event.type;
    document.getElementById('evenementDate').value = event.date;
    document.getElementById('evenementGravite').value = event.gravite;
    document.getElementById('evenementDescription').value = event.description;
    document.getElementById('evenementRapporteur').value = event.rapporteur;
    document.getElementById('evenementStatus').value = event.status;
    document.getElementById('evenementActions').value = event.actions || '';
    
    // Afficher les fichiers existants
    const fileList = document.getElementById('evenementFileList');
    fileList.innerHTML = '';
    
    if (event.files && event.files.length > 0) {
        event.files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.setAttribute('data-file-id', file.id);
            fileItem.innerHTML = `
                <div class="file-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">${file.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${file.size}</div>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        });
    }
    
    openModal('modalEvenement');
}

function deleteEvenement(id) {
    if (!checkPermission('delete')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cet événement ? Cette action est irréversible.')) {
        evenements = evenements.filter(e => e.id !== id);
        loadEvenements();
        updateEvenementStats();
        initEvenementsChart();
        showNotification('Événement supprimé avec succès', 'success');
        saveAllData();
    }
}

function triggerEvenementFileUpload() {
    document.getElementById('evenementFileInput')?.click();
}

function handleEvenementFiles(input) {
    const fileList = document.getElementById('evenementFileList');
    if (!fileList) return;
    
    Array.from(input.files).forEach(file => {
        // Vérifier la taille du fichier (max 50MB)
        if (file.size > 50 * 1024 * 1024) {
            showNotification(`Le fichier "${file.name}" est trop volumineux (max 50MB)`, 'error');
            return;
        }
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
            </div>
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--danger-color); cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    if (input.files.length > 0) {
        showNotification(`${input.files.length} fichier(s) ajouté(s)`, 'success');
    }
}

function viewEventFile(eventId, fileId) {
    const event = evenements.find(e => e.id === eventId);
    if (!event || !event.files) return;
    
    const file = event.files.find(f => f.id === fileId);
    if (!file) return;
    
    const content = `
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                <h3 style="color: var(--primary-color); margin: 0;">
                    <i class="fas fa-file"></i> ${file.name}
                </h3>
                <button class="btn btn-success" onclick="downloadEventFile('${eventId}', '${fileId}')">
                    <i class="fas fa-download"></i> Télécharger
                </button>
            </div>
            
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                ${['jpg', 'jpeg', 'png', 'gif'].includes(file.type) ? `
                    <div style="text-align: center;">
                        <i class="fas fa-file-image" style="font-size: 64px; color: #9ca3af; margin-bottom: 20px;"></i>
                        <div style="font-size: 18px; color: #374151; margin-bottom: 10px;">${file.name}</div>
                        <div style="color: #6b7280;">Image - ${file.size}</div>
                        <div style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                            <i class="fas fa-info-circle" style="color: #0ea5e9;"></i>
                            <span style="margin-left: 8px;">La visualisation des images est simulée</span>
                        </div>
                    </div>
                ` : ['pdf'].includes(file.type) ? `
                    <div style="text-align: center;">
                        <i class="fas fa-file-pdf" style="font-size: 64px; color: #dc2626; margin-bottom: 20px;"></i>
                        <div style="font-size: 18px; color: #374151; margin-bottom: 10px;">${file.name}</div>
                        <div style="color: #6b7280;">Document PDF - ${file.size}</div>
                        <div style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                            <i class="fas fa-info-circle" style="color: #0ea5e9;"></i>
                            <span style="margin-left: 8px;">La visualisation des PDF est simulée</span>
                        </div>
                    </div>
                ` : `
                    <div style="text-align: center;">
                        <i class="fas fa-file-alt" style="font-size: 64px; color: #9ca3af; margin-bottom: 20px;"></i>
                        <div style="font-size: 18px; color: #374151; margin-bottom: 10px;">${file.name}</div>
                        <div style="color: #6b7280;">${file.type.toUpperCase()} - ${file.size}</div>
                        <div style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                            <i class="fas fa-info-circle" style="color: #0ea5e9;"></i>
                            <span style="margin-left: 8px;">La visualisation de ce type de fichier est simulée</span>
                        </div>
                    </div>
                `}
                
                <button class="btn btn-primary" onclick="downloadEventFile('${eventId}', '${fileId}')" style="margin-top: 30px;">
                    <i class="fas fa-download"></i> Télécharger le fichier complet
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('fileViewerContent').innerHTML = content;
    openModal('modalFileViewer');
}

function downloadEventFile(eventId, fileId) {
    const event = evenements.find(e => e.id === eventId);
    if (!event || !event.files) return;
    
    const file = event.files.find(f => f.id === fileId);
    if (!file) return;
    
    showNotification(`Téléchargement de "${file.name}"...`, 'info');
    
    // Simulation du téléchargement
    setTimeout(() => {
        // Dans une vraie application, vous utiliseriez:
        // window.location.href = file.downloadUrl;
        
        // Créer un lien de téléchargement simulé
        const blob = new Blob([`Contenu du fichier associé à l'événement: ${event.type}\n\nDescription: ${event.description}\n\nFichier: ${file.name}`], { 
            type: file.type === 'pdf' ? 'application/pdf' : 'text/plain' 
        });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Fichier téléchargé avec succès', 'success');
    }, 1000);
}

function filterEvenements() {
    const type = document.getElementById('filterEventType')?.value || '';
    const gravite = document.getElementById('filterEventGravite')?.value || '';
    const status = document.getElementById('filterEventStatus')?.value || '';
    const search = document.getElementById('searchEventKeyword')?.value.toLowerCase() || '';
    
    let filtered = [...evenements];
    
    if (type) filtered = filtered.filter(e => e.type === type);
    if (gravite) filtered = filtered.filter(e => e.gravite === gravite);
    if (status) filtered = filtered.filter(e => e.status === status);
    
    if (search) {
        filtered = filtered.filter(e => {
            const aerodrome = aerodromes.find(a => a.id === e.aerodromeId);
            const searchText = `${e.type || ''} ${e.description || ''} ${e.rapporteur || ''} ${aerodrome?.code || ''} ${aerodrome?.name || ''}`.toLowerCase();
            return searchText.includes(search);
        });
    }
    
    loadEvenements(filtered);
}

function resetEventFilters() {
    if (document.getElementById('filterEventType')) document.getElementById('filterEventType').value = '';
    if (document.getElementById('filterEventGravite')) document.getElementById('filterEventGravite').value = '';
    if (document.getElementById('filterEventStatus')) document.getElementById('filterEventStatus').value = '';
    if (document.getElementById('searchEventKeyword')) document.getElementById('searchEventKeyword').value = '';
    loadEvenements();
}

function sortEvenements(field, direction = 'asc') {
    currentEvenementSort = { field, direction };
    
    const sorted = [...evenements].sort((a, b) => {
        let aVal, bVal;
        
        if (field === 'date') {
            aVal = new Date(a.date);
            bVal = new Date(b.date);
        } else if (field === 'gravite') {
            const graviteOrder = { 'Critique': 3, 'Majeur': 2, 'Mineur': 1 };
            aVal = graviteOrder[a.gravite] || 0;
            bVal = graviteOrder[b.gravite] || 0;
        } else if (field === 'type') {
            aVal = a.type || '';
            bVal = b.type || '';
        } else {
            aVal = a[field] || '';
            bVal = b[field] || '';
        }
        
        return direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
    });
    
    loadEvenements(sorted);
}


// ============ FONCTIONS POUR ALERTES SIMPLIFIÉES ============

// Initialiser la modal d'alerte
function initAlerteModal() {
    document.getElementById('alerteId').value = '';
    document.getElementById('alerteModalTitle').textContent = 'Nouvelle Alerte Urgente';
    document.getElementById('alerteTitre').value = '';
    document.getElementById('alerteType').value = '';
    
    // Définir la date d'échéance par défaut à 24h
    const tomorrow = new Date();
    tomorrow.setHours(tomorrow.getHours() + 24);
    document.getElementById('alerteDateEcheance').value = tomorrow.toISOString().slice(0, 16);
    
    document.getElementById('alerteUrgence').value = 'Critique';
    document.getElementById('alerteDescription').value = '';
    document.getElementById('alerteLocalisation').value = '';
    
    // Charger la liste des inspecteurs
    const destinatairesSelect = document.getElementById('alerteDestinataires');
    destinatairesSelect.innerHTML = '';
    
    // Ajouter tous les inspecteurs disponibles
    inspectors.forEach(inspector => {
        const option = document.createElement('option');
        option.value = inspector.id;
        option.textContent = `${inspector.lastName} ${inspector.firstName} - ${inspector.specialty}`;
        
        // Vérifier si l'inspecteur a un email
        if (inspector.email) {
            option.setAttribute('data-email', inspector.email);
        }
        
        destinatairesSelect.appendChild(option);
    });
    
    // Sélectionner tous les inspecteurs par défaut
    Array.from(destinatairesSelect.options).forEach(option => {
        option.selected = true;
    });
    
    // Initialiser les actions
    const actionsSelect = document.getElementById('alerteActions');
    actionsSelect.innerHTML = `
        <option value="Inspection immédiate">Inspection immédiate</option>
        <option value="Rapport dans 24h">Rapport dans 24h</option>
        <option value="Suspension temporaire">Suspension temporaire</option>
        <option value="Réunion d'urgence">Réunion d'urgence</option>
        <option value="Contrôle renforcé">Contrôle renforcé</option>
    `;
}

// Ouvrir la modal d'alerte
function openAlerteModal() {
    // Vérifier les permissions
    if (!checkPermission('manage_users')) {
        showNotification('Seuls les administrateurs peuvent créer des alertes.', 'error');
        return;
    }
    
    initAlerteModal();
    openModal('modalAlerte');
}

// Sauvegarder et envoyer l'alerte
async function saveAlerte() {
    // Vérifier les permissions
    if (!checkPermission('manage_users')) {
        showNotification('Permission refusée. Seul l\'administrateur peut créer des alertes.', 'error');
        return;
    }
    
    // Récupérer les valeurs du formulaire
    const titre = document.getElementById('alerteTitre').value.trim();
    const type = document.getElementById('alerteType').value;
    const dateEcheance = document.getElementById('alerteDateEcheance').value;
    const urgence = document.getElementById('alerteUrgence').value;
    const description = document.getElementById('alerteDescription').value.trim();
    const localisation = document.getElementById('alerteLocalisation').value.trim();
    
    // Validation
    if (!titre || !type || !dateEcheance || !urgence || !description) {
        showNotification('Veuillez remplir tous les champs obligatoires (*)', 'error');
        return;
    }
    
    // Récupérer les destinataires sélectionnés
    const destinatairesSelect = document.getElementById('alerteDestinataires');
    const destinatairesIds = Array.from(destinatairesSelect.selectedOptions).map(option => option.value);
    
    if (destinatairesIds.length === 0) {
        showNotification('Veuillez sélectionner au moins un inspecteur', 'error');
        return;
    }
    
    // Récupérer les emails des destinataires
    const destinatairesEmails = Array.from(destinatairesSelect.selectedOptions)
        .filter(option => option.getAttribute('data-email'))
        .map(option => ({
            id: option.value,
            email: option.getAttribute('data-email'),
            nom: option.textContent
        }));
    
    // Récupérer les actions requises
    const actionsSelect = document.getElementById('alerteActions');
    const actions = Array.from(actionsSelect.selectedOptions).map(option => option.value);
    
    showLoading();
    
    try {
        // Créer l'objet alerte
        const alerte = {
            id: 'alert-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            titre: titre,
            type: type,
            dateEcheance: dateEcheance,
            urgence: urgence,
            description: description,
            localisation: localisation,
            destinataires: destinatairesIds,
            emailsDestinataires: destinatairesEmails,
            actionsRequises: actions,
            status: 'Active',
            dateCreation: new Date().toISOString(),
            createur: currentUser,
            envoyee: false // Pour suivre si l'email a été envoyé
        };
        
        // Simuler un délai pour l'envoi
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Envoyer les emails aux inspecteurs (simulation)
        const emailResult = await envoyerEmailsAlerte(alerte, destinatairesEmails);
        
        if (emailResult.success) {
            // Ajouter l'alerte à la liste
            alertes.push(alerte);
            
            // Afficher la confirmation
            document.getElementById('nombreDestinataires').textContent = destinatairesEmails.length;
            closeModal('modalAlerte');
            openModal('modalConfirmationAlerte');
            
            // Recharger la liste des alertes
            loadAlertes();
            
            // Sauvegarder les données
            saveAllData();
            
            showNotification('Alerte envoyée avec succès !', 'success');
        } else {
            showNotification('Erreur lors de l\'envoi des emails: ' + emailResult.message, 'error');
        }
    } catch (error) {
        console.error('Erreur lors de la création de l\'alerte:', error);
        showNotification('Erreur lors de la création de l\'alerte', 'error');
    } finally {
        hideLoading();
    }
}

// Fonction pour envoyer les emails d'alerte (simulée)
async function envoyerEmailsAlerte(alerte, destinataires) {
    // Dans une application réelle, ceci appellerait une API d'envoi d'emails
    // Pour cette démo, nous allons simuler l'envoi
    
    console.log('Envoi d\'alertes par email:', {
        alerte: alerte.titre,
        destinataires: destinataires.map(d => ({ email: d.email, nom: d.nom }))
    });
    
    // Simulation de l'envoi d'emails
    return new Promise(resolve => {
        setTimeout(() => {
            resolve({
                success: true,
                message: `Emails envoyés à ${destinataires.length} inspecteur(s)`,
                details: destinataires.map(d => d.email)
            });
        }, 800);
    });
}

// Charger les alertes dans la liste
function loadAlertes() {
    const container = document.getElementById('alertesList');
    if (!container) return;
    
    // Trier les alertes par date de création (plus récentes en premier)
    const alertesTriees = [...alertes].sort((a, b) => 
        new Date(b.dateCreation) - new Date(a.dateCreation)
    );
    
    if (alertesTriees.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Aucune alerte envoyée</h3>
                <p>Créez votre première alerte urgente en cliquant sur "Nouvelle Alerte Urgente"</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = alertesTriees.map(alerte => {
        // Déterminer la classe CSS en fonction du niveau d'urgence
        let urgenceClass = '';
        let urgenceTextClass = '';
        
        if (alerte.urgence === 'Critique') {
            urgenceClass = 'critical';
            urgenceTextClass = 'critical';
        } else if (alerte.urgence === 'Haute') {
            urgenceClass = 'high';
            urgenceTextClass = 'high';
        } else {
            urgenceClass = 'medium';
            urgenceTextClass = 'medium';
        }
        
        // Formater la date
        const dateCreation = new Date(alerte.dateCreation).toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Formater la date d'échéance
        const dateEcheance = new Date(alerte.dateEcheance).toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Calculer le nombre de destinataires
        const nbDestinataires = alerte.destinataires?.length || 0;
        
        return `
            <div class="alerte-card ${urgenceClass}">
                <div class="alerte-header">
                    <div class="alerte-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${alerte.titre}
                    </div>
                    <div class="alerte-date">${dateCreation}</div>
                </div>
                
                <div class="alerte-urgence ${urgenceTextClass}">${alerte.urgence}</div>
                
                <div class="alerte-description">
                    ${alerte.description}
                </div>
                
                <div class="alerte-details">
                    <div class="alerte-detail-item">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${alerte.type}</span>
                    </div>
                    
                    <div class="alerte-detail-item">
                        <span class="detail-label">Échéance:</span>
                        <span class="detail-value">${dateEcheance}</span>
                    </div>
                    
                    <div class="alerte-detail-item">
                        <span class="detail-label">Localisation:</span>
                        <span class="detail-value">${alerte.localisation || 'Non spécifiée'}</span>
                    </div>
                    
                    <div class="alerte-detail-item">
                        <span class="detail-label">Destinataires:</span>
                        <span class="detail-value">${nbDestinataires} inspecteur(s)</span>
                    </div>
                    
                    ${alerte.actionsRequises?.length > 0 ? `
                        <div class="alerte-detail-item" style="grid-column: 1 / -1;">
                            <span class="detail-label">Actions requises:</span>
                            <span class="detail-value">${alerte.actionsRequises.join(', ')}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="alerte-actions">
                    <button class="btn btn-secondary" onclick="viewAlerteDetails('${alerte.id}')" style="flex: 1;">
                        <i class="fas fa-eye"></i> Voir détails
                    </button>
                    <button class="btn btn-danger" onclick="deleteAlerte('${alerte.id}')" style="flex: 1;">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Voir les détails d'une alerte
function viewAlerteDetails(id) {
    const alerte = alertes.find(a => a.id === id);
    if (!alerte) return;
    
    // Formater les dates
    const dateCreation = new Date(alerte.dateCreation).toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const dateEcheance = new Date(alerte.dateEcheance).toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Récupérer les noms des destinataires
    const destinatairesNoms = alerte.destinataires?.map(id => {
        const inspector = inspectors.find(i => i.id === id);
        return inspector ? `${inspector.lastName} ${inspector.firstName} (${inspector.specialty})` : 'Inconnu';
    }).join(', ') || 'Aucun destinataire';
    
    // Récupérer les emails des destinataires
    const destinatairesEmails = alerte.emailsDestinataires?.map(d => d.email).join(', ') || 'Non disponible';
    
    const details = `
        <div class="aerodrome-detail-card">
            <h3 style="color: var(--danger-color); margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i> Détails de l'Alerte
            </h3>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Informations Générales</h4>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Titre</div>
                        <div class="detail-value">${alerte.titre}</div>
                    </div>
                    <div>
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${alerte.type}</div>
                    </div>
                    <div>
                        <div class="detail-label">Niveau d'urgence</div>
                        <div class="detail-value">${alerte.urgence}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div>
                        <div class="detail-label">Date de création</div>
                        <div class="detail-value">${dateCreation}</div>
                    </div>
                    <div>
                        <div class="detail-label">Date d'échéance</div>
                        <div class="detail-value">${dateEcheance}</div>
                    </div>
                    <div>
                        <div class="detail-label">Créé par</div>
                        <div class="detail-value">${alerte.createur || 'Système'}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div style="grid-column: 1 / -1;">
                        <div class="detail-label">Localisation</div>
                        <div class="detail-value">${alerte.localisation || 'Non spécifiée'}</div>
                    </div>
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Description</h4>
                <div style="padding: 20px; background: var(--light-bg); border-radius: 8px; line-height: 1.6;">
                    ${alerte.description}
                </div>
            </div>
            
            <div class="aerodrome-detail-section">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">Destinataires</h4>
                <div class="detail-row">
                    <div style="grid-column: 1 / -1;">
                        <div class="detail-label">Inspecteurs concernés (${alerte.destinataires?.length || 0})</div>
                        <div class="detail-value">${destinatairesNoms}</div>
                    </div>
                </div>
                <div class="detail-row">
                    <div style="grid-column: 1 / -1;">
                        <div class="detail-label">Emails de notification</div>
                        <div class="detail-value" style="font-size: 14px; color: var(--text-secondary);">
                            ${destinatairesEmails}
                        </div>
                    </div>
                </div>
            </div>
            
            ${alerte.actionsRequises?.length > 0 ? `
                <div class="aerodrome-detail-section">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Actions Requises</h4>
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px;">
                        <ul style="margin: 0; padding-left: 20px;">
                            ${alerte.actionsRequises.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('modalCustomContent').innerHTML = details;
    document.getElementById('modalCustom').classList.add('active');
}

// Supprimer une alerte
function deleteAlerte(id) {
    // Vérifier les permissions
    if (!checkPermission('manage_users')) {
        showNotification('Permission refusée.', 'error');
        return;
    }
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette alerte ? Cette action est irréversible.')) {
        const index = alertes.findIndex(a => a.id === id);
        if (index !== -1) {
            alertes.splice(index, 1);
            loadAlertes();
            saveAllData();
            showNotification('Alerte supprimée avec succès', 'success');
        }
    }
}

// Initialiser les alertes au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si l'onglet alertes existe
    if (document.getElementById('alertesList')) {
        loadAlertes();
    }
});


// ============ FONCTIONS UTILITAIRES POUR LES DÉTAILS ============

function showPlanningDetails(planningId) {
    const planning = plannings.find(p => p.id === planningId);
    if (!planning) return;
    
    showTab('planning');
    
    // Ajouter un effet visuel sur l'élément concerné
    setTimeout(() => {
        const elements = document.querySelectorAll('.planning-card');
        elements.forEach(el => {
            if (el.getAttribute('data-id') === planningId) {
                el.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => el.style.animation = '', 1000);
            }
        });
    }, 500);
}

function showPlanActionDetails(planId) {
    const plan = plansActions.find(p => p.id === planId);
    if (!plan) return;
    
    showTab('plans-actions');
    
    setTimeout(() => {
        const elements = document.querySelectorAll('.plan-action-card');
        elements.forEach(el => {
            if (el.getAttribute('data-id') === planId) {
                el.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => el.style.animation = '', 1000);
            }
        });
    }, 500);
}

function showFormationDetails(formationId) {
    const formation = formations.find(f => f.id === formationId);
    if (!formation) return;
    
    showTab('formation');
    
    setTimeout(() => {
        const elements = document.querySelectorAll('.formation-card');
        elements.forEach(el => {
            if (el.getAttribute('data-id') === formationId) {
                el.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => el.style.animation = '', 1000);
            }
        });
    }, 500);
}

function updateAllTabs() {
            loadAerodromes();
            loadCertifications();
            loadHomologations();
            loadPlannings();
            loadSurveillances();
            loadRegistres();
            loadInspectors();
            loadFormations();
            loadDossiers();
            loadPlansActionsGrouped();
            loadKitFiles();
            loadUtilisateurs();
            loadEvenements();
            updateDashboard();
            updateAlertes();
	    updateAllCalendars();
        }

// Fonction pour démarrer le rafraîchissement périodique des alertes
function startAlertsRefresh() {
    // Vérifier immédiatement
    updateAlertes();
    loadRegistres();
    loadDossiers();
    initFormationTab();
    updateKitStats();
    loadKitFiles();
    updateEvenementStats();
    loadEvenements();
    initEvenementsChart();
    updateAlerteStats();
    loadAlertes();

    // Initialiser quand la page est chargée
    document.addEventListener('DOMContentLoaded', function() {
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab && activeTab.id === 'formation') {
            setTimeout(initFormationTab, 100); // Petit délai pour s'assurer que le DOM est prêt
        }
    });

    // Écouter les changements d'onglets
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            if (tabId === 'formation') {
                setTimeout(initFormationTab, 100);
            }
        });
    });

    // Vérifier toutes les 30 secondes
    setInterval(() => {
        updateAlertes();
    }, 30000);
}

    </script>
</body>
</html>